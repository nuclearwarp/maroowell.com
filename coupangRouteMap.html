// 1) Kakao Polygon -> WGS84 위경도 배열로 추출
function getPolygonPointsWgs84(polygon) {
  const result = [];

  if (!polygon || typeof polygon.getPath !== "function") {
    log("[ERR] getPolygonPointsWgs84: polygon/getPath 없음", "err");
    return result;
  }

  const rawPath = polygon.getPath();   // kakao.maps.LatLngPath 또는 배열 비슷한 객체
  log("[DEBUG] drawend raw path", rawPath, "info");

  const walk = (node) => {
    if (!node) return;

    // kakao.maps.LatLng 또는 비슷한 객체
    if (typeof node.getLat === "function" && typeof node.getLng === "function") {
      const lat = node.getLat();
      const lng = node.getLng();
      if (Number.isFinite(lat) && Number.isFinite(lng)) {
        result.push({ lat, lng });
      }
      return;
    }

    // LatLngPath (getLength / getAt)
    if (typeof node.getLength === "function" && typeof node.getAt === "function") {
      const len = node.getLength();
      for (let i = 0; i < len; i++) walk(node.getAt(i));
      return;
    }

    // 배열이면 재귀
    if (Array.isArray(node)) {
      node.forEach(walk);
    }
  };

  walk(rawPath);

  log(`[DEBUG] getPolygonPointsWgs84 결과 점 수=${result.length}`, "info");
  return result;
}

// 2) 저장 버튼에서 호출하는 부분
saveBtn.addEventListener("click", async () => {
  const camp = campInput.value.trim();
  const code = routeInput.value.trim();

  if (!camp || !code) {
    alert("캠프 이름과 라우트 코드를 모두 입력해주세요.");
    return;
  }
  if (!currentPolygon) {
    alert("저장할 폴리곤이 없습니다. [새로 그리기]로 영역을 그리고 저장해주세요.");
    log("[LOG] 저장 실패: currentPolygon 없음", "err");
    return;
  }

  // ★ 여기서 항상 WGS84 좌표만 추출
  const pts = getPolygonPointsWgs84(currentPolygon);

  if (!pts.length) {
    alert("폴리곤 점이 없습니다. 최소 3개 이상 찍어주세요.");
    log("[LOG] 저장 실패: 추출된 점 개수 0", "err");
    return;
  }

  // 이상 좌표 체크 (index.html 처럼 경고만 띄우는 용도)
  const weird = pts.filter(p =>
    p.lat < 30 || p.lat > 45 || p.lng < 120 || p.lng > 135
  );
  if (weird.length) {
    const w = weird[0];
    log(
      `[WARN] 저장 좌표 중 한국 범위 밖인 점이 있습니다. 예: lat=${w.lat}, lng=${w.lng}`,
      "warn"
    );
  }

  const center = computeCenter(pts);  // 평균으로 중심 구하는 기존 함수 그대로 사용
  log(
    `[LOG] 저장 준비: 점 ${pts.length}개, 중심 (${center.lat.toFixed(
      6
    )}, ${center.lng.toFixed(6)})`,
    "info"
  );

  try {
    await saveRoute(camp, code, pts, center);
    alert("저장 완료되었습니다.");
  } catch (e) {
    console.error(e);
    alert("저장 중 오류가 발생했습니다.");
  }
});
