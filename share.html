<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë°°ì†¡ ì§€ë„ ê³µìœ </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico?v=2" />

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2d;
      --txt:#e6eefc;
      --muted:#93a4c7;
      --line:rgba(255,255,255,.08);
      --btn:#162744;
      --btn2:#1a2f55;
    }
    *{box-sizing:border-box; margin:0; padding:0;}
    html,body{height:100%; font-family:system-ui, -apple-system, "Noto Sans KR", sans-serif; background:var(--bg); color:var(--txt);}
    
    .container{display:flex; flex-direction:column; height:100vh;}
    
    /* í—¤ë” */
    .header{
      background:linear-gradient(135deg, #1a2f55 0%, #0f1a2d 100%);
      padding:16px 20px;
      border-bottom:2px solid var(--line);
      box-shadow:0 4px 12px rgba(0,0,0,.3);
    }
    .header-content{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .title-area{flex:1; min-width:0;}
    .title{font-size:22px; font-weight:800; margin-bottom:6px; letter-spacing:0.3px;}
    .subtitle{font-size:14px; color:var(--muted); display:flex; align-items:center; gap:12px; flex-wrap:wrap;}
    .badge{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      font-size:12px;
      color:var(--txt);
      gap:6px;
    }
    .badge .dot{
      width:6px;
      height:6px;
      border-radius:50%;
      background:currentColor;
    }
    
    /* ë„¤ë¹„ ë²„íŠ¼ ì˜ì—­ */
    .navi-buttons{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .btn{
      padding:10px 18px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--txt);
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      white-space:nowrap;
      transition:all 0.2s;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn:hover{background:var(--btn2); transform:translateY(-1px);}
    .btn.primary{
      background:linear-gradient(135deg, #00C2FF 0%, #0088CC 100%);
      border-color:#00C2FF;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,194,255,.25);
    }
    .btn.primary:hover{
      box-shadow:0 6px 16px rgba(0,194,255,.35);
    }
    
    /* ì§€ë„ */
    .map-container{flex:1; position:relative;}
    #map{position:absolute; inset:0;}
    
    /* ë°°ì†¡ì§€ ëª©ë¡ íŒ¨ë„ */
    .address-panel{
      position:absolute;
      bottom:20px;
      left:20px;
      max-width:360px;
      max-height:50vh;
      background:rgba(15,26,45,.95);
      backdrop-filter:blur(10px);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.4);
      overflow:hidden;
      display:none; /* ë°°ì†¡ì§€ê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ */
    }
    .address-panel.visible{display:block;}
    .panel-header{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      font-weight:700;
      font-size:14px;
      background:rgba(0,0,0,.2);
    }
    .address-list{
      max-height:calc(50vh - 50px);
      overflow-y:auto;
      padding:8px;
    }
    .address-item{
      padding:10px 12px;
      margin-bottom:6px;
      background:rgba(0,0,0,.15);
      border:1px solid var(--line);
      border-radius:10px;
      font-size:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      transition:background 0.2s;
    }
    .address-item:hover{background:rgba(0,0,0,.25);}
    .address-info{flex:1; min-width:0;}
    .address-text{font-weight:600; color:var(--txt); margin-bottom:3px; word-break:break-all;}
    .address-meta{color:var(--muted); font-size:11px;}
    .address-item .btn{padding:6px 12px; font-size:11px;}
    
    /* ì…ì°¨ì§€ ì •ë³´ íŒ¨ë„ */
    .delivery-info{
      position:absolute;
      top:20px;
      left:20px;
      max-width:300px;
      background:rgba(15,26,45,.95);
      backdrop-filter:blur(10px);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 14px;
      box-shadow:0 4px 12px rgba(0,0,0,.3);
      display:none;
    }
    .delivery-info.visible{display:block;}
    .delivery-info .label{font-size:11px; color:var(--muted); margin-bottom:4px;}
    .delivery-info .value{font-size:13px; color:var(--txt); font-weight:600;}
    
    /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
    .loading{
      position:absolute;
      inset:0;
      background:rgba(11,18,32,.85);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:100;
      flex-direction:column;
      gap:12px;
    }
    .spinner{
      width:40px;
      height:40px;
      border:4px solid rgba(255,255,255,.1);
      border-top-color:#00C2FF;
      border-radius:50%;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg);}}
    .loading-text{font-size:14px; color:var(--muted);}
    
    /* ë¼ë²¨ */
    .route-label{
      padding:5px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.65);
      color:#fff;
      font-size:13px;
      border:1px solid rgba(255,255,255,.2);
      white-space:nowrap;
      box-shadow:0 2px 10px rgba(0,0,0,.4);
      font-weight:700;
      letter-spacing:0.2px;
    }
    
    /* ë°˜ì‘í˜• */
    @media (max-width: 768px){
      .header-content{flex-direction:column; align-items:stretch;}
      .navi-buttons{flex-direction:column;}
      .btn{width:100%;}
      .address-panel{
        left:10px;
        right:10px;
        bottom:10px;
        max-width:none;
      }
      .delivery-info{
        left:10px;
        right:10px;
        top:10px;
        max-width:none;
      }
    }
  </style>

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=add4ce93b38c0ff9d9b9053728e067b3&autoload=false&libraries=services"></script>
</head>

<body>
<div class="container">
  <!-- í—¤ë” -->
  <div class="header">
    <div class="header-content">
      <div class="title-area">
        <div class="title">ğŸ“ ë°°ì†¡ êµ¬ì—­ ì•ˆë‚´</div>
        <div class="subtitle" id="subtitle">
          <span class="badge" id="campBadge"><span class="dot" style="background:#00C2FF"></span>ìº í”„: -</span>
          <span class="badge" id="codeBadge"><span class="dot" style="background:#FFD166"></span>ë¼ìš°íŠ¸: -</span>
        </div>
      </div>
      
      <div class="navi-buttons">
        <button class="btn primary" id="naviBtn" style="display:none;">
          ğŸš— ìº í”„ê¹Œì§€ ê¸¸ì°¾ê¸°
        </button>
      </div>
    </div>
  </div>
  
  <!-- ì§€ë„ -->
  <div class="map-container">
    <div id="map"></div>
    
    <!-- ë¡œë”© -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div class="loading-text">ì§€ë„ ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </div>
    
    <!-- ì…ì°¨ì§€ ì •ë³´ íŒ¨ë„ -->
    <div class="delivery-info" id="deliveryInfo">
      <div class="label">ì…ì°¨ì§€ (ì¶œë°œì§€)</div>
      <div class="value" id="deliveryName">-</div>
      <div class="label" style="margin-top:8px;">ì£¼ì†Œ</div>
      <div class="value" id="deliveryAddr" style="font-size:12px; font-weight:400;">-</div>
    </div>
    
    <!-- ë°°ì†¡ì§€ ëª©ë¡ íŒ¨ë„ -->
    <div class="address-panel" id="addressPanel">
      <div class="panel-header">ğŸ“¦ ë°°ì†¡ì§€ ëª©ë¡</div>
      <div class="address-list" id="addressList"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const API_BASE = "https://route.maroowell.com";
  const ROUTE_ENDPOINT = `${API_BASE}/route`;
  const ADDRESS_ENDPOINT = `${API_BASE}/addresses`;
  
  const $ = (id) => document.getElementById(id);
  const loading = $("loading");
  const naviBtn = $("naviBtn");
  const campBadge = $("campBadge");
  const codeBadge = $("codeBadge");
  const deliveryInfo = $("deliveryInfo");
  const deliveryName = $("deliveryName");
  const deliveryAddr = $("deliveryAddr");
  const addressPanel = $("addressPanel");
  const addressList = $("addressList");
  
  let map, geocoder;
  let routeData = null;
  let addressRows = [];
  
  // URL íŒŒë¼ë¯¸í„° ì¶”ì¶œ
  const params = new URLSearchParams(location.search);
  const camp = params.get("camp") || "";
  const code = params.get("code") || "";
  
  // ì»¬ëŸ¬ íŒ”ë ˆíŠ¸
  const COLOR_PALETTE = [
    "#00C2FF", "#FF4D6D", "#FFD166", "#06D6A0", "#A78BFA",
    "#F97316", "#22C55E", "#E11D48", "#3B82F6", "#F59E0B"
  ];
  
  function hashCode(str) {
    let h = 0;
    for (let i=0;i<str.length;i++){
      h = (h<<5) - h + str.charCodeAt(i);
      h |= 0;
    }
    return Math.abs(h);
  }
  
  function colorFor(code) {
    return COLOR_PALETTE[hashCode(code) % COLOR_PALETTE.length];
  }
  
  // API í˜¸ì¶œ
  async function apiGet(url) {
    const res = await fetch(url, { method:"GET" });
    const text = await res.text();
    let json = null;
    try { json = text ? JSON.parse(text) : null; } catch {}
    if (!res.ok) {
      const msg = json?.error || text || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return json;
  }
  
  // í´ë¦¬ê³¤ íŒŒì‹±
  function parsePolygonWgs84(v) {
    if (!v) return null;
    if (Array.isArray(v)) return v;
    if (typeof v === "string") {
      try {
        const p = JSON.parse(v);
        if (Array.isArray(p)) return p;
      } catch (e) {}
    }
    return null;
  }
  
  // í´ë¦¬ê³¤ ì¤‘ì‹¬ì  ê³„ì‚°
  function centroidOfLatLngs(latlngs) {
    let latSum=0, lngSum=0;
    for (const ll of latlngs) { 
      latSum += ll.getLat(); 
      lngSum += ll.getLng(); 
    }
    return new kakao.maps.LatLng(latSum/latlngs.length, lngSum/latlngs.length);
  }
  
  // ë¼ë²¨ ìƒì„±
  function createLabel(text, position, color) {
    const el = document.createElement("div");
    el.className = "route-label";
    el.style.borderColor = color;
    el.innerHTML = `<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${color};margin-right:6px;vertical-align:middle;"></span>${text}`;
    
    return new kakao.maps.CustomOverlay({
      position,
      content: el,
      yAnchor: 1.0,
      zIndex: 10
    });
  }
  
  // í´ë¦¬ê³¤ ê·¸ë¦¬ê¸°
  function drawPolygons(rows) {
    if (!rows || rows.length === 0) return;
    
    const bounds = new kakao.maps.LatLngBounds();
    let hasPolygon = false;
    
    for (const row of rows) {
      const fullCode = row.full_code || row.code || "";
      const color = row.color || colorFor(fullCode);
      const poly = parsePolygonWgs84(row.polygon_wgs84);
      
      if (!poly || !Array.isArray(poly) || poly.length === 0) continue;
      
      // ë°ì´í„° í˜•ì‹ ìë™ ê°ì§€
      let rings = [];
      const first = poly[0];
      
      if (first && typeof first === 'object' && 'lat' in first && 'lng' in first) {
        rings = [poly];
      } else if (Array.isArray(first)) {
        const firstOfFirst = first[0];
        if (firstOfFirst && typeof firstOfFirst === 'object' && 'lat' in firstOfFirst) {
          rings = poly;
        } else if (Array.isArray(firstOfFirst) && firstOfFirst.length >= 2) {
          rings = poly;
        } else if (typeof firstOfFirst === 'number') {
          rings = [poly];
        }
      }
      
      for (const ring of rings) {
        if (!Array.isArray(ring) || ring.length < 3) continue;
        
        const latlngs = ring.map(pt => {
          if (pt && typeof pt === 'object' && 'lat' in pt && 'lng' in pt) {
            return new kakao.maps.LatLng(pt.lat, pt.lng);
          } else if (Array.isArray(pt) && pt.length >= 2) {
            return new kakao.maps.LatLng(pt[1], pt[0]);
          }
          return null;
        }).filter(ll => ll !== null);
        
        if (latlngs.length < 3) continue;
        
        // í´ë¦¬ê³¤ ìƒì„±
        const polygon = new kakao.maps.Polygon({
          path: latlngs,
          strokeWeight: 5,
          strokeColor: color,
          strokeOpacity: 1.0,
          strokeStyle: "solid",
          fillColor: color,
          fillOpacity: 0.20,
          zIndex: 1
        });
        polygon.setMap(map);
        
        // ë¼ë²¨ ìƒì„±
        const center = centroidOfLatLngs(latlngs);
        const label = createLabel(fullCode, center, color);
        label.setMap(map);
        
        latlngs.forEach(ll => bounds.extend(ll));
        hasPolygon = true;
      }
    }
    
    if (hasPolygon) {
      map.setBounds(bounds);
    }
  }
  
  // ë°°ì†¡ì§€ ëª©ë¡ ë Œë”ë§
  function renderAddressList() {
    if (!addressRows || addressRows.length === 0) {
      addressPanel.classList.remove("visible");
      return;
    }
    
    addressPanel.classList.add("visible");
    addressList.innerHTML = "";
    
    addressRows.forEach((addr, idx) => {
      const item = document.createElement("div");
      item.className = "address-item";
      
      const addressText = addr.address || addr.full_address || "ì£¼ì†Œ ì—†ìŒ";
      const dong = addr.dong ? `(${addr.dong})` : "";
      const zipcode = addr.zipcode ? `ìš°í¸ë²ˆí˜¸: ${addr.zipcode}` : "";
      
      item.innerHTML = `
        <div class="address-info">
          <div class="address-text">${idx + 1}. ${addressText} ${dong}</div>
          <div class="address-meta">${zipcode}</div>
        </div>
        <button class="btn" data-addr-id="${addr.id}">ğŸš—</button>
      `;
      
      const btn = item.querySelector("button");
      btn.onclick = () => openNaviToAddress(addr);
      
      addressList.appendChild(item);
    });
  }
  
  // ë°°ì†¡ì§€ë¡œ ë„¤ë¹„ ì‹¤í–‰
  async function openNaviToAddress(addr) {
    if (!routeData || !routeData.delivery_location_address) {
      alert("ì…ì°¨ì§€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    if (!addr.center_wgs84) {
      alert("ë°°ì†¡ì§€ ì¢Œí‘œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    const deliveryAddress = routeData.delivery_location_address;
    
    // ì…ì°¨ì§€ ì£¼ì†Œë¥¼ ì¢Œí‘œë¡œ ë³€í™˜
    geocoder.addressSearch(deliveryAddress, (result, status) => {
      if (status !== kakao.maps.services.Status.OK || !result?.length) {
        alert("ì…ì°¨ì§€ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      
      const startLat = Number(result[0].y);
      const startLng = Number(result[0].x);
      
      // ë°°ì†¡ì§€ ì¢Œí‘œ ì¶”ì¶œ
      let endLat, endLng;
      
      if (typeof addr.center_wgs84 === 'object') {
        endLat = addr.center_wgs84.lat || addr.center_wgs84.latitude;
        endLng = addr.center_wgs84.lng || addr.center_wgs84.lon || addr.center_wgs84.longitude;
      } else if (Array.isArray(addr.center_wgs84) && addr.center_wgs84.length >= 2) {
        const [first, second] = addr.center_wgs84;
        if (Math.abs(first) > Math.abs(second)) {
          endLng = first;
          endLat = second;
        } else {
          endLat = first;
          endLng = second;
        }
      }
      
      if (!endLat || !endLng || !isFinite(endLat) || !isFinite(endLng)) {
        alert("ë°°ì†¡ì§€ ì¢Œí‘œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }
      
      const startName = routeData.delivery_location_name || "ì…ì°¨ì§€";
      const endName = addr.address || "ë°°ì†¡ì§€";
      
      // ì¹´ì¹´ì˜¤ë‚´ë¹„ URL
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      let naviUrl;
      
      if (isMobile) {
        naviUrl = `kakaomap://route?sp=${startLat},${startLng}&ep=${endLat},${endLng}&by=CAR`;
      } else {
        naviUrl = `https://map.kakao.com/link/from/${encodeURIComponent(startName)},${startLat},${startLng}/to/${encodeURIComponent(endName)},${endLat},${endLng}`;
      }
      
      window.open(naviUrl, "_blank");
    });
  }
  
  // ìº í”„ê¹Œì§€ ë„¤ë¹„ (í´ë¦¬ê³¤ ì¤‘ì‹¬ì ìœ¼ë¡œ)
  function openNaviToCamp() {
    if (!routeData || !routeData.delivery_location_address) {
      alert("ì…ì°¨ì§€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    const deliveryAddress = routeData.delivery_location_address;
    
    geocoder.addressSearch(deliveryAddress, (result, status) => {
      if (status !== kakao.maps.services.Status.OK || !result?.length) {
        alert("ì…ì°¨ì§€ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      
      const lat = Number(result[0].y);
      const lng = Number(result[0].x);
      const startName = routeData.delivery_location_name || "ì…ì°¨ì§€";
      
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      let naviUrl;
      
      if (isMobile) {
        naviUrl = `kakaomap://look?p=${lat},${lng}`;
      } else {
        naviUrl = `https://map.kakao.com/link/map/${encodeURIComponent(startName)},${lat},${lng}`;
      }
      
      window.open(naviUrl, "_blank");
    });
  }
  
  // ë°ì´í„° ë¡œë“œ
  async function loadData() {
    try {
      if (!camp) {
        throw new Error("ìº í”„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. (camp íŒŒë¼ë¯¸í„° í•„ìš”)");
      }
      
      // ë¼ìš°íŠ¸ ë°ì´í„° ë¡œë“œ
      const url = new URL(ROUTE_ENDPOINT);
      url.searchParams.set("camp", camp);
      if (code) {
        url.searchParams.set("code", code);
        url.searchParams.set("mode", "prefix");
      } else {
        url.searchParams.set("mode", "prefix");
      }
      
      const data = await apiGet(url.toString());
      
      if (!data || !data.rows || data.rows.length === 0) {
        throw new Error("ë¼ìš°íŠ¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
      
      routeData = data.rows[0]; // ì²« ë²ˆì§¸ ë¼ìš°íŠ¸ ì‚¬ìš©
      
      // UI ì—…ë°ì´íŠ¸
      campBadge.innerHTML = `<span class="dot" style="background:#00C2FF"></span>ìº í”„: ${camp}`;
      codeBadge.innerHTML = `<span class="dot" style="background:#FFD166"></span>ë¼ìš°íŠ¸: ${code || "ì „ì²´"}`;
      
      // ì…ì°¨ì§€ ì •ë³´ í‘œì‹œ
      if (routeData.delivery_location_name || routeData.delivery_location_address) {
        deliveryInfo.classList.add("visible");
        deliveryName.textContent = routeData.delivery_location_name || "-";
        deliveryAddr.textContent = routeData.delivery_location_address || "-";
        naviBtn.style.display = "inline-flex";
      }
      
      // í´ë¦¬ê³¤ ê·¸ë¦¬ê¸°
      drawPolygons(data.rows);
      
      // ë°°ì†¡ì§€ ëª©ë¡ ë¡œë“œ
      try {
        const addrUrl = new URL(ADDRESS_ENDPOINT);
        addrUrl.searchParams.set("camp", camp);
        if (code) addrUrl.searchParams.set("code", code);
        
        const addrData = await apiGet(addrUrl.toString());
        addressRows = addrData?.rows || [];
        renderAddressList();
      } catch (addrErr) {
        console.warn("ë°°ì†¡ì§€ ë¡œë“œ ì‹¤íŒ¨:", addrErr);
      }
      
      loading.style.display = "none";
      
    } catch (err) {
      console.error(err);
      loading.innerHTML = `
        <div style="text-align:center; color:#FF4D6D;">
          <div style="font-size:48px; margin-bottom:16px;">âš ï¸</div>
          <div style="font-size:16px; font-weight:700; margin-bottom:8px;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>
          <div style="font-size:13px; color:var(--muted);">${err.message}</div>
        </div>
      `;
    }
  }
  
  // ì´ˆê¸°í™”
  function init() {
    kakao.maps.load(() => {
      const center = new kakao.maps.LatLng(37.5665, 126.978);
      map = new kakao.maps.Map($("map"), { 
        center, 
        level: 8,
        draggable: true,
        scrollwheel: true,
        disableDoubleClickZoom: false
      });
      geocoder = new kakao.maps.services.Geocoder();
      
      // ì¤Œ ì»¨íŠ¸ë¡¤ ì¶”ê°€
      const zoomControl = new kakao.maps.ZoomControl();
      map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
      
      // ë„¤ë¹„ ë²„íŠ¼ ë°”ì¸ë”©
      naviBtn.onclick = openNaviToCamp;
      
      loadData();
    });
  }
  
  init();
})();
</script>
</body>
</html>
