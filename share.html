<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ë°°ì†¡ ì§€ë„ ê³µìœ </title>

  <!-- Open Graph / ë§í¬ ë¯¸ë¦¬ë³´ê¸° ë©”íƒ€ íƒœê·¸ -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="ë°°ì†¡ ì§€ë„ ê³µìœ " />
  <meta property="og:description" content="ë°°ì†¡ êµ¬ì—­ ë° ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”" />
  <meta property="og:site_name" content="Maroowell" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ë°°ì†¡ ì§€ë„ ê³µìœ " />
  <meta name="twitter:description" content="ë°°ì†¡ êµ¬ì—­ ë° ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”" />

  <link rel="icon" type="image/x-icon" href="/favicon.ico?v=2" />

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2d;
      --txt:#e6eefc;
      --muted:#93a4c7;
      --line:rgba(255,255,255,.08);
      --btn:#162744;
      --btn2:#1a2f55;
    }
    *{box-sizing:border-box; margin:0; padding:0;}
    html,body{height:100%; font-family:system-ui, -apple-system, "Noto Sans KR", sans-serif; background:var(--bg); color:var(--txt);}

    .container{display:flex; flex-direction:column; height:100vh;}

    /* í—¤ë” - ëª¨ë°”ì¼ ì¤‘ì‹¬ */
    .header{
      background:linear-gradient(135deg, #1a2f55 0%, #0f1a2d 100%);
      padding:20px;
      border-bottom:2px solid var(--line);
      box-shadow:0 4px 12px rgba(0,0,0,.3);
      text-align:center;
    }
    .header-content{
      max-width:600px;
      margin:0 auto;
    }
    .camp-info{
      margin-bottom:16px;
    }
    .camp-name{
      font-size:24px;
      font-weight:800;
      margin-bottom:8px;
      letter-spacing:0.3px;
      color:#00C2FF;
    }
    .camp-address{
      font-size:14px;
      color:var(--muted);
      line-height:1.5;
      margin-bottom:4px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .copy-btn{
      background:rgba(0,194,255,.15);
      border:1px solid rgba(0,194,255,.3);
      color:#00C2FF;
      padding:4px 8px;
      border-radius:6px;
      cursor:pointer;
      font-size:12px;
      transition:all 0.2s;
      white-space:nowrap;
    }
    .copy-btn:hover{
      background:rgba(0,194,255,.25);
      border-color:#00C2FF;
    }

    /* ë„¤ë¹„ ë²„íŠ¼ ì˜ì—­ */
    .navi-buttons{
      display:flex;
      gap:8px;
      flex-direction:column;
    }
    .btn{
      width:100%;
      padding:14px 20px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--txt);
      cursor:pointer;
      font-weight:700;
      font-size:15px;
      white-space:nowrap;
      transition:all 0.2s;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:hover{background:var(--btn2); transform:translateY(-1px);}
    .btn.primary{
      background:linear-gradient(135deg, #00C2FF 0%, #0088CC 100%);
      border-color:#00C2FF;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,194,255,.25);
      font-size:16px;
      padding:16px 20px;
    }
    .btn.primary:hover{
      box-shadow:0 6px 16px rgba(0,194,255,.35);
    }

    /* ì§€ë„ */
    .map-container{flex:1; position:relative;}
    #map{position:absolute; inset:0;}

    /* ë°°ì†¡ì§€ ëª©ë¡ íŒ¨ë„ */
    .address-panel{
      position:absolute;
      bottom:20px;
      left:20px;
      max-width:360px;
      max-height:60vh;
      background:rgba(15,26,45,.95);
      backdrop-filter:blur(10px);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.4);
      overflow:hidden;
      display:none; /* ë°°ì†¡ì§€ê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ */
    }
    .address-panel.visible{display:block;}
    .panel-header{
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      font-weight:700;
      font-size:15px;
      background:rgba(0,0,0,.2);
    }
    .address-list{
      max-height:calc(60vh - 60px);
      overflow-y:auto;
      padding:10px;
    }
    .address-item{
      padding:14px 16px;
      margin-bottom:8px;
      background:rgba(0,0,0,.15);
      border:1px solid var(--line);
      border-radius:12px;
      font-size:13px;
      display:flex;
      flex-direction:column;
      gap:10px;
      transition:all 0.2s;
    }
    .address-item:hover{background:rgba(0,0,0,.25); border-color:#00C2FF;}
    .address-info{flex:1; min-width:0;}
    .address-text{font-weight:600; color:var(--txt); margin-bottom:4px; word-break:break-all;}
    .address-meta{color:var(--muted); font-size:12px;}
    .address-item .btn{
      padding:10px 16px;
      font-size:14px;
      width:100%;
      border-radius:8px;
    }

    /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
    .loading{
      position:absolute;
      inset:0;
      background:rgba(11,18,32,.85);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:100;
      flex-direction:column;
      gap:12px;
    }
    .spinner{
      width:40px;
      height:40px;
      border:4px solid rgba(255,255,255,.1);
      border-top-color:#00C2FF;
      border-radius:50%;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg);}}
    .loading-text{font-size:14px; color:var(--muted);}

    /* ë¼ë²¨ - ìº í”„ í‘œì‹œ í¬ê²Œ */
    .route-label{
      padding:5px 10px;
      border-radius:12px;
      background:rgba(0,0,0,.10);
      color:#fff;
      font-size:12px;
      border:2px solid rgba(255,255,255,.22);
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.35);
      font-weight:800;
      letter-spacing:0.2px;
      backdrop-filter:blur(4px);
    }

    /* ë¼ìš°íŠ¸ ì„ íƒ ëª¨ë‹¬ */
    .route-modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.8);
      backdrop-filter:blur(8px);
      z-index:1000;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .route-modal.visible{display:flex;}
    .route-modal-content{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      padding:24px;
      max-width:500px;
      width:100%;
      max-height:80vh;
      overflow-y:auto;
    }
    .route-modal-title{
      font-size:20px;
      font-weight:800;
      margin-bottom:16px;
      text-align:center;
    }
    .route-item{
      padding:16px;
      margin-bottom:12px;
      background:rgba(0,0,0,.2);
      border:1px solid var(--line);
      border-radius:12px;
      cursor:pointer;
      transition:all 0.2s;
    }
    .route-item:hover{
      background:rgba(0,0,0,.3);
      border-color:#00C2FF;
      transform:translateY(-2px);
    }
    .route-item-code{
      font-size:18px;
      font-weight:700;
      color:#00C2FF;
      margin-bottom:8px;
    }
    .route-item-info{
      font-size:13px;
      color:var(--muted);
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px){
      .address-panel{
        left:10px;
        right:10px;
        bottom:10px;
        max-width:none;
      }
      .route-modal-content{
        padding:20px;
      }
    }
  </style>

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=add4ce93b38c0ff9d9b9053728e067b3&autoload=false&libraries=services"></script>
</head>

<body>
<div class="container">
  <!-- í—¤ë” -->
  <div class="header">
    <div class="header-content">
      <div class="camp-info">
        <div class="camp-name" id="campName">ğŸ“ ë°°ì†¡ êµ¬ì—­ ì•ˆë‚´</div>
        <div class="camp-address">
          <span id="campAddress">ì£¼ì†Œ ì •ë³´ ë¡œë”© ì¤‘...</span>
          <button class="copy-btn" id="copyAddressBtn" style="display:none;">ğŸ“‹ ë³µì‚¬</button>
        </div>
      </div>

      <div class="navi-buttons">
        <button class="btn primary" id="naviToCampBtn">
          ğŸ§­ í˜„ì¬ìœ„ì¹˜ â†’ ìº í”„ê¹Œì§€ ê¸¸ì°¾ê¸°
        </button>

        <!-- addresses ë¡œë“œì™€ ë¬´ê´€í•˜ê²Œ í•­ìƒ ë³´ì´ë„ë¡ -->
        <button class="btn" id="naviToDeliveryBtn"
          style="background:linear-gradient(135deg, #22C55E 0%, #16A34A 100%); border-color:#22C55E; color:#fff;">
           ìº í”„ â†’ ë°°ì†¡ì§€ ì¹´ì¹´ì˜¤ì§€ë„ ì—°ë™â™ª
        </button>
      </div>
    </div>
  </div>

  <!-- ë¼ìš°íŠ¸ ì„ íƒ ëª¨ë‹¬ -->
  <div class="route-modal" id="routeModal">
    <div class="route-modal-content">
      <div class="route-modal-title" id="routeModalTitle">ë°°ì†¡ì§€ ì„ íƒ</div>
      <div id="routeList"></div>
    </div>
  </div>

  <!-- ì§€ë„ -->
  <div class="map-container">
    <div id="map"></div>

    <!-- ë¡œë”© -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div class="loading-text">ì§€ë„ ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </div>

    <!-- ë°°ì†¡ì§€ ëª©ë¡ íŒ¨ë„ -->
    <div class="address-panel" id="addressPanel">
      <div class="panel-header">ğŸ“¦ ë°°ì†¡ì§€ ëª©ë¡</div>
      <div class="address-list" id="addressList"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const API_BASE = "https://route.maroowell.com";
  const ROUTE_ENDPOINT = `${API_BASE}/route`;
  const ADDRESS_ENDPOINT = `${API_BASE}/addresses`;

  const $ = (id) => document.getElementById(id);

  function updateMetaTags(title, description) {
    document.title = title;

    let ogTitle = document.querySelector('meta[property="og:title"]');
    if (ogTitle) ogTitle.setAttribute('content', title);

    let ogDesc = document.querySelector('meta[property="og:description"]');
    if (ogDesc) ogDesc.setAttribute('content', description);

    let twitterTitle = document.querySelector('meta[name="twitter:title"]');
    if (twitterTitle) twitterTitle.setAttribute('content', title);

    let twitterDesc = document.querySelector('meta[name="twitter:description"]');
    if (twitterDesc) twitterDesc.setAttribute('content', description);
  }

  const loading = $("loading");
  const naviToCampBtn = $("naviToCampBtn");
  const naviToDeliveryBtn = $("naviToDeliveryBtn");
  const campName = $("campName");
  const campAddress = $("campAddress");
  const copyAddressBtn = $("copyAddressBtn");
  const addressPanel = $("addressPanel");
  const addressList = $("addressList");
  const routeModal = $("routeModal");
  const routeList = $("routeList");
  const routeModalTitle = $("routeModalTitle");

  let map, geocoder;
  let allRoutes = [];
  let routeData = null;
  let addressRows = [];

  const params = new URLSearchParams(location.search);
  const camp = params.get("camp") || "";
  const code = (params.get("code") || "").replace(/&.*$/,"").trim();

  const COLOR_PALETTE = [
    "#00C2FF", "#FF4D6D", "#FFD166", "#06D6A0", "#A78BFA",
    "#F97316", "#22C55E", "#E11D48", "#3B82F6", "#F59E0B"
  ];

  function hashCode(str) {
    let h = 0;
    for (let i=0;i<str.length;i++){
      h = (h<<5) - h + str.charCodeAt(i);
      h |= 0;
    }
    return Math.abs(h);
  }
  function colorFor(code) {
    return COLOR_PALETTE[hashCode(code) % COLOR_PALETTE.length];
  }

  async function apiGet(url) {
    const res = await fetch(url, { method:"GET" });
    const text = await res.text();
    let json = null;
    try { json = text ? JSON.parse(text) : null; } catch {}
    if (!res.ok) {
      const msg = json?.error || text || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return json;
  }

  function parsePolygonWgs84(v) {
    if (!v) return null;
    if (Array.isArray(v)) return v;
    if (typeof v === "string") {
      try {
        const p = JSON.parse(v);
        if (Array.isArray(p)) return p;
      } catch (e) {}
    }
    return null;
  }

  function centroidOfLatLngs(latlngs) {
    let latSum=0, lngSum=0;
    for (const ll of latlngs) {
      latSum += ll.getLat();
      lngSum += ll.getLng();
    }
    return new kakao.maps.LatLng(latSum/latlngs.length, lngSum/latlngs.length);
  }

  function createLabel(text, position, color) {
    const el = document.createElement("div");
    el.className = "route-label";
    el.style.borderColor = color;
    el.style.background = `linear-gradient(135deg, ${color}14, ${color}26)`;
    el.innerHTML = `ğŸ“¦ ${text}`;

    return new kakao.maps.CustomOverlay({
      position,
      content: el,
      yAnchor: 0.5,
      zIndex: 10
    });
  }

  // í´ë¦¬ê³¤(ë˜ëŠ” ë§)ì—ì„œ ì¢Œí‘œ ë°°ì—´({lat,lng}[]) ì¶”ì¶œ
  function extractRingLatLngs(poly) {
    if (!poly) return [];
    const first = poly[0];

    let ring = null;

    // [ {lat,lng}, ... ]
    if (first && typeof first === 'object' && 'lat' in first && 'lng' in first) {
      ring = poly;
    }
    // [ [..], [..] ] í˜•íƒœë“¤
    else if (Array.isArray(first)) {
      const firstOfFirst = first[0];

      // [ [ {lat,lng}... ], [ {lat,lng}... ] ]  => ì²« ë§
      if (firstOfFirst && typeof firstOfFirst === 'object' && 'lat' in firstOfFirst && 'lng' in firstOfFirst) {
        ring = first;
      }
      // [ [ [lng,lat], ... ], ... ] => ì²« ë§
      else if (Array.isArray(firstOfFirst) && firstOfFirst.length >= 2) {
        ring = first;
      }
      // [ [lng,lat], ... ]
      else if (typeof firstOfFirst === 'number') {
        ring = poly;
      }
    }

    if (!Array.isArray(ring)) return [];

    const latlngs = ring.map(pt => {
      // {lat,lng}
      if (pt && typeof pt === 'object' && 'lat' in pt && 'lng' in pt) {
        return { lat: Number(pt.lat), lng: Number(pt.lng) };
      }
      // [lng,lat]
      if (Array.isArray(pt) && pt.length >= 2) {
        return { lat: Number(pt[1]), lng: Number(pt[0]) };
      }
      return null;
    }).filter(v => v && isFinite(v.lat) && isFinite(v.lng));

    return latlngs;
  }

  // ì„œë¸Œë¼ìš°íŠ¸(í´ë¦¬ê³¤) ì¤‘ì‹¬ì (í‰ê· )ìœ¼ë¡œ ë°°ì†¡ì§€ ì¢Œí‘œ ëŒ€ì²´
  function centroidLatLngOfPolygonWgs84(polygon_wgs84) {
    const poly = parsePolygonWgs84(polygon_wgs84);
    if (!poly) return null;

    const ring = extractRingLatLngs(poly);
    if (!ring || ring.length < 3) return null;

    let latSum = 0, lngSum = 0;
    for (const p of ring) {
      latSum += p.lat;
      lngSum += p.lng;
    }
    return { lat: latSum / ring.length, lng: lngSum / ring.length };
  }

  function drawPolygons(rows) {
    if (!rows || rows.length === 0) return;

    const bounds = new kakao.maps.LatLngBounds();
    let hasPolygon = false;

    for (const row of rows) {
      const fullCode = row.full_code || row.code || "";
      const color = row.color || colorFor(fullCode);
      const poly = parsePolygonWgs84(row.polygon_wgs84);

      if (!poly || !Array.isArray(poly) || poly.length === 0) continue;

      let rings = [];
      const first = poly[0];

      if (first && typeof first === 'object' && 'lat' in first && 'lng' in first) {
        rings = [poly];
      } else if (Array.isArray(first)) {
        const firstOfFirst = first[0];
        if (firstOfFirst && typeof firstOfFirst === 'object' && 'lat' in firstOfFirst && 'lng' in firstOfFirst) {
          rings = poly;
        } else if (Array.isArray(firstOfFirst) && firstOfFirst.length >= 2) {
          rings = poly;
        } else if (typeof firstOfFirst === 'number') {
          rings = [poly];
        }
      }

      for (const ring of rings) {
        if (!Array.isArray(ring) || ring.length < 3) continue;

        const latlngs = ring.map(pt => {
          if (pt && typeof pt === 'object' && 'lat' in pt && 'lng' in pt) {
            return new kakao.maps.LatLng(pt.lat, pt.lng);
          } else if (Array.isArray(pt) && pt.length >= 2) {
            return new kakao.maps.LatLng(pt[1], pt[0]);
          }
          return null;
        }).filter(ll => ll !== null);

        if (latlngs.length < 3) continue;

        const polygon = new kakao.maps.Polygon({
          path: latlngs,
          strokeWeight: 5,
          strokeColor: color,
          strokeOpacity: 1.0,
          strokeStyle: "solid",
          fillColor: color,
          fillOpacity: 0.20,
          zIndex: 1
        });
        polygon.setMap(map);

        const center = centroidOfLatLngs(latlngs);
        const label = createLabel(fullCode, center, color);
        label.setMap(map);

        latlngs.forEach(ll => bounds.extend(ll));
        hasPolygon = true;
      }
    }

    if (hasPolygon) {
      map.setBounds(bounds);
    }
  }

  function renderAddressList() {
    if (!addressRows || addressRows.length === 0) {
      addressPanel.classList.remove("visible");
      return;
    }

    addressPanel.classList.add("visible");
    addressList.innerHTML = "";

    addressRows.forEach((addr, idx) => {
      const item = document.createElement("div");
      item.className = "address-item";

      const addressText = addr.address || addr.full_address || "ì£¼ì†Œ ì—†ìŒ";
      const dong = addr.dong ? `(${addr.dong})` : "";
      const zipcode = addr.zipcode ? `ìš°í¸ë²ˆí˜¸: ${addr.zipcode}` : "";

      item.innerHTML = `
        <div class="address-info">
          <div class="address-text">${idx + 1}. ${addressText} ${dong}</div>
          <div class="address-meta">${zipcode}</div>
        </div>
        <button class="btn">ğŸš— ê¸¸ì°¾ê¸°</button>
      `;

      const btn = item.querySelector("button");
      btn.onclick = () => openNaviToAddress(addr);

      addressList.appendChild(item);
    });
  }

  routeModal.onclick = (e) => {
    if (e.target === routeModal) {
      routeModal.classList.remove("visible");
    }
  };

  // Promise ê¸°ë°˜ ì§€ì˜¤ì½”ë”©
  function geocodeAsync(address) {
    return new Promise((resolve, reject) => {
      geocoder.addressSearch(address, (result, status) => {
        if (status !== kakao.maps.services.Status.OK || !result?.length) {
          reject(new Error("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
          return;
        }
        resolve({ lat: Number(result[0].y), lng: Number(result[0].x) });
      });
    });
  }

  // ìº í”„(ì…ì°¨ì§€) ì¢Œí‘œ ê°€ì ¸ì˜¤ê¸°: (1) lat/lng í•„ë“œ ìˆìœ¼ë©´ ì‚¬ìš© (2) ì£¼ì†Œ ì§€ì˜¤ì½”ë”©
  async function getCampLatLng() {
    if (!routeData) throw new Error("ìº í”„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

    const lat =
      Number(routeData.delivery_location_lat ?? routeData.delivery_lat ?? routeData.lat ?? routeData.y);
    const lng =
      Number(routeData.delivery_location_lng ?? routeData.delivery_lng ?? routeData.lng ?? routeData.x);

    if (isFinite(lat) && isFinite(lng)) return { lat, lng };

    const addr = routeData.delivery_location_address;
    if (!addr) throw new Error("ìº í”„ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
    return await geocodeAsync(addr);
  }

  function openKakaoRoute({ sp, ep, spName, epName }) {
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    if (isMobile) {
      // ëª¨ë°”ì¼: kakaomap://route
      let url = `kakaomap://route?by=CAR`;
      if (sp) url += `&sp=${sp.lat},${sp.lng}`;
      if (ep) url += `&ep=${ep.lat},${ep.lng}`;
      window.location.href = url;
      return;
    }

    // PC: ë§í¬
    if (sp && ep) {
      const url =
        `https://map.kakao.com/link/from/${encodeURIComponent(spName || "ì¶œë°œ")},${sp.lat},${sp.lng}` +
        `/to/${encodeURIComponent(epName || "ë„ì°©")},${ep.lat},${ep.lng}`;
      window.open(url, "_blank");
    } else if (ep) {
      const url =
        `https://map.kakao.com/link/to/${encodeURIComponent(epName || "ëª©ì ì§€")},${ep.lat},${ep.lng}`;
      window.open(url, "_blank");
    }
  }

  // ìƒë‹¨ ë²„íŠ¼: í˜„ì¬ìœ„ì¹˜ -> ìº í”„(ì…ì°¨ì§€) : ëª¨ë‹¬ ì—†ì´ ë°”ë¡œ
  async function openNaviCurrentToCamp() {
    try {
      const campLatLng = await getCampLatLng();
      const epName = routeData?.delivery_location_name || camp || "ìº í”„";
      openKakaoRoute({ ep: campLatLng, epName });
    } catch (e) {
      alert("ìº í”„ ê¸¸ì°¾ê¸° ì‹¤íŒ¨: " + e.message);
    }
  }

  // í•˜ë‹¨ ë²„íŠ¼: ìº í”„ -> ì„œë¸Œë¼ìš°íŠ¸ ë°°ì†¡ì§€(ì¢Œí‘œ) ì„ íƒ ëª¨ë‹¬
  function showSubrouteModalForDelivery() {
    if (!allRoutes || allRoutes.length === 0) {
      alert("ë¼ìš°íŠ¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    // 1ê°œë©´ ë°”ë¡œ ì‹¤í–‰
    if (allRoutes.length === 1) {
      openNaviCampToSubroute(allRoutes[0]);
      return;
    }

    routeModalTitle.textContent = "ë°°ì†¡ì§€ ì„ íƒ(ì„œë¸Œë¼ìš°íŠ¸)";
    routeList.innerHTML = "";

    allRoutes.forEach((r, idx) => {
      const item = document.createElement("div");
      item.className = "route-item";

      const routeCode = r.full_code || r.code || `ì„œë¸Œë¼ìš°íŠ¸ ${idx + 1}`;
      const info1 = "ìº í”„ â†’ ì„ íƒ êµ¬ì—­ ì¤‘ì‹¬(ì¢Œí‘œ) ê¸¸ì°¾ê¸°";

      item.innerHTML = `
        <div class="route-item-code">${routeCode}</div>
        <div class="route-item-info">${info1}</div>
      `;

      item.onclick = () => {
        routeModal.classList.remove("visible");
        openNaviCampToSubroute(r);
      };

      routeList.appendChild(item);
    });

    routeModal.classList.add("visible");
  }

  // ìº í”„ -> ì„œë¸Œë¼ìš°íŠ¸(ë°°ì†¡ì§€ ì¢Œí‘œ) ê¸¸ì°¾ê¸°
  async function openNaviCampToSubroute(route) {
    try {
      const sp = await getCampLatLng();
      const spName = routeData?.delivery_location_name || camp || "ìº í”„";

      // (1) ì„œë¸Œë¼ìš°íŠ¸ ìì²´ì— ì¢Œí‘œ í•„ë“œê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
      const lat =
        Number(route.delivery_lat ?? route.delivery_location_lat ?? route.lat ?? route.y);
      const lng =
        Number(route.delivery_lng ?? route.delivery_location_lng ?? route.lng ?? route.x);

      let ep = null;
      if (isFinite(lat) && isFinite(lng)) {
        ep = { lat, lng };
      } else {
        // (2) ì—†ìœ¼ë©´ í´ë¦¬ê³¤ ì¤‘ì‹¬ì ìœ¼ë¡œ ëŒ€ì²´
        ep = centroidLatLngOfPolygonWgs84(route.polygon_wgs84);
      }

      if (!ep) throw new Error("ì„œë¸Œë¼ìš°íŠ¸ ë°°ì†¡ì§€ ì¢Œí‘œë¥¼ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

      const epName = route.full_code || route.code || "ë°°ì†¡ì§€";
      openKakaoRoute({ sp, ep, spName, epName });
    } catch (e) {
      alert("ë°°ì†¡ì§€ ì—°ë™ ì‹¤íŒ¨: " + e.message);
    }
  }

  // ì£¼ì†Œ(íŒ¨ë„)ì—ì„œ ìº í”„->ì£¼ì†Œ ê¸¸ì°¾ê¸° (ì¢Œí‘œ ìˆìœ¼ë©´ ì¢Œí‘œ ìš°ì„ , ì—†ìœ¼ë©´ ì§€ì˜¤ì½”ë”©)
  function openNaviToAddress(addr) {
    if (!routeData) {
      alert("ìº í”„ ë°ì´í„° ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.");
      return;
    }

    const addressText = addr.address || addr.full_address;

    const endLat = Number(addr.lat ?? addr.latitude ?? addr.y);
    const endLng = Number(addr.lng ?? addr.longitude ?? addr.x);

    (async () => {
      try {
        const sp = await getCampLatLng();
        const spName = routeData?.delivery_location_name || camp || "ìº í”„";

        // ì£¼ì†Œ rowì— ì¢Œí‘œê°€ ìˆìœ¼ë©´ ë°”ë¡œ ì‚¬ìš©
        if (isFinite(endLat) && isFinite(endLng)) {
          openKakaoRoute({
            sp,
            ep: { lat: endLat, lng: endLng },
            spName,
            epName: addressText || "ë°°ì†¡ì§€"
          });
          return;
        }

        // ì—†ìœ¼ë©´ ê¸°ì¡´ì²˜ëŸ¼ ì£¼ì†Œ ì§€ì˜¤ì½”ë”©
        if (!addressText) throw new Error("ë°°ì†¡ì§€ ì£¼ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        const ep = await geocodeAsync(addressText);

        openKakaoRoute({
          sp,
          ep,
          spName,
          epName: addressText
        });
      } catch (e) {
        alert("ê¸¸ì°¾ê¸° ì‹¤íŒ¨: " + e.message);
      }
    })();
  }

  async function loadData() {
    try {
      if (!camp) throw new Error("ìº í”„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. (camp íŒŒë¼ë¯¸í„° í•„ìš”)");/* route ë¡œë“œ */
const codes = code ? code.split(/[,\s]+/).map(s => s.trim()).filter(Boolean) : [];

const fetchRoutes = async (singleCode) => {
  const u = new URL(ROUTE_ENDPOINT);
  u.searchParams.set("camp", camp);
  u.searchParams.set("mode", "prefix");
  if (singleCode) u.searchParams.set("code", singleCode);
  const d = await apiGet(u.toString());
  return d?.rows || [];
};

let rows = [];
if (codes.length <= 1) {
  rows = await fetchRoutes(codes[0] || "");
} else {
  for (const c of codes) {
    const part = await fetchRoutes(c);
    if (part && part.length) rows.push(...part);
  }
  // ì¤‘ë³µ ì œê±° (id ìš°ì„ )
  const seen = new Set();
  rows = rows.filter(r => {
    const k = (r && r.id != null) ? String(r.id) : `${r?.camp||""}/${r?.full_code||r?.code||""}`;
    if (seen.has(k)) return false;
    seen.add(k);
    return true;
  });
}

if (!rows.length) throw new Error("ë¼ìš°íŠ¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

allRoutes = rows;
routeData = rows[0];

      const displayName = routeData.delivery_location_name || "ìº í”„";
      const displayAddress = routeData.delivery_location_address || "ì£¼ì†Œ ì •ë³´ ì—†ìŒ";
      const displayCode = code || (allRoutes.length === 1 ? (allRoutes[0].full_code || allRoutes[0].code || "") : "");

      campName.textContent = `ğŸ“ ${camp} ${displayName}`;
      campAddress.textContent = displayAddress;

      let pageTitle = `${camp} ${displayName}`;
      if (displayCode) pageTitle += ` ${displayCode}`;
      const pageDescription = `${pageTitle} ë°°ì†¡ êµ¬ì—­ì„ í™•ì¸í•˜ì„¸ìš”`;
      updateMetaTags(pageTitle, pageDescription);

      if (displayAddress && displayAddress !== "ì£¼ì†Œ ì •ë³´ ì—†ìŒ") {
        copyAddressBtn.style.display = "inline-block";
      }

      drawPolygons(allRoutes);

      /* addresses ë¡œë“œ (íŒ¨ë„ ìš©ë„: ì‹¤íŒ¨í•´ë„ ì „ì²´ëŠ” ì •ìƒ) */
      try {const codes = code ? code.split(/[,\s]+/).map(s => s.trim()).filter(Boolean) : [];
let merged = [];

const fetchAddrs = async (singleCode) => {
  const au = new URL(ADDRESS_ENDPOINT);
  au.searchParams.set("camp", camp);
  if (singleCode) {
    au.searchParams.set("code", singleCode);
    au.searchParams.set("mode", "prefix");
  }
  const ad = await apiGet(au.toString());
  return ad?.rows || [];
};

if (codes.length <= 1) {
  merged = await fetchAddrs(codes[0] || "");
} else {
  for (const c of codes) {
    const part = await fetchAddrs(c);
    if (part && part.length) merged.push(...part);
  }
  // ì¤‘ë³µ ì œê±° (id ìš°ì„ )
  const seen = new Set();
  merged = merged.filter(r => {
    const k = (r && r.id != null) ? String(r.id) : (r?.address || r?.full_address || JSON.stringify(r));
    if (seen.has(k)) return false;
    seen.add(k);
    return true;
  });
}

addressRows = merged;
renderAddressList();
      } catch (addrErr) {
        console.warn("ë°°ì†¡ì§€ ë¡œë“œ ì‹¤íŒ¨(íŒ¨ë„):", addrErr);
      }

      loading.style.display = "none";

    } catch (err) {
      console.error(err);
      loading.innerHTML = `
        <div style="text-align:center; color:#FF4D6D;">
          <div style="font-size:48px; margin-bottom:16px;">âš ï¸</div>
          <div style="font-size:16px; font-weight:700; margin-bottom:8px;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>
          <div style="font-size:13px; color:var(--muted);">${err.message}</div>
        </div>
      `;
    }
  }

  function init() {
    kakao.maps.load(() => {
      const center = new kakao.maps.LatLng(37.5665, 126.978);
      map = new kakao.maps.Map($("map"), {
        center,
        level: 8,
        draggable: true,
        scrollwheel: true,
        disableDoubleClickZoom: false
      });
      geocoder = new kakao.maps.services.Geocoder();

      const zoomControl = new kakao.maps.ZoomControl();
      map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

      // í•µì‹¬ ë³€ê²½:
      // ìƒë‹¨ ë²„íŠ¼ = ë°”ë¡œ ìº í”„ ê¸¸ì°¾ê¸°
      naviToCampBtn.onclick = () => {
        if (!routeData) return alert("ë°ì´í„° ë¡œë”© ì¤‘...");
        openNaviCurrentToCamp();
      };

      // í•˜ë‹¨ ë²„íŠ¼ = ì„œë¸Œë¼ìš°íŠ¸(ë°°ì†¡ì§€) ì„ íƒ ëª¨ë‹¬
      naviToDeliveryBtn.onclick = () => {
        if (!routeData) return alert("ë°ì´í„° ë¡œë”© ì¤‘...");
        showSubrouteModalForDelivery();
      };

      copyAddressBtn.onclick = () => {
        const address = campAddress.textContent;
        navigator.clipboard.writeText(address).then(() => {
          const originalText = copyAddressBtn.textContent;
          copyAddressBtn.textContent = "âœ“ ë³µì‚¬ë¨";
          setTimeout(() => { copyAddressBtn.textContent = originalText; }, 2000);
        }).catch(err => {
          alert("ë³µì‚¬ ì‹¤íŒ¨: " + err.message);
        });
      };

      loadData();
    });
  }

  init();
})();
</script>
</body>
</html>
