<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>마루웰 라우트 편집기 · Kakao Map + Supabase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      overflow: hidden;
    }

    .layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      height: 100%;
    }
    @media (max-width: 960px) {
      .layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
    }

    .side {
      padding: 18px 18px 12px;
      background: #020617;
      border-right: 1px solid #111827;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    @media (max-width: 960px) {
      .side {
        border-right: none;
        border-bottom: 1px solid #111827;
      }
    }

    .side-header-title {
      font-size: 15px;
      font-weight: 700;
    }
    .side-header-sub {
      margin-top: 2px;
      font-size: 11px;
      color: #9ca3af;
    }

    label {
      display: block;
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .field {
      margin-top: 8px;
    }

    input[type="text"] {
      width: 100%;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
    }
    input[type="text"]::placeholder {
      color: #4b5563;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    button {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }
    button.primary {
      background: #111827;
      border-color: #111827;
    }
    button.danger {
      border-color: #7f1d1d;
      color: #fecaca;
    }
    button:hover {
      background: #111827;
    }

    .hint {
      margin-top: 4px;
      font-size: 11px;
      color: #6b7280;
      line-height: 1.5;
    }

    .log {
      margin-top: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      background: #020617;
      border: 1px solid #111827;
      font-size: 11px;
      color: #9ca3af;
      height: 110px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .map-wrap {
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
    }

    .badge-api {
      position: absolute;
      top: 10px;
      right: 12px;
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      border: 1px solid #1e293b;
      color: #9ca3af;
    }
    .badge-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-right: 4px;
      background: #22c55e;
    }
  </style>

  <!-- proj4 (WGS84 <-> EPSG:5179 변환용) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.1/proj4.min.js"></script>

  <!-- Kakao Maps + Drawing 라이브러리 -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=add4ce93b38c0ff9d9b9053728e067b3&libraries=drawing&autoload=false"></script>
</head>
<body>
  <div class="layout">
    <aside class="side">
      <div>
        <div class="side-header-title">마루웰 라우트 편집기</div>
        <div class="side-header-sub">캠프 + 라우트 코드 기반 · Supabase / Cloudflare route-api 사용</div>
      </div>

      <div class="field">
        <label for="campInput">캠프 이름 (예: 일산2)</label>
        <input id="campInput" type="text" placeholder="예: 일산2" />
      </div>

      <div class="field">
        <label for="routeInput">라우트 코드 (예: 126B, 126B01)</label>
        <input id="routeInput" type="text" placeholder="예: 126B 또는 126B01" />
      </div>

      <div class="btn-row">
        <button id="loadBtn" class="primary">불러오기(GET)</button>
        <button id="drawBtn">새로 그리기</button>
        <button id="saveBtn">저장(POST)</button>
        <button id="resetBtn" class="danger">지도 초기화</button>
      </div>

      <div class="hint">
        · <b>캠프 + 라우트</b>는 둘 다 필수입니다.<br/>
        · <b>불러오기</b>는 <code>mode=prefix</code>로 호출합니다. 예) 126B → 126B01, 126B02 전부 조회.<br/>
        · <b>저장</b>은 [새로 그리기] 이후 그린 폴리곤만 저장합니다. (최소 꼭짓점 3개 이상)<br/>
        · 저장 시 <code>polygon5179 / polygon_wgs84 / center5179 / center_wgs84</code>를 Supabase에 업서트.
      </div>

      <div id="log" class="log"></div>
    </aside>

    <div class="map-wrap">
      <div id="map"></div>
      <div class="badge-api">
        <span class="badge-dot"></span>route-api · https://route.maroowell.com/route
      </div>
    </div>
  </div>

  <script>
    // ---------- 공통 유틸 ----------
    const API_BASE = "https://route.maroowell.com";

    const $ = (sel) => document.querySelector(sel);
    const logBox = $("#log");
    function log(msg, obj) {
      const t = new Date();
      const ts = t.toTimeString().slice(0, 8);
      logBox.textContent += `[${ts}] ${msg}\n`;
      if (obj) {
        logBox.textContent += "  " + JSON.stringify(obj, null, 2) + "\n";
      }
      logBox.scrollTop = logBox.scrollHeight;
    }

    function alertAndLog(msg) {
      alert(msg);
      log(msg);
    }

    // ---------- proj4 좌표계 정의 ----------
    proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");
    proj4.defs(
      "EPSG:5179",
      "+proj=tmerc +lat_0=38 +lon_0=127.5 +k=0.9996 " +
      "+x_0=1000000 +y_0=2000000 +ellps=GRS80 +units=m +no_defs"
    );

    function wgs84To5179(lng, lat) {
      return proj4("EPSG:4326", "EPSG:5179", [lng, lat]);
    }
    function t5179ToWgs84(x, y) {
      return proj4("EPSG:5179", "EPSG:4326", [x, y]);
    }

    // ---------- 전역 상태 ----------
    const state = {
      map: null,
      drawingManager: null,
      drawnPolygons: [],   // 새로 그린 폴리곤 (저장 대상)
      loadedPolygons: []   // GET으로 불러온 폴리곤
    };

    // path 가 kakao LatLngList 이든 배열이든, {lat,lng} 배열로 변환
    function pathToLatLngArray(path) {
      const out = [];
      if (!path) return out;

      if (typeof path.getLength === "function" && typeof path.getAt === "function") {
        for (let i = 0; i < path.getLength(); i++) {
          const p = path.getAt(i);
          out.push({ lat: p.getLat(), lng: p.getLng() });
        }
      } else if (Array.isArray(path)) {
        path.forEach((p) => {
          if (!p) return;
          if (typeof p.getLat === "function" && typeof p.getLng === "function") {
            out.push({ lat: p.getLat(), lng: p.getLng() });
          } else if ("lat" in p && "lng" in p) {
            out.push({ lat: p.lat, lng: p.lng });
          }
        });
      }
      return out;
    }

    function latLngArrayToPath(arr) {
      return arr.map((p) => new kakao.maps.LatLng(p.lat, p.lng));
    }

    function calcCenterOfLatLngArray(arr) {
      if (!arr.length) return null;
      let sx = 0, sy = 0;
      arr.forEach((p) => { sx += p.lng; sy += p.lat; });
      const lng = sx / arr.length;
      const lat = sy / arr.length;
      return { lat, lng };
    }

    function clearDrawnPolygons() {
      state.drawnPolygons.forEach((p) => p.setMap(null));
      state.drawnPolygons = [];
    }
    function clearLoadedPolygons() {
      state.loadedPolygons.forEach((p) => p.setMap(null));
      state.loadedPolygons = [];
    }
    function clearAllPolygons() {
      clearDrawnPolygons();
      clearLoadedPolygons();
    }

    function fitMapToAllPolygons() {
      const bounds = new kakao.maps.LatLngBounds();
      let has = false;

      const collect = (poly) => {
        const path = poly.getPath();
        const pts = pathToLatLngArray(path);
        pts.forEach(({ lat, lng }) => {
          bounds.extend(new kakao.maps.LatLng(lat, lng));
          has = true;
        });
      };

      state.loadedPolygons.forEach(collect);
      state.drawnPolygons.forEach(collect);

      if (has) {
        state.map.setBounds(bounds);
      }
    }

    // ---------- Kakao 지도 & Drawing 초기화 ----------
    kakao.maps.load(() => {
      const container = document.getElementById("map");
      state.map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 7
      });

      state.drawingManager = new kakao.maps.drawing.DrawingManager({
        map: state.map,
        drawingMode: [],
        polygonOptions: {
          draggable: true,
          editable: true,
          strokeWeight: 3,
          strokeColor: "#22c55e",
          strokeOpacity: 0.9,
          fillColor: "#22c55e",
          fillOpacity: 0.35
        }
      });

      // 폴리곤 그리기 끝났을 때
      kakao.maps.event.addListener(state.drawingManager, "drawend", function (data) {
        const overlay = data && (data.target || data.overlay);
        if (!overlay || typeof overlay.getPath !== "function") {
          console.warn("drawend: overlay 없음 또는 getPath 없음", data);
          alert("폴리곤 생성 중 오류가 발생했습니다. 다시 그려주세요.");
          return;
        }
        state.drawnPolygons.push(overlay);
        const path = pathToLatLngArray(overlay.getPath());
        log(`drawend: 폴리곤 ${state.drawnPolygons.length}개, 점 ${path.length}개`);
      });

      // 리사이즈 대응
      window.addEventListener("resize", () => {
        const center = state.map.getCenter();
        state.map.relayout();
        state.map.setCenter(center);
      });

      // 버튼 이벤트 바인딩
      $("#loadBtn").onclick  = onClickLoad;
      $("#drawBtn").onclick  = onClickDrawNew;
      $("#saveBtn").onclick  = onClickSave;
      $("#resetBtn").onclick = onClickReset;

      log("지도 초기화 완료");
    });

    // ---------- 버튼 핸들러 ----------

    async function onClickLoad() {
      const camp  = $("#campInput").value.trim();
      const code  = $("#routeInput").value.trim();

      if (!camp || !code) {
        return alertAndLog("캠프 이름과 라우트 코드를 모두 입력해주세요.");
      }

      clearAllPolygons();

      const qs = new URLSearchParams({
        camp,
        code,
        mode: "prefix"   // 126B → 126B01, 126B02 ...
      });

      const url = `${API_BASE}/route?${qs.toString()}`;
      log(`GET ${url}`);

      try {
        const res = await fetch(url, { method: "GET" });
        const json = await res.json();
        log(`GET /route 응답 (${res.status})`, json);

        if (!json.rows || !json.rows.length) {
          alert("해당 캠프/라우트에 저장된 폴리곤이 없습니다.");
          return;
        }

        json.rows.forEach((row) => {
          // polygon5179 또는 polygon_wgs84 중 있는 쪽 사용
          const poly5179 = row.polygon5179 || [];
          const polyWgs  = row.polygon_wgs84 || [];

          let ringsWgs = [];

          if (polyWgs.length) {
            // 이미 WGS84로 저장되어 있는 경우
            ringsWgs = polyWgs;
          } else if (poly5179.length) {
            // 5179 → WGS84 변환
            ringsWgs = poly5179.map((ring) =>
              ring.map(([x, y]) => {
                const [lng, lat] = t5179ToWgs84(x, y);
                return { lat, lng };
              })
            );
          }

          ringsWgs.forEach((ring) => {
            if (!ring.length) return;
            const path = latLngArrayToPath(ring);
            const poly = new kakao.maps.Polygon({
              map: state.map,
              path,
              strokeWeight: 3,
              strokeColor: "#60a5fa",
              strokeOpacity: 0.9,
              fillColor: "#60a5fa",
              fillOpacity: 0.25
            });
            state.loadedPolygons.push(poly);
          });
        });

        if (!state.loadedPolygons.length) {
          alert("서버에 폴리곤 데이터가 있으나, 좌표가 비어 있습니다.");
        }

        fitMapToAllPolygons();
      } catch (err) {
        console.error(err);
        alertAndLog("GET /route 호출 중 오류가 발생했습니다.");
      }
    }

    function onClickDrawNew() {
      // 기존 편집용 폴리곤만 제거
      clearDrawnPolygons();

      // Drawing 모드 폴리곤 선택
      state.drawingManager.cancel();
      state.drawingManager.select(kakao.maps.drawing.OverlayType.POLYGON);

      log("새로 그리기: 기존 편집용 폴리곤 제거 및 DRAW 모드 진입");
      alert("지도 위에 여러 개의 폴리곤을 그릴 수 있습니다.\n그리기 완료 후 [저장(POST)]를 눌러주세요.");
    }

    function onClickReset() {
      clearAllPolygons();
      state.drawingManager.cancel();
      state.map.setCenter(new kakao.maps.LatLng(37.5665, 126.9780));
      state.map.setLevel(7);
      log("지도 초기화 완료");
    }

    async function onClickSave() {
      const camp = $("#campInput").value.trim();
      const code = $("#routeInput").value.trim();

      if (!camp || !code) {
        return alertAndLog("캠프 이름과 라우트 코드를 모두 입력해주세요.");
      }

      if (!state.drawnPolygons.length) {
        return alertAndLog("저장할 폴리곤이 없습니다. [새로 그리기]로 영역을 그려주세요.");
      }

      // 폴리곤 -> 좌표 배열
      const polygonsWgs = state.drawnPolygons.map((poly) =>
        pathToLatLngArray(poly.getPath())
      ).filter((ring) => ring.length >= 3);

      if (!polygonsWgs.length) {
        return alertAndLog("폴리곤 정점이 너무 적습니다. 최소 3개 이상 찍어주세요.");
      }

      // WGS84 → 5179 변환
      const polygons5179 = polygonsWgs.map((ring) =>
        ring.map(({ lat, lng }) => {
          const [x, y] = wgs84To5179(lng, lat);
          return [x, y];
        })
      );

      // 중심점 계산
      const centersWgs = polygonsWgs.map(calcCenterOfLatLngArray).filter(Boolean);
      const centerWgs = centersWgs[0] || calcCenterOfLatLngArray(polygonsWgs[0]);
      let center5179 = null;
      if (centerWgs) {
        const [cx, cy] = wgs84To5179(centerWgs.lng, centerWgs.lat);
        center5179 = [cx, cy];
      }

      const payload = {
        camp,
        code,
        polygon5179: [polygons5179[0]],  // 1개 ring 기준 (필요 시 확장)
        polygon_wgs84: [polygonsWgs[0]],
        center5179,
        center_wgs84: centerWgs
      };

      const url = `${API_BASE}/route`;
      log(`POST ${url}`, payload);

      try {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        log(`POST /route 응답 (${res.status})`, json);

        if (res.ok) {
          alert("라우트 폴리곤이 저장되었습니다.");
        } else {
          alert("저장 중 오류가 발생했습니다. 콘솔 로그를 확인하세요.");
        }
      } catch (err) {
        console.error(err);
        alertAndLog("POST /route 호출 중 오류가 발생했습니다.");
      }
    }
  </script>
</body>
</html>
