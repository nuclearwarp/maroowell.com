<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="referrer" content="origin" />
  <title>ë§ˆë£¨ì›° ë¼ìš°íŠ¸ í¸ì§‘ê¸°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico?v=2" />

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2d;
      --panel2:#0c1627;
      --txt:#e6eefc;
      --muted:#93a4c7;
      --line:rgba(255,255,255,.08);
      --btn:#162744;
      --btn2:#1a2f55;
      --danger:#6b1b1b;
      --ok:#1a5a3a;
      --warn:#6a4b13;
      --overlay:rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif; background:#0a0f1a;}
    .wrap{display:flex; height:100%;}
    .left{
      width:360px; min-width:340px; max-width:420px;
      background:linear-gradient(180deg,var(--bg),#070b13);
      color:var(--txt);
      border-right:1px solid var(--line);
      padding:14px 14px 10px 14px;
      overflow:auto;
    }
    .title{font-size:18px; font-weight:800; letter-spacing:.2px; margin:2px 0 10px; display:flex; align-items:center; gap:6px;}
    .subtitle{font-size:12px; color:var(--muted); margin:-6px 0 14px;}
    .group{background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:12px; padding:10px; margin:10px 0;}
    .label{font-size:12px; color:var(--muted); margin:6px 0 6px;}
    .label.sectionTitle{ text-align:center; font-weight:900; letter-spacing:.2px; }
    input[type="text"]{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--txt);
      outline:none;
    }
    input[type="text"]:focus{border-color:rgba(255,255,255,.25)}
    .row{display:flex; gap:8px; align-items:center;}
    .row > *{flex:1}
    .btn{
      padding:10px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--txt);
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      white-space:nowrap;
    }
    .btn:hover{background:var(--btn2)}
    .btn.danger{background:rgba(107,27,27,.35); border-color:rgba(255,60,60,.22)}
    .btn.danger:hover{background:rgba(107,27,27,.55)}
    .btn.ok{background:rgba(26,90,58,.35); border-color:rgba(0,255,140,.18)}
    .btn.ok:hover{background:rgba(26,90,58,.55)}
    .btn.warn{background:rgba(106,75,19,.35); border-color:rgba(255,180,0,.18)}
    .btn.warn:hover{background:rgba(106,75,19,.55)}
    /* âœ… ë²¤ë”(ì£¼ê°„/ì•¼ê°„) í‘œì‹œ */
    .kv{
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      padding:6px 10px; /* â¬… ì¹¸ í¬ê¸° ì†Œí­ ì¶•ì†Œ */
    }
    .kvRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:0;
      min-height:40px; /* ë²¤ë” ì •ë³´ ë¼ì¸ ìˆ˜ì§ ì¤‘ì•™ ê³ ì • */
    }
    .kvRow + .kvRow{border-top:1px solid var(--line);}
    .kvLabel{
      display:flex;
      align-items:center;
      flex:0 0 92px;
      height:40px;
      font-size:12px;
      color:rgba(230,238,252,.72);
      white-space:nowrap;
      line-height:1;
    }
    .kvValue{
      display:flex;
      align-items:center;
      flex:1 1 auto;
      justify-content:flex-end;
      height:40px;
      font-size:13px;
      font-weight:900;
      color:rgba(255,255,255,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      line-height:1;
      text-align:right;
    }
    .kvValue.empty{
      color:rgba(230,238,252,.45);
      font-weight:800;
    }

    /* âœ… ë²¤ë” ì„ íƒ/1WÂ·2W ì„ íƒ ëª¨ë‹¬ */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      backdrop-filter: blur(2px);
    }
    .modalCard{
      width:min(720px, calc(100% - 40px));
      max-height:min(720px, calc(100% - 40px));
      background:linear-gradient(180deg, rgba(15,26,45,.96), rgba(8,14,26,.96));
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      box-shadow:0 22px 80px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalTop{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .modalTitle{
      font-weight:900;
      color:#eaf2ff;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .modalTop .miniBtn{
      height:36px;
      padding:0 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:#fff;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }
    .modalTop .miniBtn:hover{background:rgba(0,0,0,.35)}
    .modalBody{
      flex:1;
      overflow:auto;
      padding:12px 14px;
    }
    .modalMeta{
      padding:10px 14px;
      color:rgba(230,238,252,.70);
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .waveGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      padding:14px;
    }
    .waveBtn{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      color:#fff;
      cursor:pointer;
      padding:14px 12px;
      text-align:left;
      font-weight:900;
    }
    .waveBtn:hover{background:rgba(0,0,0,.30)}
    .waveBtn .sub{
      display:block;
      margin-top:6px;
      color:rgba(230,238,252,.70);
      font-size:12px;
      font-weight:800;
    }
    .logWrap{
      border-radius:12px;
      border:1px solid var(--line);
      overflow:hidden;
      background:rgba(0,0,0,.25);
      margin-top:10px;
    }
    .logHeader{
      padding:8px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
      font-size:12px; color:var(--muted);
    }
    .log{
      height:170px;
      overflow:auto;
      padding:8px 10px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      white-space:pre-wrap;
      color:#d9e5ff;
    }
    .pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      font-size:12px;
      color:var(--muted);
    }
    .map{flex:1; position:relative;}

    /* âœ… mapWrap/roadview (index.html ìŠ¤íƒ€ì¼ ì´ì‹) */
    #mapWrap{
      position:absolute;
      inset:0;
      display:flex;
      min-width:0;
      min-height:0;
    }
    #map,#roadview{
      flex:1;
      width:100%;
      height:100%;
      min-width:0;
      min-height:0;
    }
    #roadview{display:none;}
    #mapWrap.roadview-open #roadview{display:block;}

    .map-controls{
      position:absolute;
      top:10px;
      right:10px;
      z-index:25;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      pointer-events:auto;
    }
    .map-controls button{
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      backdrop-filter: blur(6px);
    }
    .map-controls button:hover{
      background:rgba(0,0,0,.68);
      border-color:rgba(255,255,255,.22);
    }
    .map-controls .hint{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.55);
      color:#cbd5e1;
      font-size:12px;
      display:none;
    }

    .floatingHint{
      position:absolute;
      top:10px; left:10px;
      background:rgba(0,0,0,.55);
      color:#fff;
      border:1px solid rgba(255,255,255,.14);
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
      max-width:520px;
      display:none;
      z-index:20;
      pointer-events:none;
    }
    .sep{height:1px; background:var(--line); margin:10px 0;}
    .small{font-size:11px; color:var(--muted);}

    /* âœ… ì¹´ì¹´ì˜¤ì§€ë„ ìŠ¤íƒ€ì¼ ê²€ìƒ‰ ëª¨ë‹¬ */
    .searchModal{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.20);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      backdrop-filter: blur(2px);
    }
    .searchCard{
      width:min(860px, calc(100% - 40px));
      height:min(680px, calc(100% - 40px));
      background:linear-gradient(180deg, rgba(15,26,45,.96), rgba(8,14,26,.96));
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      box-shadow:0 22px 80px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .searchTop{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .searchTopTitle{
      font-weight:900;
      color:#eaf2ff;
      letter-spacing:.2px;
      margin-right:4px;
      white-space:nowrap;
    }
    .searchInput{
      flex:1;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .searchInput input{
      flex:1;
      height:40px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:#eaf2ff;
      padding:0 12px;
      outline:none;
    }
    .searchInput input:focus{border-color:rgba(255,255,255,.25)}
    .searchTop .miniBtn{
      height:40px;
      padding:0 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:#fff;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }
    .searchTop .miniBtn:hover{background:rgba(0,0,0,.35)}
    .searchMeta{
      padding:10px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      color:rgba(230,238,252,.80);
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .searchBody{
      flex:1;
      overflow:auto;
      padding:12px 14px;
    }
    .sectionTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:10px 0 8px;
      color:#eaf2ff;
      font-weight:900;
      letter-spacing:.2px;
    }
    .sectionTitle .count{
      font-size:12px;
      color:rgba(230,238,252,.65);
      font-weight:800;
    }
    .resultCard{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      border-radius:14px;
      padding:12px 12px;
      margin-bottom:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
    }
    .resultCard:hover{
      border-color:rgba(255,255,255,.18);
      background:rgba(0,0,0,.22);
    }
    .resultTitle{
      font-weight:900;
      color:#fff;
      margin-bottom:6px;
      line-height:1.2;
      word-break:keep-all;
    }
    .resultSub{
      color:rgba(230,238,252,.70);
      font-size:12px;
      line-height:1.45;
      white-space:pre-line;
    }
    .createBox{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
    }
    .createHead{
      font-weight:800;
      font-size:14px;
      letter-spacing:.2px;
    }


    .createDesc{
      margin-top:6px;
      color:rgba(230,238,252,.62);
      font-size:12px;
      line-height:1.4;
    }
    .createForm{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width: 860px){
      .createForm{ grid-template-columns: 1fr 1fr; }
    }
    .createField{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .createLabel{
      font-size:12px;
      color:rgba(230,238,252,.70);
      font-weight:800;
    }
    .createInput{
      width:100%;
      height:40px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:#fff;
      outline:none;
      box-sizing:border-box;
    }
    .createInput:focus{
      border-color: rgba(92,162,255,.55);
      box-shadow: 0 0 0 3px rgba(92,162,255,.15);
    }
    .createActions{
      margin-top:12px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
    }
    .createBtn{
      height:40px;
      padding:0 16px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(58,130,255,.45), rgba(58,130,255,.22));
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .createBtn:hover{ filter:brightness(1.06); }
    .createBtn:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:none;
    }
    .tagPill{
      flex:0 0 auto;
      margin-left:10px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      color:rgba(230,238,252,.85);
      font-weight:900;
      font-size:12px;
      background:rgba(255,255,255,.04);
      align-self:center;
      white-space:nowrap;
    }
    .searchBottom{
      padding:10px 14px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color:rgba(230,238,252,.70);
      font-size:12px;
    }
    .pager{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pager .miniBtn{
      height:30px;
      padding:0 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:#fff;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .pager .miniBtn:hover{background:rgba(0,0,0,.30)}
    .kbdHint{
      color:rgba(230,238,252,.55);
      font-size:12px;
      white-space:nowrap;
    }
  
  /* --- vendor search UX additions --- */
  .btnSearch{padding:10px 14px; min-width:86px;}
  .pillRow{
    display:flex; align-items:center; justify-content:space-between;
    padding:6px 10px; border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.04);
    color:var(--muted);
    font-size:12px;
    gap:10px;
  }
  .pillX{
    width:22px; height:22px; border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    color:var(--muted);
    display:inline-flex; align-items:center; justify-content:center;
    cursor:pointer;
  }
  .pillX:hover{background:rgba(255,255,255,.12);}
  .resultActions{display:flex; gap:8px; align-items:center;}
  .miniX{
    min-width:34px; height:32px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.05);
    color:var(--muted);
    display:inline-flex; align-items:center; justify-content:center;
    cursor:pointer;
  }
  .miniX:hover{background:rgba(255,255,255,.10);}
  .kv{
    padding-top:0 !important;
    padding-bottom:0 !important;
  }
  .kvRow{
    display:flex !important;
    align-items:center !important;
    justify-content:space-between !important;
    gap:10px !important;
    min-height:40px !important;
  }
  .kvLabel, .kvValue{
    display:flex !important;
    align-items:center !important;
    min-height:40px !important;
    height:40px !important;
    line-height:1 !important;
    transform:none !important;
    margin:0 !important;
    padding:0 !important;
  }
  .kvLabel{
    flex:0 0 92px !important;
  }
  .kvValue{
    flex:1 1 auto !important;
    justify-content:flex-end !important;
    text-align:right !important;
  }

  /* vendor modal empty state */
  .emptyMsg{
    padding:10px 6px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    color:#fff;
    font-weight:900;
    font-size:13px;
  }
</style>

  <!-- Kakao Maps -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=add4ce93b38c0ff9d9b9053728e067b3&autoload=false&libraries=services"></script>
</head>

<body>
<div class="wrap">
  <div class="left">
    <div class="title">
      <a href="/index.html" style="display:flex;align-items:center">
        <img src="/favicon.ico" alt="Maroowell Logo" style="width:24px;height:24px;transform:translateY(-2px);cursor:pointer" />
      </a>
      <span>ë§ˆë£¨ì›° ë¼ìš°íŠ¸ í¸ì§‘ê¸°</span>
    </div>

    <div class="group">
      <div class="label">ìº í”„ ì´ë¦„ (ì˜ˆ: í‰ì–‘1)</div>
      <input id="campInput" type="text" value="" />

      <div class="label">ë¼ìš°íŠ¸ ì½”ë“œ (ì˜ˆ: 101A,101B) â€” ë¹„ìš°ë©´ camp ì „ì²´ í‘œì‹œ</div>
      <input id="codeInput" type="text" value="" />

      <div class="sep"></div>

      <div class="label sectionTitle">ë²¤ë” ì •ë³´(ì„œë¸Œë¼ìš°íŠ¸ ë‹¨ìœ„)</div>

      <div class="kv">
        <div class="kvRow">
          <div class="kvLabel">ì£¼ê°„ (2W)</div>
          <div class="kvValue" id="vendorWeekValue">-</div>
        </div>
        <div class="kvRow">
          <div class="kvLabel">ì•¼ê°„ (1W)</div>
          <div class="kvValue" id="vendorNightValue">-</div>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="row" style="gap:10px;">
            <input id="vendorSearchInput" type="text" placeholder="ë²¤ë”ëª…/ì‚¬ì—…ìë²ˆí˜¸ ì¼ë¶€ ì…ë ¥ í›„ Enter" style="flex:1;" />
            <button id="vendorSearchBtn" class="btn btnSearch" type="button">ê²€ìƒ‰</button>
          </div>

      <div style="height:10px"></div>
      <div class="row">
        <button id="vendorSaveBtn" class="btn ok">ë²¤ë” ì €ì¥</button>
        <button id="vendorClearBtn" class="btn danger">ë²¤ë” ë¹„ìš°ê¸°</button>
      </div>

      <div style="height:8px"></div>
      <div id="vendorPickedWrap" class="pillRow" style="display:none;margin-top:8px;">
            <div id="vendorPickedText"></div>
            <button id="vendorPickedClearBtn" class="pillX" type="button" title="ì„ íƒ í•´ì œ">âœ•</button>
          </div>

      <div class="sep"></div>

      <div class="label sectionTitle">ì…ì°¨ì§€ ì •ë³´(ì„œë¸Œë¼ìš°íŠ¸ ë‹¨ìœ„)</div>
      <div class="row" style="gap:10px;">
        <input id="deliveryNameInput" type="text" placeholder="ì…ì°¨ì§€(ëª¨ë°”ì¼ìº í”„ëª…) ê²€ìƒ‰ í›„ Enter" style="flex:1;" />
        <button id="deliverySearchBtn" class="btn btnSearch" type="button">ê²€ìƒ‰</button>
      </div>
      <div style="height:8px"></div>
      <input id="deliveryAddrInput" type="text" placeholder="ì…ì°¨ì§€ ì£¼ì†Œ (camps í…Œì´ë¸”ì—ì„œ ìë™ ì¡°íšŒ)" readonly />

      <div style="height:10px"></div>
      <div class="row">
        <button id="deliverySaveBtn" class="btn ok">ì…ì°¨ì§€ ì €ì¥</button>
        <button id="deliveryClearBtn" class="btn danger">ì…ì°¨ì§€ ë¹„ìš°ê¸°</button>
      </div>
</div>

    <div class="group" id="addressListGroup" style="display:none">
      <div class="label">ë°°ì†¡ì§€ ëª©ë¡ (ì…ì°¨ì§€â†’ë°°ì†¡ì§€ ë„¤ë¹„)</div>
      <div id="addressList" style="max-height:300px; overflow-y:auto; margin-top:8px;"></div>
</div>

    <div class="group">
      <div class="row">
        <button id="loadBtn" class="btn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="drawNewBtn" class="btn warn">ìƒˆë¡œ ê·¸ë¦¬ê¸°</button>
        <button id="drawAddBtn" class="btn warn">êµ¬ì—­ ì¶”ê°€</button>
      </div>
      <div style="height:8px"></div>
      <div class="row">
        <button id="saveBtn" class="btn ok">ì €ì¥</button>
        <button id="deletePolyBtn" class="btn danger">í´ë¦¬ê³¤ ì‚­ì œ</button>
        <button id="vendorLabelToggleBtn" class="btn">ë²¤ë” ë¼ë²¨ OFF</button>
      </div>
      <div style="height:8px"></div>
      <div class="row">
        <button id="addrBtn" class="btn">ì£¼ì†Œê²€ìƒ‰</button>
        <button id="labelToggleBtn" class="btn">ë¼ìš°íŠ¸ ë¼ë²¨ ON</button>
        <button id="resetBtn" class="btn">ì§€ë„ ì´ˆê¸°í™”</button>
      </div>
      <div style="height:8px"></div>
      <div class="row">
        <button id="shareBtn" class="btn ok" style="width:100%;">ğŸ”— ê³µìœ  ë§í¬ ìƒì„±</button>
      </div>
</div>

    <div class="logWrap">
      <div class="logHeader">
        <span class="pill" id="statusPill">READY</span>
        <span class="small" id="selectedInfo">ì„ íƒ: ì—†ìŒ</span>
      </div>
      <div class="log" id="log"></div>
    </div>
</div>

  <div class="map">
    <div id="mapWrap">
      <div id="map"></div>
      <div id="roadview"></div>
    </div>

    <div class="map-controls">
      <button id="toggleMapType" title="ì¼ë°˜/ìœ„ì„± ì „í™˜">ìœ„ì„±</button>
      <button id="toggleRoadview" title="ë¡œë“œë·° ë³´ê¸°/ì¢…ë£Œ">ë¡œë“œë·°</button>
      <span id="roadviewHint" class="hint">ë¡œë“œë·°: íŒŒë€ ê¸¸ í´ë¦­</span>
    </div>

    <div class="floatingHint" id="hint"></div>

    <!-- âœ… ì¹´ì¹´ì˜¤ì§€ë„ ìŠ¤íƒ€ì¼ ê²€ìƒ‰ ëª¨ë‹¬ -->
    <div class="searchModal" id="searchModal" aria-hidden="true">
      <div class="searchCard" role="dialog" aria-modal="true" aria-label="ì¹´ì¹´ì˜¤ì§€ë„ ê²€ìƒ‰">
        <div class="searchTop">
          <div class="searchTopTitle">ì¹´ì¹´ì˜¤ì§€ë„ ê²€ìƒ‰</div>
          <div class="searchInput">
            <input id="searchQ" type="text" placeholder="ì¥ì†Œ, ì£¼ì†Œ, í‚¤ì›Œë“œ ê²€ìƒ‰" autocomplete="off" />
            <button id="searchRunBtn" class="miniBtn">ê²€ìƒ‰</button>
            <button id="searchCloseBtn" class="miniBtn" style="background:rgba(255,80,80,.18);border-color:rgba(255,80,80,.26)">ë‹«ê¸°</button>
          </div>
        </div>
        <div class="searchMeta">
          <div class="kbdHint">Enter: ê²€ìƒ‰ Â· ESC: ë‹«ê¸°/ë§ˆì»¤ì‚­ì œ</div>
          <div id="searchMetaCount">ì£¼ì†Œ 0ê°œ Â· ì¥ì†Œ 0ê°œ</div>
        </div>
        <div class="searchBody" id="searchResults"></div>
        <div class="searchBottom">
          <div class="kbdHint">ì£¼ì†Œ ê²€ìƒ‰ ê²°ê³¼ + ì¥ì†Œ(í‚¤ì›Œë“œ) ê²°ê³¼ë¥¼ ë™ì‹œì— í‘œì‹œí•©ë‹ˆë‹¤</div>
          <div class="pager">
            <button id="placePrevBtn" class="miniBtn">ì´ì „</button>
            <span id="placePageInfo">ì¥ì†Œ í˜ì´ì§€ 1 / 1</span>
            <button id="placeNextBtn" class="miniBtn">ë‹¤ìŒ</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>



<!-- âœ… ë²¤ë” ê²€ìƒ‰ ê²°ê³¼ ì„ íƒ ëª¨ë‹¬ -->
<div class="modal" id="vendorModal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true" aria-label="ë²¤ë” ì„ íƒ">
    <div class="modalTop">
      <div class="modalTitle">ë²¤ë” ì„ íƒ</div>
      <button id="vendorModalCloseBtn" class="miniBtn" style="background:rgba(255,80,80,.18);border-color:rgba(255,80,80,.26)">ë‹«ê¸°</button>
    </div>
    <div class="modalMeta">
      <div class="kbdHint">í´ë¦­: ì„ íƒ Â· ESC: ë‹«ê¸°</div>
      <div id="vendorMetaCount">0ê°œ</div>
    </div>
    <div class="modalBody" id="vendorResults"></div>
  </div>
</div>

<!-- âœ… 1W/2W ì„ íƒ ëª¨ë‹¬ -->
<div class="modal" id="waveModal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true" aria-label="1W/2W ì„ íƒ" style="width:min(520px, calc(100% - 40px)); max-height:none;">
    <div class="modalTop">
      <div class="modalTitle" id="waveModalTitle">ì €ì¥ êµ¬ë¶„ ì„ íƒ</div>
      <button id="waveModalCloseBtn" class="miniBtn" style="background:rgba(255,80,80,.18);border-color:rgba(255,80,80,.26)">ë‹«ê¸°</button>
    </div>
    <div class="modalMeta">
      <div class="kbdHint">ì£¼ê°„/ì•¼ê°„ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
      <div class="pill" id="waveModalVendorPill" style="display:none"></div>
    </div>
    <div class="waveGrid">
      <button id="wave2WBtn" class="waveBtn">ì£¼ê°„ (2W)<span class="sub">2Wë¡œ ì €ì¥</span></button>
      <button id="wave1WBtn" class="waveBtn">ì•¼ê°„ (1W)<span class="sub">1Wë¡œ ì €ì¥</span></button>
    </div>
  </div>
</div>

<!-- âœ… ì…ì°¨ì§€(ìº í”„) ê²€ìƒ‰/ë“±ë¡ ëª¨ë‹¬ -->
<div class="modal" id="deliveryCampModal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true" aria-label="ì…ì°¨ì§€ ì„ íƒ">
    <div class="modalTop">
      <div class="modalTitle">ì…ì°¨ì§€ ì„ íƒ</div>
      <button id="deliveryCampModalCloseBtn" class="miniBtn" style="background:rgba(255,80,80,.18);border-color:rgba(255,80,80,.26)">ë‹«ê¸°</button>
    </div>
    <div class="modalMeta">
      <div class="kbdHint">í´ë¦­: ì„ íƒ Â· ê²°ê³¼ ì—†ìœ¼ë©´ ì•„ë˜ì—ì„œ ë“±ë¡</div>
      <div id="deliveryCampMetaCount">0ê°œ</div>
    </div>
    <div class="modalBody" id="deliveryCampResults"></div>
  </div>
</div>

<script>
(() => {
  if (window.__coupangRouteMapInitialized) return;
  window.__coupangRouteMapInitialized = true;

  // ====== í™˜ê²½ ì„¤ì • ======
  const API_BASE = "https://route.maroowell.com"; // í•„ìš”ì‹œ ë³€ê²½
  const ROUTE_ENDPOINT = `${API_BASE}/route`;
  const OSM_ENDPOINT = `${API_BASE}/osm`;
  const ADDRESS_ENDPOINT = `${API_BASE}/addresses`;
  const CAMPS_ENDPOINT = `${API_BASE}/camps`; // âœ… ì…ì°¨ì§€(ìº í”„) ê²€ìƒ‰/ë“±ë¡
  const VENDORS_ENDPOINT = `${API_BASE}/vendors`; // âœ… ë²¤ë” ê²€ìƒ‰(ì´ë¦„ ë¶€ë¶„ ì¼ì¹˜)

  // ====== DOM ======
  const $ = (id) => document.getElementById(id);

  const campInput = $("campInput");
  const codeInput = $("codeInput");

  // âœ… ë²¤ë”(ì£¼ê°„/ì•¼ê°„)
  const vendorWeekValue = $("vendorWeekValue");
  const vendorNightValue = $("vendorNightValue");
  const vendorSearchInput = $("vendorSearchInput");
  const vendorSearchBtn = $("vendorSearchBtn");
  const vendorPickedWrap = $("vendorPickedWrap");
  const vendorPickedText = $("vendorPickedText");
  const vendorPickedClearBtn = $("vendorPickedClearBtn");

  // âœ… ë²¤ë” ì„ íƒ ëª¨ë‹¬
  const vendorModalEl = $("vendorModal");
  const vendorModalCloseBtn = $("vendorModalCloseBtn");
  const vendorMetaCountEl = $("vendorMetaCount");
  const vendorResultsEl = $("vendorResults");

  // âœ… 1W/2W ì„ íƒ ëª¨ë‹¬
  const waveModalEl = $("waveModal");
  const waveModalCloseBtn = $("waveModalCloseBtn");
  const waveModalTitleEl = $("waveModalTitle");
  const waveModalVendorPillEl = $("waveModalVendorPill");
  const wave1WBtn = $("wave1WBtn");
  const wave2WBtn = $("wave2WBtn");

  // âœ… ì…ì°¨ì§€
  const deliveryNameInput = $("deliveryNameInput");
  const deliveryAddrInput = $("deliveryAddrInput");
  const deliverySearchBtn = $("deliverySearchBtn");

  // âœ… ì…ì°¨ì§€ ì„ íƒ ëª¨ë‹¬
  const deliveryCampModalEl = $("deliveryCampModal");
  const deliveryCampModalCloseBtn = $("deliveryCampModalCloseBtn");
  const deliveryCampMetaCountEl = $("deliveryCampMetaCount");
  const deliveryCampResultsEl = $("deliveryCampResults");

  const loadBtn = $("loadBtn");
  const drawNewBtn = $("drawNewBtn");
  const drawAddBtn = $("drawAddBtn");
  const addrBtn = $("addrBtn");
  const saveBtn = $("saveBtn");
  const deletePolyBtn = $("deletePolyBtn");
  const vendorLabelToggleBtn = $("vendorLabelToggleBtn");
  const labelToggleBtn = $("labelToggleBtn");
  const resetBtn = $("resetBtn");
  const vendorSaveBtn = $("vendorSaveBtn");
  const vendorClearBtn = $("vendorClearBtn");
  const deliverySaveBtn = $("deliverySaveBtn");
  const deliveryClearBtn = $("deliveryClearBtn");
  const shareBtn = $("shareBtn");

  const logEl = $("log");
  const statusPill = $("statusPill");
  const selectedInfo = $("selectedInfo");
  const hintEl = $("hint");

  // ì§€ë„ ì»¨íŠ¸ë¡¤
  const toggleMapTypeBtn = $("toggleMapType");
  const toggleRoadviewBtn = $("toggleRoadview");
  const roadviewHintEl = $("roadviewHint");
  const mapWrapEl = $("mapWrap");

  // ê²€ìƒ‰ ëª¨ë‹¬
  const searchModalEl = $("searchModal");
  const searchQEl = $("searchQ");
  const searchRunBtn = $("searchRunBtn");
  const searchCloseBtn = $("searchCloseBtn");
  const searchResultsEl = $("searchResults");
  const searchMetaCountEl = $("searchMetaCount");
  const placePrevBtn = $("placePrevBtn");
  const placeNextBtn = $("placeNextBtn");
  const placePageInfoEl = $("placePageInfo");

  // ====== ë¡œê·¸ ======
  const ts = () => {
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    const ss = String(d.getSeconds()).padStart(2,"0");
    return `[${hh}:${mm}:${ss}]`;
  };
  function setStatus(t, kind="READY") {
    statusPill.textContent = kind;
    statusPill.style.borderColor =
      kind === "ERR" ? "rgba(255,60,60,.35)" :
      kind === "WARN" ? "rgba(255,180,0,.30)" :
      kind === "OK" ? "rgba(0,255,140,.22)" :
      "rgba(255,255,255,.10)";
    statusPill.style.background =
      kind === "ERR" ? "rgba(255,60,60,.12)" :
      kind === "WARN" ? "rgba(255,180,0,.10)" :
      kind === "OK" ? "rgba(0,255,140,.08)" :
      "rgba(255,255,255,.04)";
    if (t) log(`${kind} ${t}`);
  }
  function toastOk(msg) { setStatus(msg, "OK"); }
  function toastWarn(msg) { setStatus(msg, "WARN"); }
  function toastErr(msg) { setStatus(msg, "ERR"); }
  function log(msg) {
    logEl.textContent += `${ts()} ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }
  function hint(msg, show=true) {
    hintEl.textContent = msg;
    hintEl.style.display = show ? "block" : "none";
  }

  // ====== ìƒíƒœ ======
  let map, geocoder, places;

  /** @type {Array<any>} */
  let routeRows = []; // APIì—ì„œ ë°›ì€ rowë“¤
  let addressRows = []; // ë°°ì†¡ì§€ ëª©ë¡

  /**
   * rowId -> { row, polygons: kakao.maps.Polygon[], labels: kakao.maps.CustomOverlay[] }
   */
  const overlayById = new Map();

  // ì„ íƒ/í¸ì§‘ ìƒíƒœ
  let selectedRouteId = null;   // í´ë¦­ìœ¼ë¡œ ì„ íƒëœ ë¼ìš°íŠ¸(id)
  let editingRouteId = null;    // Enterë¡œ í¸ì§‘ ì¤‘ì¸ ë¼ìš°íŠ¸(id)
  let editHandles = [];         // kakao.maps.Marker[]
  let editPolygons = [];        // kakao.maps.Polygon[]
  let labelOn = true;
  let vendorLabelOn = false;

  // âœ… ë¼ë²¨ ìœ„ì¹˜ ìˆ˜ë™ì¡°ì •(í¸ì§‘ëª¨ë“œ) ì„ì‹œ ë¹„í™œì„±í™”: ë–¨ì–´ì§„ í´ë¦¬ê³¤ ì¡°ê°ë³„ ë¼ë²¨ í‘œê¸° ìš°ì„ 
  const LABEL_ANCHOR_EDIT_ENABLED = false;

  // âœ… ë²¤ë” ê²€ìƒ‰/í•„í„° ìƒíƒœ
  let vendorCandidate = null;              // { name, business_number, vendor_code }
  let vendorFilterBusinessNumber = null;   // ë¶ˆëŸ¬ì˜¤ê¸°(ê²€ìƒ‰)ìš©

  // âœ… ì…ì°¨ì§€(ìº í”„) ê²€ìƒ‰/ì„ íƒ ìƒíƒœ
  let deliveryCampCandidate = null;        // { id, camp, code, mb_camp, address, latitude, longitude }
  let deliveryCampModalOpen = false;


  // âœ… (ì¶”ê°€) í´ë¦¬ê³¤ ê°œë³„ ì‚­ì œ X ì˜¤ë²„ë ˆì´
  let deleteOverlays = []; // kakao.maps.CustomOverlay[]

  // ì»¤ìŠ¤í…€ ë“œë˜ê·¸ ìƒíƒœ
  let draggingVertex = null; // { marker, polygon, index }

  // ê·¸ë¦¬ê¸° ìƒíƒœ
  let drawMode = null; // "new" | "add" | null
  let drawPoints = []; // kakao.maps.LatLng[]
  let drawMarkers = []; // kakao.maps.Marker[]
  let drawLine = null; // kakao.maps.Polyline

  // OSM ì˜¤ë²„ë ˆì´
  let osmOverlays = [];

  // âœ… ê²€ìƒ‰ ì„ íƒ ë§ˆì»¤ (ESCë¡œ ì‚­ì œ)
  let searchSelectedMarker = null;
  let searchSelectedOverlay = null;

  // âœ… ìœ„ì„±/ë¡œë“œë·°
  let isSatellite = false;
  let roadviewOn = false;    // ê¸¸ ì„ íƒ ëª¨ë“œ on/off
  let roadviewOpen = false;  // ì‹¤ì œ roadview í™”ë©´ open ì—¬ë¶€
  let roadview = null;
  let roadviewClient = null;
  let roadviewClickHandler = null;

  // âœ… ê²€ìƒ‰ ëª¨ë‹¬ ìƒíƒœ
  let searchModalOpen = false;
  let searchQuery = "";
  let placePage = 1;
  let placeLast = 1;
  let placeTotal = 0;
  let placeItems = [];
  let addrItems = [];

  // ====== ì»¬ëŸ¬(ì¸ì ‘ ë¼ìš°íŠ¸ ìƒ‰ ì°¨ì´ + ëˆˆë¶€ì‹¬ ì™„í™”) ======
  // - ë¼ìš°íŠ¸ ëª©ë¡(full_code ì •ë ¬) ê¸°ì¤€ìœ¼ë¡œ "ê³¨ë“  ì•µê¸€" ë¶„ì‚° ìƒ‰ìƒì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
  // - ì±„ë„/ëª…ë„ëŠ” ë‚®ì¶°ì„œ(ëˆˆë¶€ì‹¬ ì™„í™”) ë¼ë²¨/ì„ ë§Œ ë˜ë ·í•˜ê²Œ ë³´ì´ê²Œ í•©ë‹ˆë‹¤.
  const GOLDEN_ANGLE = 137.50776405003785;

  function clamp01(x){ return Math.max(0, Math.min(1, x)); }

  function hslToHex(h, s, l) {
    // h:0-360, s/l:0-100
    h = ((h % 360) + 360) % 360;
    s = clamp01(s / 100);
    l = clamp01(l / 100);

    const c = (1 - Math.abs(2*l - 1)) * s;
    const hh = h / 60;
    const x = c * (1 - Math.abs((hh % 2) - 1));
    let r=0,g=0,b=0;

    if (0 <= hh && hh < 1) { r=c; g=x; b=0; }
    else if (1 <= hh && hh < 2) { r=x; g=c; b=0; }
    else if (2 <= hh && hh < 3) { r=0; g=c; b=x; }
    else if (3 <= hh && hh < 4) { r=0; g=x; b=c; }
    else if (4 <= hh && hh < 5) { r=x; g=0; b=c; }
    else { r=c; g=0; b=x; }

    const m = l - c/2;
    const to255 = (v)=> Math.round((v+m)*255);
    const rr = to255(r), gg = to255(g), bb = to255(b);

    const hex = (n)=> n.toString(16).padStart(2,"0");
    return `#${hex(rr)}${hex(gg)}${hex(bb)}`;
  }

  // fallback(ë‹¨ë… í˜¸ì¶œ) - ìƒ‰ìƒ ê°•ì œ ì €ì¥í•˜ì§€ ì•Šê³  "í‘œì‹œìš©"ìœ¼ë¡œë§Œ ì”ë‹ˆë‹¤.
  function colorFor(code) {
    const str = String(code||"");
    let h = 2166136261; // FNV-1a
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    const hue = (h >>> 0) % 360;
    const sat = 28;
    const light = 60;
    return hslToHex(hue, sat, light);
  }


  // âœ… ì¸ì ‘ ë¼ìš°íŠ¸ ìƒ‰ìƒ ê²¹ì¹¨ ìµœì†Œí™”: ì •ë ¬ ìˆœì„œ ê¸°ë°˜ ê³¨ë“  ì•µê¸€ ë¶„ì‚°(ì €ì±„ë„/ì¤‘ëª…ë„)
  function buildDisplayColors(rows) {
    const arr = Array.isArray(rows) ? rows.slice() : [];
    const keyOf = (r) => String(r?.full_code || r?.code || r?.route_code || "");
    arr.sort((a,b)=> keyOf(a).localeCompare(keyOf(b), "en", { numeric:true, sensitivity:"base" }));

    // camp ê¸°ë°˜ seed (ê°™ì€ campëŠ” ê°™ì€ ì‹œì‘ìƒ‰)
    const camp = String(arr[0]?.camp || "");
    let seed = 2166136261; // FNV-1a
    for (let i=0;i<camp.length;i++){
      seed ^= camp.charCodeAt(i);
      seed = Math.imul(seed, 16777619);
    }
    const startHue = (seed >>> 0) % 360;
    const golden = 137.50776405003785; // degrees

    const map = new Map();
    for (let i=0;i<arr.length;i++){
      const r = arr[i];
      const idKey = (typeof r?.id === "number" || typeof r?.id === "string") ? r.id : keyOf(r);
      const hue = (startHue + i * golden) % 360;
      const sat = 42 + ((i * 11) % 18);      // 42~59 (ì ë‹¹í•œ ì±„ë„)
      const light = 48 + ((i * 7) % 10);      // 48~57 (ì¤‘ì €ëª…ë„)
      map.set(idKey, hslToHex(hue, sat, light));
    }
    return map;
  }

  // ====== API ======
  async function apiGet(url) {
    const res = await fetch(url, { method:"GET" });
    const text = await res.text();
    let json = null;
    try { json = text ? JSON.parse(text) : null; } catch {}
    if (!res.ok) {
      const msg = json?.error || text || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return json;
  }
  async function apiJson(method, url, body) {
    const res = await fetch(url, {
      method,
      headers: { "Content-Type":"application/json" },
      body: body ? JSON.stringify(body) : undefined
    });
    const text = await res.text();
    let json = null;
    try { json = text ? JSON.parse(text) : null; } catch {}
    if (!res.ok) {
      const msg = json?.error || text || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return json;
  }

  // ====== ìœ í‹¸: polygon_wgs84 íŒŒì‹± ======
  function parsePolygonWgs84(v, debugId = "") {
    if (!v) return null;
    if (Array.isArray(v)) return v;
    if (typeof v === "string") {
      try {
        const p = JSON.parse(v);
        if (Array.isArray(p)) return p;
      } catch (e) {
        if (debugId) log(`âš  í´ë¦¬ê³¤ íŒŒì‹± ì‹¤íŒ¨: ${debugId}`);
      }
    }
    return null;
  }

  // ====== ì§€ë„ ì˜¤ë²„ë ˆì´ ì •ë¦¬ ======
  function clearAllOverlays() {
    stopEditing();
    stopDraw(true);
    clearOsm();

    for (const {polygons, labels} of overlayById.values()) {
      polygons.forEach(p => p.setMap(null));
      labels.forEach(l => l.setMap(null));
    }
    overlayById.clear();
    routeRows = [];
    selectedRouteId = null;
    editingRouteId = null;
    selectedInfo.textContent = "ì„ íƒ: ì—†ìŒ";

    clearVendorDisplay();
    clearDeliveryDisplay();
  }

  function normalizeDeliveryCamp(v) {
    if (!v || typeof v !== "object") return null;
    const camp = (v.camp ?? "").toString().trim();
    const code = (v.code ?? "").toString().trim();
    const mb_camp = (v.mb_camp ?? v.delivery_location_name ?? v.name ?? "").toString().trim();
    const address = (v.address ?? v.delivery_location_address ?? "").toString().trim();
    if (!mb_camp) return null;
    return {
      id: v.id ?? null,
      camp,
      code,
      mb_camp,
      address,
      latitude: v.latitude ?? v.delivery_location_lat ?? null,
      longitude: v.longitude ?? v.delivery_location_lng ?? null,
    };
  }

  function resolveDeliveryLocationName() {
    const picked = (deliveryCampCandidate?.mb_camp ?? "").toString().trim();
    if (picked) return picked;
    return (deliveryNameInput?.value ?? "").toString().trim();
  }

  function setDeliveryCampCandidate(v, { syncNameInput = true } = {}) {
    deliveryCampCandidate = normalizeDeliveryCamp(v);

    if (!deliveryCampCandidate) {
      if (syncNameInput && deliveryNameInput) deliveryNameInput.value = "";
      if (deliveryAddrInput) deliveryAddrInput.value = "";
      return;
    }

    if (syncNameInput && deliveryNameInput) deliveryNameInput.value = deliveryCampCandidate.mb_camp;
    if (deliveryAddrInput) deliveryAddrInput.value = deliveryCampCandidate.address || "";
  }

  function setDeliveryDisplayFromRow(row) {
    const normalized = normalizeDeliveryCamp({
      camp: row?.camp || row?.camp_name || "",
      mb_camp: row?.delivery_location_name || "",
      address: row?.delivery_location_address || "",
      delivery_location_lat: row?.delivery_location_lat,
      delivery_location_lng: row?.delivery_location_lng,
    });
    if (normalized) setDeliveryCampCandidate(normalized);
    else clearDeliveryDisplay();
  }

  function clearDeliveryDisplay() {
    setDeliveryCampCandidate(null);
  }

  function clearOsm() {
    osmOverlays.forEach(o => o.setMap(null));
    osmOverlays = [];
  }

  // ====== ë¼ë²¨ ======
  function centroidOfLatLngs(latlngs) {
    let latSum=0, lngSum=0;
    for (const ll of latlngs) { latSum += ll.getLat(); lngSum += ll.getLng(); }
    return new kakao.maps.LatLng(latSum/latlngs.length, lngSum/latlngs.length);
  }
  function normalizeCenterWgs84(v) {
    if (!v) return null;
    let obj = v;
    if (typeof obj === "string") {
      try { obj = JSON.parse(obj); } catch { return null; }
    }
    let lat = null, lng = null;

    if (Array.isArray(obj) && obj.length >= 2) {
      const a = Number(obj[0]);
      const b = Number(obj[1]);
      // [lng,lat] or [lat,lng] heuristic
      if (Math.abs(a) > Math.abs(b)) { lng = a; lat = b; }
      else { lat = a; lng = b; }
    } else if (obj && typeof obj === "object") {
      lat = Number(obj.lat ?? obj.latitude ?? obj.y);
      lng = Number(obj.lng ?? obj.lon ?? obj.longitude ?? obj.x);
    }

    if (!isFinite(lat) || !isFinite(lng)) return null;
    return new kakao.maps.LatLng(lat, lng);
  }

  function vendorNameOnly(name, bn) {
    const n = (name ?? "").toString().trim();
    if (n) return n;
    const b = (bn ?? "").toString().trim();
    if (b) return b;
    return "-";
  }

  function getVendorWeekNightFromRow(row) {
    // âœ… ì£¼ê°„=2W, ì•¼ê°„=1W (ìš”êµ¬ì‚¬í•­ ë°˜ì˜)
    const name1 =
      row.vendor_name_1w ??
      row.vendor_1w_name ??
      row.vendor_week_name ??
      row.vendor_name_week ??
      null;
    const bn1 =
      row.vendor_business_number_1w ??
      row.vendor_business_number_week ??
      null;

    const name2 =
      row.vendor_name_2w ??
      row.vendor_2w_name ??
      row.vendor_night_name ??
      row.vendor_name_night ??
      null;
    const bn2 =
      row.vendor_business_number_2w ??
      row.vendor_business_number_night ??
      null;

    return {
      week: vendorNameOnly(name2, bn2),
      night: vendorNameOnly(name1, bn1)
    };
  }

  function createLabelOverlay(code, row, position, color, opts = {}) {
    const showCode = (opts.showCode !== undefined) ? opts.showCode : labelOn;
    const showVendor = (opts.showVendor !== undefined) ? opts.showVendor : vendorLabelOn;

    const root = document.createElement("div");
    root.style.padding = showVendor ? "6px 10px" : "4px 8px";
    root.style.borderRadius = "14px";
    root.style.background = "rgba(0,0,0,0.55)";
    root.style.color = "#fff";
    root.style.border = "1px solid rgba(255,255,255,0.18)";
    root.style.boxShadow = "0 4px 14px rgba(0,0,0,0.28)";
    root.style.backdropFilter = "blur(2px)";
    root.style.maxWidth = "240px";
    root.style.pointerEvents = "none";
    root.style.display = "flex";
    root.style.flexDirection = "column";
    root.style.gap = (showVendor && showCode) ? "3px" : (showVendor ? "2px" : "0");

    // âœ… ë¼ìš°íŠ¸ ë¼ë²¨ OFF + ë²¤ë” ë¼ë²¨ ON : ë¼ìš°íŠ¸ì½”ë“œ ìˆ¨ê¹€(ë²¤ë” ì •ë³´ë§Œ í‘œì‹œ)
    if (!showCode && showVendor) {
      root.style.borderLeft = `4px solid ${color}`;
    }

    if (showCode) {
      const top = document.createElement("div");
      top.style.display = "inline-flex";
      top.style.alignItems = "center";
      top.style.gap = "6px";

      const dot = document.createElement("span");
      dot.style.width = "8px";
      dot.style.height = "8px";
      dot.style.borderRadius = "999px";
      dot.style.background = color;
      dot.style.boxShadow = "0 0 0 2px rgba(255,255,255,0.12)";
      dot.style.flex = "0 0 auto";

      const t = document.createElement("span");
      t.textContent = String(code || "");
      t.style.fontWeight = "900";
      t.style.fontSize = "12px";
      t.style.letterSpacing = "0.2px";
      t.style.lineHeight = "1.1";

      top.appendChild(dot);
      top.appendChild(t);
      root.appendChild(top);
    }

    if (showVendor) {
      const { week, night } = getVendorWeekNightFromRow(row || {});
      const box = document.createElement("div");
      box.style.display = "flex";
      box.style.flexDirection = "column";
      box.style.gap = "1px";
      box.style.fontSize = "11px";
      box.style.lineHeight = "1.2";
      box.style.color = "rgba(255,255,255,0.88)";

      const l1 = document.createElement("div");
      l1.textContent = `ì£¼ê°„: ${week}`;
      const l2 = document.createElement("div");
      l2.textContent = `ì•¼ê°„: ${night}`;

      [l1, l2].forEach(el => {
        el.style.whiteSpace = "nowrap";
        el.style.overflow = "hidden";
        el.style.textOverflow = "ellipsis";
      });

      box.appendChild(l1);
      box.appendChild(l2);
      root.appendChild(box);
    }

    return new kakao.maps.CustomOverlay({ position, content: root, yAnchor: 1.0, zIndex: 10 });
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ====== í´ë¦¬ê³¤ ìƒì„± ======
  function makePolygon(latlngs, strokeColor, fillColor, zIndex=1) {
    return new kakao.maps.Polygon({
      path: latlngs, // ë°˜ë“œì‹œ LatLng[]
      strokeWeight: 1,
      strokeColor,
      strokeOpacity: 1.0,
      strokeStyle: "solid",
      fillColor,
      fillOpacity: 0.24,
      zIndex
    });
  }

  // ====== (ì¶”ê°€) í´ë¦¬ê³¤ ê°œë³„ ì‚­ì œ X ì˜¤ë²„ë ˆì´ ìœ í‹¸ ======
  function clearDeleteOverlays() {
    deleteOverlays.forEach(o => o.setMap(null));
    deleteOverlays = [];
  }

  function getPolygonPathAsArray(polygon) {
    const rawPath = polygon.getPath();
    const out = [];
    if (!rawPath) return out;

    if (Array.isArray(rawPath)) {
      out.push(...rawPath);
      return out;
    }
    if (typeof rawPath.getLength === "function" && typeof rawPath.getAt === "function") {
      for (let i = 0; i < rawPath.getLength(); i++) out.push(rawPath.getAt(i));
      return out;
    }
    return out;
  }

  function createDeleteOverlayForPolygon(polygon) {
    const path = getPolygonPathAsArray(polygon);
    if (!path || path.length < 3) return null;

    const pos = centroidOfLatLngs(path);

    const btn = document.createElement("div");
    btn.textContent = "Ã—";
    btn.title = "ì´ êµ¬ì—­ë§Œ ì‚­ì œ";
    btn.style.width = "22px";
    btn.style.height = "22px";
    btn.style.display = "flex";
    btn.style.alignItems = "center";
    btn.style.justifyContent = "center";
    btn.style.borderRadius = "999px";
    btn.style.cursor = "pointer";
    btn.style.userSelect = "none";
    btn.style.background = "rgba(0,0,0,.72)";
    btn.style.color = "#fff";
    btn.style.border = "1px solid rgba(255,255,255,.22)";
    btn.style.boxShadow = "0 3px 12px rgba(0,0,0,.45)";
    btn.style.fontWeight = "900";
    btn.style.fontSize = "14px";
    btn.style.lineHeight = "1";

    btn.onmouseenter = () => {
      btn.style.background = "rgba(255,60,60,.75)";
      btn.style.borderColor = "rgba(255,60,60,.55)";
    };
    btn.onmouseleave = () => {
      btn.style.background = "rgba(0,0,0,.72)";
      btn.style.borderColor = "rgba(255,255,255,.22)";
    };

    btn.onclick = (e) => {
      if (e && typeof e.stopPropagation === "function") e.stopPropagation();
      deleteSinglePolygonOnly(polygon);
    };

    return new kakao.maps.CustomOverlay({
      position: pos,
      content: btn,
      xAnchor: 0.5,
      yAnchor: 0.5,
      zIndex: 30
    });
  }

  function rebuildDeleteOverlays() {
    clearDeleteOverlays();
    if (!selectedRouteId) return;
    if (!editPolygons || editPolygons.length === 0) return;

    for (const p of editPolygons) {
      const overlay = createDeleteOverlayForPolygon(p);
      if (!overlay) continue;
      overlay.setMap(map);
      deleteOverlays.push(overlay);
    }
  }

  function deleteSinglePolygonOnly(targetPolygon) {
    if (!selectedRouteId || !overlayById.has(selectedRouteId)) return;

    const pack = overlayById.get(selectedRouteId);
    if (!pack || !pack.polygons) return;

    targetPolygon.setMap(null);

    pack.polygons = pack.polygons.filter(p => p !== targetPolygon);
    editPolygons = editPolygons.filter(p => p !== targetPolygon);

    if (pack.polygons.length === 0) {
      updateSelectedLabels();
      stopEditing();
      setStatus("í•´ë‹¹ ë¼ìš°íŠ¸ì˜ êµ¬ì—­ì´ ëª¨ë‘ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥í•˜ë©´ ë°˜ì˜ë©ë‹ˆë‹¤.", "WARN");
      return;
    }

    updateSelectedLabels();
    rebuildHandles();
    setStatus("êµ¬ì—­ 1ê°œ ì œê±°(ë¡œì»¬). ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°˜ì˜í•˜ì„¸ìš”.", "OK");
  }

  // ====== âœ… ê²€ìƒ‰ ì„ íƒ ë§ˆì»¤ ìœ í‹¸ (ESCë¡œ ì‚­ì œ) ======
  function clearSearchSelectedMarker() {
    if (searchSelectedMarker) {
      searchSelectedMarker.setMap(null);
      searchSelectedMarker = null;
    }
    if (searchSelectedOverlay) {
      if (typeof searchSelectedOverlay.setMap === "function") searchSelectedOverlay.setMap(null);
      if (typeof searchSelectedOverlay.close === "function") searchSelectedOverlay.close();
      searchSelectedOverlay = null;
    }
  }

  function setSearchSelectedMarker(latlng) {
    clearSearchSelectedMarker();
    searchSelectedMarker = new kakao.maps.Marker({
      position: latlng,
      zIndex: 999
    });
    searchSelectedMarker.setMap(map);
  }

  // ====== ë°ì´í„° í‘œì‹œ ======
  function renderRoutes(rows) {
    clearAllOverlays();
    routeRows = rows || [];

    const displayColorMap = buildDisplayColors(routeRows);

    if (!routeRows.length) {
      setStatus("í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", "WARN");
      return;
    }

    let bounds = new kakao.maps.LatLngBounds();
    let any = false;

    for (const row of routeRows) {
      const id = row.id;
      const code = row.full_code || row.code || row.route_code || "";
      const camp = row.camp || row.camp_name || "";
      const colorMap = displayColorMap;
      const idKey = (typeof id === "number" || typeof id === "string") ? id : code;
      const color = (colorMap && colorMap.get(idKey)) || colorFor(code);
      row.color = color;
      const debugId = `${camp}/${code}(id=${id})`;

      const poly = parsePolygonWgs84(row.polygon_wgs84, debugId);

      const polygons = [];
      const labels = [];

      if (poly && Array.isArray(poly) && poly.length > 0) {
        let rings = [];

        const first = poly[0];
        if (first && typeof first === 'object' && 'lat' in first && 'lng' in first) {
          rings = [poly];
        } else if (Array.isArray(first)) {
          const firstOfFirst = first[0];
          if (firstOfFirst && typeof firstOfFirst === 'object' && 'lat' in firstOfFirst && 'lng' in firstOfFirst) {
            rings = poly;
          } else if (Array.isArray(firstOfFirst) && firstOfFirst.length >= 2) {
            rings = poly;
          } else if (typeof firstOfFirst === 'number') {
            rings = [poly];
          }
        }

        for (let i=0; i<rings.length; i++) {
          const ring = rings[i];
          if (!Array.isArray(ring) || ring.length < 3) continue;

          const latlngs = ring.map(pt => {
            if (pt && typeof pt === 'object' && 'lat' in pt && 'lng' in pt) {
              return new kakao.maps.LatLng(pt.lat, pt.lng);
            } else if (Array.isArray(pt) && pt.length >= 2) {
              return new kakao.maps.LatLng(pt[1], pt[0]);
            }
            return null;
          }).filter(ll => ll !== null);

          if (latlngs.length < 3) continue;
          const p = makePolygon(latlngs, color, color, 1);
          p.setMap(map);

          kakao.maps.event.addListener(p, "click", () => {
            if (drawMode || roadviewOn || searchModalOpen) return;
            selectRoute(id);
          });

          polygons.push(p);
          any = true;
          latlngs.forEach(ll => bounds.extend(ll));


        }
      }

      // âœ… ë¼ìš°íŠ¸/ë²¤ë” ë¼ë²¨ - í´ë¦¬ê³¤ ì¡°ê°ë³„ í‘œê¸°
      if ((labelOn || vendorLabelOn) && polygons.length > 0) {
        const opts = { showCode: labelOn, showVendor: vendorLabelOn };

        // âœ… í´ë¦¬ê³¤ì´ ì—¬ëŸ¬ ì¡°ê°(ë–¨ì–´ì§„ êµ¬ì—­)ì¸ ê²½ìš°: ì¡°ê°ë³„ë¡œ ë¼ë²¨ ê°ê° í‘œê¸°
        if (polygons.length === 1) {
          const pos =
            normalizeCenterWgs84(row.center_wgs84) ||
            centroidOfLatLngs(getPolygonPathAsArray(polygons[0]));
          const label = createLabelOverlay(code, row, pos, color, opts);
          label.setMap(map);
          labels.push(label);
        } else {
          for (const p of polygons) {
            const pos = centroidOfLatLngs(getPolygonPathAsArray(p));
            const label = createLabelOverlay(code, row, pos, color, opts);
            label.setMap(map);
            labels.push(label);
          }
        }
      }

      overlayById.set(id, { row, polygons, labels });
    }

    if (any) {
      map.setBounds(bounds);
      setStatus(`${routeRows.length}ê°œ ë¼ìš°íŠ¸ ë¡œë“œ ì™„ë£Œ`, "OK");
    } else {
      setStatus(`í´ë¦¬ê³¤ ë°ì´í„° ì—†ìŒ. ìƒˆë¡œ ê·¸ë¦¬ê¸°ë¡œ ìƒì„±í•˜ì„¸ìš”.`, "WARN");
    }
  }

  // ====== í¸ì§‘(ë²„í…ìŠ¤ í•¸ë“¤) ======
  let VERTEX_IMG = null;
  let MID_IMG = null;

  function makeHandleImage(fill="#ffffff", stroke="#111827") {
    const svg =
      `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12">
        <circle cx="6" cy="6" r="5" fill="${fill}" stroke="${stroke}" stroke-width="1.5"/>
      </svg>`;
    const uri = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    return new kakao.maps.MarkerImage(uri, new kakao.maps.Size(12,12), { offset: new kakao.maps.Point(6,6) });
  }

  function makeLabelAnchorImage() {
    const svg =
      `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14">
        <circle cx="7" cy="7" r="6" fill="rgba(59,130,246,0.95)" stroke="#ffffff" stroke-width="2"/>
        <circle cx="7" cy="7" r="2" fill="#111827" opacity="0.9"/>
      </svg>`;
    const uri = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    return new kakao.maps.MarkerImage(uri, new kakao.maps.Size(14,14), { offset: new kakao.maps.Point(7,7) });
  }

  let labelAnchorMarker = null;
  let labelAnchorLatLng = null;
  let labelAnchorDirty = false;

  function stopLabelAnchorEdit() {
    if (labelAnchorMarker) {
      labelAnchorMarker.setMap(null);
      labelAnchorMarker = null;
    }
    labelAnchorLatLng = null;
    labelAnchorDirty = false;
  }

  function startLabelAnchorEdit(routeId) {
    stopLabelAnchorEdit();
    const pack = overlayById.get(routeId);
    if (!pack || !pack.polygons || pack.polygons.length === 0) return;

    const row = pack.row || {};
    const pos =
      normalizeCenterWgs84(row.center_wgs84) ||
      centroidOfLatLngs(pack.polygons[0].getPath());

    labelAnchorLatLng = pos;
    labelAnchorDirty = false;

    labelAnchorMarker = new kakao.maps.Marker({
      position: pos,
      image: makeLabelAnchorImage(),
      draggable: true,
      zIndex: 9999
    });
    labelAnchorMarker.setMap(map);

    const applyPos = (p) => {
      labelAnchorLatLng = p;
      labelAnchorDirty = true;

      // ì¦‰ì‹œ ë¼ë²¨ ìœ„ì¹˜ ë°˜ì˜ (ë³´ì´ëŠ” ê²½ìš°)
      if (pack.labels && pack.labels.length > 0) {
        pack.labels.forEach(l => l.setPosition(p));
      }
    };

    kakao.maps.event.addListener(labelAnchorMarker, "dragend", () => {
      applyPos(labelAnchorMarker.getPosition());
    });

    // ìš°í´ë¦­: ìë™ ì¤‘ì‹¬(centroid)ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
    kakao.maps.event.addListener(labelAnchorMarker, "rightclick", () => {
      const c = centroidOfLatLngs(pack.polygons[0].getPath());
      labelAnchorMarker.setPosition(c);
      applyPos(c);
    });
  }

  function vendorText(name, bn) {
    const n = (name ?? "").toString().trim();
    if (n) return n;
    const b = (bn ?? "").toString().trim();
    if (b) return "ì§€ì •ë¨";
    return "-";
  }

  function setVendorDisplayFromRow(row) {
    const name1 =
      row.vendor_name_1w ??
      row.vendor_1w_name ??
      row.vendor_week_name ??
      row.vendor_name_week ??
      null;
    const bn1 =
      row.vendor_business_number_1w ??
      row.vendor_business_number_week ??
      null;

    const name2 =
      row.vendor_name_2w ??
      row.vendor_2w_name ??
      row.vendor_night_name ??
      row.vendor_name_night ??
      null;
    const bn2 =
      row.vendor_business_number_2w ??
      row.vendor_business_number_night ??
      null;

    if (vendorWeekValue) vendorWeekValue.textContent = vendorText(name2, bn2);
    if (vendorNightValue) vendorNightValue.textContent = vendorText(name1, bn1);
  }

  function clearVendorDisplay() {
    if (vendorWeekValue) vendorWeekValue.textContent = "-";
    if (vendorNightValue) vendorNightValue.textContent = "-";
  }

  function applyBasePolygonStyle() {
    for (const {row, polygons} of overlayById.values()) {
      const base = row.color || colorFor(row.full_code || "");
      polygons.forEach(p => {
        p.setOptions({
          strokeColor: base,
          fillColor: base,
          strokeWeight: 1,
          fillOpacity: 0.24,
          zIndex: 1
        });
      });
    }
  }

  function applySelectionStyle(routeId) {
    if (!routeId) return;
    const pack = overlayById.get(routeId);
    if (!pack) return;
    const { row, polygons } = pack;
    const base = row.color || colorFor(row.full_code || "");
    polygons.forEach(p => {
      p.setOptions({ strokeColor: base, fillColor: base, strokeWeight: 3, fillOpacity: 0.24, zIndex: 5 });
    });
  }

  function stopEditing() {
    editHandles.forEach(m => m.setMap(null));
    editHandles = [];
    editPolygons = [];
    draggingVertex = null;
    if (map) map.setDraggable(true);

    clearDeleteOverlays();

    // âœ… í¸ì§‘ëª¨ë“œ ë¼ë²¨ ì•µì»¤ ë§ˆì»¤ ì •ë¦¬
    stopLabelAnchorEdit();

    editingRouteId = null;

    applyBasePolygonStyle();

    // âœ… ì„ íƒëœ ë¼ìš°íŠ¸ëŠ” "ì§„í•´ì§„ ìƒíƒœ" ìœ ì§€
    if (selectedRouteId && overlayById.has(selectedRouteId)) {
      applySelectionStyle(selectedRouteId);
    }
  }

  function selectRoute(routeId, { silent = false } = {}) {
    if (!overlayById.has(routeId)) return;

    if (roadviewOn) {
      setStatus("ë¡œë“œë·° ëª¨ë“œì—ì„œëŠ” ë¼ìš°íŠ¸ ì„ íƒë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (Enter í¸ì§‘ ë¶ˆê°€)", "WARN");
    }

    stopDraw(true);

    selectedRouteId = routeId;
    stopEditing(); // í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ + ì„ íƒ í•˜ì´ë¼ì´íŠ¸ ì ìš©

    const pack = overlayById.get(routeId);
    const { row } = pack;

    const code = row.full_code || row.code || row.route_code || "";
    const camp = row.camp || row.camp_name || "";
    selectedInfo.textContent = `ì„ íƒ: ${camp} / ${code} (id=${routeId})`;

    // ì¢Œì¸¡ ì…ë ¥ê°’ ë™ê¸°í™”
    campInput.value = camp;
    codeInput.value = code;

    setVendorDisplayFromRow(row);
    setDeliveryDisplayFromRow(row);

    loadAddresses().catch(err => log(`ë°°ì†¡ì§€ ë¡œë“œ ì‹¤íŒ¨: ${err.message}`));

    if (!silent) setStatus(`ì„ íƒë¨: ${code} (Enterë¡œ ìˆ˜ì • ëª¨ë“œ)`, "OK");
  }

  function startEditing(routeId) {
    if (!overlayById.has(routeId)) return;

    if (roadviewOn) {
      setStatus("ë¡œë“œë·° ëª¨ë“œì—ì„œëŠ” ìˆ˜ì • ëª¨ë“œë¡œ ì§„ì…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œë“œë·°ë¥¼ ì¢…ë£Œí•˜ì„¸ìš”.", "WARN");
      return;
    }
    if (searchModalOpen) closeSearchModal();

    stopDraw(true);

    selectedRouteId = routeId;
    stopEditing(); // ê¸°ì¡´ í¸ì§‘ ì •ë¦¬ + ì„ íƒ í•˜ì´ë¼ì´íŠ¸

    editingRouteId = routeId;

    const pack = overlayById.get(routeId);
    const { row, polygons } = pack;

    const code = row.full_code || row.code || row.route_code || "";
    const camp = row.camp || row.camp_name || "";
    selectedInfo.textContent = `ì„ íƒ: ${camp} / ${code} (id=${routeId})`;

    // ì¢Œì¸¡ ì…ë ¥ê°’ ë™ê¸°í™”
    campInput.value = camp;
    codeInput.value = code;

    setVendorDisplayFromRow(row);
    setDeliveryDisplayFromRow(row);

    if (!polygons || polygons.length === 0) {
      setStatus(`ì„ íƒ ëŒ€ìƒ ${code}ëŠ” polygonì´ ì—†ìŠµë‹ˆë‹¤. "ìƒˆë¡œ ê·¸ë¦¬ê¸°"ë¡œ ìƒì„±í•˜ì„¸ìš”.`, "WARN");
      return;
    }

    // í¸ì§‘ìš© í´ë¦¬ê³¤ ëª©ë¡
    editPolygons = polygons.slice();

    rebuildHandles();

    // âœ… ìš”ì²­ì‚¬í•­: í¸ì§‘ëª¨ë“œ ë¼ë²¨ ìœ„ì¹˜ ìˆ˜ì • ê¸°ëŠ¥ì€ ì ê¹ ì£¼ì„ì²˜ë¦¬(ë¹„í™œì„±) â€” ìë™ ë¼ë²¨(ì¡°ê°ë³„) í‘œê¸° ìš°ì„ 
    if (LABEL_ANCHOR_EDIT_ENABLED) startLabelAnchorEdit(routeId);
    else stopLabelAnchorEdit();

    setStatus(`í¸ì§‘ ëª¨ë“œ: ${code} (Enter=ì €ì¥ Â· ESC=ì¢…ë£Œ)`, "OK");
  }

  function rebuildHandles() {
    editHandles.forEach(m => m.setMap(null));
    editHandles = [];

    for (const polygon of editPolygons) {
      const rawPath = polygon.getPath();
      if (!rawPath) {
        log(`âš  rebuildHandles: polygon.getPath()ê°€ null`);
        continue;
      }

      const path = [];
      const len = Array.isArray(rawPath) ? rawPath.length : (rawPath.getLength ? rawPath.getLength() : 0);
      for (let i = 0; i < len; i++) {
        path.push(Array.isArray(rawPath) ? rawPath[i] : rawPath.getAt(i));
      }

      if (path.length < 3) continue;

      for (let i=0;i<path.length;i++) {
        ((index, polygon) => {
          const vMarker = new kakao.maps.Marker({
            position: path[index],
            image: VERTEX_IMG,
            clickable: true,
            zIndex: 20
          });

          vMarker.setMap(map);

          kakao.maps.event.addListener(vMarker, "mousedown", (e) => {
            if (roadviewOn || searchModalOpen) return;
            draggingVertex = { marker: vMarker, polygon, index };
            map.setDraggable(false);

            if (e && e.domEvent) {
              e.domEvent.preventDefault();
              e.domEvent.stopPropagation();
            }
          });

          kakao.maps.event.addListener(vMarker, "rightclick", () => {
            const pth = polygon.getPath();
            const len = Array.isArray(pth) ? pth.length : (pth.getLength ? pth.getLength() : 0);
            if (len <= 3) {
              setStatus("ì  ì‚­ì œ ë¶ˆê°€: ìµœì†Œ 3ê°œ ê¼­ì§“ì  ìœ ì§€ í•„ìš”", "WARN");
              return;
            }
            const pathArray = [];
            for (let j = 0; j < len; j++) {
              if (j !== index) {
                pathArray.push(Array.isArray(pth) ? pth[j] : pth.getAt(j));
              }
            }
            polygon.setPath(pathArray);
            updateSelectedLabels();
            rebuildHandles();
          });

          editHandles.push(vMarker);
        })(i, polygon);
      }

      for (let i=0;i<path.length;i++) {
        ((index, polygon) => {
          const a = path[index];
          const b = path[(index+1)%path.length];

          const mid = new kakao.maps.LatLng(
            (a.getLat()+b.getLat())/2,
            (a.getLng()+b.getLng())/2
          );

          const midMarker = new kakao.maps.Marker({
            position: mid,
            clickable: true,
            image: MID_IMG,
            zIndex: 19
          });
          midMarker.setMap(map);

          kakao.maps.event.addListener(midMarker, "click", () => {
            const pth = polygon.getPath();
            const len = Array.isArray(pth) ? pth.length : (pth.getLength ? pth.getLength() : 0);
            const pathArray = [];
            for (let j = 0; j < len; j++) {
              pathArray.push(Array.isArray(pth) ? pth[j] : pth.getAt(j));
              if (j === index) {
                pathArray.push(mid);
              }
            }
            polygon.setPath(pathArray);
            updateSelectedLabels();
            rebuildHandles();
          });

          editHandles.push(midMarker);
        })(i, polygon);
      }
    }

    rebuildDeleteOverlays();
  }

  function updateSelectedLabels() {
    // ê¸°ì¡´: ì„ íƒ ë¼ìš°íŠ¸ ë¼ë²¨ ì¬ìƒì„±. í˜„ì¬ëŠ” ì „ì²´ ë¼ë²¨ì„ ê°€ë³ê²Œ ë¦¬í”„ë ˆì‹œ.
    if (!(labelOn || vendorLabelOn)) return;
    refreshLabelsOnly();
  }
      

  // ====== ê·¸ë¦¬ê¸° ëª¨ë“œ ======
  function stopDraw(silent=false) {
    drawMode = null;
    drawPoints = [];
    drawMarkers.forEach(m => m.setMap(null));
    drawMarkers = [];
    if (drawLine) { drawLine.setMap(null); drawLine = null; }
    hint("", false);
}

  function beginDraw(mode) {
    const camp = campInput.value.trim();
    const code = codeInput.value.trim();
    if (!camp) { setStatus("campê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
    if (!code) { setStatus("codeê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤. (ìƒˆë¡œ ê·¸ë¦¬ê¸°/êµ¬ì—­ ì¶”ê°€ëŠ” code í•„ìˆ˜)", "ERR"); return; }

    if (roadviewOn) {
      setStatus("ë¡œë“œë·° ëª¨ë“œì—ì„œëŠ” ê·¸ë¦¬ê¸°ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œë“œë·°ë¥¼ ì¢…ë£Œí•˜ì„¸ìš”.", "WARN");
      return;
    }
    if (searchModalOpen) closeSearchModal();

    stopEditing();
    stopDraw(true);

    drawMode = mode;
    drawPoints = [];
    drawMarkers = [];

    if (drawLine) drawLine.setMap(null);
    drawLine = new kakao.maps.Polyline({
      path: [],
      strokeWeight: 1,
      strokeColor: "#00C2FF",
      strokeOpacity: 0.9,
      strokeStyle: "shortdash"
    });
    drawLine.setMap(map);

    hint("ê·¸ë¦¬ê¸° ëª¨ë“œ: ì§€ë„ í´ë¦­ìœ¼ë¡œ ì  ì¶”ê°€ Â· Enterí‚¤ë¡œ ì™„ë£Œ Â· ìš°í´ë¦­ìœ¼ë¡œ ë§ˆì§€ë§‰ ì  ì·¨ì†Œ Â· ESCë¡œ ì·¨ì†Œ", true);
    setStatus(mode === "new" ? "ìƒˆë¡œ ê·¸ë¦¬ê¸° ì‹œì‘" : "êµ¬ì—­ ì¶”ê°€ ì‹œì‘", "OK");
  }

  function addDrawPoint(latlng) {
    drawPoints.push(latlng);

    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10">
      <circle cx="5" cy="5" r="4" fill="#00C2FF" stroke="#0b1220" stroke-width="1.5"/>
    </svg>`;
    const markerImageSrc = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    const markerImage = new kakao.maps.MarkerImage(markerImageSrc, new kakao.maps.Size(10, 10), {
      offset: new kakao.maps.Point(5, 5)
    });

    const m = new kakao.maps.Marker({
      position: latlng,
      image: markerImage,
      zIndex: 30
    });
    m.setMap(map);
    drawMarkers.push(m);

    drawLine.setPath(drawPoints);
  }

  function popDrawPoint() {
    if (drawPoints.length === 0) return;
    drawPoints.pop();
    const m = drawMarkers.pop();
    if (m) m.setMap(null);
    drawLine.setPath(drawPoints);
  }

  function finishDraw() {
    if (drawPoints.length < 3) {
      setStatus("í´ë¦¬ê³¤ ìƒì„± ì‹¤íŒ¨: ì ì´ 3ê°œ ì´ìƒ í•„ìš”", "WARN");
      return;
    }

    const camp = campInput.value.trim();
    const code = codeInput.value.trim();
    const color = colorFor(code);

    let rowId = selectedRouteId;
    let row = null;

    if (rowId && overlayById.has(rowId)) {
      row = overlayById.get(rowId).row;
    }

    if (drawMode === "new") {
      if (rowId && overlayById.has(rowId)) {
        const pack = overlayById.get(rowId);
        pack.polygons.forEach(p => p.setMap(null));
        pack.labels.forEach(l => l.setMap(null));
        pack.polygons = [];
        pack.labels = [];
      } else {
        for (const [id, pack] of overlayById.entries()) {
          const r = pack.row;
          if ((r.camp||"") === camp && (r.full_code||"") === code) {
            rowId = id;
            pack.polygons.forEach(p => p.setMap(null));
            pack.labels.forEach(l => l.setMap(null));
            pack.polygons = [];
            pack.labels = [];
            break;
          }
        }
      }
    }

    const poly = makePolygon(drawPoints.slice(), color, color, 5);
    poly.setMap(map);
    kakao.maps.event.addListener(poly, "click", () => {
      if (!rowId) return;
      if (drawMode || roadviewOn || searchModalOpen) return;
      selectRoute(rowId);
    });

    if (!rowId) {
      rowId = `tmp_${camp}_${code}`;
      overlayById.set(rowId, {
        row: {
          id: rowId,
          camp,
          full_code: code,
          color,
          polygon_wgs84: null,
          vendor_business_number_1w: null,
          vendor_business_number_2w: null,
          vendor_name_1w: null,
          vendor_name_2w: null,
          delivery_location_name: resolveDeliveryLocationName(),
          delivery_location_address: deliveryAddrInput.value.trim()
        },
        polygons: [],
        labels: []
      });
    }

    const pack = overlayById.get(rowId);
    pack.row.camp = camp;
    pack.row.full_code = code;
    pack.row.color = color;

    pack.polygons.push(poly);

    if (labelOn || vendorLabelOn) {
      const c = centroidOfLatLngs(drawPoints);
      const label = createLabelOverlay(code, pack.row, c, color, { showCode: labelOn, showVendor: vendorLabelOn });
      label.setMap(map);
      pack.labels.push(label);
    }

    stopDraw(true);
    selectedRouteId = rowId;
    selectedInfo.textContent = `ì„ íƒ: ${camp} / ${code} (id=${rowId})`;
    editPolygons = pack.polygons.slice();
    rebuildHandles();
    hint("", false);

    setStatus(`í´ë¦¬ê³¤ ìƒì„± ì™„ë£Œ: ${drawMode === "new" ? "êµì²´" : "ì¶”ê°€"} 1ê°œ`, "OK");
  }

  // ====== ì €ì¥ ë°ì´í„° ë§Œë“¤ê¸° ======
  function getCurrentEditedPolygonWgs84ById(id) {
    const pack = overlayById.get(id);
    if (!pack) return null;
    const polys = pack.polygons;
    if (!polys || polys.length === 0) return null;

    const out = [];
    for (const p of polys) {
      const pathRaw = p.getPath();
      const path = [];
      if (pathRaw && typeof pathRaw.getLength === "function") {
        for (let i=0;i<pathRaw.getLength();i++) path.push(pathRaw.getAt(i));
      } else if (Array.isArray(pathRaw)) {
        path.push(...pathRaw);
      }
      if (!path || path.length < 3) continue;

      const ring = [];
      for (let i=0;i<path.length;i++) {
        const ll = path[i];
        ring.push([ ll.getLng(), ll.getLat() ]);
      }
      out.push(ring);
    }
    return out.length ? out : null;
  }

  // ====== ë°°ì†¡ì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ======
  async function loadAddresses() {
    try {
      const camp = campInput.value.trim();
      const code = codeInput.value.trim();
      if (!camp) return;

      const url = new URL(ADDRESS_ENDPOINT);
      url.searchParams.set("camp", camp);
      if (code) url.searchParams.set("code", code);

      const data = await apiGet(url.toString());
      addressRows = data?.rows || [];

      renderAddressList();
      log(`ë°°ì†¡ì§€ ${addressRows.length}ê°œ ë¡œë“œ ì™„ë£Œ`);
    } catch (e) {
      console.error('ë°°ì†¡ì§€ ë¡œë“œ ì‹¤íŒ¨:', e);
      addressRows = [];
      renderAddressList();
    }
  }

  // ====== ë°°ì†¡ì§€ ëª©ë¡ ë Œë”ë§ ======
  function renderAddressList() {
    const container = document.getElementById("addressList");
    const group = document.getElementById("addressListGroup");

    if (!addressRows || addressRows.length === 0) {
      group.style.display = "none";
      container.innerHTML = "";
      return;
    }

    group.style.display = "block";
    container.innerHTML = "";

    addressRows.forEach((addr, idx) => {
      const item = document.createElement("div");
      item.style.cssText = `
        padding: 8px;
        margin-bottom: 6px;
        background: rgba(0,0,0,0.15);
        border: 1px solid var(--line);
        border-radius: 8px;
        font-size: 12px;
      `;

      const addressText = addr.address || addr.full_address || "ì£¼ì†Œ ì—†ìŒ";
      const dong = addr.dong ? `<span style="color:var(--muted)">(${addr.dong})</span>` : "";

      item.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
          <div style="flex:1; min-width:0;">
            <div style="font-weight:600; color:var(--txt); margin-bottom:2px;">
              ${idx + 1}. ${addressText} ${dong}
            </div>
            <div style="color:var(--muted); font-size:11px;">
              ${addr.zipcode ? `ìš°í¸ë²ˆí˜¸: ${addr.zipcode}` : ""}
            </div>
          </div>
          <button class="btn" style="padding:6px 12px; font-size:11px; white-space:nowrap;">
            ë„¤ë¹„
          </button>
        </div>
      `;

      const naviBtn = item.querySelector("button");
      naviBtn.onclick = () => openNaviToAddress(addr);

      container.appendChild(item);
    });
  }

  // ====== ë°°ì†¡ì§€ë¡œ ë„¤ë¹„ ì‹¤í–‰ ======
  async function openNaviToAddress(addr) {
    const deliveryAddr = deliveryAddrInput.value.trim();

    if (!deliveryAddr) {
      setStatus("ì…ì°¨ì§€ë¥¼ ë¨¼ì € ê²€ìƒ‰/ì„ íƒí•´ì£¼ì„¸ìš”.", "WARN");
      return;
    }

    if (!addr.center_wgs84) {
      setStatus("ë°°ì†¡ì§€ ì¢Œí‘œ(center_wgs84)ê°€ ì—†ìŠµë‹ˆë‹¤.", "ERR");
      return;
    }

    setStatus(`ê²½ë¡œ ê³„ì‚° ì¤‘: ì…ì°¨ì§€ â†’ ${addr.address || "ë°°ì†¡ì§€"}`, "OK");

    geocoder.addressSearch(deliveryAddr, (result, status) => {
      if (status !== kakao.maps.services.Status.OK || !result?.length) {
        setStatus("ì…ì°¨ì§€ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "ERR");
        return;
      }

      const startLat = Number(result[0].y);
      const startLng = Number(result[0].x);

      let endLat, endLng;

      if (typeof addr.center_wgs84 === 'object') {
        endLat = addr.center_wgs84.lat || addr.center_wgs84.latitude;
        endLng = addr.center_wgs84.lng || addr.center_wgs84.lon || addr.center_wgs84.longitude;
      } else if (Array.isArray(addr.center_wgs84) && addr.center_wgs84.length >= 2) {
        const [first, second] = addr.center_wgs84;
        if (Math.abs(first) > Math.abs(second)) {
          endLng = first;
          endLat = second;
        } else {
          endLat = first;
          endLng = second;
        }
      }

      if (!endLat || !endLng || !isFinite(endLat) || !isFinite(endLng)) {
        setStatus("ë°°ì†¡ì§€ ì¢Œí‘œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.", "ERR");
        log(`center_wgs84: ${JSON.stringify(addr.center_wgs84)}`);
        return;
      }

      const deliveryName = deliveryNameInput.value.trim() || "ì…ì°¨ì§€";
      const addressName = addr.address || "ë°°ì†¡ì§€";

      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      let naviUrl;
      if (isMobile) {
        naviUrl = `kakaomap://route?sp=${startLat},${startLng}&ep=${endLat},${endLng}&by=CAR`;
      } else {
        naviUrl = `https://map.kakao.com/link/from/${encodeURIComponent(deliveryName)},${startLat},${startLng}/to/${encodeURIComponent(addressName)},${endLat},${endLng}`;
      }

      window.open(naviUrl, "_blank");
      setStatus(`ë„¤ë¹„ ì‹¤í–‰: ${deliveryName} â†’ ${addressName}`, "OK");
      log(`ê²½ë¡œ: (${startLat.toFixed(4)}, ${startLng.toFixed(4)}) â†’ (${endLat.toFixed(4)}, ${endLng.toFixed(4)})`);
    });
  }

  // ====== ë¶ˆëŸ¬ì˜¤ê¸° ======
  async function loadRoutes() {
    try {
      stopEditing();
      stopDraw(true);
      hint("", false);
      clearOsm();

      const camp = campInput.value.trim();
      const code = codeInput.value.trim();
      if (!camp) { setStatus("campê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }

      const codes = code ? code.split(/[,\s]+/).map(c => c.trim()).filter(c => c) : [];

      let allRows = [];

      if (codes.length === 0) {
        const url = new URL(ROUTE_ENDPOINT);
        url.searchParams.set("camp", camp);
        url.searchParams.set("mode", "prefix");
const data = await apiGet(url.toString());
        if (!data || !data.rows) {
          setStatus("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜", "ERR");
          return;
        }
        allRows = data.rows;
      } else if (codes.length === 1) {
        const url = new URL(ROUTE_ENDPOINT);
        url.searchParams.set("camp", camp);
        url.searchParams.set("mode", "prefix");
        url.searchParams.set("code", codes[0]);
const data = await apiGet(url.toString());
        if (!data || !data.rows) {
          setStatus("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜", "ERR");
          return;
        }
        allRows = data.rows;
      } else {
        setStatus(`${codes.length}ê°œ ë¼ìš°íŠ¸ ì¡°íšŒ ì¤‘...`, "OK");

        for (const singleCode of codes) {
          try {
            const url = new URL(ROUTE_ENDPOINT);
            url.searchParams.set("camp", camp);
            url.searchParams.set("mode", "prefix");
            url.searchParams.set("code", singleCode);
const data = await apiGet(url.toString());

            if (data && data.rows && data.rows.length > 0) {
              allRows.push(...data.rows);
              log(`${singleCode}: ${data.rows.length}ê°œ ë°œê²¬`);
            } else {
              log(`${singleCode}: ë°ì´í„° ì—†ìŒ`);
            }
          } catch (err) {
            log(`${singleCode}: ì¡°íšŒ ì‹¤íŒ¨ - ${err.message}`);
          }
        }
      }

      if (allRows.length === 0) {
        setStatus("ì¡°íšŒëœ ë¼ìš°íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.", "WARN");
        clearAllOverlays();
        return;
      }


      // âœ… í‘œì‹œìš© ì»¬ëŸ¬ ì¬ë¶€ì—¬ (DBì— ì €ì¥í•˜ì§€ ì•ŠìŒ)
      // full_code ì •ë ¬ ê¸°ì¤€ìœ¼ë¡œ ì¸ì ‘ ë¼ìš°íŠ¸ ìƒ‰ì´ ë¹„ìŠ·í•´ì§€ì§€ ì•Šë„ë¡ ë¶„ì‚°í•©ë‹ˆë‹¤.
      try {
        const codesSorted = Array.from(
          new Set(
            (allRows || [])
              .map(r => (r.full_code || r.code || "").toString().trim())
              .filter(Boolean)
          )
        ).sort((a,b)=> a.localeCompare(b, "en", {numeric:true, sensitivity:"base"}));

        const colorMap = new Map();
        for (let i=0; i<codesSorted.length; i++) {
          const hue = (i * GOLDEN_ANGLE) % 360;
          const sat = 42 + (i % 7) * 2;    // 42-54 (ì ë‹¹í•œ ì±„ë„)
          const light = 48 + (i % 5) * 2;  // 48-56 (ì¤‘ì €ëª…ë„)
          colorMap.set(codesSorted[i], hslToHex(hue, sat, light));
        }

        for (const r of allRows) {
          const c = (r.full_code || r.code || "").toString().trim();
          r.color = colorMap.get(c) || colorFor(c);
        }
      } catch (e) {
        // color ì‹¤íŒ¨í•´ë„ ë¡œë”©ì€ ì§„í–‰
      }

      renderRoutes(allRows);
      await loadAddresses();
    } catch (e) {
      console.error(e);
      const errMsg = e.message || String(e);
      setStatus(`ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${errMsg}`, "ERR");
    }
  }

  // ====== ì €ì¥(POST) ======
  async function saveCurrent() {
    try {
      const camp = campInput.value.trim();
      const code = codeInput.value.trim();
      if (!camp) { setStatus("campê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
      if (!code) { setStatus("codeê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }

      let id = selectedRouteId;
      if (!id || !overlayById.has(id)) {
        for (const [rid, pack] of overlayById.entries()) {
          if ((pack.row.camp||"") === camp && (pack.row.full_code||"") === code) {
            id = rid;
            break;
          }
        }
      }

      const polygonSourceId = id;
      let actualId = id;

      if (actualId && typeof actualId === "string" && actualId.startsWith("tmp_")) {
        const actualRow = routeRows.find(r =>
          (r.camp||"") === camp && (r.full_code||"") === code
        );
        if (actualRow && typeof actualRow.id === "number") {
          actualId = actualRow.id;
          log(`ì„ì‹œ IDë¥¼ ì‹¤ì œ IDë¡œ ë³€í™˜: ${polygonSourceId} â†’ ${actualId}`);
        } else {
          actualId = undefined;
          log(`ì‹¤ì œ rowê°€ ì—†ìŒ. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.`);
        }
      }

      const polygon_wgs84 = polygonSourceId ? getCurrentEditedPolygonWgs84ById(polygonSourceId) : null;

      if (!actualId) {
        const existingRow = routeRows.find(r => {
          const rCamp = r.camp || r.camp_name || "";
          const rCode = r.full_code || r.code || r.route_code || "";
          return rCamp === camp && rCode === code;
        });
        if (existingRow && typeof existingRow.id === "number") {
          actualId = existingRow.id;
        }
      }

      const payload = {
        camp,
        code,
        polygon_wgs84,
        delivery_location_name: resolveDeliveryLocationName() || null
      };

      if (typeof actualId === "number") payload.id = actualId;

      await apiJson("POST", ROUTE_ENDPOINT, payload);
      setStatus(`ì €ì¥ ì™„ë£Œ`, "OK");

      await loadRoutes();
    } catch (e) {
      console.error(e);
      setStatus(`ì €ì¥ ì‹¤íŒ¨: ${e.message}`, "ERR");
    }
  }

  // ====== í´ë¦¬ê³¤ ì‚­ì œ (polygon_wgs84=null) ======
  async function deletePolygon() {
    try {
      const camp = campInput.value.trim();
      const code = codeInput.value.trim();
      if (!camp) { setStatus("campê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
      if (!code) { setStatus("codeê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }

      let id = selectedRouteId;
      const payload = (typeof id === "number") ? { id } : { camp, code };

      setStatus("DELETE /route ìš”ì²­ (polygon_wgs84=null)", "OK");
      await apiJson("DELETE", ROUTE_ENDPOINT, payload);
      setStatus("í´ë¦¬ê³¤ ì‚­ì œ ì™„ë£Œ", "OK");

      await loadRoutes();
    } catch (e) {
      console.error(e);
      setStatus(`í´ë¦¬ê³¤ ì‚­ì œ ì‹¤íŒ¨: ${e.message}`, "ERR");
    }
  }

  // ====== âœ… ë²¤ë” ê²€ìƒ‰/ì„ íƒ/ì €ì¥(1W/2W) ======
  let vendorModalOpen = false;
  let waveModalOpen = false;
  let waveModalAction = null; // "save" | "clear"

  function normalizeVendor(v) {
    if (!v || typeof v !== "object") return null;
    const name = (v.name ?? v.vendor_name ?? "").toString().trim();
    const business_number = (v.business_number ?? v.vendor_business_number ?? v.businessNumber ?? "").toString().trim();
    const vendor_code = (v.vendor_code ?? v.vendorCode ?? "").toString().trim();
    if (!name) return null;
    return { name, business_number, vendor_code };
  }

  async function apiCreateVendor(payload) {
    const data = await apiJson("POST", VENDORS_ENDPOINT, payload || {});
    const created = normalizeVendor(data?.row || data);
    if (!created || !created.business_number) {
      throw new Error("ë²¤ë” ìƒì„± ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
    return created;
  }

  function onVendorPicked(v, silent = false) {
    const normalized = normalizeVendor(v);
    if (!normalized) return;
    setVendorCandidate(normalized);
    if (!silent) {
      const bn = normalized.business_number ? ` (${normalized.business_number})` : "";
      setStatus(`ë²¤ë” ì„ íƒ: ${normalized.name}${bn}`, "OK");
    }
  }

  function setVendorCandidate(v) {
    vendorCandidate = v || null;

    if (!vendorPickedWrap || !vendorPickedText) return;

    if (!vendorCandidate) {
      vendorPickedWrap.style.display = "none";
      vendorPickedText.textContent = "";
      return;
    }

    const bn = vendorCandidate.business_number ? ` (${vendorCandidate.business_number})` : "";
    vendorPickedText.textContent = `ë²¤ë” ì„ íƒë¨: ${vendorCandidate.name || "-"}${bn}`;
    vendorPickedWrap.style.display = "flex";
  }

  if (vendorPickedClearBtn) {
    vendorPickedClearBtn.addEventListener("click", (e) => {
      e.preventDefault();
      setVendorCandidate(null);
    });
  }

  function openVendorModal(list, q="") {
    if (!vendorModalEl || !vendorResultsEl) return;

    vendorModalOpen = true;
    vendorModalEl.style.display = "flex";
    vendorModalEl.setAttribute("aria-hidden", "false");

    const safeList = Array.isArray(list) ? list : [];
    if (vendorMetaCountEl) vendorMetaCountEl.textContent = `${safeList.length}ê°œ`;

    // ê²°ê³¼ ì˜ì—­
    vendorResultsEl.innerHTML = "";

    // í˜„ì¬ ì„ íƒëœ ë²¤ë”(í›„ë³´) í‘œì‹œ + í•´ì œ(X)
    if (vendorCandidate && (vendorCandidate.name || vendorCandidate.business_number)) {
      const sel = document.createElement("div");
      sel.className = "pillRow";
      sel.style.marginBottom = "10px";

      const bn = vendorCandidate.business_number ? ` (${vendorCandidate.business_number})` : "";
      const t = document.createElement("div");
      t.textContent = `ì„ íƒë¨: ${vendorCandidate.name || "-"}${bn}`;

      const x = document.createElement("button");
      x.className = "pillX";
      x.type = "button";
      x.title = "ì„ íƒ í•´ì œ";
      x.textContent = "âœ•";
      x.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        setVendorCandidate(null);
        openVendorModal(safeList, q);
      });

      sel.appendChild(t);
      sel.appendChild(x);
      vendorResultsEl.appendChild(sel);
    }

    if (safeList.length === 0) {
      const empty = document.createElement("div");
      empty.className = "emptyMsg";
      empty.textContent = `ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ : "${q || ""}"`;
      vendorResultsEl.appendChild(empty);
    } else {
      for (const v of safeList) {
        const card = document.createElement("div");
        card.className = "resultCard";

        const left = document.createElement("div");
        left.className = "resultLeft";

        const title = document.createElement("div");
        title.className = "resultTitle";
        title.textContent = v?.name || "-";

        const meta = document.createElement("div");
        meta.className = "resultSub";
        // âœ… vendor_codeëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
        meta.textContent = `ì‚¬ì—…ìë²ˆí˜¸: ${v?.business_number || "-"}`;

        left.appendChild(title);
        left.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "resultActions";

        const isSel =
          !!vendorCandidate &&
          String(v?.business_number || "") === String(vendorCandidate?.business_number || "") &&
          String(v?.name || "") === String(vendorCandidate?.name || "");

        const selectBtn = document.createElement("button");
        selectBtn.className = "miniBtn";
        selectBtn.textContent = isSel ? "ì„ íƒë¨" : "ì„ íƒ";
        if (isSel) selectBtn.disabled = true;
        selectBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          setVendorCandidate(v);
          closeVendorModal();
        });

        const clearBtn = document.createElement("button");
        clearBtn.className = "miniX";
        clearBtn.type = "button";
        clearBtn.title = "ì„ íƒ í•´ì œ";
        clearBtn.textContent = "âœ•";
        clearBtn.style.display = isSel ? "inline-flex" : "none";
        clearBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          setVendorCandidate(null);
          openVendorModal(safeList, q);
        });

        actions.appendChild(selectBtn);
        actions.appendChild(clearBtn);

        card.appendChild(left);
        card.appendChild(actions);
        vendorResultsEl.appendChild(card);
      }
    }

    // ì‹ ê·œ ë“±ë¡ ì„¹ì…˜ (ê²€ìƒ‰ ê²°ê³¼ ìœ ë¬´ì™€ ë¬´ê´€í•˜ê²Œ í•­ìƒ ë…¸ì¶œ)
    {
      const divider = document.createElement("div");
      divider.style.marginTop = "14px";
      divider.style.paddingTop = "12px";
      divider.style.borderTop = "1px solid rgba(255,255,255,.10)";
      vendorResultsEl.appendChild(divider);

      const box = document.createElement("div");
      box.className = "createBox";

      const head = document.createElement("div");
      head.className = "createHead";
      head.textContent = "ì‹ ê·œ ë²¤ë” ë“±ë¡";

      const desc = document.createElement("div");
      desc.className = "createDesc";
      desc.textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ë„ ì—¬ê¸°ì„œ ë°”ë¡œ ë“±ë¡í•  ìˆ˜ ìˆì–´ìš”. (name + business_number)";

      const form = document.createElement("div");
      form.className = "createForm";

      const mkField = (labelText, placeholder) => {
        const wrap = document.createElement("div");
        wrap.className = "createField";

        const lab = document.createElement("div");
        lab.className = "createLabel";
        lab.textContent = labelText;

        const inp = document.createElement("input");
        inp.type = "text";
        inp.className = "createInput";
        inp.placeholder = placeholder;

        wrap.appendChild(lab);
        wrap.appendChild(inp);
        return { wrap, inp };
      };

      const fName = mkField("ë²¤ë”ëª…", "ì˜ˆ: ì°¨ë‹ˆë¬¼ë¥˜");
      const fBn = mkField("ì‚¬ì—…ìë²ˆí˜¸", "ì˜ˆ: 123-45-67890 (í•˜ì´í”ˆ í¬í•¨ ê·¸ëŒ€ë¡œ)");

      // ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ë²¤ë”ëª…ì— ìë™ ì±„ì›€
      fName.inp.value = (q || "").trim();

      form.appendChild(fName.wrap);
      form.appendChild(fBn.wrap);

      const actions = document.createElement("div");
      actions.className = "createActions";

      const createBtn = document.createElement("button");
      createBtn.className = "createBtn";
      createBtn.textContent = "ë“±ë¡";

      actions.appendChild(createBtn);

      box.appendChild(head);
      box.appendChild(desc);
      box.appendChild(form);
      box.appendChild(actions);

      const doCreate = async () => {
        const name = (fName.inp.value || "").trim();
        const bn = (fBn.inp.value || "").trim();

        if (!name) { toastWarn("ë²¤ë”ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."); fName.inp.focus(); return; }
        if (!bn) { toastWarn("ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); fBn.inp.focus(); return; }

        createBtn.disabled = true;
        createBtn.textContent = "ë“±ë¡ì¤‘...";

        try {
          const created = await apiCreateVendor({ name, business_number: bn });

          if (created?.business_number) {
            // í˜„ì¬ wave ìƒíƒœ(ì£¼ê°„/ì•¼ê°„)ë¥¼ ìœ ì§€í•œ ì±„ë¡œ ì¦‰ì‹œ ì„ íƒ ì ìš©
            onVendorPicked(created, /*silent*/true);
            closeVendorModal();
            toastOk("ë²¤ë” ë“±ë¡ ì™„ë£Œ");
          } else {
            throw new Error("ìƒì„± ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          }
        } catch (e) {
          toastErr("ë“±ë¡ ì‹¤íŒ¨: " + (e?.message || String(e)));
        } finally {
          createBtn.disabled = false;
          createBtn.textContent = "ë“±ë¡";
        }
      };

      createBtn.addEventListener("click", doCreate);
      fBn.inp.addEventListener("keydown", (ev) => { if (ev.key === "Enter") doCreate(); });
      fName.inp.addEventListener("keydown", (ev) => { if (ev.key === "Enter") fBn.inp.focus(); });

      vendorResultsEl.appendChild(box);
    }

    if (safeList.length === 0) {
      setStatus(`ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ: "${q}" (ì‹ ê·œ ë“±ë¡ ê°€ëŠ¥)`, "WARN");
    }
  }


function closeVendorModal() {
    vendorModalOpen = false;
    if (!vendorModalEl) return;
    vendorModalEl.style.display = "none";
    vendorModalEl.setAttribute("aria-hidden", "true");
  }

  async function fetchVendorsByName(q) {
    const url = new URL(VENDORS_ENDPOINT);
    url.searchParams.set("q", q);

    const data = await apiGet(url.toString());
    const rows = Array.isArray(data) ? data : (data?.rows || data?.vendors || []);
    return (rows || []).map(normalizeVendor).filter(Boolean);
  }

  async function runVendorSearch(q) {
  const query = (q || "").trim();
  if (!query) { setStatus("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "WARN"); return; }

  setStatus(`ë²¤ë” ê²€ìƒ‰ì¤‘: "${query}" ...`, "OK");

  let list = [];
  try {
    list = await fetchVendorsByName(query);
  } catch (e) {
    setStatus(`ë²¤ë” ê²€ìƒ‰ ì‹¤íŒ¨: ${e?.message || String(e)}`, "ERR");
    // ê²€ìƒ‰ ì‹¤íŒ¨ì—¬ë„ ì‹ ê·œ ë“±ë¡ì€ ê°€ëŠ¥í•˜ê²Œ ëª¨ë‹¬ ì˜¤í”ˆ
    openVendorModal([], query);
    return;
  }

  // 1ê°œì—¬ë„ ëª¨ë‹¬ ì˜¤í”ˆ(ì„ íƒ/í•´ì œ UX í†µì¼)
  if (list.length === 1) {
    setVendorCandidate(list[0]);
    openVendorModal(list, query);
    setStatus(`ë²¤ë” í›„ë³´ 1ê°œ: "${query}"`, "OK");
    return;
  }

  // 0ê°œ/ë‹¤ìˆ˜: ëª¨ë‹¬ ì˜¤í”ˆ (0ê°œì—¬ë„ ì‹ ê·œ ë“±ë¡ ê°€ëŠ¥)
  openVendorModal(list, query);

  if (list.length === 0) setStatus(`ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ: "${query}" (ì‹ ê·œ ë“±ë¡ ê°€ëŠ¥)`, "WARN");
  else setStatus(`ë²¤ë” í›„ë³´ ${list.length}ê°œ: "${query}"`, "OK");
}

function openWaveModal(action) {
    if (!waveModalEl) return;

    waveModalAction = action;
    waveModalOpen = true;
    waveModalEl.style.display = "flex";
    waveModalEl.setAttribute("aria-hidden", "false");

    if (waveModalTitleEl) {
      waveModalTitleEl.textContent =
        action === "clear" ? "ì–´ëŠ êµ¬ë¶„ì„ ë¹„ìš¸ê¹Œìš”?" : "ì–´ëŠ êµ¬ë¶„ìœ¼ë¡œ ì €ì¥í• ê¹Œìš”?";
    }

    if (waveModalVendorPillEl) {
      if (action === "save" && vendorCandidate?.name) {
        waveModalVendorPillEl.style.display = "inline-block";
        waveModalVendorPillEl.textContent = `ì €ì¥ ëŒ€ìƒ: ${vendorCandidate.name}`;
      } else {
        waveModalVendorPillEl.style.display = "none";
        waveModalVendorPillEl.textContent = "";
      }
    }
  }

  function closeWaveModal() {
    waveModalOpen = false;
    if (!waveModalEl) return;
    waveModalEl.style.display = "none";
    waveModalEl.setAttribute("aria-hidden", "true");
    waveModalAction = null;
  }

  function resolveActualId(camp, code) {
    let id = selectedRouteId;

    // ì„ì‹œ ID ì²˜ë¦¬
    if (id && typeof id === "string" && id.startsWith("tmp_")) {
      const actualRow = routeRows.find(r =>
        (r.camp||"") === camp && (r.full_code||"") === code
      );
      if (actualRow && typeof actualRow.id === "number") id = actualRow.id;
      else id = undefined;
    }

    // ì„ íƒì´ ì—†ì„ ë•Œë„ camp/codeë¡œ ë§¤ì¹­
    if (!(typeof id === "number")) {
      const actualRow = routeRows.find(r =>
        (r.camp||"") === camp && (r.full_code||"") === code
      );
      if (actualRow && typeof actualRow.id === "number") id = actualRow.id;
    }

    return (typeof id === "number") ? id : undefined;
  }

  async function saveVendorWave(wave, clear=false) {
    try {
      const camp = campInput.value.trim();
      const code = codeInput.value.trim();
      if (!camp) { setStatus("campê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
      if (!code) { setStatus("codeê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }

      const actualId = resolveActualId(camp, code);

      const bn = clear ? null : (vendorCandidate?.business_number || null);
      if (!clear && !bn) {
        setStatus("ì €ì¥í•  ë²¤ë”ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”. (ë²¤ë” ê²€ìƒ‰ Enter)", "ERR");
        return;
      }

      const payload = { camp, code };
      if (wave === "1W") payload.vendor_business_number_1w = bn;
      else payload.vendor_business_number_2w = bn;

      if (typeof actualId === "number") payload.id = actualId;

      const msg = clear ? `ë²¤ë” ë¹„ìš°ê¸°(${wave}) ì €ì¥` : `ë²¤ë” ì €ì¥(${wave})`;
      setStatus(msg, "OK");

      await apiJson("POST", ROUTE_ENDPOINT, payload);

      setStatus(clear ? `ë²¤ë” ë¹„ìš°ê¸°(${wave}) ì™„ë£Œ` : `ë²¤ë” ì €ì¥(${wave}) ì™„ë£Œ`, "OK");
      await loadRoutes();
    } catch (e) {
      console.error(e);
      setStatus(`ë²¤ë” ì €ì¥ ì‹¤íŒ¨: ${e.message}`, "ERR");
    }
  }

  // ====== âœ… ì…ì°¨ì§€(ìº í”„) ê²€ìƒ‰/ì„ íƒ/ë“±ë¡ ======
  function normalizeCampSearchRow(v) {
    return normalizeDeliveryCamp(v);
  }

  function scoreDeliveryCampSearch(row, qLower) {
    const mb = (row?.mb_camp || "").toString().toLowerCase();
    const camp = (row?.camp || "").toString().toLowerCase();

    if (!qLower) return 0;
    if (mb === qLower) return 120;
    if (camp === qLower) return 115;
    if (mb.startsWith(qLower)) return 100;
    if (camp.startsWith(qLower)) return 95;
    if (mb.includes(qLower)) return 80;
    if (camp.includes(qLower)) return 75;
    return 0;
  }

  function closeDeliveryCampModal() {
    deliveryCampModalOpen = false;
    if (!deliveryCampModalEl) return;
    deliveryCampModalEl.style.display = "none";
    deliveryCampModalEl.setAttribute("aria-hidden", "true");
  }

  function openDeliveryCampModal(list, q = "") {
    if (!deliveryCampModalEl || !deliveryCampResultsEl) return;

    const safeList = (Array.isArray(list) ? list : [])
      .map(normalizeCampSearchRow)
      .filter(Boolean);

    deliveryCampModalOpen = true;
    deliveryCampModalEl.style.display = "flex";
    deliveryCampModalEl.setAttribute("aria-hidden", "false");

    if (deliveryCampMetaCountEl) deliveryCampMetaCountEl.textContent = `${safeList.length}ê°œ`;
    deliveryCampResultsEl.innerHTML = "";

    if (deliveryCampCandidate?.mb_camp) {
      const sel = document.createElement("div");
      sel.className = "pillRow";
      sel.style.marginBottom = "10px";

      const t = document.createElement("div");
      const campText = deliveryCampCandidate.camp ? `${deliveryCampCandidate.camp} / ` : "";
      const addrText = deliveryCampCandidate.address ? ` Â· ${deliveryCampCandidate.address}` : "";
      t.textContent = `ì„ íƒë¨: ${campText}${deliveryCampCandidate.mb_camp}${addrText}`;

      const x = document.createElement("button");
      x.className = "pillX";
      x.type = "button";
      x.title = "ì„ íƒ í•´ì œ";
      x.textContent = "âœ•";
      x.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        setDeliveryCampCandidate(null, { syncNameInput: false });
        openDeliveryCampModal(safeList, q);
      });

      sel.appendChild(t);
      sel.appendChild(x);
      deliveryCampResultsEl.appendChild(sel);
    }

    if (safeList.length === 0) {
      const empty = document.createElement("div");
      empty.className = "emptyMsg";
      empty.textContent = `ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ : "${q || ""}"`;
      deliveryCampResultsEl.appendChild(empty);
    } else {
      for (const c of safeList) {
        const card = document.createElement("div");
        card.className = "resultCard";

        const left = document.createElement("div");
        left.style.flex = "1";
        left.style.minWidth = "0";

        const title = document.createElement("div");
        title.className = "resultTitle";
        title.textContent = c.mb_camp || "-";

        const meta = document.createElement("div");
        meta.className = "resultSub";
        const campText = c.camp ? `ìº í”„: ${c.camp}\n` : "";
        const addrText = c.address ? `ì£¼ì†Œ: ${c.address}` : "ì£¼ì†Œ: -";
        meta.textContent = `${campText}${addrText}`.trim();

        left.appendChild(title);
        left.appendChild(meta);

        const tag = document.createElement("div");
        tag.className = "tagPill";
        tag.textContent = "ì…ì°¨ì§€";

        card.appendChild(left);
        card.appendChild(tag);
        card.addEventListener("click", () => {
          setDeliveryCampCandidate(c);
          closeDeliveryCampModal();
          setStatus(`ì…ì°¨ì§€ ì„ íƒ: ${c.mb_camp}`, "OK");
        });

        deliveryCampResultsEl.appendChild(card);
      }
    }

    // ê²°ê³¼ê°€ ì—†ì„ ë•Œ ì‹ ê·œ ë“±ë¡ í¼ í‘œì‹œ
    if (safeList.length === 0) {
      const divider = document.createElement("div");
      divider.style.height = "10px";
      deliveryCampResultsEl.appendChild(divider);

      const box = document.createElement("div");
      box.className = "createBox";

      const head = document.createElement("div");
      head.className = "createHead";
      head.textContent = "ì‹ ê·œ ì…ì°¨ì§€ ë“±ë¡";

      const desc = document.createElement("div");
      desc.className = "createDesc";
      desc.textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ camps í…Œì´ë¸”ì— ë°”ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.";

      const form = document.createElement("div");
      form.className = "createForm";

      const mkField = (labelText, placeholder) => {
        const wrap = document.createElement("div");
        wrap.className = "createField";

        const lab = document.createElement("div");
        lab.className = "createLabel";
        lab.textContent = labelText;

        const inp = document.createElement("input");
        inp.type = "text";
        inp.className = "createInput";
        inp.placeholder = placeholder;

        wrap.appendChild(lab);
        wrap.appendChild(inp);
        return { wrap, inp };
      };

      const fCamp = mkField("ìº í”„", "ì˜ˆ: ê¹€í¬1");
      const fMbCamp = mkField("ì…ì°¨ì§€ëª…(mb_camp)", "ì˜ˆ: ë³¸ìº í”„ / ì‹ì‚¬ë™MB");
      const fAddr = mkField("ì£¼ì†Œ", "ì˜ˆ: ê²½ê¸° ê³ ì–‘ì‹œ ...");

      fCamp.inp.value = campInput.value.trim();
      fMbCamp.inp.value = (q || "").trim();

      form.appendChild(fCamp.wrap);
      form.appendChild(fMbCamp.wrap);
      form.appendChild(fAddr.wrap);

      const actions = document.createElement("div");
      actions.className = "createActions";

      const createBtn = document.createElement("button");
      createBtn.className = "createBtn";
      createBtn.textContent = "ë“±ë¡";
      actions.appendChild(createBtn);

      box.appendChild(head);
      box.appendChild(desc);
      box.appendChild(form);
      box.appendChild(actions);

      const doCreate = async () => {
        const campName = (fCamp.inp.value || "").trim();
        const mbCampName = (fMbCamp.inp.value || "").trim();
        const address = (fAddr.inp.value || "").trim();

        if (!campName) { setStatus("ìº í”„ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "WARN"); fCamp.inp.focus(); return; }
        if (!mbCampName) { setStatus("ì…ì°¨ì§€ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.", "WARN"); fMbCamp.inp.focus(); return; }
        if (!address) { setStatus("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "WARN"); fAddr.inp.focus(); return; }

        createBtn.disabled = true;
        createBtn.textContent = "ë“±ë¡ì¤‘...";

        try {
          const res = await apiJson("POST", CAMPS_ENDPOINT, {
            camp: campName,
            mb_camp: mbCampName,
            address,
          });

          const created = normalizeCampSearchRow(res?.row || res);
          if (!created) throw new Error("ë“±ë¡ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");

          setDeliveryCampCandidate(created);
          closeDeliveryCampModal();
          setStatus("ì…ì°¨ì§€ ë“±ë¡ ì™„ë£Œ", "OK");
        } catch (e) {
          setStatus(`ì…ì°¨ì§€ ë“±ë¡ ì‹¤íŒ¨: ${e?.message || String(e)}`, "ERR");
        } finally {
          createBtn.disabled = false;
          createBtn.textContent = "ë“±ë¡";
        }
      };

      createBtn.addEventListener("click", doCreate);
      fAddr.inp.addEventListener("keydown", (ev) => { if (ev.key === "Enter") doCreate(); });
      fCamp.inp.addEventListener("keydown", (ev) => { if (ev.key === "Enter") fMbCamp.inp.focus(); });
      fMbCamp.inp.addEventListener("keydown", (ev) => { if (ev.key === "Enter") fAddr.inp.focus(); });

      deliveryCampResultsEl.appendChild(box);
    }
  }

  async function fetchCampsByName(q) {
    const query = (q || "").trim();

    const url = new URL(CAMPS_ENDPOINT);
    url.searchParams.set("q", query);
    url.searchParams.set("limit", "100");

    const data = await apiGet(url.toString());
    const rows = Array.isArray(data) ? data : (data?.rows || data?.camps || []);
    const out = (rows || []).map(normalizeCampSearchRow).filter(Boolean);

    const qLower = query.toLowerCase();
    const filtered = out.filter((row) => {
      const hay = `${row?.mb_camp || ""}\n${row?.camp || ""}`.toLowerCase();
      return hay.includes(qLower);
    });

    return filtered.sort((a, b) => scoreDeliveryCampSearch(b, qLower) - scoreDeliveryCampSearch(a, qLower));
  }

  async function runDeliveryCampSearch(q) {
    const query = (q || "").trim();
    if (!query) {
      setStatus("ì…ì°¨ì§€ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "WARN");
      return;
    }

    setStatus(`ì…ì°¨ì§€ ê²€ìƒ‰ì¤‘: "${query}" ...`, "OK");
    let list = [];
    try {
      list = await fetchCampsByName(query);
    } catch (e) {
      setStatus(`ì…ì°¨ì§€ ê²€ìƒ‰ ì‹¤íŒ¨: ${e?.message || String(e)}`, "ERR");
      openDeliveryCampModal([], query);
      return;
    }

    if (list.length === 1) setDeliveryCampCandidate(list[0]);
    openDeliveryCampModal(list, query);

    if (list.length === 0) setStatus(`ì…ì°¨ì§€ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ: "${query}" (ì‹ ê·œ ë“±ë¡ ê°€ëŠ¥)`, "WARN");
    else setStatus(`ì…ì°¨ì§€ í›„ë³´ ${list.length}ê°œ: "${query}"`, "OK");
  }

  // ====== í´ë¦¬ê³¤ ì¤‘ì‹¬ì  ê³„ì‚° ======
  function getRouteCenter() {
    if (!selectedRouteId || !overlayById.has(selectedRouteId)) return null;

    const pack = overlayById.get(selectedRouteId);
    const polygons = pack.polygons;

    if (!polygons || polygons.length === 0) return null;

    const allPoints = [];
    for (const poly of polygons) {
      const path = poly.getPath();
      if (!path) continue;

      const len = Array.isArray(path) ? path.length : (path.getLength ? path.getLength() : 0);
      for (let i = 0; i < len; i++) {
        const pt = Array.isArray(path) ? path[i] : path.getAt(i);
        if (pt) allPoints.push(pt);
      }
    }

    if (allPoints.length === 0) return null;
    return centroidOfLatLngs(allPoints);
  }
  // ====== ì…ì°¨ì§€ ì €ì¥/ë¹„ìš°ê¸° ======
  async function saveDeliveryOnly(clear=false) {
    try {
      const camp = campInput.value.trim();
      const code = codeInput.value.trim();
      if (!camp) { setStatus("campê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
      if (!code) { setStatus("codeê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
      if (!clear && !resolveDeliveryLocationName()) {
        setStatus("ì…ì°¨ì§€ë¥¼ ë¨¼ì € ê²€ìƒ‰/ì„ íƒí•˜ì„¸ìš”.", "ERR");
        return;
      }

      let id = selectedRouteId;

      if (id && typeof id === "string" && id.startsWith("tmp_")) {
        const actualRow = routeRows.find(r =>
          (r.camp||"") === camp && (r.full_code||"") === code
        );
        if (actualRow && typeof actualRow.id === "number") id = actualRow.id;
        else id = undefined;
      }

      const payload = {
        camp,
        code,
        delivery_location_name: clear ? null : (resolveDeliveryLocationName() || null),
      };

      if (typeof id === "number") payload.id = id;

      setStatus(clear ? "ì…ì°¨ì§€ ë¹„ìš°ê¸° ì €ì¥" : "ì…ì°¨ì§€ ì €ì¥", "OK");
      await apiJson("POST", ROUTE_ENDPOINT, payload);
      setStatus(clear ? "ì…ì°¨ì§€ ë¹„ìš°ê¸° ì™„ë£Œ" : "ì…ì°¨ì§€ ì €ì¥ ì™„ë£Œ", "OK");
      await loadRoutes();
    } catch (e) {
      console.error(e);
      setStatus(`ì…ì°¨ì§€ ì €ì¥ ì‹¤íŒ¨: ${e.message}`, "ERR");
    }
  }

  // ====== âœ… ì£¼ì†Œê²€ìƒ‰ (ì¹´ì¹´ì˜¤ì§€ë„ ìŠ¤íƒ€ì¼ ëª¨ë‹¬) ======
  function openSearchModal(prefill="") {
    searchModalOpen = true;
    searchModalEl.style.display = "flex";
    searchModalEl.setAttribute("aria-hidden", "false");
    if (prefill) searchQEl.value = prefill;
    setTimeout(() => searchQEl.focus(), 0);
  }

  function closeSearchModal() {
    searchModalOpen = false;
    searchModalEl.style.display = "none";
    searchModalEl.setAttribute("aria-hidden", "true");
  }

  function renderSearchSection(title, countText, items, kind) {
    const wrap = document.createElement("div");

    const head = document.createElement("div");
    head.className = "sectionTitle";
    head.innerHTML = `<div>${escapeHtml(title)}</div><div class="count">${escapeHtml(String(countText))}</div>`;
    wrap.appendChild(head);

    if (!items || items.length === 0) {
      const empty = document.createElement("div");
      empty.style.cssText = "color:rgba(230,238,252,.55);font-size:12px;margin:6px 0 14px;";
      empty.textContent = "ê²°ê³¼ ì—†ìŒ";
      wrap.appendChild(empty);
      return wrap;
    }

    for (const it of items) {
      const card = document.createElement("div");
      card.className = "resultCard";

      const left = document.createElement("div");
      left.style.flex = "1";
      left.style.minWidth = "0";

      const titleEl = document.createElement("div");
      titleEl.className = "resultTitle";

      const subEl = document.createElement("div");
      subEl.className = "resultSub";

      if (kind === "addr") {
        titleEl.textContent = it.address_name || it.address || "ì£¼ì†Œ";
        const road = it.road_address_name ? `ë„ë¡œëª…: ${it.road_address_name}\n` : "";
        const jibun = it.address_name ? `ì§€ë²ˆ: ${it.address_name}` : "";
        subEl.textContent = `${road}${jibun}`.trim();

        card.onclick = () => {
          const lat = Number(it.y);
          const lng = Number(it.x);
          const pos = new kakao.maps.LatLng(lat, lng);
          setSearchSelectedMarker(pos);
          map.setCenter(pos);
          map.setLevel(4);
          closeSearchModal();
          setStatus(`ì£¼ì†Œ ì„ íƒ: ${titleEl.textContent}`, "OK");
        };
      } else {
        titleEl.textContent = it.place_name || it.name || "ì¥ì†Œ";
        const addr = it.road_address_name || it.address_name || "";
        const phone = it.phone ? `\nì „í™”: ${it.phone}` : "";
        subEl.textContent = `${addr}${phone}`.trim();

        card.onclick = () => {
          const lat = Number(it.y);
          const lng = Number(it.x);
          const pos = new kakao.maps.LatLng(lat, lng);
          setSearchSelectedMarker(pos);
          map.setCenter(pos);
          map.setLevel(4);
          closeSearchModal();
          setStatus(`ì¥ì†Œ ì„ íƒ: ${titleEl.textContent}`, "OK");
        };
      }

      left.appendChild(titleEl);
      left.appendChild(subEl);

      const tag = document.createElement("div");
      tag.className = "tagPill";
      tag.textContent = (kind === "addr") ? "ì£¼ì†Œ" : "ì¥ì†Œ";

      card.appendChild(left);
      card.appendChild(tag);

      wrap.appendChild(card);
    }

    return wrap;
  }

  function updateSearchMeta() {
    // âœ… ìš”ì²­ëŒ€ë¡œ "ì£¼ì†Œ ë¨¼ì €" í‘œê¸°
    const addrCountText = `ì£¼ì†Œ ${addrItems.length}ê°œ`;
    const placeCountText = `ì¥ì†Œ ${placeTotal || placeItems.length}ê°œ`;
    searchMetaCountEl.textContent = `${addrCountText} Â· ${placeCountText}`;

    placePageInfoEl.textContent = `ì¥ì†Œ í˜ì´ì§€ ${placePage} / ${placeLast}`;
    placePrevBtn.disabled = (placePage <= 1);
    placeNextBtn.disabled = (placePage >= placeLast);

    placePrevBtn.style.opacity = placePrevBtn.disabled ? "0.5" : "1";
    placeNextBtn.style.opacity = placeNextBtn.disabled ? "0.5" : "1";
    placePrevBtn.style.cursor = placePrevBtn.disabled ? "not-allowed" : "pointer";
    placeNextBtn.style.cursor = placeNextBtn.disabled ? "not-allowed" : "pointer";
  }

  function renderSearchResults() {
    searchResultsEl.innerHTML = "";

    // âœ… ìš”ì²­ëŒ€ë¡œ: ì£¼ì†Œ ì„¹ì…˜ì„ ìœ„ë¡œ, ì¥ì†Œ(í‚¤ì›Œë“œ) ì„¹ì…˜ì„ ì•„ë˜ë¡œ
    searchResultsEl.appendChild(
      renderSearchSection("ì£¼ì†Œ", addrItems.length, addrItems, "addr")
    );
    searchResultsEl.appendChild(
      renderSearchSection("ì¥ì†Œ(í‚¤ì›Œë“œ)", (placeTotal ? `${placeTotal}ê°œ` : `${placePage}/${placeLast}p`), placeItems, "place")
    );

    updateSearchMeta();
  }

  function placesKeywordSearchPromise(q, page) {
    return new Promise((resolve) => {
      // âœ… ì „êµ­ ê²€ìƒ‰: location/bounds/radius ì˜µì…˜ ë„£ì§€ ì•ŠìŒ
      const options = { page, size: 15 };
      places.keywordSearch(q, (data, status, pagination) => {
        if (status !== kakao.maps.services.Status.OK) {
          return resolve({ items: [], total: 0, last: 1, current: page });
        }
        const total = Number(pagination?.totalCount || data?.length || 0);
        const last = Number(pagination?.last || 1);
        const current = Number(pagination?.current || page);
        resolve({ items: data || [], total, last, current });
      }, options);
    });
  }

  function geocoderAddressSearchPromise(q) {
    return new Promise((resolve) => {
      geocoder.addressSearch(q, (result, status) => {
        if (status !== kakao.maps.services.Status.OK) return resolve([]);
        resolve(result || []);
      });
    });
  }

  // âœ…âœ…âœ… ì—¬ê¸°ë§Œ â€œì½©ëŒ•ì½©ëŒ•â€ ì´ìŠ¤í„°ì—ê·¸ í¬í•¨í•´ì„œ ì˜¤ë¥˜ ì—†ì´ ìˆ˜ì •ë¨
  async function runSearch(q, page=1) {
    let query = (q || "").trim();
    if (!query) {
      setStatus("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "WARN");
      return;
    }

    // âœ… Easter egg
    if (query === "ì½©ëŒ•ì½©ëŒ•") {
      query = "ê²½ê¸° íŒŒì£¼ì‹œ í•˜ìš°ê³ ê°œê¸¸ 411";
      // ì…ë ¥ì°½ì—ë„ ì¹˜í™˜ëœ ê°’ í‘œì‹œ (ì›í•˜ë©´ ì´ ì¤„ ì‚­ì œ ê°€ëŠ¥)
      searchQEl.value = query;
    }

    searchQuery = query;
    placePage = page;

    searchResultsEl.innerHTML = `<div style="color:rgba(230,238,252,.65);font-size:12px;padding:10px 2px;">ê²€ìƒ‰ ì¤‘...</div>`;

    try {
      const [addr, placePack] = await Promise.all([
        geocoderAddressSearchPromise(query),
        placesKeywordSearchPromise(query, page)
      ]);

      addrItems = addr;
      placeItems = placePack.items;
      placeTotal = placePack.total;
      placeLast = placePack.last;
      placePage = placePack.current;

      renderSearchResults();
      setStatus(`ê²€ìƒ‰ ì™„ë£Œ: ${query}`, "OK");
    } catch (e) {
      console.error(e);
      addrItems = [];
      placeItems = [];
      placeTotal = 0;
      placeLast = 1;
      placePage = 1;
      renderSearchResults();
      setStatus(`ê²€ìƒ‰ ì‹¤íŒ¨: ${e.message}`, "ERR");
    }
  }

  function searchAddress() {
    openSearchModal("");
  }

  // ====== OSM ì •ë ¬(Overpass) ======
  async function alignWithOsm() {
    try {
      clearOsm();

      const b = map.getBounds();
      const sw = b.getSouthWest();
      const ne = b.getNorthEast();

      const bbox = `${sw.getLng()},${sw.getLat()},${ne.getLng()},${ne.getLat()}`;
      const url = new URL(OSM_ENDPOINT);
      url.searchParams.set("bbox", bbox);

      setStatus(`GET /osm ìš”ì²­: ${url.toString()}`, "OK");
      const data = await apiGet(url.toString());

      const roads = data?.roads || [];
      const buildings = data?.buildings || [];

      for (const r of roads) {
        if (!r.coords || r.coords.length < 2) continue;
        const path = r.coords.map(([lng,lat]) => new kakao.maps.LatLng(lat,lng));
        const pl = new kakao.maps.Polyline({
          path,
          strokeWeight: 1,
          strokeColor: "#ffffff",
          strokeOpacity: 0.35,
          strokeStyle: "solid",
          zIndex: 0
        });
        pl.setMap(map);
        osmOverlays.push(pl);
      }

      for (const g of buildings) {
        if (!g.coords || g.coords.length < 3) continue;
        const path = g.coords.map(([lng,lat]) => new kakao.maps.LatLng(lat,lng));
        const pg = new kakao.maps.Polygon({
          path,
          strokeWeight: 1,
          strokeColor: "#ffffff",
          strokeOpacity: 0.18,
          strokeStyle: "solid",
          fillColor: "#ffffff",
          fillOpacity: 0.05,
          zIndex: 0
        });
        pg.setMap(map);
        osmOverlays.push(pg);
      }

      setStatus(`OSM í‘œì‹œ ì™„ë£Œ: roads ${roads.length}, buildings ${buildings.length}`, "OK");
    } catch (e) {
      console.error(e);
      setStatus(`OSM ì •ë ¬ ì‹¤íŒ¨: ${e.message}`, "ERR");
    }
  }

  // ====== ë¼ë²¨ í† ê¸€ ======
  function refreshLabelsOnly() {
    for (const [id, pack] of overlayById.entries()) {
      pack.labels.forEach(l => l.setMap(null));
      pack.labels = [];

      if (!(labelOn || vendorLabelOn)) continue;
      if (!pack.polygons || pack.polygons.length === 0) continue;

      const row = pack.row || {};
      const code = row.full_code || row.code || row.route_code || "";
      const color = row.color || colorFor(code);

      const opts = { showCode: labelOn, showVendor: vendorLabelOn };

      if (pack.polygons.length === 1) {
        const pos =
          normalizeCenterWgs84(row.center_wgs84) ||
          centroidOfLatLngs(getPolygonPathAsArray(pack.polygons[0]));
        const label = createLabelOverlay(code, row, pos, color, opts);
        label.setMap(map);
        pack.labels.push(label);
      } else {
        for (const p of pack.polygons) {
          const pos = centroidOfLatLngs(getPolygonPathAsArray(p));
          const label = createLabelOverlay(code, row, pos, color, opts);
          label.setMap(map);
          pack.labels.push(label);
        }
      }
    }
  }

  function toggleLabels() {
    labelOn = !labelOn;
    labelToggleBtn.textContent = labelOn ? "ë¼ìš°íŠ¸ ë¼ë²¨ ON" : "ë¼ìš°íŠ¸ ë¼ë²¨ OFF";
    refreshLabelsOnly();
  }

  function toggleVendorLabels() {
    vendorLabelOn = !vendorLabelOn;
    vendorLabelToggleBtn.textContent = vendorLabelOn ? "ë²¤ë” ë¼ë²¨ ON" : "ë²¤ë” ë¼ë²¨ OFF";
    refreshLabelsOnly();
  }
        

  // ====== ì´ˆê¸°í™” ======
  function resetMap() {
    clearAllOverlays();
    clearOsm();
    stopDraw(true);
    hint("", false);
    setStatus("ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ.", "OK");
  }

  // ====== (ì¶”ê°€) KST yyyymmddHHMM ======
  function kstYYYYMMDDHHMM() {
    const now = new Date();
    const kst = new Date(now.getTime() + 9 * 60 * 60 * 1000);
    const yyyy = String(kst.getUTCFullYear());
    const mm = String(kst.getUTCMonth() + 1).padStart(2, "0");
    const dd = String(kst.getUTCDate()).padStart(2, "0");
    const HH = String(kst.getUTCHours()).padStart(2, "0");
    const MM = String(kst.getUTCMinutes()).padStart(2, "0");
    return `${yyyy}${mm}${dd}${HH}${MM}`;
  }

  // ====== ê³µìœ  ë§í¬ ìƒì„± ======
  function generateShareLink() {
    const camp = campInput.value.trim();
    const code = codeInput.value.trim();

    if (!camp) {
      setStatus("ìº í”„ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "WARN");
      return;
    }

    const shareUrl = new URL("/share.html", location.origin);
    shareUrl.searchParams.set("camp", camp);
    if (code) shareUrl.searchParams.set("code", code);

    shareUrl.searchParams.set("v", kstYYYYMMDDHHMM());

    const url = shareUrl.toString();

    navigator.clipboard.writeText(url).then(() => {
      setStatus("ê³µìœ  ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!", "OK");

      const confirmed = confirm(
        `ê³µìœ  ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n${url}\n\nìƒˆ íƒ­ì—ì„œ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì—¬ì‹œê² ìŠµë‹ˆê¹Œ?`
      );

      if (confirmed) window.open(url, "_blank");
    }).catch(err => {
      prompt("ê³µìœ  ë§í¬ (Ctrl+Cë¡œ ë³µì‚¬):", url);
      setStatus("ê³µìœ  ë§í¬ë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤.", "OK");
    });

    log(`ê³µìœ  ë§í¬ ìƒì„±: ${url}`);
  }

  // ====== âœ… ìœ„ì„±/ë¡œë“œë·° ======
  function setMapTypeSatellite(on) {
    isSatellite = !!on;
    if (!map) return;
    map.setMapTypeId(isSatellite ? kakao.maps.MapTypeId.HYBRID : kakao.maps.MapTypeId.ROADMAP);
    if (toggleMapTypeBtn) toggleMapTypeBtn.textContent = isSatellite ? "ì¼ë°˜" : "ìœ„ì„±";
  }

  function ensureRoadview() {
    if (roadview && roadviewClient) return;
    const container = $("roadview");
    if (!container) return;
    roadview = new kakao.maps.Roadview(container);
    roadviewClient = new kakao.maps.RoadviewClient();
  }

  function setRoadviewOverlay(on) {
    if (!map) return;
    try {
      if (on) map.addOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
      else map.removeOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
    } catch (e) {
      console.warn("ROADVIEW ì˜¤ë²„ë ˆì´ í† ê¸€ ì‹¤íŒ¨", e);
    }
  }

  function setRoadviewAt(latlng) {
    ensureRoadview();
    if (!roadviewClient || !roadview) return;

    const radii = [80, 200, 500, 1200];
    const tryFind = (i) => {
      const r = radii[i];
      roadviewClient.getNearestPanoId(latlng, r, (panoId) => {
        if (panoId === null || panoId === undefined) {
          if (i < radii.length - 1) return tryFind(i + 1);
          alert("ì´ ìœ„ì¹˜ ê·¼ì²˜ì—ëŠ” ë¡œë“œë·°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        roadviewOpen = true;
        if (mapWrapEl) mapWrapEl.classList.add("roadview-open");

        if (roadview && typeof roadview.relayout === "function") {
          setTimeout(() => roadview.relayout(), 0);
        }

        roadview.setPanoId(panoId, latlng);
      });
    };
    tryFind(0);
  }

  function setRoadviewOn(on) {
    roadviewOn = !!on;
    if (!roadviewOn) roadviewOpen = false;

    if (toggleRoadviewBtn) toggleRoadviewBtn.textContent = roadviewOn ? "ë¡œë“œë·° ì¢…ë£Œ" : "ë¡œë“œë·°";
    if (roadviewHintEl) roadviewHintEl.style.display = roadviewOn ? "inline-flex" : "none";

    if (mapWrapEl) {
      if (!roadviewOn) mapWrapEl.classList.remove("roadview-open");
    }

    if (map) {
      const c = map.getCenter();
      map.relayout();
      map.setCenter(c);
    }
    if (!roadviewOn) {
      setRoadviewOverlay(false);
      if (roadviewClickHandler && map) {
        kakao.maps.event.removeListener(map, "click", roadviewClickHandler);
      }
      roadviewClickHandler = null;
      return;
    }

    if (drawMode) stopDraw(true);
    if (searchModalOpen) closeSearchModal();

    setRoadviewOverlay(true);

    if (!roadviewClickHandler && map) {
      roadviewClickHandler = (mouseEvent) => {
        if (!roadviewOn) return;
        if (drawMode) return;
        if (searchModalOpen) return;
        if (mouseEvent && mouseEvent.latLng) setRoadviewAt(mouseEvent.latLng);
      };
      kakao.maps.event.addListener(map, "click", roadviewClickHandler);
    }
  }

  // ====== ì§€ë„ ì´ë²¤íŠ¸(ê·¸ë¦¬ê¸° ëª¨ë“œ + ì»¤ìŠ¤í…€ ë“œë˜ê·¸) ======
  function attachMapEvents() {
    kakao.maps.event.addListener(map, "click", (mouseEvent) => {
      if (drawMode) {
        const latlng = mouseEvent.latLng;
        addDrawPoint(latlng);
      }
    });

    kakao.maps.event.addListener(map, "rightclick", () => {
      if (!drawMode) return;
      popDrawPoint();
    });

    const handleMouseMove = (e) => {
      if (!draggingVertex) return;

      const mapDiv = map.getNode ? map.getNode() : document.getElementById("map");
      const rect = mapDiv.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const proj = map.getProjection();
      const point = new kakao.maps.Point(x, y);
      const newPos = proj.coordsFromContainerPoint(point);

      const { marker, polygon, index } = draggingVertex;

      marker.setPosition(newPos);

      const currentPath = polygon.getPath();
      const pathArray = [];
      if (currentPath && typeof currentPath.getLength === 'function') {
        for (let j = 0; j < currentPath.getLength(); j++) {
          pathArray.push(j === index ? newPos : currentPath.getAt(j));
        }
      } else if (Array.isArray(currentPath)) {
        for (let j = 0; j < currentPath.length; j++) {
          pathArray.push(j === index ? newPos : currentPath[j]);
        }
      }
      polygon.setPath(pathArray);

      updateSelectedLabels();
    };

    const handleMouseUp = () => {
      if (!draggingVertex) return;
      draggingVertex = null;
      map.setDraggable(true);
      rebuildHandles();
    };

    window.addEventListener("mousemove", handleMouseMove);
    window.addEventListener("mouseup", handleMouseUp);

    // âœ… í‚¤ë³´ë“œ: Enter/ESC ë™ì‘ (ëª¨ë‹¬ â†’ ê·¸ë¦¬ê¸° â†’ í¸ì§‘/ì„ íƒ ìš°ì„ ìˆœìœ„)
    window.addEventListener("keydown", (e) => {
      // 0) ëª¨ë‹¬ ìš°ì„  ì²˜ë¦¬
      if (e.key === "Escape") {
        if (waveModalOpen) {
          closeWaveModal();
          setStatus("1W/2W ì„ íƒ ë‹«ê¸°", "OK");
          return;
        }
        if (vendorModalOpen) {
          closeVendorModal();
          setStatus("ë²¤ë” ì„ íƒ ë‹«ê¸°", "OK");
          return;
        }
        if (deliveryCampModalOpen) {
          closeDeliveryCampModal();
          setStatus("ì…ì°¨ì§€ ì„ íƒ ë‹«ê¸°", "OK");
          return;
        }
        if (searchModalOpen) {
          closeSearchModal();
          clearSearchSelectedMarker();
          setStatus("ê²€ìƒ‰ ë‹«ê¸°/ë§ˆì»¤ ì‚­ì œ", "OK");
          return;
        }
        if (searchSelectedMarker || searchSelectedOverlay) {
          clearSearchSelectedMarker();
          setStatus("ê²€ìƒ‰ ë§ˆì»¤ ì‚­ì œ", "OK");
          return;
        }
      }

      // 1) ê·¸ë¦¬ê¸° ëª¨ë“œ
      if (drawMode) {
        if (e.key === "Escape") {
          stopDraw();
          setStatus("ê·¸ë¦¬ê¸° ì·¨ì†Œ", "WARN");
        } else if (e.key === "Enter") {
          e.preventDefault();
          e.stopPropagation();
          finishDraw();
        }
        return;
      }

      // 2) ì…ë ¥ ì¤‘ì´ë©´ ê¸€ë¡œë²Œ EnterëŠ” ë¬´ì‹œ (ê° inputì—ì„œ ì²˜ë¦¬)
      const active = document.activeElement;
      const tag = (active?.tagName || "").toLowerCase();
      const isTyping = tag === "input" || tag === "textarea" || active?.isContentEditable;
      if (isTyping) return;

      // 3) Enter: í¸ì§‘ ì €ì¥ / ì„ íƒâ†’í¸ì§‘ ì§„ì…
      if (e.key === "Enter") {
        if (editingRouteId) {
          e.preventDefault();
          e.stopPropagation();
          saveCurrent();
          return;
        }
        if (selectedRouteId) {
          e.preventDefault();
          e.stopPropagation();
          startEditing(selectedRouteId);
          return;
        }
      }

      // 4) Escape: í¸ì§‘ ì¢…ë£Œ(ì„ íƒ ìœ ì§€) / ì„ íƒ í•´ì œ
      if (e.key === "Escape") {
        if (editingRouteId) {
          stopEditing();
          setStatus("í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ (ì„ íƒ ìœ ì§€)", "OK");
          return;
        }
        if (selectedRouteId) {
          selectedRouteId = null;
          stopEditing();
          selectedInfo.textContent = "ì„ íƒ: ì—†ìŒ";
          clearVendorDisplay();
          clearDeliveryDisplay();
          setStatus("ì„ íƒ í•´ì œ", "OK");
          return;
        }
      }
    });
  }

  // ====== ì´ˆê¸° êµ¬ë™ ======
  function init() {
    kakao.maps.load(() => {
      const center = new kakao.maps.LatLng(37.4936, 126.9019);
      map = new kakao.maps.Map($("map"), { center, level: 6 });
      geocoder = new kakao.maps.services.Geocoder();
      places = new kakao.maps.services.Places();

      VERTEX_IMG = makeHandleImage("#ffffff", "#0b1220");
      MID_IMG = makeHandleImage("#93a4c7", "#0b1220");

      attachMapEvents();

      // ì…ì°¨ì§€ ì£¼ì†ŒëŠ” camps ë§¤í•‘ ê²°ê³¼ë¥¼ ì¶œë ¥ë§Œ í•˜ë„ë¡ ê³ ì •
      if (deliveryAddrInput) deliveryAddrInput.readOnly = true;

      window.addEventListener("resize", () => {
        if (!map) return;
        const c = map.getCenter();
        map.relayout();
        map.setCenter(c);
        if (roadviewOn && roadview && typeof roadview.relayout === "function") roadview.relayout();
      });

      loadBtn.addEventListener("click", loadRoutes);
      drawNewBtn.addEventListener("click", () => beginDraw("new"));
      drawAddBtn.addEventListener("click", () => beginDraw("add"));
      addrBtn.addEventListener("click", searchAddress);
      saveBtn.addEventListener("click", saveCurrent);
      deletePolyBtn.addEventListener("click", deletePolygon);
      
      labelToggleBtn.addEventListener("click", toggleLabels);
      vendorLabelToggleBtn.addEventListener("click", toggleVendorLabels);
      resetBtn.addEventListener("click", resetMap);

      // âœ… Enterë¡œ "ë¶ˆëŸ¬ì˜¤ê¸°" (ìº í”„/ë¼ìš°íŠ¸ì½”ë“œ)
      campInput.addEventListener("keydown", (e) => {
        if (e.key !== "Enter") return;
        e.preventDefault();
        e.stopPropagation();
        if (editingRouteId) saveCurrent();
        else loadRoutes();
      });
      codeInput.addEventListener("keydown", (e) => {
        if (e.key !== "Enter") return;
        e.preventDefault();
        e.stopPropagation();
        if (editingRouteId) saveCurrent();
        else loadRoutes();
      });

      // âœ… Enterë¡œ ë²¤ë” ê²€ìƒ‰ + ìº í”„+ë²¤ë” ìë™ ë¶ˆëŸ¬ì˜¤ê¸°
      if (vendorSearchInput) vendorSearchInput.addEventListener("keydown", (e) => {
        if (e.isComposing) return;
        if (e.key !== "Enter") return;
        e.preventDefault();
        e.stopPropagation();
        runVendorSearch(vendorSearchInput.value);
      });

      if (vendorSearchBtn) {
        vendorSearchBtn.addEventListener("click", (e) => {
          e.preventDefault();
          runVendorSearch(vendorSearchInput.value);
        });
      }

      // âœ… Enter/ë²„íŠ¼ìœ¼ë¡œ ì…ì°¨ì§€ ê²€ìƒ‰ (camps)
      if (deliveryNameInput) {
        deliveryNameInput.addEventListener("keydown", (e) => {
          if (e.isComposing) return;
          if (e.key !== "Enter") return;
          e.preventDefault();
          e.stopPropagation();
          runDeliveryCampSearch(deliveryNameInput.value);
        });
        deliveryNameInput.addEventListener("input", () => {
          const typed = (deliveryNameInput.value || "").trim();
          const picked = (deliveryCampCandidate?.mb_camp || "").trim();
          if (!typed) {
            setDeliveryCampCandidate(null, { syncNameInput: false });
            return;
          }
          if (picked && typed !== picked) {
            // ì„ íƒê°’ê³¼ íƒ€ì´í•‘ê°’ì´ ë‹¬ë¼ì§€ë©´ ì£¼ì†ŒëŠ” ë‹¤ì‹œ ì¡°íšŒë˜ì–´ì•¼ í•˜ë¯€ë¡œ í›„ë³´ í•´ì œ
            setDeliveryCampCandidate(null, { syncNameInput: false });
          }
        });
      }
      if (deliverySearchBtn) {
        deliverySearchBtn.addEventListener("click", (e) => {
          e.preventDefault();
          runDeliveryCampSearch(deliveryNameInput?.value || "");
        });
      }

      // âœ… ë²¤ë” ì €ì¥/ë¹„ìš°ê¸°: 1W/2W ì„ íƒ ëª¨ë‹¬
      vendorSaveBtn.addEventListener("click", () => {
        const camp = campInput.value.trim();
        const code = codeInput.value.trim();
        if (!camp) { setStatus("campê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
        if (!code) { setStatus("codeê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
        if (!vendorCandidate?.business_number) {
          setStatus("ë²¤ë”ë¥¼ ë¨¼ì € ê²€ìƒ‰/ì„ íƒí•˜ì„¸ìš”. (ë²¤ë” ê²€ìƒ‰ Enter)", "ERR");
          return;
        }
        openWaveModal("save");
      });
      vendorClearBtn.addEventListener("click", () => {
        const camp = campInput.value.trim();
        const code = codeInput.value.trim();
        if (!camp) { setStatus("campê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
        if (!code) { setStatus("codeê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
        openWaveModal("clear");
      });

      // âœ… ëª¨ë‹¬ ë‹«ê¸°/ì´ë²¤íŠ¸
      if (vendorModalCloseBtn) vendorModalCloseBtn.addEventListener("click", closeVendorModal);
      if (vendorModalEl) vendorModalEl.addEventListener("click", (e) => { if (e.target === vendorModalEl) closeVendorModal(); });
      if (deliveryCampModalCloseBtn) deliveryCampModalCloseBtn.addEventListener("click", closeDeliveryCampModal);
      if (deliveryCampModalEl) deliveryCampModalEl.addEventListener("click", (e) => {
        if (e.target === deliveryCampModalEl) closeDeliveryCampModal();
      });

      if (waveModalCloseBtn) waveModalCloseBtn.addEventListener("click", closeWaveModal);
      if (waveModalEl) waveModalEl.addEventListener("click", (e) => { if (e.target === waveModalEl) closeWaveModal(); });

      if (wave1WBtn) wave1WBtn.addEventListener("click", () => {
        const action = waveModalAction;
        closeWaveModal();
        saveVendorWave("1W", action === "clear");
      });
      if (wave2WBtn) wave2WBtn.addEventListener("click", () => {
        const action = waveModalAction;
        closeWaveModal();
        saveVendorWave("2W", action === "clear");
      });

      // âœ… ì…ì°¨ì§€ ì €ì¥/ë¹„ìš°ê¸°
      deliverySaveBtn.addEventListener("click", () => saveDeliveryOnly(false));
      deliveryClearBtn.addEventListener("click", () => saveDeliveryOnly(true));

      shareBtn.addEventListener("click", generateShareLink);

      if (toggleMapTypeBtn) toggleMapTypeBtn.addEventListener("click", () => setMapTypeSatellite(!isSatellite));
      if (toggleRoadviewBtn) toggleRoadviewBtn.addEventListener("click", () => setRoadviewOn(!roadviewOn));

      // âœ… ê²€ìƒ‰ ëª¨ë‹¬ ì´ë²¤íŠ¸
      searchRunBtn.addEventListener("click", () => runSearch(searchQEl.value, 1));
      searchCloseBtn.addEventListener("click", () => closeSearchModal());
      searchQEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") runSearch(searchQEl.value, 1);
        if (e.key === "Escape") {
          closeSearchModal();
          clearSearchSelectedMarker();
        }
      });
      searchModalEl.addEventListener("click", (e) => {
        if (e.target === searchModalEl) closeSearchModal();
      });

      placePrevBtn.addEventListener("click", () => {
        if (placePage <= 1) return;
        runSearch(searchQuery, placePage - 1);
      });
      placeNextBtn.addEventListener("click", () => {
        if (placePage >= placeLast) return;
        runSearch(searchQuery, placePage + 1);
      });

      setStatus("ì§€ë„ ë¡œë“œ ì™„ë£Œ", "OK");

      loadRoutes().catch((err) => {
        log("ìë™ ë¡œë“œ ì‹¤íŒ¨. ë°±ì—”ë“œ API í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        setStatus("ìë™ ë¡œë“œ ì‹¤íŒ¨ (ë°±ì—”ë“œ API ì˜¤ë¥˜). ìƒˆë¡œ ê·¸ë¦¬ê¸°ëŠ” ê°€ëŠ¥í•©ë‹ˆë‹¤.", "WARN");
      });
    });
  }

  window.addEventListener("error", (ev) => {
    const msg = ev?.message || "Script error.";
    log(`ERR window.error: ${msg}`);
  });

  init();
})();
</script>
</body>
</html>

  <meta name="referrer" content="origin" />
  <title>ë§ˆë£¨ì›° ë¼ìš°íŠ¸ í¸ì§‘ê¸°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico?v=2" />

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2d;
      --panel2:#0c1627;
      --txt:#e6eefc;
      --muted:#93a4c7;
      --line:rgba(255,255,255,.08);
      --btn:#162744;
      --btn2:#1a2f55;
      --danger:#6b1b1b;
      --ok:#1a5a3a;
      --warn:#6a4b13;
      --overlay:rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif; background:#0a0f1a;}
    .wrap{display:flex; height:100%;}
    .left{
      width:360px; min-width:340px; max-width:420px;
      background:linear-gradient(180deg,var(--bg),#070b13);
      color:var(--txt);
      border-right:1px solid var(--line);
      padding:14px 14px 10px 14px;
      overflow:auto;
    }
    .title{font-size:18px; font-weight:800; letter-spacing:.2px; margin:2px 0 10px; display:flex; align-items:center; gap:6px;}
    .subtitle{font-size:12px; color:var(--muted); margin:-6px 0 14px;}
    .group{background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:12px; padding:10px; margin:10px 0;}
    .label{font-size:12px; color:var(--muted); margin:6px 0 6px;}
    .label.sectionTitle{ text-align:center; font-weight:900; letter-spacing:.2px; }
    input[type="text"]{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--txt);
      outline:none;
    }
    input[type="text"]:focus{border-color:rgba(255,255,255,.25)}
    .row{display:flex; gap:8px; align-items:center;}
    .row > *{flex:1}
    .btn{
      padding:10px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--txt);
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      white-space:nowrap;
    }
    .btn:hover{background:var(--btn2)}
    .btn.danger{background:rgba(107,27,27,.35); border-color:rgba(255,60,60,.22)}
    .btn.danger:hover{background:rgba(107,27,27,.55)}
    .btn.ok{background:rgba(26,90,58,.35); border-color:rgba(0,255,140,.18)}
    .btn.ok:hover{background:rgba(26,90,58,.55)}
    .btn.warn{background:rgba(106,75,19,.35); border-color:rgba(255,180,0,.18)}
    .btn.warn:hover{background:rgba(106,75,19,.55)}
    /* âœ… ë²¤ë”(ì£¼ê°„/ì•¼ê°„) í‘œì‹œ */
    .kv{
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      padding:8px 10px;
    }
    .kvRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:0;
      min-height:40px; /* ë²¤ë” ì •ë³´ ë¼ì¸ ìˆ˜ì§ ì¤‘ì•™ ê³ ì • */
    }
    .kvRow + .kvRow{border-top:1px solid var(--line);}
    .kvLabel{
      display:flex;
      align-items:center;
      flex:0 0 92px;
      height:40px;
      font-size:12px;
      color:rgba(230,238,252,.72);
      white-space:nowrap;
      line-height:1;
    }
    .kvValue{
      display:flex;
      align-items:center;
      flex:1 1 auto;
      justify-content:flex-end;
      height:40px;
      font-size:13px;
      font-weight:900;
      color:rgba(255,255,255,.92);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      line-height:1;
      text-align:right;
    }
    .kvValue.empty{
      color:rgba(230,238,252,.45);
      font-weight:800;
    }

    /* âœ… ë²¤ë” ì„ íƒ/1WÂ·2W ì„ íƒ ëª¨ë‹¬ */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      backdrop-filter: blur(2px);
    }
    .modalCard{
      width:min(720px, calc(100% - 40px));
      max-height:min(720px, calc(100% - 40px));
      background:linear-gradient(180deg, rgba(15,26,45,.96), rgba(8,14,26,.96));
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      box-shadow:0 22px 80px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalTop{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .modalTitle{
      font-weight:900;
      color:#eaf2ff;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .modalTop .miniBtn{
      height:36px;
      padding:0 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:#fff;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }
    .modalTop .miniBtn:hover{background:rgba(0,0,0,.35)}
    .modalBody{
      flex:1;
      overflow:auto;
      padding:12px 14px;
    }
    .modalMeta{
      padding:10px 14px;
      color:rgba(230,238,252,.70);
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .waveGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      padding:14px;
    }
    .waveBtn{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      color:#fff;
      cursor:pointer;
      padding:14px 12px;
      text-align:left;
      font-weight:900;
    }
    .waveBtn:hover{background:rgba(0,0,0,.30)}
    .waveBtn .sub{
      display:block;
      margin-top:6px;
      color:rgba(230,238,252,.70);
      font-size:12px;
      font-weight:800;
    }
    .logWrap{
      border-radius:12px;
      border:1px solid var(--line);
      overflow:hidden;
      background:rgba(0,0,0,.25);
      margin-top:10px;
    }
    .logHeader{
      padding:8px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
      font-size:12px; color:var(--muted);
    }
    .log{
      height:170px;
      overflow:auto;
      padding:8px 10px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      white-space:pre-wrap;
      color:#d9e5ff;
    }
    .pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      font-size:12px;
      color:var(--muted);
    }
    .map{flex:1; position:relative;}

    /* âœ… mapWrap/roadview (index.html ìŠ¤íƒ€ì¼ ì´ì‹) */
    #mapWrap{
      position:absolute;
      inset:0;
      display:flex;
      min-width:0;
      min-height:0;
    }
    #map,#roadview{
      flex:1;
      width:100%;
      height:100%;
      min-width:0;
      min-height:0;
    }
    #roadview{display:none;}
    #mapWrap.roadview-open #roadview{display:block;}

    .map-controls{
      position:absolute;
      top:10px;
      right:10px;
      z-index:25;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      pointer-events:auto;
    }
    .map-controls button{
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      backdrop-filter: blur(6px);
    }
    .map-controls button:hover{
      background:rgba(0,0,0,.68);
      border-color:rgba(255,255,255,.22);
    }
    .map-controls .hint{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.55);
      color:#cbd5e1;
      font-size:12px;
      display:none;
    }

    .floatingHint{
      position:absolute;
      top:10px; left:10px;
      background:rgba(0,0,0,.55);
      color:#fff;
      border:1px solid rgba(255,255,255,.14);
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
      max-width:520px;
      display:none;
      z-index:20;
      pointer-events:none;
    }
    .sep{height:1px; background:var(--line); margin:10px 0;}
    .small{font-size:11px; color:var(--muted);}

    /* âœ… ì¹´ì¹´ì˜¤ì§€ë„ ìŠ¤íƒ€ì¼ ê²€ìƒ‰ ëª¨ë‹¬ */
    .searchModal{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.20);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      backdrop-filter: blur(2px);
    }
    .searchCard{
      width:min(860px, calc(100% - 40px));
      height:min(680px, calc(100% - 40px));
      background:linear-gradient(180deg, rgba(15,26,45,.96), rgba(8,14,26,.96));
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      box-shadow:0 22px 80px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .searchTop{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .searchTopTitle{
      font-weight:900;
      color:#eaf2ff;
      letter-spacing:.2px;
      margin-right:4px;
      white-space:nowrap;
    }
    .searchInput{
      flex:1;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .searchInput input{
      flex:1;
      height:40px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:#eaf2ff;
      padding:0 12px;
      outline:none;
    }
    .searchInput input:focus{border-color:rgba(255,255,255,.25)}
    .searchTop .miniBtn{
      height:40px;
      padding:0 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:#fff;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }
    .searchTop .miniBtn:hover{background:rgba(0,0,0,.35)}
    .searchMeta{
      padding:10px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      color:rgba(230,238,252,.80);
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .searchBody{
      flex:1;
      overflow:auto;
      padding:12px 14px;
    }
    .sectionTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:10px 0 8px;
      color:#eaf2ff;
      font-weight:900;
      letter-spacing:.2px;
    }
    .sectionTitle .count{
      font-size:12px;
      color:rgba(230,238,252,.65);
      font-weight:800;
    }
    .resultCard{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      border-radius:14px;
      padding:12px 12px;
      margin-bottom:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
    }
    .resultCard:hover{
      border-color:rgba(255,255,255,.18);
      background:rgba(0,0,0,.22);
    }
    .resultTitle{
      font-weight:900;
      color:#fff;
      margin-bottom:6px;
      line-height:1.2;
      word-break:keep-all;
    }
    .resultSub{
      color:rgba(230,238,252,.70);
      font-size:12px;
      line-height:1.45;
      white-space:pre-line;
    }
    .createBox{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
    }
    .createHead{
      font-weight:800;
      font-size:14px;
      letter-spacing:.2px;
    }


    .createDesc{
      margin-top:6px;
      color:rgba(230,238,252,.62);
      font-size:12px;
      line-height:1.4;
    }
    .createForm{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width: 860px){
      .createForm{ grid-template-columns: 1fr 1fr; }
    }
    .createField{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .createLabel{
      font-size:12px;
      color:rgba(230,238,252,.70);
      font-weight:800;
    }
    .createInput{
      width:100%;
      height:40px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:#fff;
      outline:none;
      box-sizing:border-box;
    }
    .createInput:focus{
      border-color: rgba(92,162,255,.55);
      box-shadow: 0 0 0 3px rgba(92,162,255,.15);
    }
    .createActions{
      margin-top:12px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
    }
    .createBtn{
      height:40px;
      padding:0 16px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(58,130,255,.45), rgba(58,130,255,.22));
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .createBtn:hover{ filter:brightness(1.06); }
    .createBtn:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:none;
    }
    .tagPill{
      flex:0 0 auto;
      margin-left:10px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      color:rgba(230,238,252,.85);
      font-weight:900;
      font-size:12px;
      background:rgba(255,255,255,.04);
      align-self:center;
      white-space:nowrap;
    }
    .searchBottom{
      padding:10px 14px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color:rgba(230,238,252,.70);
      font-size:12px;
    }
    .pager{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pager .miniBtn{
      height:30px;
      padding:0 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:#fff;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .pager .miniBtn:hover{background:rgba(0,0,0,.30)}
    .kbdHint{
      color:rgba(230,238,252,.55);
      font-size:12px;
      white-space:nowrap;
    }
  
  /* --- vendor search UX additions --- */
  .btnSearch{padding:10px 14px; min-width:86px;}
  .pillRow{
    display:flex; align-items:center; justify-content:space-between;
    padding:6px 10px; border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.04);
    color:var(--muted);
    font-size:12px;
    gap:10px;
  }
  .pillX{
    width:22px; height:22px; border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    color:var(--muted);
    display:inline-flex; align-items:center; justify-content:center;
    cursor:pointer;
  }
  .pillX:hover{background:rgba(255,255,255,.12);}
  .resultActions{display:flex; gap:8px; align-items:center;}
  .miniX{
    min-width:34px; height:32px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.05);
    color:var(--muted);
    display:inline-flex; align-items:center; justify-content:center;
    cursor:pointer;
  }
  .miniX:hover{background:rgba(255,255,255,.10);}
  .kv{
    padding-top:0 !important;
    padding-bottom:0 !important;
  }
  .kvRow{
    display:flex !important;
    align-items:center !important;
    justify-content:space-between !important;
    gap:10px !important;
    min-height:40px !important;
  }
  .kvLabel, .kvValue{
    display:flex !important;
    align-items:center !important;
    min-height:40px !important;
    height:40px !important;
    line-height:1 !important;
    transform:none !important;
    margin:0 !important;
    padding:0 !important;
  }
  .kvLabel{
    flex:0 0 92px !important;
  }
  .kvValue{
    flex:1 1 auto !important;
    justify-content:flex-end !important;
    text-align:right !important;
  }
</style>

  <!-- Kakao Maps -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=add4ce93b38c0ff9d9b9053728e067b3&autoload=false&libraries=services"></script>
</head>

<body>
<div class="wrap">
  <div class="left">
    <div class="title">
      <a href="/index.html" style="display:flex;align-items:center">
        <img src="/favicon.ico" alt="Maroowell Logo" style="width:24px;height:24px;transform:translateY(-2px);cursor:pointer" />
      </a>
      <span>ë§ˆë£¨ì›° ë¼ìš°íŠ¸ í¸ì§‘ê¸°</span>
    </div>

    <div class="group">
      <div class="label">ìº í”„ ì´ë¦„ (ì˜ˆ: í‰ì–‘1)</div>
      <input id="campInput" type="text" value="" />

      <div class="label">ë¼ìš°íŠ¸ ì½”ë“œ (ì˜ˆ: 101A,101B) â€” ë¹„ìš°ë©´ camp ì „ì²´ í‘œì‹œ</div>
      <input id="codeInput" type="text" value="" />

      <div class="sep"></div>

      <div class="label sectionTitle">ë²¤ë” ì •ë³´(ì„œë¸Œë¼ìš°íŠ¸ ë‹¨ìœ„)</div>

      <div class="kv">
        <div class="kvRow">
          <div class="kvLabel">ì£¼ê°„ (2W)</div>
          <div class="kvValue" id="vendorWeekValue">-</div>
        </div>
        <div class="kvRow">
          <div class="kvLabel">ì•¼ê°„ (1W)</div>
          <div class="kvValue" id="vendorNightValue">-</div>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="row" style="gap:10px;">
            <input id="vendorSearchInput" type="text" placeholder="ë²¤ë”ëª…/ì‚¬ì—…ìë²ˆí˜¸ ì¼ë¶€ ì…ë ¥ í›„ Enter" style="flex:1;" />
            <button id="vendorSearchBtn" class="btn btnSearch" type="button">ê²€ìƒ‰</button>
          </div>

      <div style="height:10px"></div>
      <div class="row">
        <button id="vendorSaveBtn" class="btn ok">ë²¤ë” ì €ì¥</button>
        <button id="vendorClearBtn" class="btn danger">ë²¤ë” ë¹„ìš°ê¸°</button>
      </div>

      <div style="height:8px"></div>
      <div id="vendorPickedWrap" class="pillRow" style="display:none;margin-top:8px;">
            <div id="vendorPickedText"></div>
            <button id="vendorPickedClearBtn" class="pillX" type="button" title="ì„ íƒ í•´ì œ">âœ•</button>
          </div>

      <div class="sep"></div>

      <div class="label sectionTitle">ì…ì°¨ì§€ ì •ë³´(ì„œë¸Œë¼ìš°íŠ¸ ë‹¨ìœ„)</div>
      <input id="deliveryNameInput" type="text" placeholder="ì…ì°¨ì§€ (ì˜ˆ: ë³¸ìº í”„ or ì‹ì‚¬ë™MB)" />
      <div style="height:8px"></div>
      <input id="deliveryAddrInput" type="text" placeholder="ì…ì°¨ì§€ ì£¼ì†Œ (ìƒì„¸íˆ)" />

      <div style="height:10px"></div>
      <div class="row">
        <button id="deliverySaveBtn" class="btn ok">ì…ì°¨ì§€ ì €ì¥</button>
        <button id="deliveryClearBtn" class="btn danger">ì…ì°¨ì§€ ë¹„ìš°ê¸°</button>
      </div>
</div>

    <div class="group" id="addressListGroup" style="display:none">
      <div class="label">ë°°ì†¡ì§€ ëª©ë¡ (ì…ì°¨ì§€â†’ë°°ì†¡ì§€ ë„¤ë¹„)</div>
      <div id="addressList" style="max-height:300px; overflow-y:auto; margin-top:8px;"></div>
</div>

    <div class="group">
      <div class="row">
        <button id="loadBtn" class="btn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="drawNewBtn" class="btn warn">ìƒˆë¡œ ê·¸ë¦¬ê¸°</button>
        <button id="drawAddBtn" class="btn warn">êµ¬ì—­ ì¶”ê°€</button>
      </div>
      <div style="height:8px"></div>
      <div class="row">
        <button id="saveBtn" class="btn ok">ì €ì¥</button>
        <button id="deletePolyBtn" class="btn danger">í´ë¦¬ê³¤ ì‚­ì œ</button>
        <button id="vendorLabelToggleBtn" class="btn">ë²¤ë” ë¼ë²¨ OFF</button>
      </div>
      <div style="height:8px"></div>
      <div class="row">
        <button id="addrBtn" class="btn">ì£¼ì†Œê²€ìƒ‰</button>
        <button id="labelToggleBtn" class="btn">ë¼ìš°íŠ¸ ë¼ë²¨ ON</button>
        <button id="resetBtn" class="btn">ì§€ë„ ì´ˆê¸°í™”</button>
      </div>
      <div style="height:8px"></div>
      <div class="row">
        <button id="shareBtn" class="btn ok" style="width:100%;">ğŸ”— ê³µìœ  ë§í¬ ìƒì„±</button>
      </div>
</div>

    <div class="logWrap">
      <div class="logHeader">
        <span class="pill" id="statusPill">READY</span>
        <span class="small" id="selectedInfo">ì„ íƒ: ì—†ìŒ</span>
      </div>
      <div class="log" id="log"></div>
    </div>
</div>

  <div class="map">
    <div id="mapWrap">
      <div id="map"></div>
      <div id="roadview"></div>
    </div>

    <div class="map-controls">
      <button id="toggleMapType" title="ì¼ë°˜/ìœ„ì„± ì „í™˜">ìœ„ì„±</button>
      <button id="toggleRoadview" title="ë¡œë“œë·° ë³´ê¸°/ì¢…ë£Œ">ë¡œë“œë·°</button>
      <span id="roadviewHint" class="hint">ë¡œë“œë·°: íŒŒë€ ê¸¸ í´ë¦­</span>
    </div>

    <div class="floatingHint" id="hint"></div>

    <!-- âœ… ì¹´ì¹´ì˜¤ì§€ë„ ìŠ¤íƒ€ì¼ ê²€ìƒ‰ ëª¨ë‹¬ -->
    <div class="searchModal" id="searchModal" aria-hidden="true">
      <div class="searchCard" role="dialog" aria-modal="true" aria-label="ì¹´ì¹´ì˜¤ì§€ë„ ê²€ìƒ‰">
        <div class="searchTop">
          <div class="searchTopTitle">ì¹´ì¹´ì˜¤ì§€ë„ ê²€ìƒ‰</div>
          <div class="searchInput">
            <input id="searchQ" type="text" placeholder="ì¥ì†Œ, ì£¼ì†Œ, í‚¤ì›Œë“œ ê²€ìƒ‰" autocomplete="off" />
            <button id="searchRunBtn" class="miniBtn">ê²€ìƒ‰</button>
            <button id="searchCloseBtn" class="miniBtn" style="background:rgba(255,80,80,.18);border-color:rgba(255,80,80,.26)">ë‹«ê¸°</button>
          </div>
        </div>
        <div class="searchMeta">
          <div class="kbdHint">Enter: ê²€ìƒ‰ Â· ESC: ë‹«ê¸°/ë§ˆì»¤ì‚­ì œ</div>
          <div id="searchMetaCount">ì£¼ì†Œ 0ê°œ Â· ì¥ì†Œ 0ê°œ</div>
        </div>
        <div class="searchBody" id="searchResults"></div>
        <div class="searchBottom">
          <div class="kbdHint">ì£¼ì†Œ ê²€ìƒ‰ ê²°ê³¼ + ì¥ì†Œ(í‚¤ì›Œë“œ) ê²°ê³¼ë¥¼ ë™ì‹œì— í‘œì‹œí•©ë‹ˆë‹¤</div>
          <div class="pager">
            <button id="placePrevBtn" class="miniBtn">ì´ì „</button>
            <span id="placePageInfo">ì¥ì†Œ í˜ì´ì§€ 1 / 1</span>
            <button id="placeNextBtn" class="miniBtn">ë‹¤ìŒ</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>



<!-- âœ… ë²¤ë” ê²€ìƒ‰ ê²°ê³¼ ì„ íƒ ëª¨ë‹¬ -->
<div class="modal" id="vendorModal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true" aria-label="ë²¤ë” ì„ íƒ">
    <div class="modalTop">
      <div class="modalTitle">ë²¤ë” ì„ íƒ</div>
      <button id="vendorModalCloseBtn" class="miniBtn" style="background:rgba(255,80,80,.18);border-color:rgba(255,80,80,.26)">ë‹«ê¸°</button>
    </div>
    <div class="modalMeta">
      <div class="kbdHint">í´ë¦­: ì„ íƒ Â· ESC: ë‹«ê¸°</div>
      <div id="vendorMetaCount">0ê°œ</div>
    </div>
    <div class="modalBody" id="vendorResults"></div>
  </div>
</div>

<!-- âœ… 1W/2W ì„ íƒ ëª¨ë‹¬ -->
<div class="modal" id="waveModal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true" aria-label="1W/2W ì„ íƒ" style="width:min(520px, calc(100% - 40px)); max-height:none;">
    <div class="modalTop">
      <div class="modalTitle" id="waveModalTitle">ì €ì¥ êµ¬ë¶„ ì„ íƒ</div>
      <button id="waveModalCloseBtn" class="miniBtn" style="background:rgba(255,80,80,.18);border-color:rgba(255,80,80,.26)">ë‹«ê¸°</button>
    </div>
    <div class="modalMeta">
      <div class="kbdHint">ì£¼ê°„/ì•¼ê°„ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
      <div class="pill" id="waveModalVendorPill" style="display:none"></div>
    </div>
    <div class="waveGrid">
      <button id="wave2WBtn" class="waveBtn">ì£¼ê°„ (2W)<span class="sub">2Wë¡œ ì €ì¥</span></button>
      <button id="wave1WBtn" class="waveBtn">ì•¼ê°„ (1W)<span class="sub">1Wë¡œ ì €ì¥</span></button>
    </div>
  </div>
</div>

<script>
(() => {
  if (window.__coupangRouteMapInitialized) return;
  window.__coupangRouteMapInitialized = true;

  // ====== í™˜ê²½ ì„¤ì • ======
  const API_BASE = "https://route.maroowell.com"; // í•„ìš”ì‹œ ë³€ê²½
  const ROUTE_ENDPOINT = `${API_BASE}/route`;
  const OSM_ENDPOINT = `${API_BASE}/osm`;
  const ADDRESS_ENDPOINT = `${API_BASE}/addresses`;
  const VENDORS_ENDPOINT = `${API_BASE}/vendors`; // âœ… ë²¤ë” ê²€ìƒ‰(ì´ë¦„ ë¶€ë¶„ ì¼ì¹˜)

  // ====== DOM ======
  const $ = (id) => document.getElementById(id);

  const campInput = $("campInput");
  const codeInput = $("codeInput");

  // âœ… ë²¤ë”(ì£¼ê°„/ì•¼ê°„)
  const vendorWeekValue = $("vendorWeekValue");
  const vendorNightValue = $("vendorNightValue");
  const vendorSearchInput = $("vendorSearchInput");
  const vendorSearchBtn = $("vendorSearchBtn");
  const vendorPickedWrap = $("vendorPickedWrap");
  const vendorPickedText = $("vendorPickedText");
  const vendorPickedClearBtn = $("vendorPickedClearBtn");

  // âœ… ë²¤ë” ì„ íƒ ëª¨ë‹¬
  const vendorModalEl = $("vendorModal");
  const vendorModalCloseBtn = $("vendorModalCloseBtn");
  const vendorMetaCountEl = $("vendorMetaCount");
  const vendorResultsEl = $("vendorResults");

  // âœ… 1W/2W ì„ íƒ ëª¨ë‹¬
  const waveModalEl = $("waveModal");
  const waveModalCloseBtn = $("waveModalCloseBtn");
  const waveModalTitleEl = $("waveModalTitle");
  const waveModalVendorPillEl = $("waveModalVendorPill");
  const wave1WBtn = $("wave1WBtn");
  const wave2WBtn = $("wave2WBtn");

  // âœ… ì…ì°¨ì§€
  const deliveryNameInput = $("deliveryNameInput");
  const deliveryAddrInput = $("deliveryAddrInput");

  const loadBtn = $("loadBtn");
  const drawNewBtn = $("drawNewBtn");
  const drawAddBtn = $("drawAddBtn");
  const addrBtn = $("addrBtn");
  const saveBtn = $("saveBtn");
  const deletePolyBtn = $("deletePolyBtn");
  const vendorLabelToggleBtn = $("vendorLabelToggleBtn");
  const labelToggleBtn = $("labelToggleBtn");
  const resetBtn = $("resetBtn");
  const vendorSaveBtn = $("vendorSaveBtn");
  const vendorClearBtn = $("vendorClearBtn");
  const deliverySaveBtn = $("deliverySaveBtn");
  const deliveryClearBtn = $("deliveryClearBtn");
  const shareBtn = $("shareBtn");

  const logEl = $("log");
  const statusPill = $("statusPill");
  const selectedInfo = $("selectedInfo");
  const hintEl = $("hint");

  // ì§€ë„ ì»¨íŠ¸ë¡¤
  const toggleMapTypeBtn = $("toggleMapType");
  const toggleRoadviewBtn = $("toggleRoadview");
  const roadviewHintEl = $("roadviewHint");
  const mapWrapEl = $("mapWrap");

  // ê²€ìƒ‰ ëª¨ë‹¬
  const searchModalEl = $("searchModal");
  const searchQEl = $("searchQ");
  const searchRunBtn = $("searchRunBtn");
  const searchCloseBtn = $("searchCloseBtn");
  const searchResultsEl = $("searchResults");
  const searchMetaCountEl = $("searchMetaCount");
  const placePrevBtn = $("placePrevBtn");
  const placeNextBtn = $("placeNextBtn");
  const placePageInfoEl = $("placePageInfo");

  // ====== ë¡œê·¸ ======
  const ts = () => {
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    const ss = String(d.getSeconds()).padStart(2,"0");
    return `[${hh}:${mm}:${ss}]`;
  };
  function setStatus(t, kind="READY") {
    statusPill.textContent = kind;
    statusPill.style.borderColor =
      kind === "ERR" ? "rgba(255,60,60,.35)" :
      kind === "WARN" ? "rgba(255,180,0,.30)" :
      kind === "OK" ? "rgba(0,255,140,.22)" :
      "rgba(255,255,255,.10)";
    statusPill.style.background =
      kind === "ERR" ? "rgba(255,60,60,.12)" :
      kind === "WARN" ? "rgba(255,180,0,.10)" :
      kind === "OK" ? "rgba(0,255,140,.08)" :
      "rgba(255,255,255,.04)";
    if (t) log(`${kind} ${t}`);
  }
  function log(msg) {
    logEl.textContent += `${ts()} ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }
  function hint(msg, show=true) {
    hintEl.textContent = msg;
    hintEl.style.display = show ? "block" : "none";
  }

  // ====== ìƒíƒœ ======
  let map, geocoder, places;

  /** @type {Array<any>} */
  let routeRows = []; // APIì—ì„œ ë°›ì€ rowë“¤
  let addressRows = []; // ë°°ì†¡ì§€ ëª©ë¡

  /**
   * rowId -> { row, polygons: kakao.maps.Polygon[], labels: kakao.maps.CustomOverlay[] }
   */
  const overlayById = new Map();

  // ì„ íƒ/í¸ì§‘ ìƒíƒœ
  let selectedRouteId = null;   // í´ë¦­ìœ¼ë¡œ ì„ íƒëœ ë¼ìš°íŠ¸(id)
  let editingRouteId = null;    // Enterë¡œ í¸ì§‘ ì¤‘ì¸ ë¼ìš°íŠ¸(id)
  let editHandles = [];         // kakao.maps.Marker[]
  let editPolygons = [];        // kakao.maps.Polygon[]
  let labelOn = true;
  let vendorLabelOn = false;

  // âœ… ë²¤ë” ê²€ìƒ‰/í•„í„° ìƒíƒœ
  let vendorCandidate = null;              // { name, business_number, vendor_code }
  let vendorFilterBusinessNumber = null;   // ë¶ˆëŸ¬ì˜¤ê¸°(ê²€ìƒ‰)ìš©


  // âœ… (ì¶”ê°€) í´ë¦¬ê³¤ ê°œë³„ ì‚­ì œ X ì˜¤ë²„ë ˆì´
  let deleteOverlays = []; // kakao.maps.CustomOverlay[]

  // ì»¤ìŠ¤í…€ ë“œë˜ê·¸ ìƒíƒœ
  let draggingVertex = null; // { marker, polygon, index }

  // ê·¸ë¦¬ê¸° ìƒíƒœ
  let drawMode = null; // "new" | "add" | null
  let drawPoints = []; // kakao.maps.LatLng[]
  let drawMarkers = []; // kakao.maps.Marker[]
  let drawLine = null; // kakao.maps.Polyline

  // OSM ì˜¤ë²„ë ˆì´
  let osmOverlays = [];

  // âœ… ê²€ìƒ‰ ì„ íƒ ë§ˆì»¤ (ESCë¡œ ì‚­ì œ)
  let searchSelectedMarker = null;
  let searchSelectedOverlay = null;

  // âœ… ìœ„ì„±/ë¡œë“œë·°
  let isSatellite = false;
  let roadviewOn = false;    // ê¸¸ ì„ íƒ ëª¨ë“œ on/off
  let roadviewOpen = false;  // ì‹¤ì œ roadview í™”ë©´ open ì—¬ë¶€
  let roadview = null;
  let roadviewClient = null;
  let roadviewClickHandler = null;

  // âœ… ê²€ìƒ‰ ëª¨ë‹¬ ìƒíƒœ
  let searchModalOpen = false;
  let searchQuery = "";
  let placePage = 1;
  let placeLast = 1;
  let placeTotal = 0;
  let placeItems = [];
  let addrItems = [];

  // ====== ì»¬ëŸ¬(ì¸ì ‘ ë¼ìš°íŠ¸ ìƒ‰ ì°¨ì´ + ëˆˆë¶€ì‹¬ ì™„í™”) ======
  // - ë¼ìš°íŠ¸ ëª©ë¡(full_code ì •ë ¬) ê¸°ì¤€ìœ¼ë¡œ "ê³¨ë“  ì•µê¸€" ë¶„ì‚° ìƒ‰ìƒì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
  // - ì±„ë„/ëª…ë„ëŠ” ë‚®ì¶°ì„œ(ëˆˆë¶€ì‹¬ ì™„í™”) ë¼ë²¨/ì„ ë§Œ ë˜ë ·í•˜ê²Œ ë³´ì´ê²Œ í•©ë‹ˆë‹¤.
  const GOLDEN_ANGLE = 137.50776405003785;

  function clamp01(x){ return Math.max(0, Math.min(1, x)); }

  function hslToHex(h, s, l) {
    // h:0-360, s/l:0-100
    h = ((h % 360) + 360) % 360;
    s = clamp01(s / 100);
    l = clamp01(l / 100);

    const c = (1 - Math.abs(2*l - 1)) * s;
    const hh = h / 60;
    const x = c * (1 - Math.abs((hh % 2) - 1));
    let r=0,g=0,b=0;

    if (0 <= hh && hh < 1) { r=c; g=x; b=0; }
    else if (1 <= hh && hh < 2) { r=x; g=c; b=0; }
    else if (2 <= hh && hh < 3) { r=0; g=c; b=x; }
    else if (3 <= hh && hh < 4) { r=0; g=x; b=c; }
    else if (4 <= hh && hh < 5) { r=x; g=0; b=c; }
    else { r=c; g=0; b=x; }

    const m = l - c/2;
    const to255 = (v)=> Math.round((v+m)*255);
    const rr = to255(r), gg = to255(g), bb = to255(b);

    const hex = (n)=> n.toString(16).padStart(2,"0");
    return `#${hex(rr)}${hex(gg)}${hex(bb)}`;
  }

  // fallback(ë‹¨ë… í˜¸ì¶œ) - ìƒ‰ìƒ ê°•ì œ ì €ì¥í•˜ì§€ ì•Šê³  "í‘œì‹œìš©"ìœ¼ë¡œë§Œ ì”ë‹ˆë‹¤.
  function colorFor(code) {
    const str = String(code||"");
    let h = 2166136261; // FNV-1a
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    const hue = (h >>> 0) % 360;
    const sat = 28;
    const light = 60;
    return hslToHex(hue, sat, light);
  }


  // âœ… ì¸ì ‘ ë¼ìš°íŠ¸ ìƒ‰ìƒ ê²¹ì¹¨ ìµœì†Œí™”: ì •ë ¬ ìˆœì„œ ê¸°ë°˜ ê³¨ë“  ì•µê¸€ ë¶„ì‚°(ì €ì±„ë„/ì¤‘ëª…ë„)
  function buildDisplayColors(rows) {
    const arr = Array.isArray(rows) ? rows.slice() : [];
    const keyOf = (r) => String(r?.full_code || r?.code || r?.route_code || "");
    arr.sort((a,b)=> keyOf(a).localeCompare(keyOf(b), "en", { numeric:true, sensitivity:"base" }));

    // camp ê¸°ë°˜ seed (ê°™ì€ campëŠ” ê°™ì€ ì‹œì‘ìƒ‰)
    const camp = String(arr[0]?.camp || "");
    let seed = 2166136261; // FNV-1a
    for (let i=0;i<camp.length;i++){
      seed ^= camp.charCodeAt(i);
      seed = Math.imul(seed, 16777619);
    }
    const startHue = (seed >>> 0) % 360;
    const golden = 137.50776405003785; // degrees

    const map = new Map();
    for (let i=0;i<arr.length;i++){
      const r = arr[i];
      const idKey = (typeof r?.id === "number" || typeof r?.id === "string") ? r.id : keyOf(r);
      const hue = (startHue + i * golden) % 360;
      const sat = 42 + ((i * 11) % 18);      // 42~59 (ì ë‹¹í•œ ì±„ë„)
      const light = 48 + ((i * 7) % 10);      // 48~57 (ì¤‘ì €ëª…ë„)
      map.set(idKey, hslToHex(hue, sat, light));
    }
    return map;
  }

  // ====== API ======
  async function apiGet(url) {
    const res = await fetch(url, { method:"GET" });
    const text = await res.text();
    let json = null;
    try { json = text ? JSON.parse(text) : null; } catch {}
    if (!res.ok) {
      const msg = json?.error || text || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return json;
  }
  async function apiJson(method, url, body) {
    const res = await fetch(url, {
      method,
      headers: { "Content-Type":"application/json" },
      body: body ? JSON.stringify(body) : undefined
    });
    const text = await res.text();
    let json = null;
    try { json = text ? JSON.parse(text) : null; } catch {}
    if (!res.ok) {
      const msg = json?.error || text || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return json;
  }

  // ====== ìœ í‹¸: polygon_wgs84 íŒŒì‹± ======
  function parsePolygonWgs84(v, debugId = "") {
    if (!v) return null;
    if (Array.isArray(v)) return v;
    if (typeof v === "string") {
      try {
        const p = JSON.parse(v);
        if (Array.isArray(p)) return p;
      } catch (e) {
        if (debugId) log(`âš  í´ë¦¬ê³¤ íŒŒì‹± ì‹¤íŒ¨: ${debugId}`);
      }
    }
    return null;
  }

  // ====== ì§€ë„ ì˜¤ë²„ë ˆì´ ì •ë¦¬ ======
  function clearAllOverlays() {
    stopEditing();
    stopDraw(true);
    clearOsm();

    for (const {polygons, labels} of overlayById.values()) {
      polygons.forEach(p => p.setMap(null));
      labels.forEach(l => l.setMap(null));
    }
    overlayById.clear();
    routeRows = [];
    selectedRouteId = null;
    editingRouteId = null;
    selectedInfo.textContent = "ì„ íƒ: ì—†ìŒ";

    clearVendorDisplay();
    deliveryNameInput.value = "";
    deliveryAddrInput.value = "";
  }

  function clearOsm() {
    osmOverlays.forEach(o => o.setMap(null));
    osmOverlays = [];
  }

  // ====== ë¼ë²¨ ======
  function centroidOfLatLngs(latlngs) {
    let latSum=0, lngSum=0;
    for (const ll of latlngs) { latSum += ll.getLat(); lngSum += ll.getLng(); }
    return new kakao.maps.LatLng(latSum/latlngs.length, lngSum/latlngs.length);
  }
  function normalizeCenterWgs84(v) {
    if (!v) return null;
    let obj = v;
    if (typeof obj === "string") {
      try { obj = JSON.parse(obj); } catch { return null; }
    }
    let lat = null, lng = null;

    if (Array.isArray(obj) && obj.length >= 2) {
      const a = Number(obj[0]);
      const b = Number(obj[1]);
      // [lng,lat] or [lat,lng] heuristic
      if (Math.abs(a) > Math.abs(b)) { lng = a; lat = b; }
      else { lat = a; lng = b; }
    } else if (obj && typeof obj === "object") {
      lat = Number(obj.lat ?? obj.latitude ?? obj.y);
      lng = Number(obj.lng ?? obj.lon ?? obj.longitude ?? obj.x);
    }

    if (!isFinite(lat) || !isFinite(lng)) return null;
    return new kakao.maps.LatLng(lat, lng);
  }

  function vendorNameOnly(name, bn) {
    const n = (name ?? "").toString().trim();
    if (n) return n;
    const b = (bn ?? "").toString().trim();
    if (b) return b;
    return "-";
  }

  function getVendorWeekNightFromRow(row) {
    // âœ… ì£¼ê°„=2W, ì•¼ê°„=1W (ìš”êµ¬ì‚¬í•­ ë°˜ì˜)
    const name1 =
      row.vendor_name_1w ??
      row.vendor_1w_name ??
      row.vendor_week_name ??
      row.vendor_name_week ??
      null;
    const bn1 =
      row.vendor_business_number_1w ??
      row.vendor_business_number_week ??
      null;

    const name2 =
      row.vendor_name_2w ??
      row.vendor_2w_name ??
      row.vendor_night_name ??
      row.vendor_name_night ??
      null;
    const bn2 =
      row.vendor_business_number_2w ??
      row.vendor_business_number_night ??
      null;

    return {
      week: vendorNameOnly(name2, bn2),
      night: vendorNameOnly(name1, bn1)
    };
  }

  function createLabelOverlay(code, row, position, color) {
    const root = document.createElement("div");
    root.style.padding = vendorLabelOn ? "6px 10px" : "4px 8px";
    root.style.borderRadius = "14px";
    root.style.background = "rgba(0,0,0,0.55)";
    root.style.color = "#fff";
    root.style.border = "1px solid rgba(255,255,255,0.18)";
    root.style.boxShadow = "0 4px 14px rgba(0,0,0,0.28)";
    root.style.backdropFilter = "blur(2px)";
    root.style.maxWidth = "240px";
    root.style.pointerEvents = "none";
    root.style.display = "flex";
    root.style.flexDirection = "column";
    root.style.gap = vendorLabelOn ? "3px" : "0";

    const top = document.createElement("div");
    top.style.display = "inline-flex";
    top.style.alignItems = "center";
    top.style.gap = "6px";

    const dot = document.createElement("span");
    dot.style.width = "8px";
    dot.style.height = "8px";
    dot.style.borderRadius = "999px";
    dot.style.background = color;
    dot.style.boxShadow = "0 0 0 2px rgba(255,255,255,0.12)";
    dot.style.flex = "0 0 auto";

    const t = document.createElement("span");
    t.textContent = String(code || "");
    t.style.fontWeight = "900";
    t.style.fontSize = "12px";
    t.style.letterSpacing = "0.2px";
    t.style.lineHeight = "1.1";

    top.appendChild(dot);
    top.appendChild(t);
    root.appendChild(top);

    if (vendorLabelOn) {
      const { week, night } = getVendorWeekNightFromRow(row || {});
      const box = document.createElement("div");
      box.style.display = "flex";
      box.style.flexDirection = "column";
      box.style.gap = "1px";
      box.style.fontSize = "11px";
      box.style.lineHeight = "1.2";
      box.style.color = "rgba(255,255,255,0.88)";

      const l1 = document.createElement("div");
      l1.textContent = `ì£¼ê°„: ${week}`;
      const l2 = document.createElement("div");
      l2.textContent = `ì•¼ê°„: ${night}`;

      [l1, l2].forEach(el => {
        el.style.whiteSpace = "nowrap";
        el.style.overflow = "hidden";
        el.style.textOverflow = "ellipsis";
      });

      box.appendChild(l1);
      box.appendChild(l2);
      root.appendChild(box);
    }

    return new kakao.maps.CustomOverlay({ position, content: root, yAnchor: 1.0, zIndex: 10 });
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ====== í´ë¦¬ê³¤ ìƒì„± ======
  function makePolygon(latlngs, strokeColor, fillColor, zIndex=1) {
    return new kakao.maps.Polygon({
      path: latlngs, // ë°˜ë“œì‹œ LatLng[]
      strokeWeight: 1,
      strokeColor,
      strokeOpacity: 1.0,
      strokeStyle: "solid",
      fillColor,
      fillOpacity: 0.24,
      zIndex
    });
  }

  // ====== (ì¶”ê°€) í´ë¦¬ê³¤ ê°œë³„ ì‚­ì œ X ì˜¤ë²„ë ˆì´ ìœ í‹¸ ======
  function clearDeleteOverlays() {
    deleteOverlays.forEach(o => o.setMap(null));
    deleteOverlays = [];
  }

  function getPolygonPathAsArray(polygon) {
    const rawPath = polygon.getPath();
    const out = [];
    if (!rawPath) return out;

    if (Array.isArray(rawPath)) {
      out.push(...rawPath);
      return out;
    }
    if (typeof rawPath.getLength === "function" && typeof rawPath.getAt === "function") {
      for (let i = 0; i < rawPath.getLength(); i++) out.push(rawPath.getAt(i));
      return out;
    }
    return out;
  }

  function createDeleteOverlayForPolygon(polygon) {
    const path = getPolygonPathAsArray(polygon);
    if (!path || path.length < 3) return null;

    const pos = centroidOfLatLngs(path);

    const btn = document.createElement("div");
    btn.textContent = "Ã—";
    btn.title = "ì´ êµ¬ì—­ë§Œ ì‚­ì œ";
    btn.style.width = "22px";
    btn.style.height = "22px";
    btn.style.display = "flex";
    btn.style.alignItems = "center";
    btn.style.justifyContent = "center";
    btn.style.borderRadius = "999px";
    btn.style.cursor = "pointer";
    btn.style.userSelect = "none";
    btn.style.background = "rgba(0,0,0,.72)";
    btn.style.color = "#fff";
    btn.style.border = "1px solid rgba(255,255,255,.22)";
    btn.style.boxShadow = "0 3px 12px rgba(0,0,0,.45)";
    btn.style.fontWeight = "900";
    btn.style.fontSize = "14px";
    btn.style.lineHeight = "1";

    btn.onmouseenter = () => {
      btn.style.background = "rgba(255,60,60,.75)";
      btn.style.borderColor = "rgba(255,60,60,.55)";
    };
    btn.onmouseleave = () => {
      btn.style.background = "rgba(0,0,0,.72)";
      btn.style.borderColor = "rgba(255,255,255,.22)";
    };

    btn.onclick = (e) => {
      if (e && typeof e.stopPropagation === "function") e.stopPropagation();
      deleteSinglePolygonOnly(polygon);
    };

    return new kakao.maps.CustomOverlay({
      position: pos,
      content: btn,
      xAnchor: 0.5,
      yAnchor: 0.5,
      zIndex: 30
    });
  }

  function rebuildDeleteOverlays() {
    clearDeleteOverlays();
    if (!selectedRouteId) return;
    if (!editPolygons || editPolygons.length === 0) return;

    for (const p of editPolygons) {
      const overlay = createDeleteOverlayForPolygon(p);
      if (!overlay) continue;
      overlay.setMap(map);
      deleteOverlays.push(overlay);
    }
  }

  function deleteSinglePolygonOnly(targetPolygon) {
    if (!selectedRouteId || !overlayById.has(selectedRouteId)) return;

    const pack = overlayById.get(selectedRouteId);
    if (!pack || !pack.polygons) return;

    targetPolygon.setMap(null);

    pack.polygons = pack.polygons.filter(p => p !== targetPolygon);
    editPolygons = editPolygons.filter(p => p !== targetPolygon);

    if (pack.polygons.length === 0) {
      updateSelectedLabels();
      stopEditing();
      setStatus("í•´ë‹¹ ë¼ìš°íŠ¸ì˜ êµ¬ì—­ì´ ëª¨ë‘ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥í•˜ë©´ ë°˜ì˜ë©ë‹ˆë‹¤.", "WARN");
      return;
    }

    updateSelectedLabels();
    rebuildHandles();
    setStatus("êµ¬ì—­ 1ê°œ ì œê±°(ë¡œì»¬). ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°˜ì˜í•˜ì„¸ìš”.", "OK");
  }

  // ====== âœ… ê²€ìƒ‰ ì„ íƒ ë§ˆì»¤ ìœ í‹¸ (ESCë¡œ ì‚­ì œ) ======
  function clearSearchSelectedMarker() {
    if (searchSelectedMarker) {
      searchSelectedMarker.setMap(null);
      searchSelectedMarker = null;
    }
    if (searchSelectedOverlay) {
      if (typeof searchSelectedOverlay.setMap === "function") searchSelectedOverlay.setMap(null);
      if (typeof searchSelectedOverlay.close === "function") searchSelectedOverlay.close();
      searchSelectedOverlay = null;
    }
  }

  function setSearchSelectedMarker(latlng) {
    clearSearchSelectedMarker();
    searchSelectedMarker = new kakao.maps.Marker({
      position: latlng,
      zIndex: 999
    });
    searchSelectedMarker.setMap(map);
  }

  // ====== ë°ì´í„° í‘œì‹œ ======
  function renderRoutes(rows) {
    clearAllOverlays();
    routeRows = rows || [];

    const displayColorMap = buildDisplayColors(routeRows);

    if (!routeRows.length) {
      setStatus("í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", "WARN");
      return;
    }

    let bounds = new kakao.maps.LatLngBounds();
    let any = false;

    for (const row of routeRows) {
      const id = row.id;
      const code = row.full_code || row.code || row.route_code || "";
      const camp = row.camp || row.camp_name || "";
      const colorMap = displayColorMap;
      const idKey = (typeof id === "number" || typeof id === "string") ? id : code;
      const color = (colorMap && colorMap.get(idKey)) || colorFor(code);
      row.color = color;
      const debugId = `${camp}/${code}(id=${id})`;

      const poly = parsePolygonWgs84(row.polygon_wgs84, debugId);

      const polygons = [];
      const labels = [];

      if (poly && Array.isArray(poly) && poly.length > 0) {
        let rings = [];

        const first = poly[0];
        if (first && typeof first === 'object' && 'lat' in first && 'lng' in first) {
          rings = [poly];
        } else if (Array.isArray(first)) {
          const firstOfFirst = first[0];
          if (firstOfFirst && typeof firstOfFirst === 'object' && 'lat' in firstOfFirst && 'lng' in firstOfFirst) {
            rings = poly;
          } else if (Array.isArray(firstOfFirst) && firstOfFirst.length >= 2) {
            rings = poly;
          } else if (typeof firstOfFirst === 'number') {
            rings = [poly];
          }
        }

        for (let i=0; i<rings.length; i++) {
          const ring = rings[i];
          if (!Array.isArray(ring) || ring.length < 3) continue;

          const latlngs = ring.map(pt => {
            if (pt && typeof pt === 'object' && 'lat' in pt && 'lng' in pt) {
              return new kakao.maps.LatLng(pt.lat, pt.lng);
            } else if (Array.isArray(pt) && pt.length >= 2) {
              return new kakao.maps.LatLng(pt[1], pt[0]);
            }
            return null;
          }).filter(ll => ll !== null);

          if (latlngs.length < 3) continue;
          const p = makePolygon(latlngs, color, color, 1);
          p.setMap(map);

          kakao.maps.event.addListener(p, "click", () => {
            if (drawMode || roadviewOn || searchModalOpen) return;
            selectRoute(id);
          });

          polygons.push(p);
          any = true;
          latlngs.forEach(ll => bounds.extend(ll));


        }
      }

      // âœ… ë¼ìš°íŠ¸ ë¼ë²¨(ì½”ë“œ + ë²¤ë”) - 1ê°œë§Œ í‘œì‹œ
      if (labelOn && polygons.length > 0) {
        const pos =
          normalizeCenterWgs84(row.center_wgs84) ||
          centroidOfLatLngs(polygons[0].getPath());
        const label = createLabelOverlay(code, row, pos, color);
        label.setMap(map);
        labels.push(label);
      }

      overlayById.set(id, { row, polygons, labels });
    }

    if (any) {
      map.setBounds(bounds);
      setStatus(`${routeRows.length}ê°œ ë¼ìš°íŠ¸ ë¡œë“œ ì™„ë£Œ`, "OK");
    } else {
      setStatus(`í´ë¦¬ê³¤ ë°ì´í„° ì—†ìŒ. ìƒˆë¡œ ê·¸ë¦¬ê¸°ë¡œ ìƒì„±í•˜ì„¸ìš”.`, "WARN");
    }
  }

  // ====== í¸ì§‘(ë²„í…ìŠ¤ í•¸ë“¤) ======
  let VERTEX_IMG = null;
  let MID_IMG = null;

  function makeHandleImage(fill="#ffffff", stroke="#111827") {
    const svg =
      `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12">
        <circle cx="6" cy="6" r="5" fill="${fill}" stroke="${stroke}" stroke-width="1.5"/>
      </svg>`;
    const uri = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    return new kakao.maps.MarkerImage(uri, new kakao.maps.Size(12,12), { offset: new kakao.maps.Point(6,6) });
  }

  function makeLabelAnchorImage() {
    const svg =
      `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14">
        <circle cx="7" cy="7" r="6" fill="rgba(59,130,246,0.95)" stroke="#ffffff" stroke-width="2"/>
        <circle cx="7" cy="7" r="2" fill="#111827" opacity="0.9"/>
      </svg>`;
    const uri = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    return new kakao.maps.MarkerImage(uri, new kakao.maps.Size(14,14), { offset: new kakao.maps.Point(7,7) });
  }

  let labelAnchorMarker = null;
  let labelAnchorLatLng = null;
  let labelAnchorDirty = false;

  function stopLabelAnchorEdit() {
    if (labelAnchorMarker) {
      labelAnchorMarker.setMap(null);
      labelAnchorMarker = null;
    }
    labelAnchorLatLng = null;
    labelAnchorDirty = false;
  }

  function startLabelAnchorEdit(routeId) {
    stopLabelAnchorEdit();
    const pack = overlayById.get(routeId);
    if (!pack || !pack.polygons || pack.polygons.length === 0) return;

    const row = pack.row || {};
    const pos =
      normalizeCenterWgs84(row.center_wgs84) ||
      centroidOfLatLngs(pack.polygons[0].getPath());

    labelAnchorLatLng = pos;
    labelAnchorDirty = false;

    labelAnchorMarker = new kakao.maps.Marker({
      position: pos,
      image: makeLabelAnchorImage(),
      draggable: true,
      zIndex: 9999
    });
    labelAnchorMarker.setMap(map);

    const applyPos = (p) => {
      labelAnchorLatLng = p;
      labelAnchorDirty = true;

      // ì¦‰ì‹œ ë¼ë²¨ ìœ„ì¹˜ ë°˜ì˜ (ë³´ì´ëŠ” ê²½ìš°)
      if (pack.labels && pack.labels.length > 0) {
        pack.labels.forEach(l => l.setPosition(p));
      }
    };

    kakao.maps.event.addListener(labelAnchorMarker, "dragend", () => {
      applyPos(labelAnchorMarker.getPosition());
    });

    // ìš°í´ë¦­: ìë™ ì¤‘ì‹¬(centroid)ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
    kakao.maps.event.addListener(labelAnchorMarker, "rightclick", () => {
      const c = centroidOfLatLngs(pack.polygons[0].getPath());
      labelAnchorMarker.setPosition(c);
      applyPos(c);
    });
  }

  function vendorText(name, bn) {
    const n = (name ?? "").toString().trim();
    if (n) return n;
    const b = (bn ?? "").toString().trim();
    if (b) return "ì§€ì •ë¨";
    return "-";
  }

  function setVendorDisplayFromRow(row) {
    const name1 =
      row.vendor_name_1w ??
      row.vendor_1w_name ??
      row.vendor_week_name ??
      row.vendor_name_week ??
      null;
    const bn1 =
      row.vendor_business_number_1w ??
      row.vendor_business_number_week ??
      null;

    const name2 =
      row.vendor_name_2w ??
      row.vendor_2w_name ??
      row.vendor_night_name ??
      row.vendor_name_night ??
      null;
    const bn2 =
      row.vendor_business_number_2w ??
      row.vendor_business_number_night ??
      null;

    if (vendorWeekValue) vendorWeekValue.textContent = vendorText(name2, bn2);
    if (vendorNightValue) vendorNightValue.textContent = vendorText(name1, bn1);
  }

  function clearVendorDisplay() {
    if (vendorWeekValue) vendorWeekValue.textContent = "-";
    if (vendorNightValue) vendorNightValue.textContent = "-";
  }

  function applyBasePolygonStyle() {
    for (const {row, polygons} of overlayById.values()) {
      const base = row.color || colorFor(row.full_code || "");
      polygons.forEach(p => {
        p.setOptions({
          strokeColor: base,
          fillColor: base,
          strokeWeight: 1,
          fillOpacity: 0.24,
          zIndex: 1
        });
      });
    }
  }

  function applySelectionStyle(routeId) {
    if (!routeId) return;
    const pack = overlayById.get(routeId);
    if (!pack) return;
    const { row, polygons } = pack;
    const base = row.color || colorFor(row.full_code || "");
    polygons.forEach(p => {
      p.setOptions({ strokeColor: base, fillColor: base, strokeWeight: 3, fillOpacity: 0.24, zIndex: 5 });
    });
  }

  function stopEditing() {
    editHandles.forEach(m => m.setMap(null));
    editHandles = [];
    editPolygons = [];
    draggingVertex = null;
    if (map) map.setDraggable(true);

    clearDeleteOverlays();

    editingRouteId = null;

    applyBasePolygonStyle();

    // âœ… ì„ íƒëœ ë¼ìš°íŠ¸ëŠ” "ì§„í•´ì§„ ìƒíƒœ" ìœ ì§€
    if (selectedRouteId && overlayById.has(selectedRouteId)) {
      applySelectionStyle(selectedRouteId);
    }
  }

  function selectRoute(routeId, { silent = false } = {}) {
    if (!overlayById.has(routeId)) return;

    if (roadviewOn) {
      setStatus("ë¡œë“œë·° ëª¨ë“œì—ì„œëŠ” ë¼ìš°íŠ¸ ì„ íƒë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (Enter í¸ì§‘ ë¶ˆê°€)", "WARN");
    }

    stopDraw(true);

    selectedRouteId = routeId;
    stopEditing(); // í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ + ì„ íƒ í•˜ì´ë¼ì´íŠ¸ ì ìš©

    const pack = overlayById.get(routeId);
    const { row } = pack;

    const code = row.full_code || row.code || row.route_code || "";
    const camp = row.camp || row.camp_name || "";
    selectedInfo.textContent = `ì„ íƒ: ${camp} / ${code} (id=${routeId})`;

    // ì¢Œì¸¡ ì…ë ¥ê°’ ë™ê¸°í™”
    campInput.value = camp;
    codeInput.value = code;

    setVendorDisplayFromRow(row);

    deliveryNameInput.value = row.delivery_location_name || "";
    deliveryAddrInput.value = row.delivery_location_address || "";

    loadAddresses().catch(err => log(`ë°°ì†¡ì§€ ë¡œë“œ ì‹¤íŒ¨: ${err.message}`));

    if (!silent) setStatus(`ì„ íƒë¨: ${code} (Enterë¡œ ìˆ˜ì • ëª¨ë“œ)`, "OK");
  }

  function startEditing(routeId) {
    if (!overlayById.has(routeId)) return;

    if (roadviewOn) {
      setStatus("ë¡œë“œë·° ëª¨ë“œì—ì„œëŠ” ìˆ˜ì • ëª¨ë“œë¡œ ì§„ì…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œë“œë·°ë¥¼ ì¢…ë£Œí•˜ì„¸ìš”.", "WARN");
      return;
    }
    if (searchModalOpen) closeSearchModal();

    stopDraw(true);

    selectedRouteId = routeId;
    stopEditing(); // ê¸°ì¡´ í¸ì§‘ ì •ë¦¬ + ì„ íƒ í•˜ì´ë¼ì´íŠ¸

    editingRouteId = routeId;

    const pack = overlayById.get(routeId);
    const { row, polygons } = pack;

    const code = row.full_code || row.code || row.route_code || "";
    const camp = row.camp || row.camp_name || "";
    selectedInfo.textContent = `ì„ íƒ: ${camp} / ${code} (id=${routeId})`;

    // ì¢Œì¸¡ ì…ë ¥ê°’ ë™ê¸°í™”
    campInput.value = camp;
    codeInput.value = code;

    setVendorDisplayFromRow(row);

    deliveryNameInput.value = row.delivery_location_name || "";
    deliveryAddrInput.value = row.delivery_location_address || "";

    if (!polygons || polygons.length === 0) {
      setStatus(`ì„ íƒ ëŒ€ìƒ ${code}ëŠ” polygonì´ ì—†ìŠµë‹ˆë‹¤. "ìƒˆë¡œ ê·¸ë¦¬ê¸°"ë¡œ ìƒì„±í•˜ì„¸ìš”.`, "WARN");
      return;
    }

    // í¸ì§‘ìš© í´ë¦¬ê³¤ ëª©ë¡
    editPolygons = polygons.slice();

    rebuildHandles();
    startLabelAnchorEdit(routeId);
    setStatus(`í¸ì§‘ ëª¨ë“œ: ${code} (Enter=ì €ì¥ Â· ESC=ì¢…ë£Œ)`, "OK");
  }

  function rebuildHandles() {
    editHandles.forEach(m => m.setMap(null));
    editHandles = [];

    for (const polygon of editPolygons) {
      const rawPath = polygon.getPath();
      if (!rawPath) {
        log(`âš  rebuildHandles: polygon.getPath()ê°€ null`);
        continue;
      }

      const path = [];
      const len = Array.isArray(rawPath) ? rawPath.length : (rawPath.getLength ? rawPath.getLength() : 0);
      for (let i = 0; i < len; i++) {
        path.push(Array.isArray(rawPath) ? rawPath[i] : rawPath.getAt(i));
      }

      if (path.length < 3) continue;

      for (let i=0;i<path.length;i++) {
        ((index, polygon) => {
          const vMarker = new kakao.maps.Marker({
            position: path[index],
            image: VERTEX_IMG,
            clickable: true,
            zIndex: 20
          });

          vMarker.setMap(map);

          kakao.maps.event.addListener(vMarker, "mousedown", (e) => {
            if (roadviewOn || searchModalOpen) return;
            draggingVertex = { marker: vMarker, polygon, index };
            map.setDraggable(false);

            if (e && e.domEvent) {
              e.domEvent.preventDefault();
              e.domEvent.stopPropagation();
            }
          });

          kakao.maps.event.addListener(vMarker, "rightclick", () => {
            const pth = polygon.getPath();
            const len = Array.isArray(pth) ? pth.length : (pth.getLength ? pth.getLength() : 0);
            if (len <= 3) {
              setStatus("ì  ì‚­ì œ ë¶ˆê°€: ìµœì†Œ 3ê°œ ê¼­ì§“ì  ìœ ì§€ í•„ìš”", "WARN");
              return;
            }
            const pathArray = [];
            for (let j = 0; j < len; j++) {
              if (j !== index) {
                pathArray.push(Array.isArray(pth) ? pth[j] : pth.getAt(j));
              }
            }
            polygon.setPath(pathArray);
            updateSelectedLabels();
            rebuildHandles();
          });

          editHandles.push(vMarker);
        })(i, polygon);
      }

      for (let i=0;i<path.length;i++) {
        ((index, polygon) => {
          const a = path[index];
          const b = path[(index+1)%path.length];

          const mid = new kakao.maps.LatLng(
            (a.getLat()+b.getLat())/2,
            (a.getLng()+b.getLng())/2
          );

          const midMarker = new kakao.maps.Marker({
            position: mid,
            clickable: true,
            image: MID_IMG,
            zIndex: 19
          });
          midMarker.setMap(map);

          kakao.maps.event.addListener(midMarker, "click", () => {
            const pth = polygon.getPath();
            const len = Array.isArray(pth) ? pth.length : (pth.getLength ? pth.getLength() : 0);
            const pathArray = [];
            for (let j = 0; j < len; j++) {
              pathArray.push(Array.isArray(pth) ? pth[j] : pth.getAt(j));
              if (j === index) {
                pathArray.push(mid);
              }
            }
            polygon.setPath(pathArray);
            updateSelectedLabels();
            rebuildHandles();
          });

          editHandles.push(midMarker);
        })(i, polygon);
      }
    }

    rebuildDeleteOverlays();
  }

  function updateSelectedLabels() {
    // ê¸°ì¡´: ì„ íƒ ë¼ìš°íŠ¸ ë¼ë²¨ ì¬ìƒì„±. í˜„ì¬ëŠ” ì „ì²´ ë¼ë²¨ì„ ê°€ë³ê²Œ ë¦¬í”„ë ˆì‹œ.
    if (!(labelOn || vendorLabelOn)) return;
    refreshLabelsOnly();
  }
      

  // ====== ê·¸ë¦¬ê¸° ëª¨ë“œ ======
  function stopDraw(silent=false) {
    drawMode = null;
    drawPoints = [];
    drawMarkers.forEach(m => m.setMap(null));
    drawMarkers = [];
    if (drawLine) { drawLine.setMap(null); drawLine = null; }
    hint("", false);
}

  function beginDraw(mode) {
    const camp = campInput.value.trim();
    const code = codeInput.value.trim();
    if (!camp) { setStatus("campê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
    if (!code) { setStatus("codeê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤. (ìƒˆë¡œ ê·¸ë¦¬ê¸°/êµ¬ì—­ ì¶”ê°€ëŠ” code í•„ìˆ˜)", "ERR"); return; }

    if (roadviewOn) {
      setStatus("ë¡œë“œë·° ëª¨ë“œì—ì„œëŠ” ê·¸ë¦¬ê¸°ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œë“œë·°ë¥¼ ì¢…ë£Œí•˜ì„¸ìš”.", "WARN");
      return;
    }
    if (searchModalOpen) closeSearchModal();

    stopEditing();
    stopDraw(true);

    drawMode = mode;
    drawPoints = [];
    drawMarkers = [];

    if (drawLine) drawLine.setMap(null);
    drawLine = new kakao.maps.Polyline({
      path: [],
      strokeWeight: 1,
      strokeColor: "#00C2FF",
      strokeOpacity: 0.9,
      strokeStyle: "shortdash"
    });
    drawLine.setMap(map);

    hint("ê·¸ë¦¬ê¸° ëª¨ë“œ: ì§€ë„ í´ë¦­ìœ¼ë¡œ ì  ì¶”ê°€ Â· Enterí‚¤ë¡œ ì™„ë£Œ Â· ìš°í´ë¦­ìœ¼ë¡œ ë§ˆì§€ë§‰ ì  ì·¨ì†Œ Â· ESCë¡œ ì·¨ì†Œ", true);
    setStatus(mode === "new" ? "ìƒˆë¡œ ê·¸ë¦¬ê¸° ì‹œì‘" : "êµ¬ì—­ ì¶”ê°€ ì‹œì‘", "OK");
  }

  function addDrawPoint(latlng) {
    drawPoints.push(latlng);

    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10">
      <circle cx="5" cy="5" r="4" fill="#00C2FF" stroke="#0b1220" stroke-width="1.5"/>
    </svg>`;
    const markerImageSrc = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    const markerImage = new kakao.maps.MarkerImage(markerImageSrc, new kakao.maps.Size(10, 10), {
      offset: new kakao.maps.Point(5, 5)
    });

    const m = new kakao.maps.Marker({
      position: latlng,
      image: markerImage,
      zIndex: 30
    });
    m.setMap(map);
    drawMarkers.push(m);

    drawLine.setPath(drawPoints);
  }

  function popDrawPoint() {
    if (drawPoints.length === 0) return;
    drawPoints.pop();
    const m = drawMarkers.pop();
    if (m) m.setMap(null);
    drawLine.setPath(drawPoints);
  }

  function finishDraw() {
    if (drawPoints.length < 3) {
      setStatus("í´ë¦¬ê³¤ ìƒì„± ì‹¤íŒ¨: ì ì´ 3ê°œ ì´ìƒ í•„ìš”", "WARN");
      return;
    }

    const camp = campInput.value.trim();
    const code = codeInput.value.trim();
    const color = colorFor(code);

    let rowId = selectedRouteId;
    let row = null;

    if (rowId && overlayById.has(rowId)) {
      row = overlayById.get(rowId).row;
    }

    if (drawMode === "new") {
      if (rowId && overlayById.has(rowId)) {
        const pack = overlayById.get(rowId);
        pack.polygons.forEach(p => p.setMap(null));
        pack.labels.forEach(l => l.setMap(null));
        pack.polygons = [];
        pack.labels = [];
      } else {
        for (const [id, pack] of overlayById.entries()) {
          const r = pack.row;
          if ((r.camp||"") === camp && (r.full_code||"") === code) {
            rowId = id;
            pack.polygons.forEach(p => p.setMap(null));
            pack.labels.forEach(l => l.setMap(null));
            pack.polygons = [];
            pack.labels = [];
            break;
          }
        }
      }
    }

    const poly = makePolygon(drawPoints.slice(), color, color, 5);
    poly.setMap(map);
    kakao.maps.event.addListener(poly, "click", () => {
      if (!rowId) return;
      if (drawMode || roadviewOn || searchModalOpen) return;
      selectRoute(rowId);
    });

    if (!rowId) {
      rowId = `tmp_${camp}_${code}`;
      overlayById.set(rowId, {
        row: {
          id: rowId,
          camp,
          full_code: code,
          color,
          polygon_wgs84: null,
          vendor_business_number_1w: null,
          vendor_business_number_2w: null,
          vendor_name_1w: null,
          vendor_name_2w: null,
          delivery_location_name: deliveryNameInput.value.trim(),
          delivery_location_address: deliveryAddrInput.value.trim()
        },
        polygons: [],
        labels: []
      });
    }

    const pack = overlayById.get(rowId);
    pack.row.camp = camp;
    pack.row.full_code = code;
    pack.row.color = color;

    pack.polygons.push(poly);

    if (labelOn) {
      const c = centroidOfLatLngs(drawPoints);
      const label = createLabelOverlay(code, pack.row, c, color);
      label.setMap(map);
      pack.labels.push(label);
    }

    stopDraw(true);
    selectedRouteId = rowId;
    selectedInfo.textContent = `ì„ íƒ: ${camp} / ${code} (id=${rowId})`;
    editPolygons = pack.polygons.slice();
    rebuildHandles();
    hint("", false);

    setStatus(`í´ë¦¬ê³¤ ìƒì„± ì™„ë£Œ: ${drawMode === "new" ? "êµì²´" : "ì¶”ê°€"} 1ê°œ`, "OK");
  }

  // ====== ì €ì¥ ë°ì´í„° ë§Œë“¤ê¸° ======
  function getCurrentEditedPolygonWgs84ById(id) {
    const pack = overlayById.get(id);
    if (!pack) return null;
    const polys = pack.polygons;
    if (!polys || polys.length === 0) return null;

    const out = [];
    for (const p of polys) {
      const pathRaw = p.getPath();
      const path = [];
      if (pathRaw && typeof pathRaw.getLength === "function") {
        for (let i=0;i<pathRaw.getLength();i++) path.push(pathRaw.getAt(i));
      } else if (Array.isArray(pathRaw)) {
        path.push(...pathRaw);
      }
      if (!path || path.length < 3) continue;

      const ring = [];
      for (let i=0;i<path.length;i++) {
        const ll = path[i];
        ring.push([ ll.getLng(), ll.getLat() ]);
      }
      out.push(ring);
    }
    return out.length ? out : null;
  }

  // ====== ë°°ì†¡ì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ======
  async function loadAddresses() {
    try {
      const camp = campInput.value.trim();
      const code = codeInput.value.trim();
      if (!camp) return;

      const url = new URL(ADDRESS_ENDPOINT);
      url.searchParams.set("camp", camp);
      if (code) url.searchParams.set("code", code);

      const data = await apiGet(url.toString());
      addressRows = data?.rows || [];

      renderAddressList();
      log(`ë°°ì†¡ì§€ ${addressRows.length}ê°œ ë¡œë“œ ì™„ë£Œ`);
    } catch (e) {
      console.error('ë°°ì†¡ì§€ ë¡œë“œ ì‹¤íŒ¨:', e);
      addressRows = [];
      renderAddressList();
    }
  }

  // ====== ë°°ì†¡ì§€ ëª©ë¡ ë Œë”ë§ ======
  function renderAddressList() {
    const container = document.getElementById("addressList");
    const group = document.getElementById("addressListGroup");

    if (!addressRows || addressRows.length === 0) {
      group.style.display = "none";
      container.innerHTML = "";
      return;
    }

    group.style.display = "block";
    container.innerHTML = "";

    addressRows.forEach((addr, idx) => {
      const item = document.createElement("div");
      item.style.cssText = `
        padding: 8px;
        margin-bottom: 6px;
        background: rgba(0,0,0,0.15);
        border: 1px solid var(--line);
        border-radius: 8px;
        font-size: 12px;
      `;

      const addressText = addr.address || addr.full_address || "ì£¼ì†Œ ì—†ìŒ";
      const dong = addr.dong ? `<span style="color:var(--muted)">(${addr.dong})</span>` : "";

      item.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
          <div style="flex:1; min-width:0;">
            <div style="font-weight:600; color:var(--txt); margin-bottom:2px;">
              ${idx + 1}. ${addressText} ${dong}
            </div>
            <div style="color:var(--muted); font-size:11px;">
              ${addr.zipcode ? `ìš°í¸ë²ˆí˜¸: ${addr.zipcode}` : ""}
            </div>
          </div>
          <button class="btn" style="padding:6px 12px; font-size:11px; white-space:nowrap;">
            ë„¤ë¹„
          </button>
        </div>
      `;

      const naviBtn = item.querySelector("button");
      naviBtn.onclick = () => openNaviToAddress(addr);

      container.appendChild(item);
    });
  }

  // ====== ë°°ì†¡ì§€ë¡œ ë„¤ë¹„ ì‹¤í–‰ ======
  async function openNaviToAddress(addr) {
    const deliveryAddr = deliveryAddrInput.value.trim();

    if (!deliveryAddr) {
      setStatus("ì…ì°¨ì§€ ì£¼ì†Œë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.", "WARN");
      return;
    }

    if (!addr.center_wgs84) {
      setStatus("ë°°ì†¡ì§€ ì¢Œí‘œ(center_wgs84)ê°€ ì—†ìŠµë‹ˆë‹¤.", "ERR");
      return;
    }

    setStatus(`ê²½ë¡œ ê³„ì‚° ì¤‘: ì…ì°¨ì§€ â†’ ${addr.address || "ë°°ì†¡ì§€"}`, "OK");

    geocoder.addressSearch(deliveryAddr, (result, status) => {
      if (status !== kakao.maps.services.Status.OK || !result?.length) {
        setStatus("ì…ì°¨ì§€ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "ERR");
        return;
      }

      const startLat = Number(result[0].y);
      const startLng = Number(result[0].x);

      let endLat, endLng;

      if (typeof addr.center_wgs84 === 'object') {
        endLat = addr.center_wgs84.lat || addr.center_wgs84.latitude;
        endLng = addr.center_wgs84.lng || addr.center_wgs84.lon || addr.center_wgs84.longitude;
      } else if (Array.isArray(addr.center_wgs84) && addr.center_wgs84.length >= 2) {
        const [first, second] = addr.center_wgs84;
        if (Math.abs(first) > Math.abs(second)) {
          endLng = first;
          endLat = second;
        } else {
          endLat = first;
          endLng = second;
        }
      }

      if (!endLat || !endLng || !isFinite(endLat) || !isFinite(endLng)) {
        setStatus("ë°°ì†¡ì§€ ì¢Œí‘œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.", "ERR");
        log(`center_wgs84: ${JSON.stringify(addr.center_wgs84)}`);
        return;
      }

      const deliveryName = deliveryNameInput.value.trim() || "ì…ì°¨ì§€";
      const addressName = addr.address || "ë°°ì†¡ì§€";

      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      let naviUrl;
      if (isMobile) {
        naviUrl = `kakaomap://route?sp=${startLat},${startLng}&ep=${endLat},${endLng}&by=CAR`;
      } else {
        naviUrl = `https://map.kakao.com/link/from/${encodeURIComponent(deliveryName)},${startLat},${startLng}/to/${encodeURIComponent(addressName)},${endLat},${endLng}`;
      }

      window.open(naviUrl, "_blank");
      setStatus(`ë„¤ë¹„ ì‹¤í–‰: ${deliveryName} â†’ ${addressName}`, "OK");
      log(`ê²½ë¡œ: (${startLat.toFixed(4)}, ${startLng.toFixed(4)}) â†’ (${endLat.toFixed(4)}, ${endLng.toFixed(4)})`);
    });
  }

  // ====== ë¶ˆëŸ¬ì˜¤ê¸° ======
  async function loadRoutes() {
    try {
      stopEditing();
      stopDraw(true);
      hint("", false);
      clearOsm();

      const camp = campInput.value.trim();
      const code = codeInput.value.trim();
      if (!camp) { setStatus("campê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }

      const codes = code ? code.split(/[,\s]+/).map(c => c.trim()).filter(c => c) : [];

      let allRows = [];

      if (codes.length === 0) {
        const url = new URL(ROUTE_ENDPOINT);
        url.searchParams.set("camp", camp);
        url.searchParams.set("mode", "prefix");
const data = await apiGet(url.toString());
        if (!data || !data.rows) {
          setStatus("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜", "ERR");
          return;
        }
        allRows = data.rows;
      } else if (codes.length === 1) {
        const url = new URL(ROUTE_ENDPOINT);
        url.searchParams.set("camp", camp);
        url.searchParams.set("mode", "prefix");
        url.searchParams.set("code", codes[0]);
const data = await apiGet(url.toString());
        if (!data || !data.rows) {
          setStatus("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜", "ERR");
          return;
        }
        allRows = data.rows;
      } else {
        setStatus(`${codes.length}ê°œ ë¼ìš°íŠ¸ ì¡°íšŒ ì¤‘...`, "OK");

        for (const singleCode of codes) {
          try {
            const url = new URL(ROUTE_ENDPOINT);
            url.searchParams.set("camp", camp);
            url.searchParams.set("mode", "prefix");
            url.searchParams.set("code", singleCode);
const data = await apiGet(url.toString());

            if (data && data.rows && data.rows.length > 0) {
              allRows.push(...data.rows);
              log(`${singleCode}: ${data.rows.length}ê°œ ë°œê²¬`);
            } else {
              log(`${singleCode}: ë°ì´í„° ì—†ìŒ`);
            }
          } catch (err) {
            log(`${singleCode}: ì¡°íšŒ ì‹¤íŒ¨ - ${err.message}`);
          }
        }
      }

      if (allRows.length === 0) {
        setStatus("ì¡°íšŒëœ ë¼ìš°íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.", "WARN");
        clearAllOverlays();
        return;
      }


      // âœ… í‘œì‹œìš© ì»¬ëŸ¬ ì¬ë¶€ì—¬ (DBì— ì €ì¥í•˜ì§€ ì•ŠìŒ)
      // full_code ì •ë ¬ ê¸°ì¤€ìœ¼ë¡œ ì¸ì ‘ ë¼ìš°íŠ¸ ìƒ‰ì´ ë¹„ìŠ·í•´ì§€ì§€ ì•Šë„ë¡ ë¶„ì‚°í•©ë‹ˆë‹¤.
      try {
        const codesSorted = Array.from(
          new Set(
            (allRows || [])
              .map(r => (r.full_code || r.code || "").toString().trim())
              .filter(Boolean)
          )
        ).sort((a,b)=> a.localeCompare(b, "en", {numeric:true, sensitivity:"base"}));

        const colorMap = new Map();
        for (let i=0; i<codesSorted.length; i++) {
          const hue = (i * GOLDEN_ANGLE) % 360;
          const sat = 42 + (i % 7) * 2;    // 42-54 (ì ë‹¹í•œ ì±„ë„)
          const light = 48 + (i % 5) * 2;  // 48-56 (ì¤‘ì €ëª…ë„)
          colorMap.set(codesSorted[i], hslToHex(hue, sat, light));
        }

        for (const r of allRows) {
          const c = (r.full_code || r.code || "").toString().trim();
          r.color = colorMap.get(c) || colorFor(c);
        }
      } catch (e) {
        // color ì‹¤íŒ¨í•´ë„ ë¡œë”©ì€ ì§„í–‰
      }

      renderRoutes(allRows);
      await loadAddresses();
    } catch (e) {
      console.error(e);
      const errMsg = e.message || String(e);
      setStatus(`ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${errMsg}`, "ERR");
    }
  }

  // ====== ì €ì¥(POST) ======
  async function saveCurrent() {
    try {
      const camp = campInput.value.trim();
      const code = codeInput.value.trim();
      if (!camp) { setStatus("campê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
      if (!code) { setStatus("codeê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }

      let id = selectedRouteId;
      if (!id || !overlayById.has(id)) {
        for (const [rid, pack] of overlayById.entries()) {
          if ((pack.row.camp||"") === camp && (pack.row.full_code||"") === code) {
            id = rid;
            break;
          }
        }
      }

      const polygonSourceId = id;
      let actualId = id;

      if (actualId && typeof actualId === "string" && actualId.startsWith("tmp_")) {
        const actualRow = routeRows.find(r =>
          (r.camp||"") === camp && (r.full_code||"") === code
        );
        if (actualRow && typeof actualRow.id === "number") {
          actualId = actualRow.id;
          log(`ì„ì‹œ IDë¥¼ ì‹¤ì œ IDë¡œ ë³€í™˜: ${polygonSourceId} â†’ ${actualId}`);
        } else {
          actualId = undefined;
          log(`ì‹¤ì œ rowê°€ ì—†ìŒ. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.`);
        }
      }

      const polygon_wgs84 = polygonSourceId ? getCurrentEditedPolygonWgs84ById(polygonSourceId) : null;

      if (!actualId) {
        const existingRow = routeRows.find(r => {
          const rCamp = r.camp || r.camp_name || "";
          const rCode = r.full_code || r.code || r.route_code || "";
          return rCamp === camp && rCode === code;
        });
        if (existingRow && typeof existingRow.id === "number") {
          actualId = existingRow.id;
        }
      }

      const payload = {
        camp,
        code,
        polygon_wgs84,
        delivery_location_name: deliveryNameInput.value.trim() || null,
        delivery_location_address: deliveryAddrInput.value.trim() || null
      };

      if (typeof actualId === "number") payload.id = actualId;

      await apiJson("POST", ROUTE_ENDPOINT, payload);
      setStatus(`ì €ì¥ ì™„ë£Œ`, "OK");

      await loadRoutes();
    } catch (e) {
      console.error(e);
      setStatus(`ì €ì¥ ì‹¤íŒ¨: ${e.message}`, "ERR");
    }
  }

  // ====== í´ë¦¬ê³¤ ì‚­ì œ (polygon_wgs84=null) ======
  async function deletePolygon() {
    try {
      const camp = campInput.value.trim();
      const code = codeInput.value.trim();
      if (!camp) { setStatus("campê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
      if (!code) { setStatus("codeê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }

      let id = selectedRouteId;
      const payload = (typeof id === "number") ? { id } : { camp, code };

      setStatus("DELETE /route ìš”ì²­ (polygon_wgs84=null)", "OK");
      await apiJson("DELETE", ROUTE_ENDPOINT, payload);
      setStatus("í´ë¦¬ê³¤ ì‚­ì œ ì™„ë£Œ", "OK");

      await loadRoutes();
    } catch (e) {
      console.error(e);
      setStatus(`í´ë¦¬ê³¤ ì‚­ì œ ì‹¤íŒ¨: ${e.message}`, "ERR");
    }
  }

  // ====== âœ… ë²¤ë” ê²€ìƒ‰/ì„ íƒ/ì €ì¥(1W/2W) ======
  let vendorModalOpen = false;
  let waveModalOpen = false;
  let waveModalAction = null; // "save" | "clear"

  function normalizeVendor(v) {
    if (!v || typeof v !== "object") return null;
    const name = (v.name ?? v.vendor_name ?? "").toString().trim();
    const business_number = (v.business_number ?? v.vendor_business_number ?? v.businessNumber ?? "").toString().trim();
    const vendor_code = (v.vendor_code ?? v.vendorCode ?? "").toString().trim();
    if (!name) return null;
    return { name, business_number, vendor_code };
  }

  function setVendorCandidate(v) {
    vendorCandidate = v || null;

    if (!vendorPickedWrap || !vendorPickedText) return;

    if (!vendorCandidate) {
      vendorPickedWrap.style.display = "none";
      vendorPickedText.textContent = "";
      return;
    }

    const bn = vendorCandidate.business_number ? ` (${vendorCandidate.business_number})` : "";
    vendorPickedText.textContent = `ë²¤ë” ì„ íƒë¨: ${vendorCandidate.name || "-"}${bn}`;
    vendorPickedWrap.style.display = "flex";
  }

  if (vendorPickedClearBtn) {
    vendorPickedClearBtn.addEventListener("click", (e) => {
      e.preventDefault();
      setVendorCandidate(null);
    });
  }

  function openVendorModal(list, q="") {
    if (!vendorModalEl || !vendorResultsEl) return;

    vendorModalOpen = true;
    vendorModalEl.style.display = "flex";
    vendorModalEl.setAttribute("aria-hidden", "false");

    const safeList = Array.isArray(list) ? list : [];
    if (vendorMetaCountEl) vendorMetaCountEl.textContent = `${safeList.length}ê°œ`;

    // ê²°ê³¼ ì˜ì—­
    vendorResultsEl.innerHTML = "";

    // í˜„ì¬ ì„ íƒëœ ë²¤ë”(í›„ë³´) í‘œì‹œ + í•´ì œ(X)
    if (vendorCandidate && (vendorCandidate.name || vendorCandidate.business_number)) {
      const sel = document.createElement("div");
      sel.className = "pillRow";
      sel.style.marginBottom = "10px";

      const bn = vendorCandidate.business_number ? ` (${vendorCandidate.business_number})` : "";
      const t = document.createElement("div");
      t.textContent = `ì„ íƒë¨: ${vendorCandidate.name || "-"}${bn}`;

      const x = document.createElement("button");
      x.className = "pillX";
      x.type = "button";
      x.title = "ì„ íƒ í•´ì œ";
      x.textContent = "âœ•";
      x.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        setVendorCandidate(null);
        openVendorModal(safeList, q);
      });

      sel.appendChild(t);
      sel.appendChild(x);
      vendorResultsEl.appendChild(sel);
    }

    if (safeList.length === 0) {
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.style.padding = "10px 4px";
      empty.textContent = `ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ: "${q || ""}"`;
      vendorResultsEl.appendChild(empty);
    } else {
      for (const v of safeList) {
        const card = document.createElement("div");
        card.className = "resultCard";

        const left = document.createElement("div");
        left.className = "resultLeft";

        const title = document.createElement("div");
        title.className = "resultTitle";
        title.textContent = v?.name || "-";

        const meta = document.createElement("div");
        meta.className = "resultSub";
        // âœ… vendor_codeëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
        meta.textContent = `ì‚¬ì—…ìë²ˆí˜¸: ${v?.business_number || "-"}`;

        left.appendChild(title);
        left.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "resultActions";

        const isSel =
          !!vendorCandidate &&
          String(v?.business_number || "") === String(vendorCandidate?.business_number || "") &&
          String(v?.name || "") === String(vendorCandidate?.name || "");

        const selectBtn = document.createElement("button");
        selectBtn.className = "miniBtn";
        selectBtn.textContent = isSel ? "ì„ íƒë¨" : "ì„ íƒ";
        if (isSel) selectBtn.disabled = true;
        selectBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          setVendorCandidate(v);
          closeVendorModal();
        });

        const clearBtn = document.createElement("button");
        clearBtn.className = "miniX";
        clearBtn.type = "button";
        clearBtn.title = "ì„ íƒ í•´ì œ";
        clearBtn.textContent = "âœ•";
        clearBtn.style.display = isSel ? "inline-flex" : "none";
        clearBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          setVendorCandidate(null);
          openVendorModal(safeList, q);
        });

        actions.appendChild(selectBtn);
        actions.appendChild(clearBtn);

        card.appendChild(left);
        card.appendChild(actions);
        vendorResultsEl.appendChild(card);
      }
    }

    // ì‹ ê·œ ë“±ë¡ ì„¹ì…˜ (ê²€ìƒ‰ ê²°ê³¼ ìœ ë¬´ì™€ ë¬´ê´€í•˜ê²Œ í•­ìƒ ë…¸ì¶œ)
    {
      const divider = document.createElement("div");
      divider.style.marginTop = "14px";
      divider.style.paddingTop = "12px";
      divider.style.borderTop = "1px solid rgba(255,255,255,.10)";
      vendorResultsEl.appendChild(divider);

      const box = document.createElement("div");
      box.className = "createBox";

      const head = document.createElement("div");
      head.className = "createHead";
      head.textContent = "ì‹ ê·œ ë²¤ë” ë“±ë¡";

      const desc = document.createElement("div");
      desc.className = "createDesc";
      desc.textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ë„ ì—¬ê¸°ì„œ ë°”ë¡œ ë“±ë¡í•  ìˆ˜ ìˆì–´ìš”. (name + business_number)";

      const form = document.createElement("div");
      form.className = "createForm";

      const mkField = (labelText, placeholder) => {
        const wrap = document.createElement("div");
        wrap.className = "createField";

        const lab = document.createElement("div");
        lab.className = "createLabel";
        lab.textContent = labelText;

        const inp = document.createElement("input");
        inp.type = "text";
        inp.className = "createInput";
        inp.placeholder = placeholder;

        wrap.appendChild(lab);
        wrap.appendChild(inp);
        return { wrap, inp };
      };

      const fName = mkField("ë²¤ë”ëª…", "ì˜ˆ: ì°¨ë‹ˆë¬¼ë¥˜");
      const fBn = mkField("ì‚¬ì—…ìë²ˆí˜¸", "ì˜ˆ: 123-45-67890 (í•˜ì´í”ˆ í¬í•¨ ê·¸ëŒ€ë¡œ)");

      // ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ë²¤ë”ëª…ì— ìë™ ì±„ì›€
      fName.inp.value = (q || "").trim();

      form.appendChild(fName.wrap);
      form.appendChild(fBn.wrap);

      const actions = document.createElement("div");
      actions.className = "createActions";

      const createBtn = document.createElement("button");
      createBtn.className = "createBtn";
      createBtn.textContent = "ë“±ë¡";

      actions.appendChild(createBtn);

      box.appendChild(head);
      box.appendChild(desc);
      box.appendChild(form);
      box.appendChild(actions);

      const doCreate = async () => {
        const name = (fName.inp.value || "").trim();
        const bn = (fBn.inp.value || "").trim();

        if (!name) { toastWarn("ë²¤ë”ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."); fName.inp.focus(); return; }
        if (!bn) { toastWarn("ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); fBn.inp.focus(); return; }

        createBtn.disabled = true;
        createBtn.textContent = "ë“±ë¡ì¤‘...";

        try {
          const created = await apiCreateVendor({ name, business_number: bn });

          if (created?.business_number) {
            // í˜„ì¬ wave ìƒíƒœ(ì£¼ê°„/ì•¼ê°„)ë¥¼ ìœ ì§€í•œ ì±„ë¡œ ì¦‰ì‹œ ì„ íƒ ì ìš©
            onVendorPicked(created, /*silent*/true);
            closeVendorModal();
            toastOk("ë²¤ë” ë“±ë¡ ì™„ë£Œ");
          } else {
            throw new Error("ìƒì„± ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          }
        } catch (e) {
          toastErr("ë“±ë¡ ì‹¤íŒ¨: " + (e?.message || String(e)));
        } finally {
          createBtn.disabled = false;
          createBtn.textContent = "ë“±ë¡";
        }
      };

      createBtn.addEventListener("click", doCreate);
      fBn.inp.addEventListener("keydown", (ev) => { if (ev.key === "Enter") doCreate(); });
      fName.inp.addEventListener("keydown", (ev) => { if (ev.key === "Enter") fBn.inp.focus(); });

      vendorResultsEl.appendChild(box);
    }

    if (safeList.length === 0) {
      setStatus(`ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ: "${q}" (ì‹ ê·œ ë“±ë¡ ê°€ëŠ¥)`, "WARN");
    }
  }


function closeVendorModal() {
    vendorModalOpen = false;
    if (!vendorModalEl) return;
    vendorModalEl.style.display = "none";
    vendorModalEl.setAttribute("aria-hidden", "true");
  }

  async function fetchVendorsByName(q) {
    const url = new URL(VENDORS_ENDPOINT);
    url.searchParams.set("q", q);

    const data = await apiGet(url.toString());
    const rows = Array.isArray(data) ? data : (data?.rows || data?.vendors || []);
    return (rows || []).map(normalizeVendor).filter(Boolean);
  }

  async function runVendorSearch(q) {
  const query = (q || "").trim();
  if (!query) { setStatus("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "WARN"); return; }

  setStatus(`ë²¤ë” ê²€ìƒ‰ì¤‘: "${query}" ...`, "OK");

  let list = [];
  try {
    list = await fetchVendorsByName(query);
  } catch (e) {
    setStatus(`ë²¤ë” ê²€ìƒ‰ ì‹¤íŒ¨: ${e?.message || String(e)}`, "ERR");
    // ê²€ìƒ‰ ì‹¤íŒ¨ì—¬ë„ ì‹ ê·œ ë“±ë¡ì€ ê°€ëŠ¥í•˜ê²Œ ëª¨ë‹¬ ì˜¤í”ˆ
    openVendorModal([], query);
    return;
  }

  // 1ê°œì—¬ë„ ëª¨ë‹¬ ì˜¤í”ˆ(ì„ íƒ/í•´ì œ UX í†µì¼)
  if (list.length === 1) {
    setVendorCandidate(list[0]);
    openVendorModal(list, query);
    setStatus(`ë²¤ë” í›„ë³´ 1ê°œ: "${query}"`, "OK");
    return;
  }

  // 0ê°œ/ë‹¤ìˆ˜: ëª¨ë‹¬ ì˜¤í”ˆ (0ê°œì—¬ë„ ì‹ ê·œ ë“±ë¡ ê°€ëŠ¥)
  openVendorModal(list, query);

  if (list.length === 0) setStatus(`ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ: "${query}" (ì‹ ê·œ ë“±ë¡ ê°€ëŠ¥)`, "WARN");
  else setStatus(`ë²¤ë” í›„ë³´ ${list.length}ê°œ: "${query}"`, "OK");
}

function openWaveModal(action) {
    if (!waveModalEl) return;

    waveModalAction = action;
    waveModalOpen = true;
    waveModalEl.style.display = "flex";
    waveModalEl.setAttribute("aria-hidden", "false");

    if (waveModalTitleEl) {
      waveModalTitleEl.textContent =
        action === "clear" ? "ì–´ëŠ êµ¬ë¶„ì„ ë¹„ìš¸ê¹Œìš”?" : "ì–´ëŠ êµ¬ë¶„ìœ¼ë¡œ ì €ì¥í• ê¹Œìš”?";
    }

    if (waveModalVendorPillEl) {
      if (action === "save" && vendorCandidate?.name) {
        waveModalVendorPillEl.style.display = "inline-block";
        waveModalVendorPillEl.textContent = `ì €ì¥ ëŒ€ìƒ: ${vendorCandidate.name}`;
      } else {
        waveModalVendorPillEl.style.display = "none";
        waveModalVendorPillEl.textContent = "";
      }
    }
  }

  function closeWaveModal() {
    waveModalOpen = false;
    if (!waveModalEl) return;
    waveModalEl.style.display = "none";
    waveModalEl.setAttribute("aria-hidden", "true");
    waveModalAction = null;
  }

  function resolveActualId(camp, code) {
    let id = selectedRouteId;

    // ì„ì‹œ ID ì²˜ë¦¬
    if (id && typeof id === "string" && id.startsWith("tmp_")) {
      const actualRow = routeRows.find(r =>
        (r.camp||"") === camp && (r.full_code||"") === code
      );
      if (actualRow && typeof actualRow.id === "number") id = actualRow.id;
      else id = undefined;
    }

    // ì„ íƒì´ ì—†ì„ ë•Œë„ camp/codeë¡œ ë§¤ì¹­
    if (!(typeof id === "number")) {
      const actualRow = routeRows.find(r =>
        (r.camp||"") === camp && (r.full_code||"") === code
      );
      if (actualRow && typeof actualRow.id === "number") id = actualRow.id;
    }

    return (typeof id === "number") ? id : undefined;
  }

  async function saveVendorWave(wave, clear=false) {
    try {
      const camp = campInput.value.trim();
      const code = codeInput.value.trim();
      if (!camp) { setStatus("campê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
      if (!code) { setStatus("codeê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }

      const actualId = resolveActualId(camp, code);

      const bn = clear ? null : (vendorCandidate?.business_number || null);
      if (!clear && !bn) {
        setStatus("ì €ì¥í•  ë²¤ë”ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”. (ë²¤ë” ê²€ìƒ‰ Enter)", "ERR");
        return;
      }

      const payload = { camp, code };
      if (wave === "1W") payload.vendor_business_number_1w = bn;
      else payload.vendor_business_number_2w = bn;

      if (typeof actualId === "number") payload.id = actualId;

      const msg = clear ? `ë²¤ë” ë¹„ìš°ê¸°(${wave}) ì €ì¥` : `ë²¤ë” ì €ì¥(${wave})`;
      setStatus(msg, "OK");

      await apiJson("POST", ROUTE_ENDPOINT, payload);

      setStatus(clear ? `ë²¤ë” ë¹„ìš°ê¸°(${wave}) ì™„ë£Œ` : `ë²¤ë” ì €ì¥(${wave}) ì™„ë£Œ`, "OK");
      await loadRoutes();
    } catch (e) {
      console.error(e);
      setStatus(`ë²¤ë” ì €ì¥ ì‹¤íŒ¨: ${e.message}`, "ERR");
    }
  }

  // ====== í´ë¦¬ê³¤ ì¤‘ì‹¬ì  ê³„ì‚° ======
  function getRouteCenter() {
    if (!selectedRouteId || !overlayById.has(selectedRouteId)) return null;

    const pack = overlayById.get(selectedRouteId);
    const polygons = pack.polygons;

    if (!polygons || polygons.length === 0) return null;

    const allPoints = [];
    for (const poly of polygons) {
      const path = poly.getPath();
      if (!path) continue;

      const len = Array.isArray(path) ? path.length : (path.getLength ? path.getLength() : 0);
      for (let i = 0; i < len; i++) {
        const pt = Array.isArray(path) ? path[i] : path.getAt(i);
        if (pt) allPoints.push(pt);
      }
    }

    if (allPoints.length === 0) return null;
    return centroidOfLatLngs(allPoints);
  }
  // ====== ì…ì°¨ì§€ ì €ì¥/ë¹„ìš°ê¸° ======
  async function saveDeliveryOnly(clear=false) {
    try {
      const camp = campInput.value.trim();
      const code = codeInput.value.trim();
      if (!camp) { setStatus("campê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
      if (!code) { setStatus("codeê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }

      let id = selectedRouteId;

      if (id && typeof id === "string" && id.startsWith("tmp_")) {
        const actualRow = routeRows.find(r =>
          (r.camp||"") === camp && (r.full_code||"") === code
        );
        if (actualRow && typeof actualRow.id === "number") id = actualRow.id;
        else id = undefined;
      }

      const payload = {
        camp,
        code,
        delivery_location_name: clear ? null : (deliveryNameInput.value.trim() || null),
        delivery_location_address: clear ? null : (deliveryAddrInput.value.trim() || null),
      };

      if (typeof id === "number") payload.id = id;

      setStatus(clear ? "ì…ì°¨ì§€ ë¹„ìš°ê¸° ì €ì¥" : "ì…ì°¨ì§€ ì €ì¥", "OK");
      await apiJson("POST", ROUTE_ENDPOINT, payload);
      setStatus(clear ? "ì…ì°¨ì§€ ë¹„ìš°ê¸° ì™„ë£Œ" : "ì…ì°¨ì§€ ì €ì¥ ì™„ë£Œ", "OK");
      await loadRoutes();
    } catch (e) {
      console.error(e);
      setStatus(`ì…ì°¨ì§€ ì €ì¥ ì‹¤íŒ¨: ${e.message}`, "ERR");
    }
  }

  // ====== âœ… ì£¼ì†Œê²€ìƒ‰ (ì¹´ì¹´ì˜¤ì§€ë„ ìŠ¤íƒ€ì¼ ëª¨ë‹¬) ======
  function openSearchModal(prefill="") {
    searchModalOpen = true;
    searchModalEl.style.display = "flex";
    searchModalEl.setAttribute("aria-hidden", "false");
    if (prefill) searchQEl.value = prefill;
    setTimeout(() => searchQEl.focus(), 0);
  }

  function closeSearchModal() {
    searchModalOpen = false;
    searchModalEl.style.display = "none";
    searchModalEl.setAttribute("aria-hidden", "true");
  }

  function renderSearchSection(title, countText, items, kind) {
    const wrap = document.createElement("div");

    const head = document.createElement("div");
    head.className = "sectionTitle";
    head.innerHTML = `<div>${escapeHtml(title)}</div><div class="count">${escapeHtml(String(countText))}</div>`;
    wrap.appendChild(head);

    if (!items || items.length === 0) {
      const empty = document.createElement("div");
      empty.style.cssText = "color:rgba(230,238,252,.55);font-size:12px;margin:6px 0 14px;";
      empty.textContent = "ê²°ê³¼ ì—†ìŒ";
      wrap.appendChild(empty);
      return wrap;
    }

    for (const it of items) {
      const card = document.createElement("div");
      card.className = "resultCard";

      const left = document.createElement("div");
      left.style.flex = "1";
      left.style.minWidth = "0";

      const titleEl = document.createElement("div");
      titleEl.className = "resultTitle";

      const subEl = document.createElement("div");
      subEl.className = "resultSub";

      if (kind === "addr") {
        titleEl.textContent = it.address_name || it.address || "ì£¼ì†Œ";
        const road = it.road_address_name ? `ë„ë¡œëª…: ${it.road_address_name}\n` : "";
        const jibun = it.address_name ? `ì§€ë²ˆ: ${it.address_name}` : "";
        subEl.textContent = `${road}${jibun}`.trim();

        card.onclick = () => {
          const lat = Number(it.y);
          const lng = Number(it.x);
          const pos = new kakao.maps.LatLng(lat, lng);
          setSearchSelectedMarker(pos);
          map.setCenter(pos);
          map.setLevel(4);
          closeSearchModal();
          setStatus(`ì£¼ì†Œ ì„ íƒ: ${titleEl.textContent}`, "OK");
        };
      } else {
        titleEl.textContent = it.place_name || it.name || "ì¥ì†Œ";
        const addr = it.road_address_name || it.address_name || "";
        const phone = it.phone ? `\nì „í™”: ${it.phone}` : "";
        subEl.textContent = `${addr}${phone}`.trim();

        card.onclick = () => {
          const lat = Number(it.y);
          const lng = Number(it.x);
          const pos = new kakao.maps.LatLng(lat, lng);
          setSearchSelectedMarker(pos);
          map.setCenter(pos);
          map.setLevel(4);
          closeSearchModal();
          setStatus(`ì¥ì†Œ ì„ íƒ: ${titleEl.textContent}`, "OK");
        };
      }

      left.appendChild(titleEl);
      left.appendChild(subEl);

      const tag = document.createElement("div");
      tag.className = "tagPill";
      tag.textContent = (kind === "addr") ? "ì£¼ì†Œ" : "ì¥ì†Œ";

      card.appendChild(left);
      card.appendChild(tag);

      wrap.appendChild(card);
    }

    return wrap;
  }

  function updateSearchMeta() {
    // âœ… ìš”ì²­ëŒ€ë¡œ "ì£¼ì†Œ ë¨¼ì €" í‘œê¸°
    const addrCountText = `ì£¼ì†Œ ${addrItems.length}ê°œ`;
    const placeCountText = `ì¥ì†Œ ${placeTotal || placeItems.length}ê°œ`;
    searchMetaCountEl.textContent = `${addrCountText} Â· ${placeCountText}`;

    placePageInfoEl.textContent = `ì¥ì†Œ í˜ì´ì§€ ${placePage} / ${placeLast}`;
    placePrevBtn.disabled = (placePage <= 1);
    placeNextBtn.disabled = (placePage >= placeLast);

    placePrevBtn.style.opacity = placePrevBtn.disabled ? "0.5" : "1";
    placeNextBtn.style.opacity = placeNextBtn.disabled ? "0.5" : "1";
    placePrevBtn.style.cursor = placePrevBtn.disabled ? "not-allowed" : "pointer";
    placeNextBtn.style.cursor = placeNextBtn.disabled ? "not-allowed" : "pointer";
  }

  function renderSearchResults() {
    searchResultsEl.innerHTML = "";

    // âœ… ìš”ì²­ëŒ€ë¡œ: ì£¼ì†Œ ì„¹ì…˜ì„ ìœ„ë¡œ, ì¥ì†Œ(í‚¤ì›Œë“œ) ì„¹ì…˜ì„ ì•„ë˜ë¡œ
    searchResultsEl.appendChild(
      renderSearchSection("ì£¼ì†Œ", addrItems.length, addrItems, "addr")
    );
    searchResultsEl.appendChild(
      renderSearchSection("ì¥ì†Œ(í‚¤ì›Œë“œ)", (placeTotal ? `${placeTotal}ê°œ` : `${placePage}/${placeLast}p`), placeItems, "place")
    );

    updateSearchMeta();
  }

  function placesKeywordSearchPromise(q, page) {
    return new Promise((resolve) => {
      // âœ… ì „êµ­ ê²€ìƒ‰: location/bounds/radius ì˜µì…˜ ë„£ì§€ ì•ŠìŒ
      const options = { page, size: 15 };
      places.keywordSearch(q, (data, status, pagination) => {
        if (status !== kakao.maps.services.Status.OK) {
          return resolve({ items: [], total: 0, last: 1, current: page });
        }
        const total = Number(pagination?.totalCount || data?.length || 0);
        const last = Number(pagination?.last || 1);
        const current = Number(pagination?.current || page);
        resolve({ items: data || [], total, last, current });
      }, options);
    });
  }

  function geocoderAddressSearchPromise(q) {
    return new Promise((resolve) => {
      geocoder.addressSearch(q, (result, status) => {
        if (status !== kakao.maps.services.Status.OK) return resolve([]);
        resolve(result || []);
      });
    });
  }

  // âœ…âœ…âœ… ì—¬ê¸°ë§Œ â€œì½©ëŒ•ì½©ëŒ•â€ ì´ìŠ¤í„°ì—ê·¸ í¬í•¨í•´ì„œ ì˜¤ë¥˜ ì—†ì´ ìˆ˜ì •ë¨
  async function runSearch(q, page=1) {
    let query = (q || "").trim();
    if (!query) {
      setStatus("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "WARN");
      return;
    }

    // âœ… Easter egg
    if (query === "ì½©ëŒ•ì½©ëŒ•") {
      query = "ê²½ê¸° íŒŒì£¼ì‹œ í•˜ìš°ê³ ê°œê¸¸ 411";
      // ì…ë ¥ì°½ì—ë„ ì¹˜í™˜ëœ ê°’ í‘œì‹œ (ì›í•˜ë©´ ì´ ì¤„ ì‚­ì œ ê°€ëŠ¥)
      searchQEl.value = query;
    }

    searchQuery = query;
    placePage = page;

    searchResultsEl.innerHTML = `<div style="color:rgba(230,238,252,.65);font-size:12px;padding:10px 2px;">ê²€ìƒ‰ ì¤‘...</div>`;

    try {
      const [addr, placePack] = await Promise.all([
        geocoderAddressSearchPromise(query),
        placesKeywordSearchPromise(query, page)
      ]);

      addrItems = addr;
      placeItems = placePack.items;
      placeTotal = placePack.total;
      placeLast = placePack.last;
      placePage = placePack.current;

      renderSearchResults();
      setStatus(`ê²€ìƒ‰ ì™„ë£Œ: ${query}`, "OK");
    } catch (e) {
      console.error(e);
      addrItems = [];
      placeItems = [];
      placeTotal = 0;
      placeLast = 1;
      placePage = 1;
      renderSearchResults();
      setStatus(`ê²€ìƒ‰ ì‹¤íŒ¨: ${e.message}`, "ERR");
    }
  }

  function searchAddress() {
    openSearchModal("");
  }

  // ====== OSM ì •ë ¬(Overpass) ======
  async function alignWithOsm() {
    try {
      clearOsm();

      const b = map.getBounds();
      const sw = b.getSouthWest();
      const ne = b.getNorthEast();

      const bbox = `${sw.getLng()},${sw.getLat()},${ne.getLng()},${ne.getLat()}`;
      const url = new URL(OSM_ENDPOINT);
      url.searchParams.set("bbox", bbox);

      setStatus(`GET /osm ìš”ì²­: ${url.toString()}`, "OK");
      const data = await apiGet(url.toString());

      const roads = data?.roads || [];
      const buildings = data?.buildings || [];

      for (const r of roads) {
        if (!r.coords || r.coords.length < 2) continue;
        const path = r.coords.map(([lng,lat]) => new kakao.maps.LatLng(lat,lng));
        const pl = new kakao.maps.Polyline({
          path,
          strokeWeight: 1,
          strokeColor: "#ffffff",
          strokeOpacity: 0.35,
          strokeStyle: "solid",
          zIndex: 0
        });
        pl.setMap(map);
        osmOverlays.push(pl);
      }

      for (const g of buildings) {
        if (!g.coords || g.coords.length < 3) continue;
        const path = g.coords.map(([lng,lat]) => new kakao.maps.LatLng(lat,lng));
        const pg = new kakao.maps.Polygon({
          path,
          strokeWeight: 1,
          strokeColor: "#ffffff",
          strokeOpacity: 0.18,
          strokeStyle: "solid",
          fillColor: "#ffffff",
          fillOpacity: 0.05,
          zIndex: 0
        });
        pg.setMap(map);
        osmOverlays.push(pg);
      }

      setStatus(`OSM í‘œì‹œ ì™„ë£Œ: roads ${roads.length}, buildings ${buildings.length}`, "OK");
    } catch (e) {
      console.error(e);
      setStatus(`OSM ì •ë ¬ ì‹¤íŒ¨: ${e.message}`, "ERR");
    }
  }

  // ====== ë¼ë²¨ í† ê¸€ ======
  function refreshLabelsOnly() {
    for (const [id, pack] of overlayById.entries()) {
      pack.labels.forEach(l => l.setMap(null));
      pack.labels = [];

      if (!(labelOn || vendorLabelOn)) continue;
      if (!pack.polygons || pack.polygons.length === 0) continue;

      const row = pack.row || {};
      const code = row.full_code || row.code || row.route_code || "";
      const color = row.color || colorFor(code);

      const pos =
        normalizeCenterWgs84(row.center_wgs84) ||
        centroidOfLatLngs(pack.polygons[0].getPath());

      const label = createLabelOverlay(code, row, pos, color);
      label.setMap(map);
      pack.labels.push(label);
    }
  }

  function toggleLabels() {
    labelOn = !labelOn;
    labelToggleBtn.textContent = labelOn ? "ë¼ìš°íŠ¸ ë¼ë²¨ ON" : "ë¼ìš°íŠ¸ ë¼ë²¨ OFF";
    refreshLabelsOnly();
  }

  function toggleVendorLabels() {
    vendorLabelOn = !vendorLabelOn;
    vendorLabelToggleBtn.textContent = vendorLabelOn ? "ë²¤ë” ë¼ë²¨ ON" : "ë²¤ë” ë¼ë²¨ OFF";
    refreshLabelsOnly();
  }
        

  // ====== ì´ˆê¸°í™” ======
  function resetMap() {
    clearAllOverlays();
    clearOsm();
    stopDraw(true);
    hint("", false);
    setStatus("ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ.", "OK");
  }

  // ====== (ì¶”ê°€) KST yyyymmddHHMM ======
  function kstYYYYMMDDHHMM() {
    const now = new Date();
    const kst = new Date(now.getTime() + 9 * 60 * 60 * 1000);
    const yyyy = String(kst.getUTCFullYear());
    const mm = String(kst.getUTCMonth() + 1).padStart(2, "0");
    const dd = String(kst.getUTCDate()).padStart(2, "0");
    const HH = String(kst.getUTCHours()).padStart(2, "0");
    const MM = String(kst.getUTCMinutes()).padStart(2, "0");
    return `${yyyy}${mm}${dd}${HH}${MM}`;
  }

  // ====== ê³µìœ  ë§í¬ ìƒì„± ======
  function generateShareLink() {
    const camp = campInput.value.trim();
    const code = codeInput.value.trim();

    if (!camp) {
      setStatus("ìº í”„ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "WARN");
      return;
    }

    const shareUrl = new URL("/share.html", location.origin);
    shareUrl.searchParams.set("camp", camp);
    if (code) shareUrl.searchParams.set("code", code);

    shareUrl.searchParams.set("v", kstYYYYMMDDHHMM());

    const url = shareUrl.toString();

    navigator.clipboard.writeText(url).then(() => {
      setStatus("ê³µìœ  ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!", "OK");

      const confirmed = confirm(
        `ê³µìœ  ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n${url}\n\nìƒˆ íƒ­ì—ì„œ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì—¬ì‹œê² ìŠµë‹ˆê¹Œ?`
      );

      if (confirmed) window.open(url, "_blank");
    }).catch(err => {
      prompt("ê³µìœ  ë§í¬ (Ctrl+Cë¡œ ë³µì‚¬):", url);
      setStatus("ê³µìœ  ë§í¬ë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤.", "OK");
    });

    log(`ê³µìœ  ë§í¬ ìƒì„±: ${url}`);
  }

  // ====== âœ… ìœ„ì„±/ë¡œë“œë·° ======
  function setMapTypeSatellite(on) {
    isSatellite = !!on;
    if (!map) return;
    map.setMapTypeId(isSatellite ? kakao.maps.MapTypeId.HYBRID : kakao.maps.MapTypeId.ROADMAP);
    if (toggleMapTypeBtn) toggleMapTypeBtn.textContent = isSatellite ? "ì¼ë°˜" : "ìœ„ì„±";
  }

  function ensureRoadview() {
    if (roadview && roadviewClient) return;
    const container = $("roadview");
    if (!container) return;
    roadview = new kakao.maps.Roadview(container);
    roadviewClient = new kakao.maps.RoadviewClient();
  }

  function setRoadviewOverlay(on) {
    if (!map) return;
    try {
      if (on) map.addOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
      else map.removeOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
    } catch (e) {
      console.warn("ROADVIEW ì˜¤ë²„ë ˆì´ í† ê¸€ ì‹¤íŒ¨", e);
    }
  }

  function setRoadviewAt(latlng) {
    ensureRoadview();
    if (!roadviewClient || !roadview) return;

    const radii = [80, 200, 500, 1200];
    const tryFind = (i) => {
      const r = radii[i];
      roadviewClient.getNearestPanoId(latlng, r, (panoId) => {
        if (panoId === null || panoId === undefined) {
          if (i < radii.length - 1) return tryFind(i + 1);
          alert("ì´ ìœ„ì¹˜ ê·¼ì²˜ì—ëŠ” ë¡œë“œë·°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        roadviewOpen = true;
        if (mapWrapEl) mapWrapEl.classList.add("roadview-open");

        if (roadview && typeof roadview.relayout === "function") {
          setTimeout(() => roadview.relayout(), 0);
        }

        roadview.setPanoId(panoId, latlng);
      });
    };
    tryFind(0);
  }

  function setRoadviewOn(on) {
    roadviewOn = !!on;
    if (!roadviewOn) roadviewOpen = false;

    if (toggleRoadviewBtn) toggleRoadviewBtn.textContent = roadviewOn ? "ë¡œë“œë·° ì¢…ë£Œ" : "ë¡œë“œë·°";
    if (roadviewHintEl) roadviewHintEl.style.display = roadviewOn ? "inline-flex" : "none";

    if (mapWrapEl) {
      if (!roadviewOn) mapWrapEl.classList.remove("roadview-open");
    }

    if (map) {
      const c = map.getCenter();
      map.relayout();
      map.setCenter(c);
    }
    if (!roadviewOn) {
      setRoadviewOverlay(false);
      if (roadviewClickHandler && map) {
        kakao.maps.event.removeListener(map, "click", roadviewClickHandler);
      }
      roadviewClickHandler = null;
      return;
    }

    if (drawMode) stopDraw(true);
    if (searchModalOpen) closeSearchModal();

    setRoadviewOverlay(true);

    if (!roadviewClickHandler && map) {
      roadviewClickHandler = (mouseEvent) => {
        if (!roadviewOn) return;
        if (drawMode) return;
        if (searchModalOpen) return;
        if (mouseEvent && mouseEvent.latLng) setRoadviewAt(mouseEvent.latLng);
      };
      kakao.maps.event.addListener(map, "click", roadviewClickHandler);
    }
  }

  // ====== ì§€ë„ ì´ë²¤íŠ¸(ê·¸ë¦¬ê¸° ëª¨ë“œ + ì»¤ìŠ¤í…€ ë“œë˜ê·¸) ======
  function attachMapEvents() {
    kakao.maps.event.addListener(map, "click", (mouseEvent) => {
      if (drawMode) {
        const latlng = mouseEvent.latLng;
        addDrawPoint(latlng);
      }
    });

    kakao.maps.event.addListener(map, "rightclick", () => {
      if (!drawMode) return;
      popDrawPoint();
    });

    const handleMouseMove = (e) => {
      if (!draggingVertex) return;

      const mapDiv = map.getNode ? map.getNode() : document.getElementById("map");
      const rect = mapDiv.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const proj = map.getProjection();
      const point = new kakao.maps.Point(x, y);
      const newPos = proj.coordsFromContainerPoint(point);

      const { marker, polygon, index } = draggingVertex;

      marker.setPosition(newPos);

      const currentPath = polygon.getPath();
      const pathArray = [];
      if (currentPath && typeof currentPath.getLength === 'function') {
        for (let j = 0; j < currentPath.getLength(); j++) {
          pathArray.push(j === index ? newPos : currentPath.getAt(j));
        }
      } else if (Array.isArray(currentPath)) {
        for (let j = 0; j < currentPath.length; j++) {
          pathArray.push(j === index ? newPos : currentPath[j]);
        }
      }
      polygon.setPath(pathArray);

      updateSelectedLabels();
    };

    const handleMouseUp = () => {
      if (!draggingVertex) return;
      draggingVertex = null;
      map.setDraggable(true);
      rebuildHandles();
    };

    window.addEventListener("mousemove", handleMouseMove);
    window.addEventListener("mouseup", handleMouseUp);

    // âœ… í‚¤ë³´ë“œ: Enter/ESC ë™ì‘ (ëª¨ë‹¬ â†’ ê·¸ë¦¬ê¸° â†’ í¸ì§‘/ì„ íƒ ìš°ì„ ìˆœìœ„)
    window.addEventListener("keydown", (e) => {
      // 0) ëª¨ë‹¬ ìš°ì„  ì²˜ë¦¬
      if (e.key === "Escape") {
        if (waveModalOpen) {
          closeWaveModal();
          setStatus("1W/2W ì„ íƒ ë‹«ê¸°", "OK");
          return;
        }
        if (vendorModalOpen) {
          closeVendorModal();
          setStatus("ë²¤ë” ì„ íƒ ë‹«ê¸°", "OK");
          return;
        }
        if (searchModalOpen) {
          closeSearchModal();
          clearSearchSelectedMarker();
          setStatus("ê²€ìƒ‰ ë‹«ê¸°/ë§ˆì»¤ ì‚­ì œ", "OK");
          return;
        }
        if (searchSelectedMarker || searchSelectedOverlay) {
          clearSearchSelectedMarker();
          setStatus("ê²€ìƒ‰ ë§ˆì»¤ ì‚­ì œ", "OK");
          return;
        }
      }

      // 1) ê·¸ë¦¬ê¸° ëª¨ë“œ
      if (drawMode) {
        if (e.key === "Escape") {
          stopDraw();
          setStatus("ê·¸ë¦¬ê¸° ì·¨ì†Œ", "WARN");
        } else if (e.key === "Enter") {
          e.preventDefault();
          e.stopPropagation();
          finishDraw();
        }
        return;
      }

      // 2) ì…ë ¥ ì¤‘ì´ë©´ ê¸€ë¡œë²Œ EnterëŠ” ë¬´ì‹œ (ê° inputì—ì„œ ì²˜ë¦¬)
      const active = document.activeElement;
      const tag = (active?.tagName || "").toLowerCase();
      const isTyping = tag === "input" || tag === "textarea" || active?.isContentEditable;
      if (isTyping) return;

      // 3) Enter: í¸ì§‘ ì €ì¥ / ì„ íƒâ†’í¸ì§‘ ì§„ì…
      if (e.key === "Enter") {
        if (editingRouteId) {
          e.preventDefault();
          e.stopPropagation();
          saveCurrent();
          return;
        }
        if (selectedRouteId) {
          e.preventDefault();
          e.stopPropagation();
          startEditing(selectedRouteId);
          return;
        }
      }

      // 4) Escape: í¸ì§‘ ì¢…ë£Œ(ì„ íƒ ìœ ì§€) / ì„ íƒ í•´ì œ
      if (e.key === "Escape") {
        if (editingRouteId) {
          stopEditing();
          setStatus("í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ (ì„ íƒ ìœ ì§€)", "OK");
          return;
        }
        if (selectedRouteId) {
          selectedRouteId = null;
          stopEditing();
          selectedInfo.textContent = "ì„ íƒ: ì—†ìŒ";
          clearVendorDisplay();
          deliveryNameInput.value = "";
          deliveryAddrInput.value = "";
          setStatus("ì„ íƒ í•´ì œ", "OK");
          return;
        }
      }
    });
  }

  // ====== ì´ˆê¸° êµ¬ë™ ======
  function init() {
    kakao.maps.load(() => {
      const center = new kakao.maps.LatLng(37.4936, 126.9019);
      map = new kakao.maps.Map($("map"), { center, level: 6 });
      geocoder = new kakao.maps.services.Geocoder();
      places = new kakao.maps.services.Places();

      VERTEX_IMG = makeHandleImage("#ffffff", "#0b1220");
      MID_IMG = makeHandleImage("#93a4c7", "#0b1220");

      attachMapEvents();

      window.addEventListener("resize", () => {
        if (!map) return;
        const c = map.getCenter();
        map.relayout();
        map.setCenter(c);
        if (roadviewOn && roadview && typeof roadview.relayout === "function") roadview.relayout();
      });

      loadBtn.addEventListener("click", loadRoutes);
      drawNewBtn.addEventListener("click", () => beginDraw("new"));
      drawAddBtn.addEventListener("click", () => beginDraw("add"));
      addrBtn.addEventListener("click", searchAddress);
      saveBtn.addEventListener("click", saveCurrent);
      deletePolyBtn.addEventListener("click", deletePolygon);
      
      labelToggleBtn.addEventListener("click", toggleLabels);
      vendorLabelToggleBtn.addEventListener("click", toggleVendorLabels);
      resetBtn.addEventListener("click", resetMap);

      // âœ… Enterë¡œ "ë¶ˆëŸ¬ì˜¤ê¸°" (ìº í”„/ë¼ìš°íŠ¸ì½”ë“œ)
      campInput.addEventListener("keydown", (e) => {
        if (e.key !== "Enter") return;
        e.preventDefault();
        e.stopPropagation();
        if (editingRouteId) saveCurrent();
        else loadRoutes();
      });
      codeInput.addEventListener("keydown", (e) => {
        if (e.key !== "Enter") return;
        e.preventDefault();
        e.stopPropagation();
        if (editingRouteId) saveCurrent();
        else loadRoutes();
      });

      // âœ… Enterë¡œ ë²¤ë” ê²€ìƒ‰ + ìº í”„+ë²¤ë” ìë™ ë¶ˆëŸ¬ì˜¤ê¸°
      if (vendorSearchInput) vendorSearchInput.addEventListener("keydown", (e) => {
        if (e.isComposing) return;
        if (e.key !== "Enter") return;
        e.preventDefault();
        e.stopPropagation();
        runVendorSearch(vendorSearchInput.value);
      });

      if (vendorSearchBtn) {
        vendorSearchBtn.addEventListener("click", (e) => {
          e.preventDefault();
          runVendorSearch(vendorSearchInput.value);
        });
      }

      // âœ… ë²¤ë” ì €ì¥/ë¹„ìš°ê¸°: 1W/2W ì„ íƒ ëª¨ë‹¬
      vendorSaveBtn.addEventListener("click", () => {
        const camp = campInput.value.trim();
        const code = codeInput.value.trim();
        if (!camp) { setStatus("campê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
        if (!code) { setStatus("codeê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
        if (!vendorCandidate?.business_number) {
          setStatus("ë²¤ë”ë¥¼ ë¨¼ì € ê²€ìƒ‰/ì„ íƒí•˜ì„¸ìš”. (ë²¤ë” ê²€ìƒ‰ Enter)", "ERR");
          return;
        }
        openWaveModal("save");
      });
      vendorClearBtn.addEventListener("click", () => {
        const camp = campInput.value.trim();
        const code = codeInput.value.trim();
        if (!camp) { setStatus("campê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
        if (!code) { setStatus("codeê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.", "ERR"); return; }
        openWaveModal("clear");
      });

      // âœ… ëª¨ë‹¬ ë‹«ê¸°/ì´ë²¤íŠ¸
      if (vendorModalCloseBtn) vendorModalCloseBtn.addEventListener("click", closeVendorModal);
      if (vendorModalEl) vendorModalEl.addEventListener("click", (e) => { if (e.target === vendorModalEl) closeVendorModal(); });

      if (waveModalCloseBtn) waveModalCloseBtn.addEventListener("click", closeWaveModal);
      if (waveModalEl) waveModalEl.addEventListener("click", (e) => { if (e.target === waveModalEl) closeWaveModal(); });

      if (wave1WBtn) wave1WBtn.addEventListener("click", () => {
        const action = waveModalAction;
        closeWaveModal();
        saveVendorWave("1W", action === "clear");
      });
      if (wave2WBtn) wave2WBtn.addEventListener("click", () => {
        const action = waveModalAction;
        closeWaveModal();
        saveVendorWave("2W", action === "clear");
      });

      // âœ… ì…ì°¨ì§€ ì €ì¥/ë¹„ìš°ê¸°
      deliverySaveBtn.addEventListener("click", () => saveDeliveryOnly(false));
      deliveryClearBtn.addEventListener("click", () => saveDeliveryOnly(true));

      shareBtn.addEventListener("click", generateShareLink);

      if (toggleMapTypeBtn) toggleMapTypeBtn.addEventListener("click", () => setMapTypeSatellite(!isSatellite));
      if (toggleRoadviewBtn) toggleRoadviewBtn.addEventListener("click", () => setRoadviewOn(!roadviewOn));

      // âœ… ê²€ìƒ‰ ëª¨ë‹¬ ì´ë²¤íŠ¸
      searchRunBtn.addEventListener("click", () => runSearch(searchQEl.value, 1));
      searchCloseBtn.addEventListener("click", () => closeSearchModal());
      searchQEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") runSearch(searchQEl.value, 1);
        if (e.key === "Escape") {
          closeSearchModal();
          clearSearchSelectedMarker();
        }
      });
      searchModalEl.addEventListener("click", (e) => {
        if (e.target === searchModalEl) closeSearchModal();
      });

      placePrevBtn.addEventListener("click", () => {
        if (placePage <= 1) return;
        runSearch(searchQuery, placePage - 1);
      });
      placeNextBtn.addEventListener("click", () => {
        if (placePage >= placeLast) return;
        runSearch(searchQuery, placePage + 1);
      });

      setStatus("ì§€ë„ ë¡œë“œ ì™„ë£Œ", "OK");

      loadRoutes().catch((err) => {
        log("ìë™ ë¡œë“œ ì‹¤íŒ¨. ë°±ì—”ë“œ API í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        setStatus("ìë™ ë¡œë“œ ì‹¤íŒ¨ (ë°±ì—”ë“œ API ì˜¤ë¥˜). ìƒˆë¡œ ê·¸ë¦¬ê¸°ëŠ” ê°€ëŠ¥í•©ë‹ˆë‹¤.", "WARN");
      });
    });
  }

  window.addEventListener("error", (ev) => {
    const msg = ev?.message || "Script error.";
    log(`ERR window.error: ${msg}`);
  });

  init();
})();
</script>
</body>
</html>
