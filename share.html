<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ë°°ì†¡ ì§€ë„ ê³µìœ </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico?v=2" />

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2d;
      --txt:#e6eefc;
      --muted:#93a4c7;
      --line:rgba(255,255,255,.08);
      --btn:#162744;
      --btn2:#1a2f55;
    }
    *{box-sizing:border-box; margin:0; padding:0;}
    html,body{height:100%; font-family:system-ui, -apple-system, "Noto Sans KR", sans-serif; background:var(--bg); color:var(--txt);}
    
    .container{display:flex; flex-direction:column; height:100vh;}
    
    /* í—¤ë” - ëª¨ë°”ì¼ ì¤‘ì‹¬ */
    .header{
      background:linear-gradient(135deg, #1a2f55 0%, #0f1a2d 100%);
      padding:20px;
      border-bottom:2px solid var(--line);
      box-shadow:0 4px 12px rgba(0,0,0,.3);
      text-align:center;
    }
    .header-content{
      max-width:600px;
      margin:0 auto;
    }
    .camp-info{
      margin-bottom:16px;
    }
    .camp-name{
      font-size:24px; 
      font-weight:800; 
      margin-bottom:8px; 
      letter-spacing:0.3px;
      color:#00C2FF;
    }
    .camp-address{
      font-size:14px; 
      color:var(--muted); 
      line-height:1.5;
      margin-bottom:4px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .copy-btn{
      background:rgba(0,194,255,.15);
      border:1px solid rgba(0,194,255,.3);
      color:#00C2FF;
      padding:4px 8px;
      border-radius:6px;
      cursor:pointer;
      font-size:12px;
      transition:all 0.2s;
      white-space:nowrap;
    }
    .copy-btn:hover{
      background:rgba(0,194,255,.25);
      border-color:#00C2FF;
    }
    .camp-badge{
      display:inline-block;
      padding:6px 14px;
      border-radius:999px;
      background:rgba(0,194,255,.15);
      border:1px solid rgba(0,194,255,.3);
      font-size:13px;
      color:#00C2FF;
      font-weight:600;
      margin-top:8px;
    }
    
    /* ë„¤ë¹„ ë²„íŠ¼ ì˜ì—­ */
    .navi-buttons{
      display:flex;
      gap:8px;
      flex-direction:column;
    }
    .btn{
      width:100%;
      padding:14px 20px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--txt);
      cursor:pointer;
      font-weight:700;
      font-size:15px;
      white-space:nowrap;
      transition:all 0.2s;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:hover{background:var(--btn2); transform:translateY(-1px);}
    .btn.primary{
      background:linear-gradient(135deg, #00C2FF 0%, #0088CC 100%);
      border-color:#00C2FF;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,194,255,.25);
      font-size:16px;
      padding:16px 20px;
    }
    .btn.primary:hover{
      box-shadow:0 6px 16px rgba(0,194,255,.35);
    }
    
    /* ì§€ë„ */
    .map-container{flex:1; position:relative;}
    #map{position:absolute; inset:0;}
    
    /* ë°°ì†¡ì§€ ëª©ë¡ íŒ¨ë„ */
    .address-panel{
      position:absolute;
      bottom:20px;
      left:20px;
      max-width:360px;
      max-height:60vh;
      background:rgba(15,26,45,.95);
      backdrop-filter:blur(10px);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.4);
      overflow:hidden;
      display:none; /* ë°°ì†¡ì§€ê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ */
    }
    .address-panel.visible{display:block;}
    .panel-header{
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      font-weight:700;
      font-size:15px;
      background:rgba(0,0,0,.2);
    }
    .address-list{
      max-height:calc(60vh - 60px);
      overflow-y:auto;
      padding:10px;
    }
    .address-item{
      padding:14px 16px;
      margin-bottom:8px;
      background:rgba(0,0,0,.15);
      border:1px solid var(--line);
      border-radius:12px;
      font-size:13px;
      display:flex;
      flex-direction:column;
      gap:10px;
      transition:all 0.2s;
    }
    .address-item:hover{background:rgba(0,0,0,.25); border-color:#00C2FF;}
    .address-info{flex:1; min-width:0;}
    .address-text{font-weight:600; color:var(--txt); margin-bottom:4px; word-break:break-all;}
    .address-meta{color:var(--muted); font-size:12px;}
    .address-item .btn{
      padding:10px 16px; 
      font-size:14px; 
      width:100%;
      border-radius:8px;
    }
    
    /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
    .loading{
      position:absolute;
      inset:0;
      background:rgba(11,18,32,.85);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:100;
      flex-direction:column;
      gap:12px;
    }
    .spinner{
      width:40px;
      height:40px;
      border:4px solid rgba(255,255,255,.1);
      border-top-color:#00C2FF;
      border-radius:50%;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg);}}
    .loading-text{font-size:14px; color:var(--muted);}
    
    /* ë¼ë²¨ - ìº í”„ í‘œì‹œ í¬ê²Œ */
    .route-label{
      padding:8px 16px;
      border-radius:12px;
      background:rgba(0,0,0,.75);
      color:#fff;
      font-size:16px;
      border:2px solid rgba(255,255,255,.3);
      white-space:nowrap;
      box-shadow:0 4px 16px rgba(0,0,0,.5);
      font-weight:800;
      letter-spacing:0.3px;
      backdrop-filter:blur(4px);
    }
    
    /* ë¼ìš°íŠ¸ ì„ íƒ ëª¨ë‹¬ */
    .route-modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.8);
      backdrop-filter:blur(8px);
      z-index:1000;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .route-modal.visible{display:flex;}
    .route-modal-content{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      padding:24px;
      max-width:500px;
      width:100%;
      max-height:80vh;
      overflow-y:auto;
    }
    .route-modal-title{
      font-size:20px;
      font-weight:800;
      margin-bottom:16px;
      text-align:center;
    }
    .route-item{
      padding:16px;
      margin-bottom:12px;
      background:rgba(0,0,0,.2);
      border:1px solid var(--line);
      border-radius:12px;
      cursor:pointer;
      transition:all 0.2s;
    }
    .route-item:hover{
      background:rgba(0,0,0,.3);
      border-color:#00C2FF;
      transform:translateY(-2px);
    }
    .route-item-code{
      font-size:18px;
      font-weight:700;
      color:#00C2FF;
      margin-bottom:8px;
    }
    .route-item-info{
      font-size:13px;
      color:var(--muted);
    }
    
    /* ë°˜ì‘í˜• */
    @media (max-width: 768px){
      .address-panel{
        left:10px;
        right:10px;
        bottom:10px;
        max-width:none;
      }
      .route-modal-content{
        padding:20px;
      }
    }
  </style>

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=add4ce93b38c0ff9d9b9053728e067b3&autoload=false&libraries=services"></script>
</head>

<body>
<div class="container">
  <!-- í—¤ë” -->
  <div class="header">
    <div class="header-content">
      <div class="camp-info">
        <div class="camp-name" id="campName">ğŸ“ ë°°ì†¡ êµ¬ì—­ ì•ˆë‚´</div>
        <div class="camp-address">
          <span id="campAddress">ì£¼ì†Œ ì •ë³´ ë¡œë”© ì¤‘...</span>
          <button class="copy-btn" id="copyAddressBtn" style="display:none;">ğŸ“‹ ë³µì‚¬</button>
        </div>
        <div style="display:flex; gap:8px; justify-content:center; margin-top:8px;">
          <div class="camp-badge" id="campBadge">-</div>
          <div class="camp-badge" id="codeBadge" style="display:none; background:rgba(255,77,109,.15); border-color:rgba(255,77,109,.3); color:#FF4D6D;">-</div>
        </div>
      </div>
      
      <div class="navi-buttons">
        <button class="btn primary" id="naviBtn" style="display:none;">
          ğŸš— í˜„ì¬ìœ„ì¹˜ â†’ ìº í”„ ê¸¸ì°¾ê¸°
        </button>
      </div>
    </div>
  </div>
  
  <!-- ë¼ìš°íŠ¸ ì„ íƒ ëª¨ë‹¬ -->
  <div class="route-modal" id="routeModal">
    <div class="route-modal-content">
      <div class="route-modal-title">ë°°ì†¡ì§€ ì„ íƒ</div>
      <div id="routeList"></div>
    </div>
  </div>
  
  <!-- ì§€ë„ -->
  <div class="map-container">
    <div id="map"></div>
    
    <!-- ë¡œë”© -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div class="loading-text">ì§€ë„ ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </div>
    
    <!-- ë°°ì†¡ì§€ ëª©ë¡ íŒ¨ë„ -->
    <div class="address-panel" id="addressPanel">
      <div class="panel-header">ğŸ“¦ ë°°ì†¡ì§€ ëª©ë¡</div>
      <div class="address-list" id="addressList"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const API_BASE = "https://route.maroowell.com";
  const ROUTE_ENDPOINT = `${API_BASE}/route`;
  const ADDRESS_ENDPOINT = `${API_BASE}/addresses`;
  
  const $ = (id) => document.getElementById(id);
  const loading = $("loading");
  const naviBtn = $("naviBtn");
  const campName = $("campName");
  const campAddress = $("campAddress");
  const campBadge = $("campBadge");
  const codeBadge = $("codeBadge");
  const copyAddressBtn = $("copyAddressBtn");
  const addressPanel = $("addressPanel");
  const addressList = $("addressList");
  const routeModal = $("routeModal");
  const routeList = $("routeList");
  
  let map, geocoder;
  let allRoutes = []; // ëª¨ë“  ë¼ìš°íŠ¸ ì €ì¥
  let routeData = null; // í˜„ì¬ ì„ íƒëœ ë¼ìš°íŠ¸
  let addressRows = [];
  
  // URL íŒŒë¼ë¯¸í„° ì¶”ì¶œ
  const params = new URLSearchParams(location.search);
  const camp = params.get("camp") || "";
  const code = params.get("code") || "";
  
  // ì»¬ëŸ¬ íŒ”ë ˆíŠ¸
  const COLOR_PALETTE = [
    "#00C2FF", "#FF4D6D", "#FFD166", "#06D6A0", "#A78BFA",
    "#F97316", "#22C55E", "#E11D48", "#3B82F6", "#F59E0B"
  ];
  
  function hashCode(str) {
    let h = 0;
    for (let i=0;i<str.length;i++){
      h = (h<<5) - h + str.charCodeAt(i);
      h |= 0;
    }
    return Math.abs(h);
  }
  
  function colorFor(code) {
    return COLOR_PALETTE[hashCode(code) % COLOR_PALETTE.length];
  }
  
  // API í˜¸ì¶œ
  async function apiGet(url) {
    const res = await fetch(url, { method:"GET" });
    const text = await res.text();
    let json = null;
    try { json = text ? JSON.parse(text) : null; } catch {}
    if (!res.ok) {
      const msg = json?.error || text || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return json;
  }
  
  // í´ë¦¬ê³¤ íŒŒì‹±
  function parsePolygonWgs84(v) {
    if (!v) return null;
    if (Array.isArray(v)) return v;
    if (typeof v === "string") {
      try {
        const p = JSON.parse(v);
        if (Array.isArray(p)) return p;
      } catch (e) {}
    }
    return null;
  }
  
  // í´ë¦¬ê³¤ ì¤‘ì‹¬ì  ê³„ì‚°
  function centroidOfLatLngs(latlngs) {
    let latSum=0, lngSum=0;
    for (const ll of latlngs) { 
      latSum += ll.getLat(); 
      lngSum += ll.getLng(); 
    }
    return new kakao.maps.LatLng(latSum/latlngs.length, lngSum/latlngs.length);
  }
  
  // ë¼ë²¨ ìƒì„± - ìº í”„ ì´ë¦„ë§Œ í‘œì‹œ
  function createLabel(text, position, color) {
    const el = document.createElement("div");
    el.className = "route-label";
    el.style.borderColor = color;
    el.style.background = `linear-gradient(135deg, ${color}33, ${color}55)`;
    el.innerHTML = `ğŸ“¦ ${text}`;
    
    return new kakao.maps.CustomOverlay({
      position,
      content: el,
      yAnchor: 0.5,
      zIndex: 10
    });
  }
  
  // í´ë¦¬ê³¤ ê·¸ë¦¬ê¸°
  function drawPolygons(rows) {
    if (!rows || rows.length === 0) return;
    
    const bounds = new kakao.maps.LatLngBounds();
    let hasPolygon = false;
    
    for (const row of rows) {
      const fullCode = row.full_code || row.code || "";
      const color = row.color || colorFor(fullCode);
      const poly = parsePolygonWgs84(row.polygon_wgs84);
      
      if (!poly || !Array.isArray(poly) || poly.length === 0) continue;
      
      // ë°ì´í„° í˜•ì‹ ìë™ ê°ì§€
      let rings = [];
      const first = poly[0];
      
      if (first && typeof first === 'object' && 'lat' in first && 'lng' in first) {
        rings = [poly];
      } else if (Array.isArray(first)) {
        const firstOfFirst = first[0];
        if (firstOfFirst && typeof firstOfFirst === 'object' && 'lat' in firstOfFirst) {
          rings = poly;
        } else if (Array.isArray(firstOfFirst) && firstOfFirst.length >= 2) {
          rings = poly;
        } else if (typeof firstOfFirst === 'number') {
          rings = [poly];
        }
      }
      
      for (const ring of rings) {
        if (!Array.isArray(ring) || ring.length < 3) continue;
        
        const latlngs = ring.map(pt => {
          if (pt && typeof pt === 'object' && 'lat' in pt && 'lng' in pt) {
            return new kakao.maps.LatLng(pt.lat, pt.lng);
          } else if (Array.isArray(pt) && pt.length >= 2) {
            return new kakao.maps.LatLng(pt[1], pt[0]);
          }
          return null;
        }).filter(ll => ll !== null);
        
        if (latlngs.length < 3) continue;
        
        // í´ë¦¬ê³¤ ìƒì„±
        const polygon = new kakao.maps.Polygon({
          path: latlngs,
          strokeWeight: 5,
          strokeColor: color,
          strokeOpacity: 1.0,
          strokeStyle: "solid",
          fillColor: color,
          fillOpacity: 0.20,
          zIndex: 1
        });
        polygon.setMap(map);
        
        // ë¼ë²¨ ìƒì„± - ë¼ìš°íŠ¸ ë²ˆí˜¸ í‘œì‹œ
        const center = centroidOfLatLngs(latlngs);
        const label = createLabel(fullCode, center, color);
        label.setMap(map);
        
        latlngs.forEach(ll => bounds.extend(ll));
        hasPolygon = true;
      }
    }
    
    if (hasPolygon) {
      map.setBounds(bounds);
    }
  }
  
  // ë°°ì†¡ì§€ ëª©ë¡ ë Œë”ë§
  function renderAddressList() {
    if (!addressRows || addressRows.length === 0) {
      addressPanel.classList.remove("visible");
      return;
    }
    
    addressPanel.classList.add("visible");
    addressList.innerHTML = "";
    
    addressRows.forEach((addr, idx) => {
      const item = document.createElement("div");
      item.className = "address-item";
      
      const addressText = addr.address || addr.full_address || "ì£¼ì†Œ ì—†ìŒ";
      const dong = addr.dong ? `(${addr.dong})` : "";
      const zipcode = addr.zipcode ? `ìš°í¸ë²ˆí˜¸: ${addr.zipcode}` : "";
      
      item.innerHTML = `
        <div class="address-info">
          <div class="address-text">${idx + 1}. ${addressText} ${dong}</div>
          <div class="address-meta">${zipcode}</div>
        </div>
        <button class="btn">ğŸš— ê¸¸ì°¾ê¸°</button>
      `;
      
      const btn = item.querySelector("button");
      btn.onclick = () => openNaviToAddress(addr);
      
      addressList.appendChild(item);
    });
  }
  
  // ë¼ìš°íŠ¸ ì„ íƒ ëª¨ë‹¬ ë Œë”ë§
  function showRouteModal() {
    if (allRoutes.length === 0) {
      alert("ë¼ìš°íŠ¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    if (allRoutes.length === 1) {
      // ë¼ìš°íŠ¸ê°€ í•˜ë‚˜ë©´ ë°”ë¡œ ì‹¤í–‰
      openNaviToCamp(allRoutes[0]);
      return;
    }
    
    // ì—¬ëŸ¬ ë¼ìš°íŠ¸ê°€ ìˆìœ¼ë©´ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
    routeList.innerHTML = "";
    
    allRoutes.forEach((route, idx) => {
      const item = document.createElement("div");
      item.className = "route-item";
      
      const routeCode = route.full_code || route.code || `ë¼ìš°íŠ¸ ${idx + 1}`;
      const routeName = route.delivery_location_name || "ì…ì°¨ì§€";
      const routeAddr = route.delivery_location_address || "ì£¼ì†Œ ì—†ìŒ";
      
      item.innerHTML = `
        <div class="route-item-code">${routeCode}</div>
        <div class="route-item-info">${routeName}</div>
        <div class="route-item-info">${routeAddr}</div>
      `;
      
      item.onclick = () => {
        routeModal.classList.remove("visible");
        openNaviToCamp(route);
      };
      
      routeList.appendChild(item);
    });
    
    routeModal.classList.add("visible");
  }
  
  // ëª¨ë‹¬ ë‹«ê¸°
  routeModal.onclick = (e) => {
    if (e.target === routeModal) {
      routeModal.classList.remove("visible");
    }
  };
  
  // ë°°ì†¡ì§€ë¡œ ë„¤ë¹„ ì‹¤í–‰
  function openNaviToAddress(addr) {
    if (!routeData || !routeData.delivery_location_address) {
      alert("ì…ì°¨ì§€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    const addressText = addr.address || addr.full_address;
    if (!addressText) {
      alert("ë°°ì†¡ì§€ ì£¼ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    const deliveryAddress = routeData.delivery_location_address;
    const deliveryName = routeData.delivery_location_name || "ì…ì°¨ì§€";
    
    // ì…ì°¨ì§€ì™€ ë°°ì†¡ì§€ ì£¼ì†Œë¥¼ ì¢Œí‘œë¡œ ë³€í™˜
    geocoder.addressSearch(deliveryAddress, (startResult, startStatus) => {
      if (startStatus !== kakao.maps.services.Status.OK || !startResult?.length) {
        alert("ì…ì°¨ì§€ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      
      const startLat = Number(startResult[0].y);
      const startLng = Number(startResult[0].x);
      
      // ë°°ì†¡ì§€ ì£¼ì†Œ ê²€ìƒ‰
      geocoder.addressSearch(addressText, (endResult, endStatus) => {
        if (endStatus !== kakao.maps.services.Status.OK || !endResult?.length) {
          alert("ë°°ì†¡ì§€ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        
        const endLat = Number(endResult[0].y);
        const endLng = Number(endResult[0].x);
        
        // ì¹´ì¹´ì˜¤ë‚´ë¹„ URL
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        let naviUrl;
        
        if (isMobile) {
          naviUrl = `kakaomap://route?sp=${startLat},${startLng}&ep=${endLat},${endLng}&by=CAR`;
        } else {
          naviUrl = `https://map.kakao.com/link/from/${encodeURIComponent(deliveryName)},${startLat},${startLng}/to/${encodeURIComponent(addressText)},${endLat},${endLng}`;
        }
        
        window.location.href = naviUrl;
      });
    });
  }
  
  // ìº í”„ê¹Œì§€ ë„¤ë¹„ (í˜„ì¬ìœ„ì¹˜ â†’ ìº í”„ ê²½ë¡œ ì•ˆë‚´)
  function openNaviToCamp(route) {
    if (!route || !route.delivery_location_address) {
      alert("ì…ì°¨ì§€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    const deliveryAddress = route.delivery_location_address;
    const deliveryName = route.delivery_location_name || "ì…ì°¨ì§€";
    
    // ì…ì°¨ì§€ ì£¼ì†Œë¥¼ ì¢Œí‘œë¡œ ë³€í™˜
    geocoder.addressSearch(deliveryAddress, (result, status) => {
      if (status !== kakao.maps.services.Status.OK || !result?.length) {
        alert("ì…ì°¨ì§€ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •í™•í•œ ì£¼ì†Œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
        return;
      }
      
      const endLat = Number(result[0].y);
      const endLng = Number(result[0].x);
      
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      let naviUrl;
      
      if (isMobile) {
        // ëª¨ë°”ì¼: ì¹´ì¹´ì˜¤ë§µ ì•± URL ìŠ¤í‚´ (í˜„ì¬ ìœ„ì¹˜ë¥¼ ìë™ìœ¼ë¡œ ì¶œë°œì§€ë¡œ ì‚¬ìš©)
        // sp íŒŒë¼ë¯¸í„°ë¥¼ ìƒëµí•˜ë©´ ì¹´ì¹´ì˜¤ë§µ ì•±ì´ ìë™ìœ¼ë¡œ í˜„ì¬ ìœ„ì¹˜ë¥¼ ì¶œë°œì§€ë¡œ ì„¤ì •
        naviUrl = `kakaomap://route?ep=${endLat},${endLng}&by=CAR`;
      } else {
        // PC: ì¹´ì¹´ì˜¤ë§µ ì›¹ ê¸¸ì°¾ê¸° (í˜„ì¬ ìœ„ì¹˜ëŠ” ì›¹ì—ì„œ ìë™ìœ¼ë¡œ ì„¤ì •)
        // toë§Œ ì§€ì •í•˜ë©´ ì¹´ì¹´ì˜¤ë§µì—ì„œ í˜„ì¬ ìœ„ì¹˜ë¥¼ ì¶œë°œì§€ë¡œ ìë™ ì„¤ì •
        naviUrl = `https://map.kakao.com/link/to/${encodeURIComponent(deliveryName)},${endLat},${endLng}`;
      }
      
      window.open(naviUrl, "_blank");
    });
  }
  
  // ë°ì´í„° ë¡œë“œ
  async function loadData() {
    try {
      if (!camp) {
        throw new Error("ìº í”„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. (camp íŒŒë¼ë¯¸í„° í•„ìš”)");
      }
      
      // ë¼ìš°íŠ¸ ë°ì´í„° ë¡œë“œ
      const url = new URL(ROUTE_ENDPOINT);
      url.searchParams.set("camp", camp);
      if (code) {
        url.searchParams.set("code", code);
        url.searchParams.set("mode", "prefix");
      } else {
        url.searchParams.set("mode", "prefix");
      }
      
      const data = await apiGet(url.toString());
      
      if (!data || !data.rows || data.rows.length === 0) {
        throw new Error("ë¼ìš°íŠ¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
      
      // ëª¨ë“  ë¼ìš°íŠ¸ ì €ì¥
      allRoutes = data.rows;
      routeData = data.rows[0]; // ì²« ë²ˆì§¸ ë¼ìš°íŠ¸ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©
      
      // í—¤ë” UI ì—…ë°ì´íŠ¸
      const displayName = routeData.delivery_location_name || camp || "ìº í”„";
      const displayAddress = routeData.delivery_location_address || "ì£¼ì†Œ ì •ë³´ ì—†ìŒ";
      const displayCode = code || (allRoutes.length === 1 ? allRoutes[0].full_code || allRoutes[0].code : "");
      
      campName.textContent = `ğŸ“ ${displayName}`;
      campAddress.textContent = displayAddress;
      campBadge.textContent = camp;
      
      // ì½”ë“œ ë°°ì§€ í‘œì‹œ
      if (displayCode) {
        codeBadge.textContent = displayCode;
        codeBadge.style.display = "inline-block";
      }
      
      // ì£¼ì†Œê°€ ìˆìœ¼ë©´ ë³µì‚¬ ë²„íŠ¼ í‘œì‹œ
      if (displayAddress && displayAddress !== "ì£¼ì†Œ ì •ë³´ ì—†ìŒ") {
        copyAddressBtn.style.display = "inline-block";
      }
      
      // ë„¤ë¹„ ë²„íŠ¼ í‘œì‹œ
      if (routeData.delivery_location_name || routeData.delivery_location_address) {
        naviBtn.style.display = "block";
      }
      
      // í´ë¦¬ê³¤ ê·¸ë¦¬ê¸°
      drawPolygons(data.rows);
      
      // ë°°ì†¡ì§€ ëª©ë¡ ë¡œë“œ
      try {
        const addrUrl = new URL(ADDRESS_ENDPOINT);
        addrUrl.searchParams.set("camp", camp);
        if (code) addrUrl.searchParams.set("code", code);
        
        const addrData = await apiGet(addrUrl.toString());
        addressRows = addrData?.rows || [];
        renderAddressList();
      } catch (addrErr) {
        console.warn("ë°°ì†¡ì§€ ë¡œë“œ ì‹¤íŒ¨:", addrErr);
      }
      
      loading.style.display = "none";
      
    } catch (err) {
      console.error(err);
      loading.innerHTML = `
        <div style="text-align:center; color:#FF4D6D;">
          <div style="font-size:48px; margin-bottom:16px;">âš ï¸</div>
          <div style="font-size:16px; font-weight:700; margin-bottom:8px;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>
          <div style="font-size:13px; color:var(--muted);">${err.message}</div>
        </div>
      `;
    }
  }
  
  // ì´ˆê¸°í™”
  function init() {
    kakao.maps.load(() => {
      const center = new kakao.maps.LatLng(37.5665, 126.978);
      map = new kakao.maps.Map($("map"), { 
        center, 
        level: 8,
        draggable: true,
        scrollwheel: true,
        disableDoubleClickZoom: false
      });
      geocoder = new kakao.maps.services.Geocoder();
      
      // ì¤Œ ì»¨íŠ¸ë¡¤ ì¶”ê°€
      const zoomControl = new kakao.maps.ZoomControl();
      map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
      
      // ë„¤ë¹„ ë²„íŠ¼ ë°”ì¸ë”© - ë¼ìš°íŠ¸ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
      naviBtn.onclick = showRouteModal;
      
      // ì£¼ì†Œ ë³µì‚¬ ë²„íŠ¼ ë°”ì¸ë”©
      copyAddressBtn.onclick = () => {
        const address = campAddress.textContent;
        navigator.clipboard.writeText(address).then(() => {
          const originalText = copyAddressBtn.textContent;
          copyAddressBtn.textContent = "âœ“ ë³µì‚¬ë¨";
          setTimeout(() => {
            copyAddressBtn.textContent = originalText;
          }, 2000);
        }).catch(err => {
          alert("ë³µì‚¬ ì‹¤íŒ¨: " + err.message);
        });
      };
      
      loadData();
    });
  }
  
  init();
})();
</script>
</body>
</html>
