<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CoupangLand (프론트 임시 MVP)</title>

  <!-- Kakao 지도 SDK (autoload=false 권장) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=add4ce93b38c0ff9d9b9053728e067b3&autoload=false"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --line:#e7e9f2;
      --text:#111827;
      --muted:#6b7280;

      --blue:#2563eb;
      --blue2:#60a5fa;

      --shadow:0 10px 30px rgba(17,24,39,.08);
      --radius:18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width: 1320px;
      margin: 18px auto 28px;
      padding: 0 14px;
    }

    .topbar{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 16px;
      display:flex;
      gap: 14px;
      align-items:center;
      justify-content:space-between;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 320px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background:#7c3aed;
      box-shadow:0 0 0 4px rgba(124,58,237,.12);
    }
    .title{
      font-weight:800;
      letter-spacing:-.2px;
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }
    .subtitle{
      font-size: 12.5px;
      color: var(--muted);
      margin-top: 2px;
      line-height: 1.3;
    }
    .badge{
      font-size: 12px;
      padding: 4px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fbfbff;
      color:#374151;
    }

    /* coupang 로고 컬러(샘플 이미지 기반) */
    .coupang-word span{ font-weight:900; letter-spacing:-.6px; }
    .c1,.c2,.c3{ color:#521110; }      /* cou */
    .c4{ color:#d73227; }              /* p */
    .c5{ color:#e99923; }              /* a */
    .c6{ color:#92ba3e; }              /* n */
    .c7{ color:#50a3d9; }              /* g */
    .land{ color:#111827; font-weight:900; letter-spacing:-.6px; }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      color:#111827;
    }
    .btn.primary{
      border-color: rgba(37,99,235,.25);
      background: rgba(37,99,235,.06);
      color:#1f4ed8;
    }
    .btn.danger{
      border-color: rgba(239,68,68,.3);
      background: rgba(239,68,68,.06);
      color:#b91c1c;
    }

    .grid{
      margin-top: 14px;
      display:grid;
      /* 지도 더 크게(좌측 비중↑) */
      grid-template-columns: 1.25fr .75fr;
      gap: 14px;
      align-items:start;
    }

    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-hd{
      padding: 14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card-hd h3{
      margin:0;
      font-size: 15px;
      letter-spacing:-.2px;
    }
    .pill{
      font-size: 12px;
      padding: 6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fbfbff;
      color:#374151;
      font-weight:700;
      white-space:nowrap;
    }

    .card-bd{
      padding: 14px 16px;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .input{
      width: 100%;
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline:none;
      background:#fff;
    }
    .input:focus{
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .select{
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline:none;
      background:#fff;
      min-width: 180px;
      font-weight:700;
    }

    .chips{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .chip{
      border:1px solid rgba(37,99,235,.25);
      background: rgba(37,99,235,.06);
      color:#1f4ed8;
      padding: 6px 10px;
      border-radius:999px;
      font-size: 12px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .chip.gray{
      border-color: var(--line);
      background:#fff;
      color:#374151;
      font-weight:700;
    }

    .map{
      margin-top: 12px;
      width: 100%;
      height: 640px; /* 지도 크게 */
      border-radius: 16px;
      border:1px solid var(--line);
      overflow:hidden;
      position:relative;
    }
    .map .loading{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      color:#374151;
      background: rgba(255,255,255,.7);
      backdrop-filter: blur(2px);
      z-index: 5;
    }

    .listbox{
      margin-top: 12px;
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
    }
    .listbox .lb-hd{
      padding: 10px 12px;
      background:#fbfbff;
      border-bottom:1px solid var(--line);
      font-weight:900;
      font-size: 13px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .list{
      max-height: 220px;
      overflow:auto;
    }
    .item{
      padding: 10px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      cursor:pointer;
    }
    .item:hover{ background: rgba(37,99,235,.04); }
    .item:last-child{ border-bottom:none; }
    .name{
      font-weight:800;
      color:#111827;
    }
    .count{
      font-weight:900;
      font-size: 12px;
      padding: 4px 8px;
      border-radius:999px;
      background: rgba(37,99,235,.08);
      border:1px solid rgba(37,99,235,.18);
      color:#1f4ed8;
      white-space:nowrap;
    }

    .section{
      border-top:1px solid var(--line);
      padding-top: 12px;
      margin-top: 12px;
    }
    .section h4{
      margin: 0 0 8px;
      font-size: 13px;
      letter-spacing:-.2px;
    }
    .kv{
      display:grid;
      grid-template-columns: 110px 1fr;
      gap: 8px 10px;
      font-size: 13px;
      align-items:start;
    }
    .k{ color: var(--muted); font-weight:800; }
    .v{ font-weight:800; }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color:#374151;
      background:#fbfbff;
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      white-space: pre-wrap;
      line-height: 1.45;
    }

    textarea{
      width:100%;
      min-height: 140px;
      resize: vertical;
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 13px;
      outline:none;
      background:#fff;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    textarea:focus{
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    @media (max-width: 1060px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
      .map{ height: 520px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">
            <span class="coupang-word">
              <span class="c1">c</span><span class="c2">o</span><span class="c3">u</span><span class="c4">p</span><span class="c5">a</span><span class="c6">n</span><span class="c7">g</span>
            </span>
            <span class="land">Land</span>
            <span class="badge">프론트 임시 MVP</span>
          </div>
          <div class="subtitle">시/도 → 시군구 → 동(행정동) 단위로 대리점/라우트 현황을 조회합니다. (백엔드 없음 / localStorage 저장)</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnAll">전체 보기</button>
        <button class="btn" id="btnCopy">현재 화면 요약 복사</button>
        <button class="btn danger" id="btnReset">데이터 초기화</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="card-hd">
          <h3>지도 기반 조회</h3>
          <span class="pill" id="pillData">데이터: 0건</span>
        </div>
        <div class="card-bd">
          <div class="row">
            <input class="input" id="q" placeholder="검색: 예) 대구 / 중구 / 칠성동 / 영등포구 / 마루웰" />
            <button class="btn" id="btnSearch">검색</button>

            <!-- 업체명 칩 나열 대신 드롭다운 -->
            <select class="select" id="vendorSelect" title="업체 필터">
              <option value="ALL">업체: 전체</option>
            </select>
          </div>

          <div class="chips" id="breadcrumbs"></div>

          <div class="map" id="mapWrap">
            <div id="map" style="width:100%;height:100%;"></div>
            <div class="loading" id="mapLoading" style="display:none;">경계 데이터를 불러오는 중...</div>
          </div>

          <div class="listbox">
            <div class="lb-hd">
              <span id="lbTitle">목록</span>
              <span class="pill" id="lbCount">0</span>
            </div>
            <div class="list" id="regionList"></div>
          </div>

          <div class="section">
            <h4>데이터 입력/수정 (관리용)</h4>
            <textarea id="rawInput" spellcheck="false"></textarea>

            <div class="row" style="margin-top:10px;">
              <button class="btn primary" id="btnApply">파싱/적용</button>
              <button class="btn" id="btnLoadSample">샘플 로드</button>
              <button class="btn" id="btnExportUnique">유니크 목록 내보내기</button>
            </div>

            <div class="hint" style="margin-top:10px;">
              입력 포맷(권장):<br/>
              - [시/도] [시/군/구...] [동/읍/면] [업체명]<br/>
              - 예: <span class="mono" style="padding:2px 6px;">대구광역시 중구 칠성동 마루웰</span><br/>
              - 동일 라인이 여러 번 있어도 유니크(업체+지역) 기준으로 집계합니다.
            </div>

            <div class="hint" id="statsLine" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="card-hd">
          <h3>현재 선택 상세</h3>
          <span class="pill" id="pillScope">전체</span>
        </div>
        <div class="card-bd">
          <div class="kv">
            <div class="k">선택 범위</div><div class="v" id="scopeText">전체</div>
            <div class="k">업체 필터</div><div class="v" id="vendorText">전체</div>
            <div class="k">유니크(업체+지역)</div><div class="v" id="uniqueText">0</div>
          </div>

          <div class="section">
            <h4>업체 분포 (가나다순)</h4>
            <div class="mono" id="vendorDist">표시할 데이터가 없습니다.</div>
          </div>

          <div class="section">
            <h4>동별 업체 (동 가나다순 / 업체 가나다순)</h4>
            <div class="mono" id="dongVendors">표시할 데이터가 없습니다.</div>
          </div>

          <div class="section">
            <h4>메모</h4>
            <div class="hint">
              - 업체 칩(업체명 나열)은 제거하고 드롭다운 필터만 제공합니다.<br/>
              - “상위 동(Top 12)” 대신, 데이터가 있는 동 전체를 가나다순으로 출력합니다.<br/>
              - 검색은 “필터”만 변경하며 데이터/경계 로딩 상태를 초기화하지 않습니다.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // -----------------------------
  // Config / Storage
  // -----------------------------
  const LS_DATA = "coupangland.data.v2";
  const LS_STATE = "coupangland.state.v2";

  // 경계 데이터 소스(공개)
  const URL_SIDO = "https://raw.githubusercontent.com/southkorea/southkorea-maps/master/gadm/json/skorea-provinces-geo.json";
  const URL_SIGUNGU = "https://raw.githubusercontent.com/southkorea/southkorea-maps/master/kostat/2018/json/skorea-municipalities-2018-geo.json";
  const dongUrlBySido = (sidoKorean) =>
    "https://raw.githubusercontent.com/raqoon886/Local_HangJeongDong/master/hangjeongdong_" +
    encodeURIComponent(sidoKorean) + ".geojson";

  // 샘플 데이터(요청하신 최신 데이터)
  const SAMPLE_LINES = [
    "영등포구 대림동 마루웰",
    "영등포구 대림동 마루웰",
    "분당구 대장동 투네스트",
    "용인시 수지구 동천동 투네스트",
    "용인시 수지구 동천동 마루웰",
    "용인시 수지구 동천동 강동물류",
    "영등포구 신길동 마루웰",
    "대구광역시 중구 칠성동 마루웰",
    "대구광역시 중구 동인동 마루웰",
    "서울특별시 강서구 염창동 투네스트",
    "서울특별시 강서구 염창동 마루웰",
    "경기도 용인시 수지구 동천동 마루웰",
    "대구광역시 달서구 월성동 지엔제이",
    "대구광역시 중구 대봉동 123로지스",
    "대구광역시 중구 동인동 123로지스",
    "대구광역시 달성군 화원읍 태호물류",
    "대구광역시 동구 검사동 정직한물류",
    "대구광역시 달서구 감삼동 에스제이",
    "대구광역시 수성구 만촌동 수성영업소",
    "용인시 기흥구 마북동 성하",
    "용인시 기흥구 마북동 타이탄",
    "경기도 화성시 영천동 씨제이대한통운 서울장지",
    "경기도 용인시 기흥구 하갈동 신화종합물류",
    "경기도 용인시 기흥구 영덕동 신화종합물류",
    "경기도 용인시 기흥구 보정동 CTR종합물류",
    "경기도 성남시 분당구 분당동 천상로지스틱스",
    "경기도 성남시 분당구 정자동 아이비그룹",
    "경기도 고양시 일산서구 일산동 HR그룹",
    "경기도 고양시 일산서구 일산동 삼보로직스",
    "경기도 고양시 일산서구 일산동 YS물류",
    "경기도 고양시 일산서구 일산동 JK글로벌로직스",
    "경기도 고양시 일산서구 주엽동 가화컴퍼니",
    "경기도 고양시 일산서구 주엽동 삼보로직스",
  ];

  // -----------------------------
  // DOM
  // -----------------------------
  const el = {
    pillData: document.getElementById("pillData"),
    q: document.getElementById("q"),
    btnSearch: document.getElementById("btnSearch"),
    vendorSelect: document.getElementById("vendorSelect"),
    breadcrumbs: document.getElementById("breadcrumbs"),
    regionList: document.getElementById("regionList"),
    lbTitle: document.getElementById("lbTitle"),
    lbCount: document.getElementById("lbCount"),

    rawInput: document.getElementById("rawInput"),
    btnApply: document.getElementById("btnApply"),
    btnLoadSample: document.getElementById("btnLoadSample"),
    btnExportUnique: document.getElementById("btnExportUnique"),
    statsLine: document.getElementById("statsLine"),

    pillScope: document.getElementById("pillScope"),
    scopeText: document.getElementById("scopeText"),
    vendorText: document.getElementById("vendorText"),
    uniqueText: document.getElementById("uniqueText"),
    vendorDist: document.getElementById("vendorDist"),
    dongVendors: document.getElementById("dongVendors"),

    btnAll: document.getElementById("btnAll"),
    btnCopy: document.getElementById("btnCopy"),
    btnReset: document.getElementById("btnReset"),

    mapLoading: document.getElementById("mapLoading"),
  };

  // -----------------------------
  // State
  // -----------------------------
  const defaultState = {
    level: "NATION",      // NATION | SIDO | SIGUNGU | DONG
    sido: null,
    sigungu: null,
    dong: null,
    vendor: "ALL",
    query: ""
  };

  let state = loadJson(LS_STATE, defaultState);

  // -----------------------------
  // Data
  // -----------------------------
  // record: { sido, sigungu, dong, vendor, key }
  let records = [];
  let uniqueRecords = []; // unique by vendor+sido+sigungu+dong

  // indexes for quick grouping
  const idx = {
    vendors: [],
    bySido: new Map(),     // sido -> [uniqueRecords]
    bySigungu: new Map(),  // sido|sigungu -> [uniqueRecords]
    byDong: new Map(),     // sido|sigungu|dong -> [uniqueRecords]
  };

  // boundary caches
  const boundary = {
    sidoGeo: null,
    sigunguGeo: null,
    dongGeoBySido: new Map(), // sido -> geojson
  };

  // kakao map / overlays
  let map = null;
  let polygons = [];
  let overlays = [];

  // -----------------------------
  // Helpers
  // -----------------------------
  function saveJson(key, obj){
    localStorage.setItem(key, JSON.stringify(obj));
  }
  function loadJson(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      return JSON.parse(raw);
    }catch(e){
      return fallback;
    }
  }
  function koSort(a,b){
    return String(a).localeCompare(String(b), "ko", { sensitivity:"base" });
  }
  function uniqBy(arr, keyFn){
    const m = new Map();
    for(const x of arr){
      const k = keyFn(x);
      if(!m.has(k)) m.set(k, x);
    }
    return Array.from(m.values());
  }

  function normalizeSpaces(s){ return String(s||"").trim().replace(/\s+/g," "); }

  // 간단 파서(현재 데이터 패턴 기준)
  function parseLine(line){
    const t = normalizeSpaces(line).split(" ").filter(Boolean);
    if(t.length < 3) return null;

    const vendor = t[t.length-1];
    const parts = t.slice(0, -1);

    let sido = null, sigungu = null, dong = null;

    const isSidoToken = (x) =>
      /특별시$|광역시$|특별자치시$|도$|특별자치도$/.test(x);

    // 1) 시/도가 명시된 경우
    if(parts.length >= 3 && isSidoToken(parts[0])){
      sido = parts[0];

      // 예: 경기도 용인시 수지구 동천동
      // 예: 대구광역시 중구 칠성동
      // dong은 마지막 토큰(동/읍/면)으로 가정
      dong = parts[parts.length-1];

      const mid = parts.slice(1, -1);
      sigungu = normalizeSpaces(mid.join(" "));
      return { sido, sigungu, dong, vendor };
    }

    // 2) 시/도 생략: "영등포구 대림동" (서울로 가정)
    if(parts.length === 2 && /구$/.test(parts[0]) && /(동|읍|면)$/.test(parts[1])){
      sido = "서울특별시";
      sigungu = parts[0];
      dong = parts[1];
      return { sido, sigungu, dong, vendor };
    }

    // 3) 시/도 생략: "용인시 수지구 동천동" / "용인시 기흥구 마북동"
    if(parts.length >= 3){
      dong = parts[parts.length-1];
      const mid = parts.slice(0, -1);

      // mid가 "용인시 수지구" 형태면 sigungu로
      sigungu = normalizeSpaces(mid.join(" "));

      // 시/도 추정 (경기도/서울/대구 정도 커버)
      // - "대구시" 같은 약식 케이스도 흡수
      if(/^대구/.test(sigungu) || /^대구/.test(dong)){
        sido = "대구광역시";
      } else if(/(용인시|성남시|고양시|화성시|수원시|부천시|안양시|평택시|파주시|김포시|하남시|광주시|의정부시|양주시|포천시|광명시|과천시|여주시|이천시|안산시|시흥시|오산시|안성시|의왕시|군포시|구리시|남양주시|동두천시|연천군|가평군|양평군)/.test(sigungu)){
        sido = "경기도";
      } else if(/구$/.test(sigungu.split(" ").slice(-1)[0])) {
        // 남은 "OO구"는 서울로 가정(현 데이터 흐름)
        sido = "서울특별시";
      } else {
        // fallback
        sido = "기타";
      }

      return { sido, sigungu, dong, vendor };
    }

    return null;
  }

  function buildIndexes(){
    idx.vendors = [];
    idx.bySido.clear();
    idx.bySigungu.clear();
    idx.byDong.clear();

    // vendor list
    const vendors = Array.from(new Set(uniqueRecords.map(r => r.vendor))).sort(koSort);
    idx.vendors = vendors;

    for(const r of uniqueRecords){
      const kSido = r.sido;
      const kSigungu = r.sido + "|" + r.sigungu;
      const kDong = r.sido + "|" + r.sigungu + "|" + r.dong;

      if(!idx.bySido.has(kSido)) idx.bySido.set(kSido, []);
      if(!idx.bySigungu.has(kSigungu)) idx.bySigungu.set(kSigungu, []);
      if(!idx.byDong.has(kDong)) idx.byDong.set(kDong, []);

      idx.bySido.get(kSido).push(r);
      idx.bySigungu.get(kSigungu).push(r);
      idx.byDong.get(kDong).push(r);
    }
  }

  function applyFilters(base){
    // base: array uniqueRecords
    let arr = base;

    // vendor filter
    if(state.vendor && state.vendor !== "ALL"){
      arr = arr.filter(r => r.vendor === state.vendor);
    }

    // search query filter
    const q = normalizeSpaces(state.query || "");
    if(q){
      const qLower = q.toLowerCase();
      arr = arr.filter(r => {
        const blob = `${r.sido} ${r.sigungu} ${r.dong} ${r.vendor}`.toLowerCase();
        return blob.includes(qLower);
      });
    }

    return arr;
  }

  function currentScopeRecords(){
    // start from all uniqueRecords, then restrict by selection level
    let base = uniqueRecords;

    if(state.level === "SIDO" && state.sido){
      base = idx.bySido.get(state.sido) || [];
    } else if(state.level === "SIGUNGU" && state.sido && state.sigungu){
      base = idx.bySigungu.get(state.sido + "|" + state.sigungu) || [];
    } else if(state.level === "DONG" && state.sido && state.sigungu && state.dong){
      base = idx.byDong.get(state.sido + "|" + state.sigungu + "|" + state.dong) || [];
    }

    return applyFilters(base);
  }

  // -----------------------------
  // UI Render
  // -----------------------------
  function renderAll(){
    // header counts
    el.pillData.textContent = `데이터: ${uniqueRecords.length}건`;

    // vendor dropdown
    renderVendorSelect();

    // breadcrumbs
    renderBreadcrumbs();

    // left list (next-level)
    renderRegionList();

    // right panel details
    renderDetail();

    // map polygons
    renderMap();
  }

  function renderVendorSelect(){
    const sel = el.vendorSelect;
    const cur = state.vendor || "ALL";

    // rebuild options
    sel.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "ALL";
    optAll.textContent = "업체: 전체";
    sel.appendChild(optAll);

    for(const v of idx.vendors){
      const o = document.createElement("option");
      o.value = v;
      o.textContent = `업체: ${v}`;
      sel.appendChild(o);
    }

    sel.value = cur;
  }

  function renderBreadcrumbs(){
    const bc = el.breadcrumbs;
    bc.innerHTML = "";

    const add = (text, onClick, cls="chip gray") => {
      const c = document.createElement("div");
      c.className = cls;
      c.textContent = text;
      c.onclick = onClick;
      bc.appendChild(c);
    };

    add("전체", () => setLevel("NATION"));

    if(state.sido){
      add(state.sido, () => setLevel("SIDO", { sido: state.sido }));
    }
    if(state.sigungu){
      add(state.sigungu, () => setLevel("SIGUNGU", { sido: state.sido, sigungu: state.sigungu }));
    }
    if(state.dong){
      add(state.dong, () => setLevel("DONG", { sido: state.sido, sigungu: state.sigungu, dong: state.dong }));
    }

    if(state.level !== "NATION"){
      add("← 한 단계 위", () => goUp(), "chip");
    }
  }

  function renderRegionList(){
    const list = el.regionList;
    list.innerHTML = "";

    const scope = currentScopeRecords(); // filtered
    // next-level list should be based on selection, but counts should reflect same filters
    let items = [];

    if(state.level === "NATION"){
      // list sido
      const by = new Map();
      for(const r of applyFilters(uniqueRecords)){
        by.set(r.sido, (by.get(r.sido)||0) + 1);
      }
      items = Array.from(by.entries()).map(([name,count]) => ({ name, count, onClick: () => setLevel("SIDO", { sido:name }) }));
      items.sort((a,b) => koSort(a.name,b.name));
      el.lbTitle.textContent = "시/도";
    } else if(state.level === "SIDO"){
      const by = new Map();
      for(const r of scope){
        by.set(r.sigungu, (by.get(r.sigungu)||0) + 1);
      }
      items = Array.from(by.entries()).map(([name,count]) => ({ name, count, onClick: () => setLevel("SIGUNGU", { sido: state.sido, sigungu:name }) }));
      items.sort((a,b) => koSort(a.name,b.name));
      el.lbTitle.textContent = `시/군/구 (선택: ${state.sido})`;
    } else if(state.level === "SIGUNGU"){
      const by = new Map();
      for(const r of scope){
        by.set(r.dong, (by.get(r.dong)||0) + 1);
      }
      items = Array.from(by.entries()).map(([name,count]) => ({ name, count, onClick: () => setLevel("DONG", { sido: state.sido, sigungu: state.sigungu, dong:name }) }));
      items.sort((a,b) => koSort(a.name,b.name));
      el.lbTitle.textContent = `동/읍/면 (선택: ${state.sigungu})`;
    } else {
      // DONG: list vendors in that dong (still list)
      const by = new Map();
      for(const r of scope){
        by.set(r.vendor, (by.get(r.vendor)||0) + 1);
      }
      items = Array.from(by.entries()).map(([name,count]) => ({ name, count, onClick: () => {
        // vendor filter quick set
        state.vendor = name;
        saveJson(LS_STATE, state);
        renderAll();
      }}));
      items.sort((a,b) => koSort(a.name,b.name));
      el.lbTitle.textContent = `업체 (선택: ${state.dong})`;
    }

    for(const it of items){
      const row = document.createElement("div");
      row.className = "item";
      row.onclick = it.onClick;

      const left = document.createElement("div");
      left.className = "name";
      left.textContent = it.name;

      const right = document.createElement("div");
      right.className = "count";
      right.textContent = it.count;

      row.appendChild(left);
      row.appendChild(right);
      list.appendChild(row);
    }

    el.lbCount.textContent = String(items.length);
  }

  function renderDetail(){
    const scope = currentScopeRecords();
    const scopeLabel = getScopeLabel();

    el.pillScope.textContent = scopeLabel.short;
    el.scopeText.textContent = scopeLabel.long;
    el.vendorText.textContent = (state.vendor === "ALL" ? "전체" : state.vendor);
    el.uniqueText.textContent = String(scope.length);

    // 업체 분포(가나다순)
    const vendorMap = new Map();
    for(const r of scope){
      vendorMap.set(r.vendor, (vendorMap.get(r.vendor)||0) + 1);
    }
    const vendors = Array.from(vendorMap.entries())
      .sort((a,b) => koSort(a[0], b[0]))
      .map(([v,c]) => `- ${v}: ${c}`);
    el.vendorDist.textContent = vendors.length ? vendors.join("\n") : "표시할 데이터가 없습니다.";

    // 동별 업체(동 가나다 / 업체 가나다)
    // - 요청: "상위동" 대신 "데이터 있는 동 전체"를 출력
    // - 동 그룹: 현재 scope에서 동별로 vendor set 만들기
    const dongMap = new Map(); // dong -> Map(vendor -> count)
    for(const r of scope){
      if(!dongMap.has(r.dong)) dongMap.set(r.dong, new Map());
      const vm = dongMap.get(r.dong);
      vm.set(r.vendor, (vm.get(r.vendor)||0) + 1);
    }

    const dongLines = [];
    const dongKeys = Array.from(dongMap.keys()).sort(koSort);
    for(const d of dongKeys){
      const vm = dongMap.get(d);
      const vlist = Array.from(vm.entries())
        .sort((a,b) => koSort(a[0], b[0]))
        .map(([v,c]) => `${v}(${c})`);
      dongLines.push(`- ${d}: ${vlist.join(", ")}`);
    }
    el.dongVendors.textContent = dongLines.length ? dongLines.join("\n") : "표시할 데이터가 없습니다.";
  }

  function getScopeLabel(){
    if(state.level === "NATION") return { short:"전체", long:"전체" };
    if(state.level === "SIDO") return { short: state.sido, long: state.sido };
    if(state.level === "SIGUNGU") return { short: state.sigungu, long: `${state.sido} / ${state.sigungu}` };
    return { short: state.dong, long: `${state.sido} / ${state.sigungu} / ${state.dong}` };
  }

  function setLevel(level, payload={}){
    state.level = level;

    if(level === "NATION"){
      state.sido = null; state.sigungu = null; state.dong = null;
    } else if(level === "SIDO"){
      state.sido = payload.sido;
      state.sigungu = null; state.dong = null;
    } else if(level === "SIGUNGU"){
      state.sido = payload.sido;
      state.sigungu = payload.sigungu;
      state.dong = null;
    } else if(level === "DONG"){
      state.sido = payload.sido;
      state.sigungu = payload.sigungu;
      state.dong = payload.dong;
    }

    saveJson(LS_STATE, state);
    renderAll();
  }

  function goUp(){
    if(state.level === "DONG") return setLevel("SIGUNGU", { sido: state.sido, sigungu: state.sigungu });
    if(state.level === "SIGUNGU") return setLevel("SIDO", { sido: state.sido });
    if(state.level === "SIDO") return setLevel("NATION");
  }

  // -----------------------------
  // Map / Polygons
  // -----------------------------
  function clearMapOverlays(){
    for(const p of polygons) p.setMap(null);
    for(const o of overlays) o.setMap(null);
    polygons = [];
    overlays = [];
  }

  function showLoading(on){
    el.mapLoading.style.display = on ? "flex" : "none";
  }

  async function fetchJson(url){
    const res = await fetch(url, { cache: "force-cache" });
    if(!res.ok) throw new Error(`fetch failed: ${res.status}`);
    return res.json();
  }

  function toLatLngPath(coords){
    // coords: [[lng,lat],...]
    return coords.map(([lng,lat]) => new kakao.maps.LatLng(lat, lng));
  }

  function getBoundsFromPaths(paths){
    const b = new kakao.maps.LatLngBounds();
    const add = (pt) => b.extend(pt);

    for(const ring of paths){
      for(const pt of ring) add(pt);
    }
    return b;
  }

  function featureToPolygons(feature, style, onClick){
    const geom = feature.geometry;
    const props = feature.properties || {};

    const makePoly = (ringsLatLng) => {
      const poly = new kakao.maps.Polygon({
        path: ringsLatLng,
        strokeWeight: style.strokeWeight ?? 4,
        strokeColor: style.strokeColor ?? "#2563eb",
        strokeOpacity: style.strokeOpacity ?? 0.92,
        strokeStyle: style.strokeStyle ?? "solid",
        fillColor: style.fillColor ?? "#60a5fa",
        fillOpacity: style.fillOpacity ?? 0.12,
      });

      poly.setMap(map);

      kakao.maps.event.addListener(poly, "mouseover", () => {
        poly.setOptions({ fillOpacity: style.hoverFillOpacity ?? 0.22 });
      });
      kakao.maps.event.addListener(poly, "mouseout", () => {
        poly.setOptions({ fillOpacity: style.fillOpacity ?? 0.12 });
      });
      if(onClick){
        kakao.maps.event.addListener(poly, "click", () => onClick(props, feature));
      }

      polygons.push(poly);
      return poly;
    };

    if(!geom) return [];
    const out = [];

    if(geom.type === "Polygon"){
      const rings = geom.coordinates.map(r => toLatLngPath(r));
      out.push(makePoly(rings));
    } else if(geom.type === "MultiPolygon"){
      for(const polyCoords of geom.coordinates){
        const rings = polyCoords.map(r => toLatLngPath(r));
        out.push(makePoly(rings));
      }
    }
    return out;
  }

  function getFeatureNameAny(props){
    // 다양한 필드 fallback
    return (
      props.name_local ||
      props.name ||
      props.NAME_1 ||
      props.NAME_2 ||
      props.CTP_KOR_NM ||   // 통계청 시도명
      props.SIG_KOR_NM ||   // 시군구명
      props.adm_nm ||       // 행정동 풀네임
      ""
    );
  }

  function parseAdmNm(admNm){
    // "대구광역시 중구 칠성동" -> {sido, sigungu, dong}
    const t = normalizeSpaces(admNm).split(" ").filter(Boolean);
    if(t.length < 3) return null;
    const sido = t[0];
    const dong = t[t.length-1];
    const sigungu = normalizeSpaces(t.slice(1, -1).join(" "));
    return { sido, sigungu, dong };
  }

  async function ensureBoundaries(){
    // sido, sigungu는 1회만 로딩
    if(!boundary.sidoGeo){
      showLoading(true);
      boundary.sidoGeo = await fetchJson(URL_SIDO);
      showLoading(false);
    }
    if(!boundary.sigunguGeo){
      showLoading(true);
      boundary.sigunguGeo = await fetchJson(URL_SIGUNGU);
      showLoading(false);
    }
  }

  async function ensureDongGeo(sido){
    if(boundary.dongGeoBySido.has(sido)) return boundary.dongGeoBySido.get(sido);

    showLoading(true);
    try{
      const geo = await fetchJson(dongUrlBySido(sido));
      boundary.dongGeoBySido.set(sido, geo);
      return geo;
    } finally {
      showLoading(false);
    }
  }

  async function renderMap(){
    if(!map) return;
    await ensureBoundaries();

    clearMapOverlays();

    const scope = currentScopeRecords(); // filtered data
    const scopeSetSigungu = new Set(scope.map(r => r.sigungu));
    const scopeSetDong = new Set(scope.map(r => r.dong));

    // NATION: draw provinces (highlight those with data)
    if(state.level === "NATION"){
      const bySidoCount = new Map();
      for(const r of scope){
        bySidoCount.set(r.sido, (bySidoCount.get(r.sido)||0) + 1);
      }

      const feats = (boundary.sidoGeo.features || []);
      for(const f of feats){
        const nameAny = getFeatureNameAny(f.properties);
        // nameAny가 영어일 수도 있으니, 데이터 sido와 매칭은 "포함"으로 보수 처리
        // (실제 운영에서 필요하면 여기 매핑테이블 추가)
        const matchedSido = Array.from(bySidoCount.keys()).find(k => nameAny.includes(k) || k.includes(nameAny));
        const has = matchedSido ? bySidoCount.get(matchedSido) : 0;

        const style = {
          strokeWeight: 4,
          strokeColor: "#2563eb",
          strokeOpacity: 0.92,
          fillColor: "#60a5fa",
          fillOpacity: has ? 0.12 : 0.04,
          hoverFillOpacity: has ? 0.22 : 0.10,
        };

        featureToPolygons(f, style, () => {
          // 클릭 시, 이름 추정이 어려우면 데이터에서 가장 근접한 sido를 사용
          const target = matchedSido || normalizeSpaces(nameAny);
          setLevel("SIDO", { sido: target });
        });
      }
      return;
    }

    // SIDO: draw municipalities within selected sido
    if(state.level === "SIDO" && state.sido){
      const feats = (boundary.sigunguGeo.features || []);
      const candidates = [];

      for(const f of feats){
        const props = f.properties || {};
        const sidoName = props.CTP_KOR_NM || props.NAME_1 || props.name_1 || "";
        const sigName = props.SIG_KOR_NM || props.NAME_2 || props.name_2 || getFeatureNameAny(props);

        // 시도 매칭(엄격)
        if(normalizeSpaces(sidoName) !== normalizeSpaces(state.sido)) continue;

        const has = scopeSetSigungu.has(normalizeSpaces(sigName)) ? 1 : 0;

        candidates.push({ f, sigName: normalizeSpaces(sigName), has });
      }

      candidates.sort((a,b) => koSort(a.sigName,b.sigName));

      for(const it of candidates){
        const style = {
          strokeWeight: 4,
          strokeColor: "#2563eb",
          strokeOpacity: 0.92,
          fillColor: "#60a5fa",
          fillOpacity: it.has ? 0.12 : 0.04,
          hoverFillOpacity: it.has ? 0.22 : 0.10,
        };
        featureToPolygons(it.f, style, () => {
          setLevel("SIGUNGU", { sido: state.sido, sigungu: it.sigName });
        });
      }

      // bounds fit: selected sido's polygons bounds
      fitToCurrentPolygons();
      return;
    }

    // SIGUNGU: draw dong polygons only for dongs with data in this sigungu
    if(state.level === "SIGUNGU" && state.sido && state.sigungu){
      const dongGeo = await ensureDongGeo(state.sido);
      const feats = (dongGeo.features || []);

      // scope already filtered for this sigungu via currentScopeRecords()
      const dongsInData = new Set(scope.map(r => r.dong));

      const drawFeats = [];
      for(const f of feats){
        const props = f.properties || {};
        const admNm = props.adm_nm || getFeatureNameAny(props);
        const parsed = parseAdmNm(admNm);
        if(!parsed) continue;

        // sigungu match (부분 문자열 포함 허용)
        if(normalizeSpaces(parsed.sigungu) !== normalizeSpaces(state.sigungu)) continue;
        if(!dongsInData.has(normalizeSpaces(parsed.dong))) continue;

        drawFeats.push({ f, dong: normalizeSpaces(parsed.dong) });
      }

      drawFeats.sort((a,b) => koSort(a.dong,b.dong));

      for(const it of drawFeats){
        const style = {
          strokeWeight: 4,
          strokeColor: "#2563eb",
          strokeOpacity: 0.92,
          fillColor: "#60a5fa",
          fillOpacity: 0.12,
          hoverFillOpacity: 0.22,
        };
        featureToPolygons(it.f, style, () => {
          setLevel("DONG", { sido: state.sido, sigungu: state.sigungu, dong: it.dong });
        });
      }

      fitToCurrentPolygons();
      return;
    }

    // DONG: draw that dong polygon (if available)
    if(state.level === "DONG" && state.sido && state.sigungu && state.dong){
      const dongGeo = await ensureDongGeo(state.sido);
      const feats = (dongGeo.features || []);

      for(const f of feats){
        const props = f.properties || {};
        const admNm = props.adm_nm || getFeatureNameAny(props);
        const parsed = parseAdmNm(admNm);
        if(!parsed) continue;

        if(normalizeSpaces(parsed.sigungu) !== normalizeSpaces(state.sigungu)) continue;
        if(normalizeSpaces(parsed.dong) !== normalizeSpaces(state.dong)) continue;

        const style = {
          strokeWeight: 5,
          strokeColor: "#1d4ed8",
          strokeOpacity: 0.95,
          fillColor: "#60a5fa",
          fillOpacity: 0.18,
          hoverFillOpacity: 0.28,
        };
        featureToPolygons(f, style, null);
      }

      fitToCurrentPolygons();
      return;
    }
  }

  function fitToCurrentPolygons(){
    try{
      const b = new kakao.maps.LatLngBounds();
      let any = false;
      for(const p of polygons){
        const path = p.getPath(); // kakao.maps.LatLng[] or array of arrays
        if(!path) continue;

        // Kakao Polygon getPath() returns array-of-rings in some cases
        if(Array.isArray(path) && path.length && Array.isArray(path[0])){
          for(const ring of path){
            for(const pt of ring){
              b.extend(pt); any = true;
            }
          }
        } else if(Array.isArray(path)){
          for(const pt of path){
            b.extend(pt); any = true;
          }
        }
      }
      if(any) map.setBounds(b);
    }catch(e){
      // ignore
    }
  }

  // -----------------------------
  // Actions
  // -----------------------------
  function loadDataFromStorageOrSeed(){
    const saved = loadJson(LS_DATA, null);
    if(saved && Array.isArray(saved) && saved.length){
      uniqueRecords = saved;
      records = saved; // (이 MVP는 unique만 저장)
      return;
    }

    // seed
    el.rawInput.value = SAMPLE_LINES.join("\n");
    applyRawInput(true);
  }

  function applyRawInput(silent=false){
    const raw = el.rawInput.value || "";
    const lines = raw.split("\n").map(s => normalizeSpaces(s)).filter(Boolean);

    const parsed = [];
    for(const ln of lines){
      const r = parseLine(ln);
      if(r && r.sido && r.sigungu && r.dong && r.vendor){
        parsed.push(r);
      }
    }

    const uniq = uniqBy(parsed, r => `${r.vendor}|${r.sido}|${r.sigungu}|${r.dong}`)
      .map(r => ({...r, key:`${r.vendor}|${r.sido}|${r.sigungu}|${r.dong}`}));

    uniqueRecords = uniq;
    records = parsed;

    saveJson(LS_DATA, uniqueRecords);
    buildIndexes();

    el.statsLine.textContent = `원본 라인 ${lines.length} / 유니크(업체+지역) ${uniqueRecords.length}`;

    if(!silent){
      // 검색/필터가 들어가 있어도 데이터 자체는 보존
      renderAll();
    } else {
      renderAll();
    }
  }

  function exportUnique(){
    const rows = uniqueRecords
      .slice()
      .sort((a,b) => {
        const s1 = koSort(a.sido,b.sido);
        if(s1) return s1;
        const s2 = koSort(a.sigungu,b.sigungu);
        if(s2) return s2;
        const s3 = koSort(a.dong,b.dong);
        if(s3) return s3;
        return koSort(a.vendor,b.vendor);
      })
      .map(r => `${r.sido} ${r.sigungu} ${r.dong} ${r.vendor}`);

    const blob = new Blob([rows.join("\n")], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "coupangland_unique.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function copySummary(){
    const scopeLabel = getScopeLabel();
    const scope = currentScopeRecords();

    const vendorMap = new Map();
    for(const r of scope){
      vendorMap.set(r.vendor, (vendorMap.get(r.vendor)||0)+1);
    }
    const vendorLines = Array.from(vendorMap.entries()).sort((a,b)=>koSort(a[0],b[0]))
      .map(([v,c]) => `${v}:${c}`).join(", ");

    const dongMap = new Map();
    for(const r of scope){
      if(!dongMap.has(r.dong)) dongMap.set(r.dong, new Set());
      dongMap.get(r.dong).add(r.vendor);
    }
    const dongLines = Array.from(dongMap.entries()).sort((a,b)=>koSort(a[0],b[0]))
      .map(([d,set]) => `${d}(${Array.from(set).sort(koSort).join("/")})`)
      .slice(0, 50) // 너무 길면 컷
      .join(", ");

    const text =
`[CoupangLand 요약]
- 범위: ${scopeLabel.long}
- 업체필터: ${(state.vendor==="ALL"?"전체":state.vendor)}
- 유니크(업체+지역): ${scope.length}

[업체 분포(가나다)]
${vendorLines || "(없음)"}

[동별 업체(가나다)]
${dongLines || "(없음)"}
`;
    navigator.clipboard.writeText(text).then(()=> {
      alert("요약을 클립보드에 복사했습니다.");
    }).catch(()=> {
      alert("복사 실패: 브라우저 권한을 확인하세요.");
    });
  }

  function resetAll(){
    if(!confirm("localStorage 데이터/상태를 초기화할까요?")) return;
    localStorage.removeItem(LS_DATA);
    localStorage.removeItem(LS_STATE);
    state = {...defaultState};
    saveJson(LS_STATE, state);
    el.rawInput.value = SAMPLE_LINES.join("\n");
    applyRawInput(true);
  }

  // -----------------------------
  // Events
  // -----------------------------
  el.btnSearch.onclick = () => {
    state.query = normalizeSpaces(el.q.value);
    saveJson(LS_STATE, state);
    renderAll();
  };

  el.q.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      state.query = normalizeSpaces(el.q.value);
      saveJson(LS_STATE, state);
      renderAll();
    }
  });

  el.vendorSelect.onchange = () => {
    state.vendor = el.vendorSelect.value || "ALL";
    saveJson(LS_STATE, state);
    renderAll();
  };

  el.btnApply.onclick = () => applyRawInput(false);

  el.btnLoadSample.onclick = () => {
    el.rawInput.value = SAMPLE_LINES.join("\n");
    applyRawInput(false);
  };

  el.btnExportUnique.onclick = () => exportUnique();

  el.btnAll.onclick = () => setLevel("NATION");

  el.btnCopy.onclick = () => copySummary();

  el.btnReset.onclick = () => resetAll();

  // -----------------------------
  // Init
  // -----------------------------
  function initMap(){
    const container = document.getElementById("map");
    map = new kakao.maps.Map(container, {
      center: new kakao.maps.LatLng(36.35, 127.9),
      level: 13,
    });
  }

  function boot(){
    // seed data
    loadDataFromStorageOrSeed();

    // set search input from state
    el.q.value = state.query || "";

    // render
    renderAll();
  }

  kakao.maps.load(() => {
    initMap();
    boot();
  });

})();
</script>
</body>
</html>
