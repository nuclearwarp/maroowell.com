<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="referrer" content="origin" />
  <title>ë§ˆë£¨ì›°5</title>
  <style>
    :root {
      --headerH: 52px;
      --bg:#0f1115;
      --card:#161a22;
      --muted:#8b95a7;
      --text:#e6e9ef;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      padding:0;
      height:100%;
      background:var(--bg);
      color:var(--text);
      font:14px/1.4 system-ui,AppleSDGothicNeo,Segoe UI,Roboto;
    }

    body {
      overflow:hidden;
    }

    header{
      display:flex;
      gap:12px;
      align-items:center;
      padding:12px 16px;
      height:var(--headerH);
      background:#161a22;
      border-bottom:1px solid #232838;
      position:sticky;
      top:0;
      z-index:5;
    }
    header h1{font-size:16px;margin:0}
    header .sub{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
    #app{
      display:grid;
      grid-template-columns:320px minmax(0,1fr);
      height:calc(100dvh - var(--headerH));
      min-height:calc(100dvh - var(--headerH));
    }
    #panel{
      padding:14px;
      border-right:1px solid #232838;
      background:#10141b;
      overflow:auto;
    }
    #mapWrap{
      position:relative;
      min-height:0;
    }
    #map{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
    }

    label{display:block;margin:10px 0 6px;color:#9aa6b2}
    input,textarea,button{font:inherit}
    textarea{
      width:100%;
      background:#0c0f14;
      border:1px solid #2a3142;
      color:var(--text);
      padding:10px;
      border-radius:10px;
      min-height:90px;
    }
    button{
      background:#1b2230;
      border:1px solid #2a3142;
      color:var(--text);
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover{border-color:#3a4561}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:#8b95a7;font-size:12px}
    .list{margin-top:10px;display:flex;flex-wrap:wrap;gap:6px}
    .chip{
      border:1px solid #2a3142;
      border-radius:999px;
      padding:6px 10px;
      background:#0c0f14;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .chip button{
      border:none;
      background:transparent;
      color:#94a3b8;
      cursor:pointer;
    }
    #gate{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.8);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:99;
    }
    #gateCard{
      background:#0e131a;
      border:1px solid #2a3142;
      border-radius:16px;
      padding:22px;
      width:360px;
    }
    #gateCard h2{margin:0 0 12px}
    .ok{color:#9FE870}
    .err{color:#ff7b7b}

    /* ìŠ¤í¬ë¦°ìƒ· ëª¨ë“œ: ì§€ë„ë§Œ ê½‰ ì°¨ê²Œ */
    body.capture-mode header,
    body.capture-mode #panel {
      display:none;
    }
    body.capture-mode #app{
      grid-template-columns:1fr;
      height:100dvh;
      min-height:100dvh;
    }
    body.capture-mode #mapWrap{
      height:100dvh;
    }

    /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
    @media (max-width: 900px){
      body{overflow:auto;}

      #app{
        display:flex;
        flex-direction:column;
        height:auto;
        min-height:calc(100dvh - var(--headerH));
      }
      #mapWrap{
        order:1;
        position:relative;
        height:60vh;       /* ëª¨ë°”ì¼ì—ì„œ ì§€ë„ ë¹„ìœ¨ í¬ê²Œ */
        min-height:320px;
      }
      #map{
        position:absolute;
        inset:0;
      }
      #panel{
        order:2;
        border-right:none;
        border-top:1px solid #232838;
        max-height:40vh;
        overflow:auto;
      }

      body.capture-mode #app{
        flex-direction:column;
      }
      body.capture-mode #mapWrap{
        height:100dvh;
      }
    }
  </style>

  <!-- Daum ìš°í¸ë²ˆí˜¸ -->
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

  <!-- proj4 (5179 -> 4326 ë³€í™˜ìš©) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.1/proj4.min.js"></script>

  <!-- Kakao ì§€ë„ SDK -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=add4ce93b38c0ff9d9b9053728e067b3"></script>
</head>
<body>
  <header>
    <h1>ë§ˆë£¨ì›°4</h1>
    <span class="sub">ë‹¤ì¤‘ ìš°í¸ë²ˆí˜¸ ê¶Œì—­ ê²€ìƒ‰ê¸° Â· Kakao Map</span>
  </header>

  <!-- ì„ì‹œ ê²Œì´íŠ¸ (ì½”ë“œ: maroowell) -->
  <div id="gate">
    <div id="gateCard">
      <h2>ì ‘ì† ì½”ë“œ</h2>
      <p class="muted">ì„ì‹œ ë³´í˜¸ìš©. ë°°í¬ ì „ ì •ì‹ ì¸ì¦ìœ¼ë¡œ êµì²´ ê¶Œì¥</p>
      <label>Access Code</label>
      <input id="code" type="password" placeholder="ì˜ˆ: maroowell" />
      <div class="row" style="margin-top:12px">
        <button id="enterBtn">ì…ì¥</button>
        <span id="gateMsg" class="muted"></span>
      </div>
    </div>
  </div>

  <div id="app" style="display:none">
    <aside id="panel">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted">ìš°í¸ë²ˆí˜¸ ì—¬ëŸ¬ ê°œ ë™ì‹œ ì¡°íšŒ</div>
          <div class="muted">ì‰¼í‘œ/ê³µë°±/ì¤„ë°”ê¿ˆ ëª¨ë‘ ê°€ëŠ¥</div>
        </div>
        <button id="openAddr">ì£¼ì†Œê²€ìƒ‰ ì¶”ê°€</button>
      </div>

      <label style="margin-top:12px">ìš°í¸ë²ˆí˜¸ ëª©ë¡</label>
      <textarea id="zipInput"
        placeholder="ì˜ˆ: 07420, 07421 07422&#10;ë˜ëŠ” ë¶™ì—¬ë„£ê¸°"></textarea>

      <div class="row" style="margin-top:8px">
        <button id="addBtn">ì¶”ê°€</button>
        <button id="clearBtn">ì´ˆê¸°í™”</button>
        <button id="searchBtn">ì§€ë„í‘œì‹œ</button>
      </div>

      <div class="list" id="zipList"></div>

      <div class="row" style="margin-top:10px">
        <button id="captureBtn">ìŠ¤í¬ë¦°ìƒ· ëª¨ë“œ</button>
        <button id="fitBtn">ì˜ì—­ë§ì¶¤</button>
      </div>

      <p class="muted" style="margin-top:10px">
        â€¢ ê° ìš°í¸ë²ˆí˜¸ëŠ” <code>https://zip.maroowell.com/?zipcode=XXXXX</code> ì—ì„œ<br>
        &nbsp;&nbsp;í´ë¦¬ê³¤(5179 ì¢Œí‘œ)ì„ ë°›ì•„ì™€ì„œ ì¹´ì¹´ì˜¤ ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤.<br>
        â€¢ ì˜ëª»ëœ ìš°í¸ë²ˆí˜¸ë‚˜ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ë¯¸íƒ‘ì¬ë¡œ ì•ˆë‚´ë©ë‹ˆë‹¤.<br>
        â€¢ ìŠ¤í¬ë¦°ìƒ· ëª¨ë“œì—ì„œ ì§€ë„ë§Œ ë³´ì´ê²Œ í•œ ë’¤, ë‹¨ë§ ìŠ¤í¬ë¦°ìƒ·ìœ¼ë¡œ ìº¡ì²˜í•´ì„œ ì¹´í†¡ì— ë¶™ì—¬ë„£ì–´ ì‚¬ìš©í•˜ì„¸ìš”.
      </p>
    </aside>

    <div id="mapWrap">
      <div id="map"></div>
    </div>
  </div>

  <script>
    // ------- ì „ì—­ ìƒíƒœ ------- //
    const state = {
      map: null,
      polygons: new Map(),    // zipcode -> [Polygon, ...]
      selectedZips: new Set(),
      colors: [
        '#ff4b4b','#22c55e','#fbbf24','#3b82f6',
        '#22d3ee','#c084fc','#f472b6','#60a5fa',
        '#34d399','#f97316'
      ]
    };

    const ZIP_API = 'https://zip.maroowell.com/?zipcode=';
    const $ = sel => document.querySelector(sel);

    const parseZips = raw =>
      [...new Set((raw || '').match(/\d{5}/g) || [])];

    const pickColor = zip => {
      let h = 0;
      for (let i = 0; i < zip.length; i++) {
        h = (h * 31 + zip.charCodeAt(i)) >>> 0;
      }
      return state.colors[h % state.colors.length];
    };

    // ------- proj4 ì„¸íŒ… (5179 -> 4326) ------- //
    proj4.defs('EPSG:5179',
      '+proj=tmerc +lat_0=38 +lon_0=127.5 +k=0.9996 ' +
      '+x_0=1000000 +y_0=2000000 +ellps=GRS80 ' +
      '+towgs84=0,0,0,0,0,0,0 +units=m +no_defs'
    );
    proj4.defs('EPSG:4326',
      '+proj=longlat +datum=WGS84 +no_defs'
    );

    // 5179 â†’ WGS84 ë³€í™˜ (ì•ˆë˜ë©´ fallback)
    function convertPoint(x, y) {
      let lon, lat;

      try {
        const out = proj4('EPSG:5179', 'EPSG:4326', [x, y]);
        lon = out[0];
        lat = out[1];
      } catch (e) {
        console.warn('proj4 ë³€í™˜ ì‹¤íŒ¨, ì›ë³¸ ì¢Œí‘œ ì‚¬ìš© ì‹œë„', x, y, e);
      }

      // ë³€í™˜ê°’ì´ ë§ì´ ì•ˆë˜ë©´ (í•œêµ­ ë²”ìœ„ ë°–ì´ë©´) ì›ë³¸ì„ WGS84 ë¼ê³  ë³´ê³  ì‚¬ìš©
      if (!isFinite(lat) || !isFinite(lon) ||
          lat < 30 || lat > 45 || lon < 120 || lon > 135) {
        lon = x;
        lat = y;
      }

      return { lat, lon };
    }

    // ------- ì§€ë„ ì´ˆê¸°í™” ------- //
    function createMap() {
      if (!(window.kakao && kakao.maps)) {
        alert('ì¹´ì¹´ì˜¤ ì§€ë„ SDK ë¡œë”© ì‹¤íŒ¨');
        return;
      }
      state.map = new kakao.maps.Map($('#map'), {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 8
      });

      window.addEventListener('resize', () => {
        const c = state.map.getCenter();
        state.map.relayout();
        state.map.setCenter(c);
      });
    }

    // ------- ê²Œì´íŠ¸ ë°”ì¸ë”© ------- //
    function gateBind() {
      $('#enterBtn').onclick = () => {
        const ok = ($('#code').value.trim() === 'maroowell');
        $('#gateMsg').textContent = ok ? 'OK' : 'ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        $('#gateMsg').className = ok ? 'ok' : 'err';
        if (ok) {
          $('#gate').style.display = 'none';
          $('#app').style.display = 'grid';
          createMap();
          bindUI();
        }
      };
    }

    // ------- UI ì´ë²¤íŠ¸ ------- //
    function bindUI() {
      $('#addBtn').onclick = () => {
        parseZips($('#zipInput').value)
          .forEach(z => state.selectedZips.add(z));
        $('#zipInput').value = '';
        renderZipChips();
      };

      $('#clearBtn').onclick = () => {
        state.selectedZips.clear();
        clearPolygons();
        renderZipChips();
      };

      $('#searchBtn').onclick = async () => {
        await drawSelected();
        // drawSelected ëì—ì„œ ìë™ìœ¼ë¡œ fitBoundsAll í˜¸ì¶œí•˜ë¯€ë¡œ ì—¬ê¸°ì„  ì¶”ê°€ í˜¸ì¶œ ë¶ˆí•„ìš”
      };

      $('#fitBtn').onclick = fitBoundsAll;

      // ìŠ¤í¬ë¦°ìƒ· ëª¨ë“œ í† ê¸€
      $('#captureBtn').onclick = () => {
        document.body.classList.toggle('capture-mode');
        if (document.body.classList.contains('capture-mode')) {
          fitBoundsAll();
        }
      };

      $('#openAddr').onclick = () => {
        new daum.Postcode({
          oncomplete: d => {
            if (d.zonecode) {
              state.selectedZips.add(d.zonecode);
              renderZipChips();
            }
          }
        }).open();
      };

      const preset = parseZips(new URLSearchParams(location.search).get('zips'));
      preset.forEach(z => state.selectedZips.add(z));
      renderZipChips();
      if (preset.length) {
        drawSelected().then(fitBoundsAll);
      }
    }

    function renderZipChips() {
      const list = $('#zipList');
      list.innerHTML = '';
      [...state.selectedZips].sort().forEach(z => {
        const div = document.createElement('div');
        div.className = 'chip';
        const color = pickColor(z);
        div.innerHTML =
          `<b>${z}</b>` +
          `<span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:${color}"></span>` +
          `<button title="ì‚­ì œ">âœ•</button>`;
        div.querySelector('button').onclick = () => {
          state.selectedZips.delete(z);
          removePolygon(z);
          renderZipChips();
        };
        list.appendChild(div);
      });
    }

    // ------- í´ë¦¬ê³¤ ê´€ë¦¬ ------- //
    function clearPolygons() {
      for (const arr of state.polygons.values()) {
        arr.forEach(p => p.setMap(null));
      }
      state.polygons.clear();
    }

    function removePolygon(zip) {
      if (!state.polygons.has(zip)) return;
      state.polygons.get(zip).forEach(p => p.setMap(null));
      state.polygons.delete(zip);
    }

    // zip API -> Polygon ìƒì„±
    function polygonsFrom5179(polygon5179, color, zip) {
      if (!Array.isArray(polygon5179) || !polygon5179.length) return [];

      // polygon5179 ê°€ [[x,y], ...] í˜•ì‹
      const rings = (
        Array.isArray(polygon5179[0]) &&
        typeof polygon5179[0][0] === 'number'
      ) ? [polygon5179] : polygon5179;

      const polys = [];

      rings.forEach((ring, idx) => {
        const path = [];
        ring.forEach((pt, i) => {
          if (!Array.isArray(pt) || pt.length < 2) return;
          const x = Number(pt[0]);
          const y = Number(pt[1]);
          if (!isFinite(x) || !isFinite(y)) return;

          const { lat, lon } = convertPoint(x, y);
          if (!isFinite(lat) || !isFinite(lon)) return;

          path.push(new kakao.maps.LatLng(lat, lon));

          if (idx === 0 && i < 3) {
            console.log(`[ZIP ${zip}] sample point`, { x, y, lat, lon });
          }
        });

        console.log(`[ZIP ${zip}] ring ${idx} path length`, path.length);

        if (path.length < 3) return;

        const poly = new kakao.maps.Polygon({
          map: state.map,
          path,
          strokeWeight: 4,
          strokeColor: color,
          strokeOpacity: 1,
          strokeStyle: 'solid',
          fillColor: color,
          fillOpacity: 0.45
        });
        polys.push(poly);
      });

      return polys;
    }

    // ì„ íƒëœ ìš°í¸ë²ˆí˜¸ë“¤ ZIP API í˜¸ì¶œí•´ì„œ ê·¸ë¦¬ê¸°
    async function drawSelected() {
      const targets = [...state.selectedZips].filter(z => !state.polygons.has(z));
      if (!targets.length) {
        // ì´ë¯¸ ê·¸ë ¤ì§„ ê²ƒë§Œ ìˆì„ ë•Œë„ í¬ì»¤ìŠ¤ ë‹¤ì‹œ ë§ì¶°ë‹¬ë¼ê³  í•  ìˆ˜ ìˆì–´ì„œ
        if (state.polygons.size) fitBoundsAll();
        return;
      }

      const notFound = [];

      for (const zip of targets) {
        try {
          const url = `${ZIP_API}${encodeURIComponent(zip)}`;
          const res = await fetch(url, { cache: 'no-store' });
          const data = await res.json();
          console.log('[ZIP] ë¡œë“œ ì™„ë£Œ', zip, data);

          if (!Array.isArray(data.polygon5179) || !data.polygon5179.length) {
            notFound.push(zip);
            continue;
          }

          const color = pickColor(zip);
          const polys = polygonsFrom5179(data.polygon5179, color, zip);
          if (!polys.length) {
            console.warn('[ZIP] í´ë¦¬ê³¤ ìƒì„± ì‹¤íŒ¨', zip);
            notFound.push(zip);
            continue;
          }

          state.polygons.set(zip, polys);
        } catch (e) {
          console.error('[ZIP] ë¡œë“œ ì‹¤íŒ¨', zip, e);
          notFound.push(zip);
        }
      }

      if (notFound.length) {
        alert(`í´ë¦¬ê³¤ì„ ê·¸ë¦¬ì§€ ëª»í•œ ìš°í¸ë²ˆí˜¸: ${notFound.join(', ')}`);
      }

      // ğŸ‘‰ ì—¬ê¸°ì„œ í•­ìƒ í¬ì»¤ìŠ¤ ìë™ ë§ì¶”ê¸°
      if (state.polygons.size) {
        fitBoundsAll();
      }
    }

    // path ì—ì„œ LatLng ì „ë¶€ ë½‘ê¸°
    function collectLatLngsFromPath(path) {
      const out = [];

      const walk = (p) => {
        if (!p) return;

        // LatLngPath
        if (typeof p.getLength === 'function' && typeof p.getAt === 'function') {
          for (let i = 0; i < p.getLength(); i++) {
            out.push(p.getAt(i));
          }
          return;
        }

        // ë°°ì—´ (LatLng[], ë˜ëŠ” ê·¸ ë°°ì—´ì˜ ë°°ì—´)
        if (Array.isArray(p)) {
          p.forEach(walk);
        }
      };

      walk(path);
      return out;
    }

    // ------- í™”ë©´ ì˜ì—­ ë§ì¶”ê¸° ------- //
    function fitBoundsAll() {
      if (!state.map) return;

      const b = new kakao.maps.LatLngBounds();
      let has = false;

      for (const arr of state.polygons.values()) {
        for (const poly of arr) {
          const latlngs = collectLatLngsFromPath(poly.getPath());
          latlngs.forEach(ll => {
            b.extend(ll);
            has = true;
          });
        }
      }

      if (has) state.map.setBounds(b);
    }

    // ------- DOM ë¡œë“œ ------- //
    document.addEventListener('DOMContentLoaded', () => {
      gateBind();
    });
  </script>
</body>
</html>
