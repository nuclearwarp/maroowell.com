<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>MarooWell Coupang Route Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      overflow: hidden;
    }

    .page {
      display: flex;
      height: 100%;
      width: 100%;
    }

    .side {
      width: 320px;
      max-width: 100%;
      padding: 16px;
      background: #020617;
      border-right: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .side-header-title {
      font-size: 1rem;
      font-weight: 700;
    }
    .side-header-sub {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    textarea {
      width: 100%;
      min-height: 130px;
      resize: vertical;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      padding: 8px 10px;
      font-size: 0.8rem;
    }
    textarea::placeholder {
      color: #4b5563;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 12px;
      font-size: 0.78rem;
      cursor: pointer;
      white-space: nowrap;
    }
    button.primary {
      background: #111827;
      border-color: #111827;
    }
    button:hover {
      background: #111827;
    }

    .hint {
      margin-top: 4px;
      font-size: 0.72rem;
      color: #6b7280;
      line-height: 1.4;
    }

    .map-wrapper {
      flex: 1;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
    }

    .map-overlay-info {
      position: absolute;
      top: 10px;
      left: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.85);
      border: 1px solid #1f2937;
      font-size: 0.75rem;
      pointer-events: none;
    }

    .selected-list {
      font-size: 0.78rem;
      color: #9ca3af;
    }

    @media (max-width: 768px) {
      .page {
        flex-direction: column;
      }
      .side {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #1f2937;
      }
    }
  </style>

  <!-- proj4: 5179 -> WGS84 변환용 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.1/proj4.js"></script>

  <!-- Kakao Maps JavaScript API (JS 키는 그대로) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=add4ce93b38c0ff9d9b9053728e067b3&autoload=false"></script>
</head>
<body>
  <div class="page">
    <aside class="side">
      <div>
        <div class="side-header-title">MarooWell 지도</div>
        <div class="side-header-sub">다중 우편번호 권역 표시 · 카카오맵 + 행안부 API</div>
      </div>

      <div class="btn-row">
        <!-- 나중에 주소검색 기능 붙일 자리 (지금은 버튼만 껍데기) -->
        <button id="addrSearchBtn">주소검색 추가(추후)</button>
      </div>

      <label style="font-size:0.78rem; margin-top:4px;">우편번호 목록</label>
      <textarea id="zipInput" placeholder="예: 07420, 07421 07422
쉼표 / 공백 / 줄바꿈 아무렇게나 섞어서 입력해도 됩니다."></textarea>

      <div class="btn-row">
        <button class="primary" id="showBtn">지도표시</button>
        <button id="fitBtn">영역맞춤</button>
        <button id="clearBtn">초기화</button>
      </div>

      <div class="hint">
        · 각 우편번호는 <code>https://zip.maroowell.com/?zipcode=XXXXX</code> 에서<br />
        &nbsp;&nbsp;폴리곤을 가져와서 카카오 지도에 그립니다.<br />
        · 여러 개를 동시에 입력하면 한 번에 모두 표시됩니다.
      </div>

      <div class="selected-list" id="selectedInfo"></div>
    </aside>

    <div class="map-wrapper">
      <div id="map"></div>
      <div class="map-overlay-info" id="overlayInfo">
        지도 준비 중...
      </div>
    </div>
  </div>

  <script>
    // ---------- proj4 설정 (EPSG:5179 -> WGS84) ----------
    proj4.defs("EPSG:5179",
      "+proj=tmerc +lat_0=38 +lon_0=127.5 +k=0.9996 " +
      "+x_0=1000000 +y_0=2000000 +ellps=GRS80 +units=m +no_defs"
    );

    function toWgs84From5179(x, y) {
      // 반환 [lng, lat]
      return proj4("EPSG:5179", "WGS84", [x, y]);
    }

    // ---------- 전역 상태 ----------
    let map;
    let polygons = [];          // 현재 지도에 그려진 polygon들
    let selectedZips = [];      // 현재 선택된 우편번호들
    const API_BASE = "https://zip.maroowell.com";  // Worker API 엔드포인트

    // ---------- 유틸 ----------
    function parseZipInput(text) {
      return Array.from(
        new Set(
          text
            .split(/[\s,]+/)
            .map(v => v.trim())
            .filter(v => v.length > 0)
        )
      );
    }

    function clearPolygons() {
      polygons.forEach(p => p.setMap(null));
      polygons = [];
    }

    function updateSelectedInfo() {
      const el = document.getElementById("selectedInfo");
      if (!selectedZips.length) {
        el.textContent = "표시 중인 우편번호 없음";
      } else {
        el.textContent = "표시 중인 우편번호: " + selectedZips.join(", ");
      }
    }

    function setOverlayMessage(msg) {
      document.getElementById("overlayInfo").textContent = msg;
    }

    function colorForZip(zip) {
      // 간단 컬러 해시 (우편번호별 다른 색)
      const colors = [
        "#22c55e","#3b82f6","#eab308","#f97316",
        "#ec4899","#a855f7","#2dd4bf","#f97316"
      ];
      let sum = 0;
      for (let i = 0; i < zip.length; i++) sum += zip.charCodeAt(i);
      return colors[sum % colors.length];
    }

    // ---------- Worker API → Kakao Polygon ----------
    function polygonsFromApiData(data, zip) {
      const result = [];
      const polys5179 = data.polygon5179 || [];

      // polygon5179 구조: [ [ [x,y], [x,y], ... ], [ ... ], ... ]
      polys5179.forEach(ring => {
        if (!Array.isArray(ring) || !ring.length) return;

        const path = ring.map(([x, y]) => {
          const [lng, lat] = toWgs84From5179(x, y);
          return new kakao.maps.LatLng(lat, lng);
        });

        const color = colorForZip(zip);

        const poly = new kakao.maps.Polygon({
          path: path,
          strokeWeight: 2,
          strokeColor: color,
          strokeOpacity: 0.9,
          strokeStyle: "solid",
          fillColor: color,
          fillOpacity: 0.3
        });

        result.push(poly);
      });

      return result;
    }

    async function loadPolygonsForZip(zip) {
      const url = `${API_BASE}/?zipcode=${encodeURIComponent(zip)}`;
      const resp = await fetch(url);
      if (!resp.ok) {
        throw new Error(`API 응답 오류(${resp.status}) : ${zip}`);
      }

      const data = await resp.json();

      if (!data.polygon5179 || !data.polygon5179.length) {
        throw new Error("polygon5179 없음: " + zip);
      }

      return {
        polygons: polygonsFromApiData(data, zip),
        center5179: data.center5179 || null
      };
    }

    // ---------- 지도 표시 로직 ----------
    async function showZipAreas() {
      const raw = document.getElementById("zipInput").value;
      const zips = parseZipInput(raw);

      if (!zips.length) {
        alert("우편번호를 하나 이상 입력해주세요.");
        return;
      }

      clearPolygons();
      selectedZips = zips;
      updateSelectedInfo();
      setOverlayMessage("행안부 API 호출 중...");

      const bounds = new kakao.maps.LatLngBounds();
      let hasAny = false;
      const missing = [];

      for (const zip of zips) {
        try {
          const { polygons: polys, center5179 } = await loadPolygonsForZip(zip);

          if (!polys.length) {
            missing.push(zip);
            continue;
          }

          polys.forEach(poly => {
            poly.setMap(map);
            polygons.push(poly);

            const path = poly.getPath();
            for (let i = 0; i < path.length; i++) {
              bounds.extend(path.getAt(i));
            }
          });

          // center5179 있으면 한 번만 중심으로 써도 됨 (있어도 bounds가 더 중요)
          if (center5179 && !hasAny) {
            const [cx, cy] = center5179;
            const [lng, lat] = toWgs84From5179(cx, cy);
            map.setCenter(new kakao.maps.LatLng(lat, lng));
          }

          hasAny = true;
        } catch (e) {
          console.error(e);
          missing.push(zip);
        }
      }

      if (hasAny) {
        map.setBounds(bounds);
        setOverlayMessage("표시 중인 우편번호: " + selectedZips.join(", "));
      } else {
        setOverlayMessage("표시할 영역이 없습니다.");
      }

      if (missing.length) {
        alert("다음 우편번호는 폴리곤을 가져오지 못했습니다:\n" + missing.join(", "));
      }
    }

    function fitBoundsToPolygons() {
      if (!polygons.length) {
        alert("지도에 표시 중인 영역이 없습니다.");
        return;
      }
      const bounds = new kakao.maps.LatLngBounds();
      polygons.forEach(poly => {
        const path = poly.getPath();
        for (let i = 0; i < path.length; i++) {
          bounds.extend(path.getAt(i));
        }
      });
      map.setBounds(bounds);
    }

    function clearAll() {
      clearPolygons();
      selectedZips = [];
      document.getElementById("zipInput").value = "";
      updateSelectedInfo();
      setOverlayMessage("지도 초기화됨");
    }

    // ---------- 초기화 ----------
    kakao.maps.load(function () {
      const container = document.getElementById("map");
      const center = new kakao.maps.LatLng(37.5665, 126.9780); // 서울시청 근처
      map = new kakao.maps.Map(container, {
        center: center,
        level: 7
      });

      setOverlayMessage("지도 준비 완료. 우편번호를 입력하고 [지도표시]를 눌러주세요.");
      updateSelectedInfo();

      document.getElementById("showBtn").addEventListener("click", showZipAreas);
      document.getElementById("fitBtn").addEventListener("click", fitBoundsToPolygons);
      document.getElementById("clearBtn").addEventListener("click", clearAll);

      // 주소검색 버튼은 아직 미구현
      document.getElementById("addrSearchBtn").addEventListener("click", function () {
        alert("주소검색 기능은 추후 구현 예정입니다.");
      });
    });
  </script>
</body>
</html>
