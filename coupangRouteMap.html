<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë§ˆë£¨ì›° ë¼ìš°íŠ¸ í¸ì§‘ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#020617;
      color:#e5e7eb;
    }
    body { display:flex; }

    .side {
      width: 400px;
      min-width: 320px;
      max-width: 520px;
      background:#020617;
      border-right:1px solid #1f2937;
      padding:14px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .title { font-size:1rem; font-weight:700; }
    .subtitle { font-size:0.75rem; color:#9ca3af; }

    label { font-size:0.78rem; margin-bottom:2px; display:block; }
    input[type="text"] {
      width:100%; padding:7px 10px; border-radius:8px;
      border:1px solid #374151; background:#020617; color:#e5e7eb;
      font-size:0.8rem;
    }

    .btn-row { display:flex; flex-wrap:wrap; gap:8px; margin-top:4px; }
    button {
      border-radius:999px; border:1px solid #374151;
      background:#020617; color:#e5e7eb;
      padding:6px 12px; font-size:0.78rem;
      cursor:pointer; white-space:nowrap;
    }
    button.primary { background:#111827; border-color:#111827; }
    button.danger  { border-color:#b91c1c; color:#fecaca; }
    button:hover { background:#111827; }

    .hint { font-size:0.7rem; color:#6b7280; line-height:1.4; }
    .status-bar {
      font-size:0.7rem; padding:4px 8px; border-radius:999px;
      background:#022c22; color:#6ee7b7;
      display:inline-block; margin-top:4px;
    }
    .status-error { background:#450a0a; color:#fecaca; }

    .log-box {
      margin-top:6px;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #1f2937;
      background:#020617;
      font-size:0.7rem;
      height:170px;
      overflow:auto;
      white-space:pre-wrap;
    }
    .log-line-time { color:#6b7280; }
    .log-line-info { color:#e5e7eb; }
    .log-line-warn { color:#fbbf24; }
    .log-line-err  { color:#f87171; }

    .map-wrap { flex:1; position:relative; }
    #map { width:100%; height:100%; }

    .overlay-badge {
      position:absolute; top:10px; left:10px;
      background:rgba(15,23,42,0.9); border:1px solid #1f2937;
      border-radius:999px; padding:4px 10px;
      font-size:0.72rem; pointer-events:none;
    }

    .route-label {
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      color: #0b1220;
      background: rgba(255,255,255,0.92);
      border: 2px solid rgba(15,23,42,0.35);
      box-shadow: 0 2px 10px rgba(0,0,0,0.22);
      user-select: none;
      pointer-events: none;
      transform: translateY(-2px);
    }

    .section {
      border: 1px solid #1f2937;
      border-radius: 10px;
      padding: 10px;
      background: rgba(2,6,23,0.6);
    }

    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .row input { flex: 1 1 auto; min-width: 140px; }

    @media (max-width:900px) {
      body { flex-direction:column; }
      .side {
        width:100%; max-width:none;
        border-right:none; border-bottom:1px solid #1f2937;
      }
      .map-wrap { height:calc(100% - 340px); }
    }
  </style>

  <!-- turf.js -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- Kakao Maps + drawing + services -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=add4ce93b38c0ff9d9b9053728e067b3&libraries=drawing,services&autoload=false"></script>

  <!-- Daum Postcode -->
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body>
  <aside class="side">
    <div>
      <div class="title">ë§ˆë£¨ì›° ë¼ìš°íŠ¸ í¸ì§‘ê¸°</div>
      <div class="subtitle">ìº í”„ + ë¼ìš°íŠ¸ ì½”ë“œ ê¸°ë°˜ Â· Supabase / Cloudflare route API ì‚¬ìš©</div>
    </div>

    <div>
      <label for="campInput">ìº í”„ ì´ë¦„ (ì˜ˆ: ëŒ€êµ¬3)</label>
      <input id="campInput" type="text" placeholder="ì˜ˆ: ëŒ€êµ¬3" />
    </div>

    <div>
      <label for="routeInput">ë¼ìš°íŠ¸ ì½”ë“œ (ì˜ˆ: 213, 213C, 213C01) â€” ë¹„ìš°ë©´ camp ì „ì²´ í‘œì‹œ</label>
      <input id="routeInput" type="text" placeholder="ì˜ˆ: 213 ë˜ëŠ” 213C" />
    </div>

    <div class="btn-row">
      <button id="loadBtn" class="primary">ë¶ˆëŸ¬ì˜¤ê¸°(GET)</button>
      <button id="drawBtn">ìƒˆë¡œ ê·¸ë¦¬ê¸°</button>
      <button id="addBtn">êµ¬ì—­ ì¶”ê°€</button>
      <button id="searchAddressBtn">ğŸ“ ì£¼ì†Œê²€ìƒ‰</button>
      <button id="saveBtn" class="primary">ì €ì¥(POST)</button>
      <button id="alignBtn">ì§€ë„ ì •ë ¬</button>
      <button id="labelBtn">ë¼ìš°íŠ¸ ë¼ë²¨ ON</button>
      <button id="resetBtn" class="danger">ì§€ë„ ì´ˆê¸°í™”</button>
    </div>

    <div class="hint">
      â€¢ <b>ìº í”„ë§Œ GET:</b> í•´ë‹¹ ìº í”„ ì „ì²´ ë…¸ì„  í‘œì‹œ<br/>
      â€¢ <b>í¸ì§‘:</b> í´ë¦¬ê³¤ í´ë¦­ â†’ í¸ì§‘ ëŒ€ìƒ(ë…¹ìƒ‰) ì „í™˜ â†’ ì  ë“œë˜ê·¸<br/>
      â€¢ <b>êµ¬ì—­ ì¶”ê°€:</b> ê°™ì€ ì½”ë“œì— í´ë¦¬ê³¤ ì—¬ëŸ¬ ê°œ ì¶”ê°€(ë–¨ì–´ì§„ êµ¬ì—­ ì§€ì›)<br/>
      â€¢ <b>ì§€ë„ ì •ë ¬:</b> (í¸ì§‘ ëŒ€ìƒ ìˆìœ¼ë©´ ê·¸ ë…¸ì„ ë§Œ) ì—†ìœ¼ë©´ í˜„ì¬ í‘œì‹œëœ ë…¸ì„ (ë˜ëŠ” prefix ê·¸ë£¹) ì „ì²´ ì •ë ¬ ì €ì¥<br/>
      â€¢ <b>ì •ë ¬ ê¸°ì¤€:</b> OSM ë„ë¡œ ì¤‘ì‹¬ì„  ìŠ¤ëƒ… + ê±´ë¬¼ 50% ì´ìƒ í¬í•¨ ì‹œ ìë™ í¬í•¨
    </div>

    <div class="section">
      <div style="font-size:0.78rem;color:#9aa6b2;margin-bottom:6px;">DB ìˆ˜ì •</div>

      <div class="row" style="margin-bottom:6px;">
        <input id="campEditInput" type="text" placeholder="ìº í”„ ë³€ê²½: ì˜ˆ) ëŒ€êµ¬3" />
        <button id="campUpdateSelectedBtn">ì„ íƒ camp ìˆ˜ì •</button>
        <button id="campRenameAllBtn">camp ì „ì²´ ì´ê´€(ë³‘í•©)</button>
      </div>

      <div class="row">
        <input id="routeEditInput" type="text" placeholder="ì½”ë“œ ë³€ê²½: ì˜ˆ) 213D â†’ 213C" />
        <button id="routeRenameBtn">ì„ íƒ ì½”ë“œ ìˆ˜ì •</button>
        <button id="routeDeleteRowBtn" class="danger">ì„ íƒ DB ì‚­ì œ</button>
      </div>

      <div class="hint" style="margin-top:6px;">
        â€¢ â€œì„ íƒâ€ ì‘ì—…ì€ ì§€ë„ì—ì„œ í•´ë‹¹ ë…¸ì„ ì„ í´ë¦­í•´ í¸ì§‘ ëŒ€ìƒìœ¼ë¡œ ë§Œë“  ìƒíƒœì—ì„œ ë™ì‘í•©ë‹ˆë‹¤.<br/>
        â€¢ camp ì „ì²´ ì´ê´€ì€ from=campInput â†’ to=campEditInput, ì¶©ëŒ(ë™ì¼ full_code) ì‹œ ìë™ ë³‘í•© í›„ source ì‚­ì œí•©ë‹ˆë‹¤.
      </div>
    </div>

    <div id="apiStatus" class="status-bar">API: ready</div>
    <div id="logBox" class="log-box"></div>
  </aside>

  <div class="map-wrap">
    <div id="map"></div>
    <div class="overlay-badge" id="overlayInfo">ì§€ë„ ì´ˆê¸°í™” ì¤‘...</div>
  </div>

  <script>
    // ================== ì„¤ì • ==================
    const ROUTE_API_BASE = "https://route.maroowell.com";

    const ALIGN = {
      OSM_MARGIN_DEG: 0.0020,
      MAX_ROADS: 1200,
      MAX_BUILDINGS: 2000,
      ROAD_SNAP_METERS: 16,
      DENSIFY_STEP_METERS: 14,
      SIMPLIFY_TOLERANCE_DEG: 0.000008,
      BUILDING_RATIO: 0.50,
      MAX_DENSIFIED_POINTS: 2600
    };

    // ================== DOM ==================
    const logBox      = document.getElementById("logBox");
    const apiStatus   = document.getElementById("apiStatus");
    const overlayInfo = document.getElementById("overlayInfo");

    const campInput   = document.getElementById("campInput");
    const routeInput  = document.getElementById("routeInput");

    const loadBtn     = document.getElementById("loadBtn");
    const drawBtn     = document.getElementById("drawBtn");
    const addBtn      = document.getElementById("addBtn");
    const searchAddressBtn = document.getElementById("searchAddressBtn");
    const saveBtn     = document.getElementById("saveBtn");
    const alignBtn    = document.getElementById("alignBtn");
    const labelBtn    = document.getElementById("labelBtn");
    const resetBtn    = document.getElementById("resetBtn");

    const campEditInput = document.getElementById("campEditInput");
    const routeEditInput = document.getElementById("routeEditInput");
    const campUpdateSelectedBtn = document.getElementById("campUpdateSelectedBtn");
    const campRenameAllBtn      = document.getElementById("campRenameAllBtn");
    const routeRenameBtn        = document.getElementById("routeRenameBtn");
    const routeDeleteRowBtn     = document.getElementById("routeDeleteRowBtn");

    // ================== ë¡œê¹… ==================
    function log(message, level = "info") {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      const ss = String(now.getSeconds()).padStart(2,"0");

      const line = document.createElement("div");

      const spanTime = document.createElement("span");
      spanTime.textContent = `[${hh}:${mm}:${ss}] `;
      spanTime.className = "log-line-time";
      line.appendChild(spanTime);

      const spanMsg = document.createElement("span");
      spanMsg.textContent = message;
      spanMsg.className = "log-line-" + level;
      line.appendChild(spanMsg);

      logBox.appendChild(line);
      logBox.scrollTop = logBox.scrollHeight;
    }

    function setApiStatus(msg, isError = false) {
      apiStatus.textContent = "API: " + msg;
      apiStatus.className = "status-bar" + (isError ? " status-error" : "");
    }

    function setOverlayText(msg) {
      overlayInfo.textContent = msg;
    }

    window.addEventListener("error", (e) => {
      log(`[ERR] window.error: ${e.message} @ ${e.filename}:${e.lineno}:${e.colno}`, "err");
    });
    window.addEventListener("unhandledrejection", (e) => {
      log(`[ERR] unhandledrejection: ${String(e.reason)}`, "err");
    });

    const round6 = (x) => Math.round(x * 1e6) / 1e6;

    // ================== ì§€ë„ ìƒíƒœ ==================
    let map;
    let drawingManager;

    let staticItems = [];  // [{key,row,ringsLatLng,polygons,labels}]
    let labelsOn = true;

    let editTargetKey = null;
    let editTargetRow = null;

    // route ìƒ‰ìƒ ë§µ(ì¸ì ‘ ë¼ìš°íŠ¸ë¼ë¦¬ ìµœëŒ€í•œ ë‹¤ë¥´ê²Œ)
    let routeColorMap = Object.create(null);

    // ================== polylabel(ë¼ë²¨ ìœ„ì¹˜) ==================
    class MaxHeap { constructor(){this.data=[]} push(i){this.data.push(i);this._up(this.data.length-1)} pop(){if(!this.data.length)return null;const t=this.data[0];const e=this.data.pop();if(this.data.length){this.data[0]=e;this._down(0)}return t} get size(){return this.data.length} _up(n){const e=this.data[n];while(n>0){const p=Math.floor((n-1)/2);const pn=this.data[p];if(e.max<=pn.max)break;this.data[p]=e;this.data[n]=pn;n=p}} _down(n){const l=this.data.length;const e=this.data[n];for(;;){let ln=2*n+1;let rn=2*n+2;let s=null;if(ln<l){const le=this.data[ln];if(le.max>e.max)s=ln}if(rn<l){const re=this.data[rn];if((s===null&&re.max>e.max)||(s!==null&&re.max>this.data[s].max))s=rn}if(s===null)break;this.data[n]=this.data[s];this.data[s]=e;n=s}} }
    function getSegDistSq(px,py,a,b){let x=a[0],y=a[1];let dx=b[0]-x,dy=b[1]-y;if(dx!==0||dy!==0){const t=((px-x)*dx+(py-y)*dy)/(dx*dx+dy*dy);if(t>1){x=b[0];y=b[1]}else if(t>0){x+=dx*t;y+=dy*t}}dx=px-x;dy=py-y;return dx*dx+dy*dy}
    function pointToPolygonDist(x,y,poly){let inside=false;let min=Infinity;for(let i=0,j=poly.length-1;i<poly.length;j=i++){const a=poly[i],b=poly[j];if((a[1]>y)!==(b[1]>y)&&x<(b[0]-a[0])*(y-a[1])/(b[1]-a[1]+0.0)+a[0])inside=!inside;min=Math.min(min,getSegDistSq(x,y,a,b))}const d=Math.sqrt(min);return inside?d:-d}
    function polygonCentroid(ring){let x=0,y=0,area=0;for(let i=0,j=ring.length-1;i<ring.length;j=i++){const a=ring[i],b=ring[j];const f=a[0]*b[1]-b[0]*a[1];x+=(a[0]+b[0])*f;y+=(a[1]+b[1])*f;area+=f}area*=0.5;if(area===0)return null;x/=(6*area);y/=(6*area);return [x,y]}
    class Cell{constructor(x,y,h,poly){this.x=x;this.y=y;this.h=h;this.d=pointToPolygonDist(x,y,poly);this.max=this.d+this.h*Math.SQRT2}}
    function polylabel(ring,precision=1e-5){if(!Array.isArray(ring)||ring.length<3)return null;let pts=ring.slice();const f=pts[0],l=pts[pts.length-1];if(f[0]!==l[0]||f[1]!==l[1])pts.push(f);let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;for(const p of pts){minX=Math.min(minX,p[0]);minY=Math.min(minY,p[1]);maxX=Math.max(maxX,p[0]);maxY=Math.max(maxY,p[1])}const w=maxX-minX,h=maxY-minY;if(w===0&&h===0)return [minX,minY];const cellSize=Math.min(w,h);let hh=cellSize/2;const heap=new MaxHeap();for(let x=minX;x<maxX;x+=cellSize)for(let y=minY;y<maxY;y+=cellSize)heap.push(new Cell(x+hh,y+hh,hh,pts));let best=null;const c=polygonCentroid(pts);if(c)best=new Cell(c[0],c[1],0,pts);const bboxCell=new Cell(minX+w/2,minY+h/2,0,pts);if(!best||bboxCell.d>best.d)best=bboxCell;let iter=0;const maxIter=30000;while(heap.size&&iter++<maxIter){const cell=heap.pop();if(!cell)break;if(cell.d>best.d)best=cell;if(cell.max-best.d<=precision)continue;hh=cell.h/2;heap.push(new Cell(cell.x-hh,cell.y-hh,hh,pts));heap.push(new Cell(cell.x+hh,cell.y-hh,hh,pts));heap.push(new Cell(cell.x-hh,cell.y+hh,hh,pts));heap.push(new Cell(cell.x+hh,cell.y+hh,hh,pts))}return [best.x,best.y]}

    // ================== ìƒ‰ìƒ(ì¸ì ‘ ë¼ìš°íŠ¸ êµ¬ë¶„ ê°•í™”) ==================
    const COLOR_PALETTE = [
      "hsl(0, 92%, 52%)",
      "hsl(24, 92%, 52%)",
      "hsl(48, 92%, 50%)",
      "hsl(75, 82%, 45%)",
      "hsl(120, 82%, 42%)",
      "hsl(155, 82%, 42%)",
      "hsl(185, 92%, 44%)",
      "hsl(205, 92%, 50%)",
      "hsl(225, 92%, 54%)",
      "hsl(250, 82%, 58%)",
      "hsl(275, 82%, 58%)",
      "hsl(305, 92%, 56%)",
      "hsl(330, 92%, 54%)",
      "hsl(350, 92%, 52%)",
    ];

    function bboxOfItemRings(ringsLatLng){
      let minLat=  90, maxLat= -90, minLng=  180, maxLng= -180;
      for (const ring of ringsLatLng){
        for (const ll of ring){
          const lat = ll.getLat(), lng = ll.getLng();
          minLat = Math.min(minLat, lat);
          maxLat = Math.max(maxLat, lat);
          minLng = Math.min(minLng, lng);
          maxLng = Math.max(maxLng, lng);
        }
      }
      return {minLat,maxLat,minLng,maxLng};
    }

    function bboxOverlap(a,b,expandDeg=0.00045){
      return !(
        (a.maxLng + expandDeg) < (b.minLng - expandDeg) ||
        (a.minLng - expandDeg) > (b.maxLng + expandDeg) ||
        (a.maxLat + expandDeg) < (b.minLat - expandDeg) ||
        (a.minLat - expandDeg) > (b.maxLat + expandDeg)
      );
    }

    function computeColorMap(items){
      // ì¸ì ‘ì„±: bbox ê·¼ì ‘(í™•ì¥) ê²¹ì¹˜ë©´ ì´ì›ƒìœ¼ë¡œ ê°„ì£¼ (ê°€ë³ê³  ì¶©ë¶„íˆ ì‹¤ìš©ì )
      const bboxes = new Map();
      for (const it of items) bboxes.set(it.key, bboxOfItemRings(it.ringsLatLng));

      const neighbors = new Map();
      for (const it of items) neighbors.set(it.key, new Set());

      for (let i=0;i<items.length;i++){
        for (let j=i+1;j<items.length;j++){
          const a = items[i].key, b = items[j].key;
          if (bboxOverlap(bboxes.get(a), bboxes.get(b))) {
            neighbors.get(a).add(b);
            neighbors.get(b).add(a);
          }
        }
      }

      const order = [...items.map(x=>x.key)]
        .sort((a,b) => (neighbors.get(b).size - neighbors.get(a).size) || a.localeCompare(b));

      const map = Object.create(null);

      for (const key of order){
        const used = new Set();
        for (const nb of neighbors.get(key)) {
          if (map[nb]) used.add(map[nb]);
        }
        let chosen = null;
        for (const c of COLOR_PALETTE){
          if (!used.has(c)) { chosen = c; break; }
        }
        if (!chosen) {
          // ë‹¤ ë§‰íˆë©´ ê·¸ëƒ¥ ìˆœí™˜
          chosen = COLOR_PALETTE[Math.abs(key.length * 17 + key.charCodeAt(0)) % COLOR_PALETTE.length];
        }
        map[key] = chosen;
      }

      return map;
    }

    function colorCss(key){
      return routeColorMap[key] || "hsl(120, 80%, 45%)";
    }

    // ================== ì§€ë„ ì´ˆê¸°í™” ==================
    function initMap() {
      map = new kakao.maps.Map(document.getElementById("map"), {
        center: new kakao.maps.LatLng(35.8714, 128.6014),
        level: 6
      });

      drawingManager = new kakao.maps.drawing.DrawingManager({
        map,
        drawingMode: [kakao.maps.drawing.OverlayType.POLYGON],
        guideTooltip: ["draw", "drag", "edit"],
        polygonOptions: {
          draggable: true,
          removable: true,
          editable: true,
          strokeWeight: 4,
          strokeColor: "#22c55e",
          strokeOpacity: 0.98,
