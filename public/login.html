<!doctype html>
<html lang="ko">
<head>
    <script src="/config.js"></script>
<meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Maroowell Login</title>
  <link rel="icon" href="/favicon.ico" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect width='64' height='64' rx='14' fill='#0b1220'/><path d='M14 44V18h8l10 14 10-14h8v26h-8V31L32 44 22 31v13h-8z' fill='#22d3ee'/></svg>" />
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2d; --txt:#e6eefc; --muted:#93a4c7;
      --line:rgba(255,255,255,.10); --btn:#162744; --btn2:#1a2f55;
      --ok:#1a5a3a; --danger:#6b1b1b; --cyan:#00C2FF;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif; background:var(--bg); color:var(--txt);}
    .wrap{min-height:100%; display:flex; align-items:center; justify-content:center; padding:24px;}
    .card{
      width:100%; max-width:520px;
      background:linear-gradient(180deg,#0f1a2d,#091225);
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
      box-shadow:0 12px 40px rgba(0,0,0,.35);
    }
    .head{padding:10px 10px 14px}
    .title{font-size:22px; font-weight:900;}
    .sub{margin-top:6px; font-size:13px; color:var(--muted); line-height:1.45;}
    .tabs{display:flex; gap:8px; padding:10px;}
    .tab{
      flex:1; padding:10px 12px; border-radius:999px; border:1px solid var(--line);
      background:rgba(0,0,0,.18); color:var(--txt); font-weight:900; cursor:pointer;
    }
    .tab.active{border-color:rgba(0,194,255,.45); background:rgba(0,194,255,.10)}
    .panel{padding:10px;}
    .group{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
    }
    .label{font-size:12px; color:var(--muted); margin:6px 0;}
    input{
      width:100%; padding:12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20); color:var(--txt); outline:none;
    }
    input:focus{border-color:rgba(0,194,255,.45)}
    .row{display:flex; gap:10px; margin-top:10px; align-items:center;}
    .btn{
      flex:1; padding:12px 14px; border-radius:12px; border:1px solid var(--line);
      background:var(--btn); color:var(--txt); font-weight:900; cursor:pointer;
    }
    .btn:hover{background:var(--btn2)}
    .btn.cyan{background:linear-gradient(135deg,var(--cyan),#0088cc); border-color:rgba(0,194,255,.55); color:#fff;}
    .btn.cyan:hover{filter:brightness(1.06)}
    .btn.ok{background:rgba(26,90,58,.35); border-color:rgba(0,255,140,.18)}
    .btn.ok:hover{background:rgba(26,90,58,.55)}
    .status{
      margin-top:10px; font-size:12px; padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background:rgba(0,0,0,.18); white-space:pre-wrap; line-height:1.5;
    }
    a{color:var(--cyan); text-decoration:none}
    a:hover{text-decoration:underline}
    code{color:var(--cyan)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="head">
      <div class="title">Maroowell Login</div>
      <div class="sub">
        초대 기반 운영(Invite Only) 권장: Supabase에서 Public Sign-ups OFF로 두는 게 맞습니다.<br/>
        로그인 성공 시 <code>index.html</code>로 이동합니다.
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabLogin">로그인</button>
      <button class="tab" id="tabAccount">비밀번호 설정</button>
      <button class="tab" id="tabHelp">안내</button>
    </div>

    <div class="panel" id="panelLogin">
      <div class="group">
        <div class="label">이메일</div>
        <input id="email" type="email" placeholder="name@company.com" autocomplete="email" />
        <div class="label" style="margin-top:10px;">비밀번호</div>
        <input id="password" type="password" placeholder="********" autocomplete="current-password" />
        <div class="signupOnly" style="display:none;">
          <div class="label" style="margin-top:10px;">비밀번호 확인</div>
          <input id="password2" type="password" placeholder="********" autocomplete="new-password" />
        </div>
        <div class="row">
          <button class="btn cyan" id="btnSignIn">로그인</button>
          <button class="btn" id="btnSignUp">회원가입</button>
          <button class="btn" id="btnMagic">이메일 링크 로그인</button>
        </div>
        <div class="sub" id="signupHint" style="margin:10px 0 0; display:none;">회원가입 모드: 비밀번호 확인을 입력하세요.</div>
        <div class="status" id="statusLogin">READY</div>
      </div>

      <div class="group">
        <div class="sub" style="margin:0;">
          이미 로그인된 상태면 자동으로 이동합니다.<br/>
          공유 페이지는 <code>/share.html</code>만 공개로 유지하세요.
        </div>
        <div class="status" id="statusSession">세션 확인 중...</div>
        <div class="row">
          <button class="btn ok" id="btnGoIndex">index.html로 이동</button>
          <button class="btn" id="btnLogout">로그아웃</button>
        </div>
      </div>
    </div>

    <div class="panel" id="panelAccount" style="display:none;">
      <div class="group">
        <div class="sub" style="margin:0 0 10px;">
          초대메일로 가입한 경우 여기서 비밀번호를 설정할 수 있습니다(로그인 상태 필요).
        </div>
        <div class="label">새 비밀번호</div>
        <input id="newPassword" type="password" placeholder="********" autocomplete="new-password" />
        <div class="label" style="margin-top:10px;">새 비밀번호 확인</div>
        <input id="newPassword2" type="password" placeholder="********" autocomplete="new-password" />
        <div class="row">
          <button class="btn ok" id="btnUpdatePassword">비밀번호 설정/변경</button>
        </div>
        <div class="status" id="statusAccount">READY</div>
      </div>
    </div>

    <div class="panel" id="panelHelp" style="display:none;">
      <div class="group">
        <div class="sub" style="margin:0;">
          <b>권장 구조</b><br/>
          - <code>login.html</code>: 로그인 게이트(첫 화면)<br/>
          - <code>index.html</code>: 앱(로그인 필수)<br/>
          - <code>share.html</code>: 공개<br/><br/>
          <b>Supabase Auth 설정</b><br/>
          - Public sign-ups OFF<br/>
          - Redirect URL: <code>https://maroowell.com/login.html</code> 등록
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // =========================
  // ✅ Maroowell Login (Supabase Auth)
  // - config.js(window.MARUWELL_CONFIG)에서 URL/KEY/PATHS를 읽음
  // - 회원가입 버튼은 나중에 ENABLE_SIGNUP=false 로 숨길 수 있음
  // =========================
  const ENABLE_SIGNUP = true; // 나중에 false로 바꾸면 회원가입 버튼/필드 숨김

  const cfg = window.MARUWELL_CONFIG || {};
  const SUPABASE_URL = cfg.SUPABASE_URL;
  const SUPABASE_ANON_KEY = cfg.SUPABASE_ANON_KEY;
  const PATHS = cfg.PATHS || {};
  const INDEX_PATH = PATHS.index || "/index.html";
  const LOGIN_PATH = PATHS.login || "/login.html";

  const qs = new URLSearchParams(location.search);
  const NEXT = qs.get("next") || INDEX_PATH;

  const $ = (id) => document.getElementById(id);

  const tabLogin = $("tabLogin");
  const tabAccount = $("tabAccount");
  const tabHelp = $("tabHelp");
  const panelLogin = $("panelLogin");
  const panelAccount = $("panelAccount");
  const panelHelp = $("panelHelp");

  const email = $("email");
  const password = $("password");
  const password2 = $("password2");
  const signupOnlyWrap = document.querySelector(".signupOnly");
  const signupHint = $("signupHint");

  const btnSignIn = $("btnSignIn");
  const btnSignUp = $("btnSignUp");
  const btnMagic = $("btnMagic");
  const statusLogin = $("statusLogin");

  const newPassword = $("newPassword");
  const newPassword2 = $("newPassword2");
  const btnUpdatePassword = $("btnUpdatePassword");
  const statusAccount = $("statusAccount");

  const statusSession = $("statusSession");
  const btnGoIndex = $("btnGoIndex");
  const btnLogout = $("btnLogout");

  function setActiveTab(which) {
    tabLogin.classList.toggle("active", which === "login");
    tabAccount.classList.toggle("active", which === "account");
    tabHelp.classList.toggle("active", which === "help");
    panelLogin.style.display = (which === "login") ? "" : "none";
    panelAccount.style.display = (which === "account") ? "" : "none";
    panelHelp.style.display = (which === "help") ? "" : "none";
  }

  function setStatus(el, msg) {
    if (!el) return;
    el.textContent = msg;
  }

  function safeNextPath(p) {
    if (!p) return INDEX_PATH;
    if (p.startsWith("http://") || p.startsWith("https://")) return INDEX_PATH;
    if (!p.startsWith("/")) return INDEX_PATH;
    return p;
  }

  // config missing
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY || !window.supabase || !window.supabase.createClient) {
    setStatus(statusLogin, "설정 오류: config.js 또는 Supabase SDK 로딩 실패");
    setStatus(statusSession, "세션 확인 불가 (설정 오류)");
    btnSignIn.disabled = true;
    btnMagic.disabled = true;
    if (btnSignUp) btnSignUp.disabled = true;
    btnGoIndex.disabled = true;
    btnLogout.disabled = true;
    return;
  }

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Signup toggle
  if (!ENABLE_SIGNUP) {
    if (btnSignUp) btnSignUp.style.display = "none";
    if (signupOnlyWrap) signupOnlyWrap.style.display = "none";
    if (signupHint) signupHint.style.display = "none";
  }

  async function refreshSession() {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        setStatus(statusSession, `세션 있음: ${session.user?.email || ""}`);
        btnGoIndex.disabled = false;
        btnLogout.disabled = false;
      } else {
        setStatus(statusSession, "세션 없음 (미로그인)");
        btnGoIndex.disabled = true;
        btnLogout.disabled = true;
      }
    } catch (e) {
      setStatus(statusSession, "세션 확인 실패");
      btnGoIndex.disabled = true;
      btnLogout.disabled = true;
    }
  }

  async function goNext() {
    const next = safeNextPath(NEXT);
    location.replace(next);
  }

  btnSignIn.onclick = async () => {
    setStatus(statusLogin, "로그인 중...");
    try {
      const em = (email.value || "").trim();
      const pw = (password.value || "").trim();
      if (!em || !pw) return setStatus(statusLogin, "이메일/비밀번호를 입력하세요.");

      const { data, error } = await supabase.auth.signInWithPassword({ email: em, password: pw });
      if (error) return setStatus(statusLogin, "로그인 실패: " + error.message);

      setStatus(statusLogin, "로그인 성공");
      await refreshSession();
      await goNext();
    } catch (e) {
      setStatus(statusLogin, "로그인 실패");
    }
  };

  if (btnSignUp) {
    btnSignUp.onclick = async () => {
      if (!ENABLE_SIGNUP) {
        setStatus(statusLogin, "회원가입 비활성화 상태입니다.");
        return;
      }
      // show confirm UI
      if (signupOnlyWrap) signupOnlyWrap.style.display = "";
      if (signupHint) signupHint.style.display = "";

      setStatus(statusLogin, "회원가입 중...");
      try {
        const em = (email.value || "").trim();
        const pw = (password.value || "").trim();
        const pw2 = (password2?.value || "").trim();
        if (!em || !pw || !pw2) return setStatus(statusLogin, "이메일/비밀번호/비밀번호확인을 입력하세요.");
        if (pw !== pw2) return setStatus(statusLogin, "비밀번호가 서로 다릅니다.");

        const { data, error } = await supabase.auth.signUp({
          email: em,
          password: pw,
          options: {
            emailRedirectTo: location.origin + LOGIN_PATH
          }
        });

        if (error) return setStatus(statusLogin, "회원가입 실패: " + error.message);

        // 이메일 인증 OFF면 session이 바로 생김
        if (data?.session) {
          setStatus(statusLogin, "회원가입 완료(로그인됨) → 이동");
          await refreshSession();
          await goNext();
        } else {
          setStatus(statusLogin, "회원가입 완료. 이메일 인증이 필요할 수 있습니다.");
          await refreshSession();
        }
      } catch (e) {
        setStatus(statusLogin, "회원가입 실패");
      }
    };
  }

  btnMagic.onclick = async () => {
    setStatus(statusLogin, "이메일 링크 발송 중...");
    try {
      const em = (email.value || "").trim();
      if (!em) return setStatus(statusLogin, "이메일을 입력하세요.");

      const { error } = await supabase.auth.signInWithOtp({
        email: em,
        options: { emailRedirectTo: location.origin + LOGIN_PATH }
      });

      if (error) return setStatus(statusLogin, "발송 실패: " + error.message);
      setStatus(statusLogin, "발송 완료. 메일함 확인 후 링크로 접속하세요.");
    } catch (e) {
      setStatus(statusLogin, "발송 실패");
    }
  };

  btnUpdatePassword.onclick = async () => {
    setStatus(statusAccount, "처리 중...");
    try {
      const p1 = (newPassword.value || "").trim();
      const p2 = (newPassword2.value || "").trim();
      if (!p1 || !p2) return setStatus(statusAccount, "새 비밀번호/확인을 입력하세요.");
      if (p1 !== p2) return setStatus(statusAccount, "비밀번호가 서로 다릅니다.");

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return setStatus(statusAccount, "로그인 상태가 필요합니다.");

      const { error } = await supabase.auth.updateUser({ password: p1 });
      if (error) return setStatus(statusAccount, "실패: " + error.message);

      setStatus(statusAccount, "비밀번호 설정/변경 완료");
    } catch (e) {
      setStatus(statusAccount, "실패");
    }
  };

  btnGoIndex.onclick = () => { location.href = INDEX_PATH; };

  btnLogout.onclick = async () => {
    try {
      await supabase.auth.signOut();
      setStatus(statusLogin, "로그아웃 완료");
      await refreshSession();
    } catch (e) {
      setStatus(statusLogin, "로그아웃 실패");
    }
  };

  tabLogin.onclick = () => setActiveTab("login");
  tabAccount.onclick = () => setActiveTab("account");
  tabHelp.onclick = () => setActiveTab("help");

  setActiveTab("login");
  refreshSession();
  supabase.auth.onAuthStateChange(() => { refreshSession(); });
})();
</script>
</body>
</html>
