<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>CoupangLand</title>

  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --panel2:#f7f8fb;
      --line:#e6e8ef;
      --text:#111827;
      --muted:#6b7280;
      --primary:#2563eb;
      --danger:#ef4444;
      --shadow: 0 10px 30px rgba(17,24,39,.08);
      --radius:18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", AppleSDGothicNeo, "Malgun Gothic", Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(180deg,#fbfbfe 0%, #ffffff 55%, #fbfbfe 100%);
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .topbar-inner{
      max-width: 1400px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 240px;
    }

    .brand-text{
      font-weight: 900;
      letter-spacing: -0.6px;
      font-size: 28px; /* 글씨 크게 */
      display:flex;
      align-items:baseline;
      gap:10px;
      line-height: 1;
    }
    .coupang span{ display:inline-block; }
    .coupang .c1{ color:#7a1f17; }  /* c */
    .coupang .c2{ color:#d13a2f; }  /* o */
    .coupang .c3{ color:#e28a00; }  /* u */
    .coupang .c4{ color:#3aa64b; }  /* p */
    .coupang .c5{ color:#1f7bd7; }  /* a */
    .coupang .c6{ color:#1f7bd7; }  /* n */
    .coupang .c7{ color:#1f7bd7; }  /* g */

    .land{
      color:#7b5a2a; /* 흙색 */
      font-weight: 900;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    button, select, input, textarea{
      font: inherit;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(17,24,39,.06);
      transition: transform .06s ease, box-shadow .06s ease;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 25px rgba(17,24,39,.08); }
    .btn.primary{ border-color: rgba(37,99,235,.35); color:#1d4ed8; }
    .btn.danger{ border-color: rgba(239,68,68,.35); color:#b91c1c; }

    .wrap{
      max-width: 1400px;
      margin: 0 auto;
      padding: 18px;
    }

    .grid{
      display:grid;
      grid-template-columns: 2.2fr 1fr; /* 지도 더 크게 / 우측 더 작게 */
      gap: 14px;
      align-items: start;
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 16px 16px 12px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg,#ffffff 0%, #fbfbfe 100%);
    }
    .panel .hd h2{
      margin:0;
      font-size: 16px;
      letter-spacing: -0.2px;
    }

    .badge{
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--line);
      background: #fff;
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .controls{
      padding: 14px 16px 10px;
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .controls input{
      flex: 1 1 320px;
      min-width: 260px;
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 12px;
      padding: 11px 12px;
      outline: none;
    }
    .controls select{
      flex: 0 0 220px;
      min-width: 200px;
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
    }

    .crumbs{
      padding: 0 16px 12px;
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap: wrap;
    }
    .chip{
      border: 1px solid var(--line);
      background: #fff;
      color: #111827;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
    }
    .chip.on{
      border-color: rgba(37,99,235,.35);
      color: #1d4ed8;
      background: rgba(37,99,235,.06);
      font-weight: 700;
    }

    .map-wrap{
      padding: 0 16px 14px;
    }
    #map{
      width:100%;
      height: 62vh; /* 크게 */
      min-height: 520px;
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid var(--line);
      background: var(--panel2);
    }

    .sublist-wrap{
      padding: 0 16px 16px;
    }
    .sublist-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      color: var(--muted);
      font-size: 12px;
      padding: 10px 2px 8px;
    }
    .sublist{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: #fff;
      overflow:hidden;
    }
    .subitem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-top: 1px solid var(--line);
      cursor:pointer;
    }
    .subitem:first-child{ border-top:none; }
    .subitem:hover{ background: #fafbff; }
    .subitem .name{ font-weight: 600; }
    .subitem .meta{ color: var(--muted); font-size: 12px; }

    details.admin{
      margin: 0 16px 16px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: #fff;
      overflow:hidden;
    }
    details.admin summary{
      cursor:pointer;
      padding: 12px 12px;
      font-weight: 700;
      border-bottom: 1px solid var(--line);
      background: #fbfbfe;
    }
    .admin-inner{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    textarea{
      width:100%;
      min-height: 180px;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      outline:none;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.5;
      background: #fff;
    }
    .admin-actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .note{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }

    /* Right panel */
    .pill{
      font-size: 12px;
      border: 1px solid var(--line);
      background:#fff;
      padding: 6px 10px;
      border-radius: 999px;
      color: var(--muted);
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .kv{
      padding: 12px 16px 4px;
    }
    .kv .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px dashed #eef0f6;
    }
    .kv .k{ color: var(--muted); font-size: 12px; }
    .kv .v{ font-weight: 700; font-size: 13px; }

    .card{
      margin: 12px 16px 16px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: #fff;
      overflow:hidden;
    }
    .card h3{
      margin:0;
      padding: 12px 12px;
      font-size: 13px;
      border-bottom: 1px solid var(--line);
      background: #fbfbfe;
    }
    .card .body{
      padding: 12px;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.55;
      white-space: pre-wrap;
    }

    /* Map overlays */
    .region-label{
      display:inline-flex;
      align-items:center;
      gap: 6px; /* 글씨 + 숫자 같은줄 */
      padding: 6px 8px;
      border: 1px solid rgba(17,24,39,.12);
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 6px 18px rgba(17,24,39,.10);
      color: #111827;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: -0.2px;
      user-select:none;
      transform: translate(-50%,-50%);
    }
    .region-label .cnt{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 22px;
      height: 22px;
      padding: 0 7px;
      border-radius: 999px;
      background: #2563eb;
      color:#fff;
      font-size: 12px;
      font-weight: 900;
      line-height: 1;
    }
    .toast{
      position: fixed;
      right: 18px;
      bottom: 18px;
      padding: 12px 14px;
      background: rgba(17,24,39,.92);
      color: #fff;
      border-radius: 12px;
      box-shadow: 0 14px 35px rgba(0,0,0,.22);
      font-size: 13px;
      opacity:0;
      transform: translateY(10px);
      transition: opacity .18s ease, transform .18s ease;
      z-index: 100;
      pointer-events:none;
      max-width: min(520px, calc(100vw - 36px));
    }
    .toast.on{
      opacity:1;
      transform: translateY(0);
    }

    @media (max-width: 1080px){
      .grid{ grid-template-columns: 1fr; }
      #map{ height: 56vh; min-height: 460px; }
    }
  </style>

  <!-- Kakao 지도 SDK (사용 중인 키 그대로) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=add4ce93b38c0ff9d9b9053728e067b3"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-text">
          <span class="coupang">
            <span class="c1">c</span><span class="c2">o</span><span class="c3">u</span><span class="c4">p</span><span class="c5">a</span><span class="c6">n</span><span class="c7">g</span>
          </span>
          <span class="land">Land</span>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnAllTop">전체 보기</button>
        <button class="btn" id="btnCopyTop">현재 화면 요약 복사</button>
        <button class="btn danger" id="btnResetTop">데이터 초기화</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <section class="panel">
        <div class="hd">
          <h2>지도 기반 조회</h2>
          <div class="badge">데이터: <b id="dataCount">0</b>건</div>
        </div>

        <div class="controls">
          <input id="q" placeholder="검색: 예) 대구 / 대구광역시 / 중구 / 칠성동 / 영등포구 / 마루웰" />
          <button class="btn" id="btnSearch">검색</button>
          <select id="vendorSelect"></select>
        </div>

        <div class="crumbs" id="crumbs"></div>

        <div class="map-wrap">
          <div id="map"></div>
        </div>

        <div class="sublist-wrap">
          <div class="sublist-title">
            <div id="subTitle">시/도</div>
            <div class="badge" id="subMeta">표시: 전체</div>
          </div>
          <div class="sublist" id="subList"></div>
        </div>

        <details class="admin" open>
          <summary>데이터 입력/수정 (관리용)</summary>
          <div class="admin-inner">
            <textarea id="dataInput" spellcheck="false"></textarea>
            <div class="admin-actions">
              <button class="btn primary" id="btnApply">파싱/적용</button>
              <button class="btn" id="btnLoadSample">샘플 로드</button>
              <button class="btn" id="btnExportUnique">유니크 목록 내보내기</button>
            </div>
            <div class="note" id="parseNote"></div>
          </div>
        </details>
      </section>

      <!-- RIGHT -->
      <aside class="panel">
        <div class="hd">
          <h2>현재 선택 상세</h2>
          <div class="pill" id="scopePill">전체</div>
        </div>

        <div class="kv">
          <div class="row"><div class="k">선택 범위</div><div class="v" id="selScope">전체</div></div>
          <div class="row"><div class="k">업체 필터</div><div class="v" id="selVendor">전체</div></div>
          <div class="row"><div class="k">유니크(업체+지역)</div><div class="v" id="selUnique">0</div></div>
        </div>

        <div class="card">
          <h3>업체 분포 (가나다순)</h3>
          <div class="body">
            <div class="mono" id="vendorDist">표시할 데이터가 없습니다.</div>
          </div>
        </div>

        <div class="card">
          <h3>동별 업체 (동 가나다순 / 업체 가나다순)</h3>
          <div class="body">
            <div class="mono" id="dongVendors">표시할 데이터가 없습니다.</div>
          </div>
        </div>

        <div class="card">
          <h3>메모</h3>
          <div class="body">
            <div class="note">
              - 폴리곤 라벨은 “지역명 + (업체 수)”를 같은 줄로 표시합니다(0개면 숫자 미표시).<br/>
              - “시 → 구/군 → 동” 드릴다운: 폴리곤 클릭 또는 아래 리스트 클릭으로 이동합니다.<br/>
              - (중요) 상위 레벨 오버레이/폴리곤은 레이어 렌더링 시 항상 클리어하여 “잔상”이 남지 않게 했습니다.
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /*****************************************************************
     * 0) 샘플 데이터 (요청: 제일로지스 포함 버전 기본 로드)
     *****************************************************************/
    const DEFAULT_SAMPLE_DATA = `영등포구 대림동 마루웰
영등포구 대림동 마루웰
분당구 대장동 투네스트
용인시 수지구 동천동 투네스트
용인시 수지구 동천동 마루웰
용인시 수지구 동천동 강동물류
영등포구 신길동 마루웰
대구광역시 중구 칠성동 마루웰
대구광역시 중구 동인동 마루웰
서울특별시 강서구 염창동 투네스트
서울특별시 강서구 염창동 마루웰
경기도 용인시 수지구 동천동 마루웰
대구광역시 달서구 월성동 지엔제이
대구광역시 중구 대봉동 123로지스
대구광역시 중구 동인동 123로지스
대구광역시 달성군 화원읍 태호물류
대구광역시 동구 검사동 정직한물류
대구광역시 달서구 감삼동 에스제이
대구광역시 수성구 만촌동 수성영업소
용인시 기흥구 마북동 성하
용인시 기흥구 마북동 타이탄
경기도 화성시 영천동 씨제이대한통운 서울장지
경기도 용인시 기흥구 하갈동 신화종합물류
경기도 용인시 기흥구 영덕동 신화종합물류
경기도 용인시 기흥구 보정동 CTR종합물류
경기도 성남시 분당구 분당동 천상로지스틱스
경기도 성남시 분당구 정자동 아이비그룹
경기도 고양시 일산서구 일산동 HR그룹
경기도 고양시 일산서구 일산동 삼보로직스
경기도 고양시 일산서구 일산동 YS물류
경기도 고양시 일산서구 일산동 JK글로벌로직스
경기도 고양시 일산서구 주엽동 가화컴퍼니
경기도 고양시 일산서구 주엽동 삼보로직스
대구광역시 북구 국우동 제일로지스
대구광역시 북구 학정동 제일로지스
대구광역시 북구 동호동 제일로지스
대구광역시 북구 사수동 제일로지스
대구광역시 북구 금호동 제일로지스
대구광역시 북구 팔달동 제일로지스
대구광역시 북구 침산동 제일로지스
대구광역시 북구 대현동 제일로지스
대구광역시 동구 신천동 제일로지스
대구광역시 동구 신암동 제일로지스
대구광역시 수성구 두산동 제일로지스
대구광역시 수성구 파동 제일로지스
경상북도 경산시 중산동 제일로지스
경상북도 경산시 정평동 제일로지스
경상북도 경산시 대평동 제일로지스
경상북도 경산시 백천동 제일로지스
경상북도 경산시 유곡동 제일로지스
경상북도 경산시 평산동 제일로지스
경상북도 경산시 점천동 제일로지스
경상북도 경산시 신천동 제일로지스
경상북도 경산시 내동 제일로지스
경상북도 경산시 남방동 제일로지스
경상북도 경산시 여천동 제일로지스
경상북도 경산시 남산면 제일로지스
경상북도 경산시 사동 제일로지스
경상북도 경산시 계양동 제일로지스
경상북도 경산시 삼풍동 제일로지스
경상북도 경산시 갑제동 제일로지스
경상북도 경산시 압량읍 제일로지스
경상북도 경산시 진량읍 제일로지스
대구광역시 동구 지묘동 제일로지스
대구광역시 동구 숙천동 제일로지스
대구광역시 동구 사복동 제일로지스
대구광역시 동구 내곡동 제일로지스
대구광역시 수성구 범어동 제일로지스
대구광역시 달서구 두류동 제일로지스
대구광역시 달서구 성당동 제일로지스
대구광역시 남구 대명동 제일로지스
대구광역시 북구 칠성동 제일로지스
대구광역시 북구 동변동 제일로지스
대구광역시 북구 서변동 제일로지스`;

    /*****************************************************************
     * 1) 로컬스토리지 키
     *****************************************************************/
    const LS_DATA = "COUPANGLAND_DATA_V3";
    const LS_VENDOR = "COUPANGLAND_VENDOR_V3";
    const LS_SEL = "COUPANGLAND_SEL_V3";

    /*****************************************************************
     * 2) 경계 데이터 소스 (로컬 우선 + 공개 소스 fallback)
     *    - 네 프로젝트에 이미 경계 파일이 있다면, ./boundaries 경로만 맞추면 가장 안정적
     *****************************************************************/
    const BOUNDARY_SOURCES = {
      sido: [
        "./boundaries/sido.geojson",
        "https://raw.githubusercontent.com/southkorea/southkorea-maps/master/kostat/2018/json/skorea-provinces-2018-geo.json",
        "https://raw.githubusercontent.com/southkorea/southkorea-maps/master/kostat/2013/json/skorea-provinces-2013-geo.json"
      ],
      sigunguTopo: [
        "./boundaries/sigungu.topo.json",
        "https://raw.githubusercontent.com/southkorea/southkorea-maps/master/kostat/2018/json/skorea-municipalities-2018-topo.json",
        "https://raw.githubusercontent.com/southkorea/southkorea-maps/master/kostat/2013/json/skorea-municipalities-2013-topo.json"
      ],
      dongBySido: (sidoKor) => ([
        `./boundaries/dong/${sidoKor}.geojson`,
        // Local_HangJeongDong (파일명 패턴: hangjeongdong_대구광역시.geojson 등)
        `https://raw.githubusercontent.com/raqoon886/Local_HangJeongDong/master/${encodeURIComponent("hangjeongdong_" + sidoKor + ".geojson")}`,
        // (대체) admdongkor 대용량 파일 (여기선 미사용: 너무 큼). 필요하면 여기 추가.
      ])
    };

    /*****************************************************************
     * 3) 시/도 별칭(영문/약칭 -> 한글 정규화)
     *    - 문제였던 Daegu 인식 깨짐을 여기서 해결
     *****************************************************************/
    const SIDO_ALIAS = new Map(Object.entries({
      "Seoul": "서울특별시", "서울": "서울특별시", "서울특별시": "서울특별시",
      "Busan": "부산광역시", "부산": "부산광역시", "부산광역시": "부산광역시",
      "Daegu": "대구광역시", "대구": "대구광역시", "대구광역시": "대구광역시",
      "Incheon": "인천광역시", "인천": "인천광역시", "인천광역시": "인천광역시",
      "Gwangju": "광주광역시", "광주": "광주광역시", "광주광역시": "광주광역시",
      "Daejeon": "대전광역시", "대전": "대전광역시", "대전광역시": "대전광역시",
      "Ulsan": "울산광역시", "울산": "울산광역시", "울산광역시": "울산광역시",
      "Sejong": "세종특별자치시", "세종": "세종특별자치시", "세종특별자치시": "세종특별자치시",

      "Gyeonggi-do": "경기도", "Gyeonggi": "경기도", "경기": "경기도", "경기도": "경기도",
      "Gangwon-do": "강원특별자치도", "Gangwon": "강원특별자치도", "강원": "강원특별자치도", "강원도": "강원특별자치도", "강원특별자치도": "강원특별자치도",
      "Chungcheongbuk-do": "충청북도", "Chungbuk": "충청북도", "충북": "충청북도", "충청북도": "충청북도",
      "Chungcheongnam-do": "충청남도", "Chungnam": "충청남도", "충남": "충청남도", "충청남도": "충청남도",
      "Jeollabuk-do": "전북특별자치도", "Jeonbuk": "전북특별자치도", "전북": "전북특별자치도", "전라북도": "전북특별자치도", "전북특별자치도": "전북특별자치도",
      "Jeollanam-do": "전라남도", "Jeonnam": "전라남도", "전남": "전라남도", "전라남도": "전라남도",
      "Gyeongsangbuk-do": "경상북도", "Gyeongbuk": "경상북도", "경북": "경상북도", "경상북도": "경상북도",
      "Gyeongsangnam-do": "경상남도", "Gyeongnam": "경상남도", "경남": "경상남도", "경상남도": "경상남도",
      "Jeju-do": "제주특별자치도", "Jeju": "제주특별자치도", "제주": "제주특별자치도", "제주도": "제주특별자치도", "제주특별자치도": "제주특별자치도"
    }));

    function normalizeSido(raw){
      if(!raw) return "";
      const s = String(raw).trim();
      if(SIDO_ALIAS.has(s)) return SIDO_ALIAS.get(s);
      // 공백/하이픈 제거 후 한번 더 시도
      const compact = s.replace(/\s+/g,"").replace(/-/g,"");
      for(const [k,v] of SIDO_ALIAS.entries()){
        if(k.replace(/\s+/g,"").replace(/-/g,"") === compact) return v;
      }
      return s;
    }

    // 데이터 누락 시/도 추정 (샘플 기준 최소한만)
    const SIGUNGU_TO_SIDO_GUESS = new Map(Object.entries({
      "영등포구":"서울특별시",
      "강서구":"서울특별시",
      "분당구":"경기도",
      "용인시":"경기도",
      "고양시":"경기도",
      "성남시":"경기도",
      "화성시":"경기도"
    }));

    /*****************************************************************
     * 4) 상태 / 캐시
     *****************************************************************/
    const state = {
      records: [],
      vendorFilter: "전체",
      sel: { sido:"", sigungu:"", dong:"" }, // dong은 최종 클릭 시만 사용(리스트/상세용)
      map: null,
      polygons: [],
      overlays: [],
      caches: {
        sidoGeojson: null,
        sigunguTopo: null,
        dongGeojsonBySido: new Map()
      }
    };

    /*****************************************************************
     * 5) 유틸: 토스트
     *****************************************************************/
    let toastTimer = null;
    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("on");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> el.classList.remove("on"), 2400);
    }

    /*****************************************************************
     * 6) 데이터 파싱/저장
     *****************************************************************/
    function parseLinesToRecords(text){
      const lines = String(text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const out = [];

      for(const line of lines){
        const toks = line.split(/\s+/).filter(Boolean);
        if(toks.length < 3) continue; // 최소: (구 동 업체) 정도는 있어야 의미있음

        const vendor = toks[toks.length-1].trim();
        const loc = toks.slice(0, -1);

        let sido = "";
        let sigungu = "";
        let dong = "";

        // 케이스 A: [시도, ... , 동] + 업체
        const first = loc[0];
        const isSidoLike =
          /특별자치도$|특별자치시$|광역시$|특별시$|도$/.test(first) ||
          ["Seoul","Busan","Daegu","Incheon","Gwangju","Daejeon","Ulsan","Sejong"].includes(first) ||
          /-do$/.test(first);

        if(isSidoLike){
          sido = normalizeSido(first);
          dong = loc[loc.length-1];
          sigungu = loc.slice(1, -1).join(" "); // 예: "용인시 수지구"
        }else{
          // 케이스 B: 시도 없이 시작 (예: 영등포구 대림동, 용인시 수지구 동천동)
          dong = loc[loc.length-1];

          // sigungu는 dong 전까지 묶어서 처리 (예: "용인시 수지구", "영등포구")
          sigungu = loc.slice(0, -1).join(" ");

          // sido 추정: 첫 토큰이 "영등포구" 같은 구면 서울로, "용인시" 같은 시면 경기도로
          const head = loc[0];
          if(SIGUNGU_TO_SIDO_GUESS.has(head)) sido = SIGUNGU_TO_SIDO_GUESS.get(head);
          else{
            // "용인시 수지구" 같은 경우, 첫 토큰이 용인시로 들어오므로 위에서 걸리긴 하는데 혹시 대비
            const head2 = sigungu.split(" ")[0];
            if(SIGUNGU_TO_SIDO_GUESS.has(head2)) sido = SIGUNGU_TO_SIDO_GUESS.get(head2);
          }
        }

        sido = normalizeSido(sido);

        const full = [sido, sigungu, dong].filter(Boolean).join(" ").replace(/\s+/g," ").trim();
        const keyUnique = `${vendor}|||${full}`;

        out.push({
          raw: line,
          sido,
          sigungu: sigungu.trim(),
          dong: dong.trim(),
          vendor: vendor.trim(),
          full,
          uniqueKey: keyUnique
        });
      }

      return out;
    }

    function saveData(){
      localStorage.setItem(LS_DATA, document.getElementById("dataInput").value);
      localStorage.setItem(LS_VENDOR, state.vendorFilter);
      localStorage.setItem(LS_SEL, JSON.stringify(state.sel));
    }

    function loadDataText(){
      const saved = localStorage.getItem(LS_DATA);
      return saved && saved.trim().length ? saved : DEFAULT_SAMPLE_DATA;
    }

    function applyDataFromTextarea(){
      const text = document.getElementById("dataInput").value;
      const recs = parseLinesToRecords(text);

      state.records = recs;
      document.getElementById("dataCount").textContent = String(recs.length);

      saveData();
      rebuildVendorSelect();
      // 선택이 기존에 있었으면 유지(단, 현재 데이터에서 유효하지 않으면 상위로 올림)
      normalizeSelectionAgainstData();
      renderAll();
      toast("데이터 적용 완료");
    }

    function normalizeSelectionAgainstData(){
      const sel = state.sel;
      if(!sel.sido && !sel.sigungu && !sel.dong) return;

      const filtered = getFilteredRecords();
      const hasSido = sel.sido && filtered.some(r=>r.sido === sel.sido);
      const hasSigungu = sel.sido && sel.sigungu && filtered.some(r=>r.sido===sel.sido && matchSigungu(r.sigungu, sel.sigungu));
      const hasDong = sel.sido && sel.sigungu && sel.dong && filtered.some(r=>r.sido===sel.sido && matchSigungu(r.sigungu, sel.sigungu) && r.dong===sel.dong);

      if(sel.dong && !hasDong) sel.dong = "";
      if(sel.sigungu && !hasSigungu){ sel.sigungu = ""; sel.dong = ""; }
      if(sel.sido && !hasSido){ sel.sido = ""; sel.sigungu = ""; sel.dong = ""; }
    }

    /*****************************************************************
     * 7) 필터/집계
     *****************************************************************/
    function getFilteredRecords(){
      const v = state.vendorFilter;
      if(v === "전체") return state.records.slice();
      return state.records.filter(r=>r.vendor === v);
    }

    // "sigungu" 정합: 기록에는 "용인시 수지구"처럼 들어올 수 있고, 경계는 "수지구"만 있을 수 있음
    function matchSigungu(recordSigungu, featureName){
      const a = String(recordSigungu||"").trim();
      const b = String(featureName||"").trim();
      if(!a || !b) return false;
      if(a === b) return true;
      if(a.endsWith(" " + b)) return true;
      if(a.endsWith(b)) return true;
      return false;
    }

    function buildVendorSet(records){
      const s = new Set();
      for(const r of records) s.add(r.vendor);
      return s;
    }

    function vendorCountInScope(scope){
      // scope: {sido?, sigungu?, dong?}
      const recs = getFilteredRecords().filter(r=>{
        if(scope.sido && r.sido !== scope.sido) return false;
        if(scope.sigungu && !matchSigungu(r.sigungu, scope.sigungu)) return false;
        if(scope.dong && r.dong !== scope.dong) return false;
        return true;
      });
      return buildVendorSet(recs).size;
    }

    function uniqueCountInScope(scope){
      const recs = getFilteredRecords().filter(r=>{
        if(scope.sido && r.sido !== scope.sido) return false;
        if(scope.sigungu && !matchSigungu(r.sigungu, scope.sigungu)) return false;
        if(scope.dong && r.dong !== scope.dong) return false;
        return true;
      });
      const u = new Set(recs.map(r=>r.uniqueKey));
      return u.size;
    }

    function computeVendorDistribution(scope){
      const recs = getFilteredRecords().filter(r=>{
        if(scope.sido && r.sido !== scope.sido) return false;
        if(scope.sigungu && !matchSigungu(r.sigungu, scope.sigungu)) return false;
        if(scope.dong && r.dong !== scope.dong) return false;
        return true;
      });

      const m = new Map();
      for(const r of recs){
        m.set(r.vendor, (m.get(r.vendor)||0) + 1);
      }

      const items = Array.from(m.entries()).sort((a,b)=> a[0].localeCompare(b[0], "ko"));
      return items;
    }

    function computeDongVendors(scope){
      // “데이터 있는 동”만: scope 내에서 등장한 동 기준으로 그룹
      const recs = getFilteredRecords().filter(r=>{
        if(scope.sido && r.sido !== scope.sido) return false;
        if(scope.sigungu && !matchSigungu(r.sigungu, scope.sigungu)) return false;
        if(scope.dong && r.dong !== scope.dong) return false;
        return true;
      });

      // dong key는 "동이름"만 사용(요청: 동에서 어느 업체가 있는지). 단, 같은 동명이 다른 구에 있을 수 있어 scope가 상위에서 좁혀졌을 때만 안전.
      const m = new Map(); // dong -> Map(vendor -> count)
      for(const r of recs){
        const dk = r.dong;
        if(!m.has(dk)) m.set(dk, new Map());
        const vm = m.get(dk);
        vm.set(r.vendor, (vm.get(r.vendor)||0) + 1);
      }

      const dongNames = Array.from(m.keys()).sort((a,b)=> a.localeCompare(b,"ko"));
      const out = [];
      for(const d of dongNames){
        const vm = m.get(d);
        const vendors = Array.from(vm.entries()).sort((a,b)=> a[0].localeCompare(b[0], "ko"));
        out.push({ dong: d, vendors });
      }
      return out;
    }

    /*****************************************************************
     * 8) 벤더 셀렉트 구성
     *****************************************************************/
    function rebuildVendorSelect(){
      const sel = document.getElementById("vendorSelect");
      const prev = state.vendorFilter;

      const vendors = Array.from(new Set(state.records.map(r=>r.vendor)))
        .sort((a,b)=>a.localeCompare(b,"ko"));

      sel.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "전체";
      optAll.textContent = "업체: 전체";
      sel.appendChild(optAll);

      for(const v of vendors){
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      }

      // restore
      if(vendors.includes(prev)) state.vendorFilter = prev;
      else state.vendorFilter = "전체";

      sel.value = state.vendorFilter;
    }

    /*****************************************************************
     * 9) Kakao Map / 경계 로딩 / 폴리곤 렌더
     *****************************************************************/
    function clearLayer(){
      for(const p of state.polygons) p.setMap(null);
      for(const o of state.overlays) o.setMap(null);
      state.polygons = [];
      state.overlays = [];
    }

    async function fetchJsonWithFallback(urls){
      let lastErr = null;
      for(const url of urls){
        try{
          const res = await fetch(url, { cache:"force-cache" });
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          return await res.json();
        }catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error("fetch failed");
    }

    function getGeoFeatures(geojson){
      if(!geojson) return [];
      if(geojson.type === "FeatureCollection") return geojson.features || [];
      if(geojson.type === "Feature") return [geojson];
      return [];
    }

    function topoToGeoFeatures(topo){
      if(!topo || !topo.objects) return [];
      const keys = Object.keys(topo.objects);
      if(!keys.length) returncrc;
      const obj = topo.objects[keys[0]];
      const fc = topojson.feature(topo, obj);
      return getGeoFeatures(fc);
    }

    function featureName(feature){
      const p = feature && feature.properties ? feature.properties : {};
      return (p.name || p.NAME_1 || p.NAME || p.CTP_KOR_NM || p.SIG_KOR_NM || p.sido || p.sigungu || p.adm_nm || "").toString().trim();
    }

    function featureParentSido(feature){
      const p = feature && feature.properties ? feature.properties : {};
      const parent =
        (p.CTP_KOR_NM || p.sido || p.SIDO || (p.adm_nm ? String(p.adm_nm).split(" ")[0] : "") || "").toString().trim();
      return normalizeSido(parent);
    }

    function boundsFromCoords(coords){
      const b = new kakao.maps.LatLngBounds();
      function walk(c){
        if(typeof c[0] === "number"){
          b.extend(new kakao.maps.LatLng(c[1], c[0]));
          return;
        }
        for(const cc of c) walk(cc);
      }
      walk(coords);
      return b;
    }

    function latLngPathsFromGeometry(geom){
      // Kakao Polygon path: LatLng[] | LatLng[][] | LatLng[][][]
      const type = geom.type;
      const coords = geom.coordinates;

      const toRing = (ring) => ring.map(([lng,lat]) => new kakao.maps.LatLng(lat, lng));

      if(type === "Polygon"){
        const outer = coords[0] || [];
        return toRing(outer);
      }
      if(type === "MultiPolygon"){
        // 여러 폴리곤: 각 폴리곤의 outer ring만 사용
        return coords.map(poly => toRing((poly[0]||[])));
      }
      return [];
    }

    function overlayContent(nameKor, vendorCnt){
      // 요청: 글씨로 지역명, 숫자는 0이면 표시 X, 있으면 지역명 옆(같은 줄)
      const safeName = String(nameKor||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      if(vendorCnt > 0){
        return `<div class="region-label"><span class="nm">${safeName}</span><span class="cnt">${vendorCnt}</span></div>`;
      }
      return `<div class="region-label"><span class="nm">${safeName}</span></div>`;
    }

    function addRegionOverlay(centerLatLng, nameKor, vendorCnt){
      const ov = new kakao.maps.CustomOverlay({
        position: centerLatLng,
        content: overlayContent(nameKor, vendorCnt),
        yAnchor: 0.5,
        xAnchor: 0.5,
        zIndex: 10
      });
      ov.setMap(state.map);
      state.overlays.push(ov);
      return ov;
    }

    function addPolygon(feature, options){
      const geom = feature.geometry;
      const paths = latLngPathsFromGeometry(geom);
      if(!paths || (Array.isArray(paths) && paths.length === 0)) return null;

      const poly = new kakao.maps.Polygon({
        map: state.map,
        path: paths,
        strokeWeight: options.strokeWeight ?? 4,
        strokeColor: options.strokeColor ?? "#2563eb",
        strokeOpacity: options.strokeOpacity ?? 0.9,
        strokeStyle: "solid",
        fillColor: options.fillColor ?? "rgba(37,99,235,0.06)",
        fillOpacity: options.fillOpacity ?? 0.25
      });

      state.polygons.push(poly);
      return poly;
    }

    function fitToFeature(feature){
      const b = boundsFromCoords(feature.geometry.coordinates);
      state.map.setBounds(b, 40, 40, 40, 40);
    }

    async function ensureSidoGeojson(){
      if(state.caches.sidoGeojson) return state.caches.sidoGeojson;
      const geo = await fetchJsonWithFallback(BOUNDARY_SOURCES.sido);
      state.caches.sidoGeojson = geo;
      return geo;
    }

    async function ensureSigunguTopo(){
      if(state.caches.sigunguTopo) return state.caches.sigunguTopo;
      const topo = await fetchJsonWithFallback(BOUNDARY_SOURCES.sigunguTopo);
      state.caches.sigunguTopo = topo;
      return topo;
    }

    async function ensureDongGeojson(sidoKor){
      if(state.caches.dongGeojsonBySido.has(sidoKor)) return state.caches.dongGeojsonBySido.get(sidoKor);
      const geo = await fetchJsonWithFallback(BOUNDARY_SOURCES.dongBySido(sidoKor));
      state.caches.dongGeojsonBySido.set(sidoKor, geo);
      return geo;
    }

    function currentLevel(){
      // 드릴다운 기준
      if(state.sel.sido && state.sel.sigungu) return "dong";
      if(state.sel.sido) return "sigungu";
      return "sido";
    }

    async function renderBoundaries(){
      clearLayer(); // (중요) 잔상/겹침 방지: 렌더링마다 항상 클리어

      const level = currentLevel();
      const scope = { sido: state.sel.sido, sigungu: state.sel.sigungu, dong: state.sel.dong };

      if(level === "sido"){
        const geo = await ensureSidoGeojson();
        const feats = getGeoFeatures(geo);

        // 정규화된 시도명으로 그룹
        const items = [];
        for(const f of feats){
          const nmRaw = featureName(f);
          const nmKor = normalizeSido(nmRaw);
          if(!nmKor) continue;

          const cnt = vendorCountInScope({sido: nmKor});
          items.push({ feature:f, name:nmKor, cnt });
        }

        // 그리기
        for(const it of items){
          const poly = addPolygon(it.feature, {});
          if(!poly) continue;

          const b = boundsFromCoords(it.feature.geometry.coordinates);
          const center = b.getCenter();
          addRegionOverlay(center, it.name, it.cnt);

          kakao.maps.event.addListener(poly, "click", () => {
            // 시도 선택 -> 시군구로
            state.sel = { sido: it.name, sigungu:"", dong:"" };
            saveData();
            fitToFeature(it.feature);
            renderAll().catch(e=>console.error(e));
          });
        }

        // 초기 화면: 전국 보이도록
        // (현재 선택이 없을 때만)
      }
      else if(level === "sigungu"){
        const topo = await ensureSigunguTopo();
        const feats = topoToGeoFeatures(topo);

        // 선택 sido에 해당하는 시군구만 필터
        const targetSido = state.sel.sido;

        const items = [];
        for(const f of feats){
          const parent = featureParentSido(f);
          if(parent && targetSido && parent !== targetSido) continue;

          const nm = featureName(f);
          const nameKor = nm; // 대부분 한글
          if(!nameKor) continue;

          const cnt = vendorCountInScope({sido: targetSido, sigungu: nameKor});
          items.push({ feature:f, name:nameKor, cnt });
        }

        for(const it of items){
          const poly = addPolygon(it.feature, {});
          if(!poly) continue;

          const b = boundsFromCoords(it.feature.geometry.coordinates);
          const center = b.getCenter();
          addRegionOverlay(center, it.name, it.cnt);

          kakao.maps.event.addListener(poly, "click", async () => {
            // 시군구 선택 -> 동으로
            state.sel = { sido: targetSido, sigungu: it.name, dong:"" };
            saveData();
            fitToFeature(it.feature);
            renderAll().catch(e=>console.error(e));
          });
        }
      }
      else if(level === "dong"){
        const targetSido = state.sel.sido;
        const targetSigungu = state.sel.sigungu;

        const geo = await ensureDongGeojson(targetSido);
        const feats = getGeoFeatures(geo);

        // 동 레벨은 "데이터 있는 동만" + (선택 시군구에 해당)만 표시해서 가볍게
        const filteredRecs = getFilteredRecords().filter(r=>{
          if(r.sido !== targetSido) return false;
          if(!matchSigungu(r.sigungu, targetSigungu)) return false;
          return true;
        });

        const dongToVendorSet = new Map();
        for(const r of filteredRecs){
          if(!dongToVendorSet.has(r.dong)) dongToVendorSet.set(r.dong, new Set());
          dongToVendorSet.get(r.dong).add(r.vendor);
        }

        // feature에서 dong 이름 뽑기(가능한 여러 필드 대응)
        const items = [];
        for(const f of feats){
          const p = f.properties || {};
          let adm = (p.adm_nm || p.ADM_NM || "").toString().trim(); // "대구광역시 북구 침산동"
          let dongName = (p.emd_nm || p.EMD_NM || p.name || p.NAME || "").toString().trim();

          if(!dongName && adm){
            const parts = adm.split(/\s+/);
            dongName = parts[parts.length-1] || "";
          }

          // 시군구 필터: adm_nm에 포함되면 우선
          if(adm){
            if(!adm.includes(targetSido)) continue;
            if(!adm.includes(targetSigungu)) continue;
          }

          if(!dongName) continue;
          if(!dongToVendorSet.has(dongName)) continue; // 데이터 없는 동은 미표시(요청)

          const cnt = dongToVendorSet.get(dongName).size; // 업체 수
          items.push({ feature:f, name:dongName, cnt });
        }

        for(const it of items){
          const poly = addPolygon(it.feature, { strokeWeight: 3, fillOpacity: 0.20 });
          if(!poly) continue;

          const b = boundsFromCoords(it.feature.geometry.coordinates);
          const center = b.getCenter();
          addRegionOverlay(center, it.name, it.cnt);

          kakao.maps.event.addListener(poly, "click", () => {
            // 동 선택(최종)
            state.sel = { sido: targetSido, sigungu: targetSigungu, dong: it.name };
            saveData();
            renderRightPanel();
            renderSubList();
            renderCrumbs();
          });
        }
      }
    }

    /*****************************************************************
     * 10) 우측 패널 렌더
     *****************************************************************/
    function scopeLabel(){
      const s = state.sel;
      if(!s.sido) return "전체";
      if(s.sido && !s.sigungu) return s.sido;
      if(s.sido && s.sigungu && !s.dong) return `${s.sido} / ${s.sigungu}`;
      return `${s.sido} / ${s.sigungu} / ${s.dong}`;
    }

    function renderRightPanel(){
      const s = state.sel;
      const v = state.vendorFilter;

      document.getElementById("scopePill").textContent = scopeLabel();
      document.getElementById("selScope").textContent = scopeLabel();
      document.getElementById("selVendor").textContent = v;

      const scope = {sido:s.sido, sigungu:s.sigungu, dong:s.dong};
      document.getElementById("selUnique").textContent = String(uniqueCountInScope(scope));

      // 업체 분포 (가나다)
      const dist = computeVendorDistribution(scope);
      if(!dist.length){
        document.getElementById("vendorDist").textContent = "표시할 데이터가 없습니다.";
      }else{
        document.getElementById("vendorDist").textContent =
          dist.map(([name,c]) => `- ${name}: ${c}`).join("\n");
      }

      // 동별 업체 (동 가나다 / 업체 가나다)
      const dv = computeDongVendors(scope);
      if(!dv.length){
        document.getElementById("dongVendors").textContent = "표시할 데이터가 없습니다.";
      }else{
        const lines = [];
        for(const row of dv){
          const vendorsStr = row.vendors.map(([vn,c]) => `${vn}(${c})`).join(", ");
          lines.push(`- ${row.dong}: ${vendorsStr}`);
        }
        document.getElementById("dongVendors").textContent = lines.join("\n");
      }
    }

    /*****************************************************************
     * 11) 하단 리스트(클릭으로 이동)
     *****************************************************************/
    function renderSubList(){
      const level = currentLevel();
      const el = document.getElementById("subList");
      el.innerHTML = "";

      const titleEl = document.getElementById("subTitle");
      const metaEl = document.getElementById("subMeta");

      if(level === "sido"){
        titleEl.textContent = "시/도";
        metaEl.textContent = "표시: 전체";

        // 데이터 기반(경계가 못 불러와도 리스트는 동작)
        const recs = getFilteredRecords();
        const m = new Map(); // sido -> vendorSet
        for(const r of recs){
          const k = r.sido || "";
          if(!k) continue;
          if(!m.has(k)) m.set(k, new Set());
          m.get(k).add(r.vendor);
        }

        const items = Array.from(m.entries()).map(([name,set]) => ({name, cnt:set.size}))
          .sort((a,b)=>a.name.localeCompare(b.name,"ko"));

        if(!items.length){
          el.innerHTML = `<div class="subitem"><span class="name">표시할 데이터가 없습니다.</span><span class="meta"></span></div>`;
          return;
        }

        for(const it of items){
          const row = document.createElement("div");
          row.className = "subitem";
          row.innerHTML = `<span class="name">${it.name}</span><span class="meta">업체 ${it.cnt}</span>`;
          row.addEventListener("click", ()=>{
            state.sel = { sido: it.name, sigungu:"", dong:"" };
            saveData();
            renderAll().catch(e=>console.error(e));
          });
          el.appendChild(row);
        }
        return;
      }

      if(level === "sigungu"){
        titleEl.textContent = `시/군/구 (선택: ${state.sel.sido})`;
        metaEl.textContent = "표시: 시군구";

        const recs = getFilteredRecords().filter(r=>r.sido === state.sel.sido);
        const m = new Map(); // sigunguNameCanonical -> vendorSet

        for(const r of recs){
          const k = r.sigungu || "";
          if(!k) continue;
          if(!m.has(k)) m.set(k, new Set());
          m.get(k).add(r.vendor);
        }

        const items = Array.from(m.entries()).map(([name,set]) => ({name, cnt:set.size}))
          .sort((a,b)=>a.name.localeCompare(b.name,"ko"));

        if(!items.length){
          el.innerHTML = `<div class="subitem"><span class="name">표시할 데이터가 없습니다.</span><span class="meta"></span></div>`;
          return;
        }

        for(const it of items){
          const row = document.createElement("div");
          row.className = "subitem";
          row.innerHTML = `<span class="name">${it.name}</span><span class="meta">업체 ${it.cnt}</span>`;
          row.addEventListener("click", ()=>{
            state.sel = { sido: state.sel.sido, sigungu: it.name, dong:"" };
            saveData();
            renderAll().catch(e=>console.error(e));
          });
          el.appendChild(row);
        }
        return;
      }

      if(level === "dong"){
        titleEl.textContent = `동/읍/면 (선택: ${state.sel.sigungu})`;
        metaEl.textContent = "표시: 데이터 있는 동";

        const recs = getFilteredRecords().filter(r=>
          r.sido===state.sel.sido && matchSigungu(r.sigungu, state.sel.sigungu)
        );

        const m = new Map(); // dong -> vendorSet
        for(const r of recs){
          const k = r.dong || "";
          if(!k) continue;
          if(!m.has(k)) m.set(k, new Set());
          m.get(k).add(r.vendor);
        }

        const items = Array.from(m.entries())
          .map(([name,set])=>({name, cnt:set.size}))
          .sort((a,b)=>a.name.localeCompare(b.name,"ko"));

        if(!items.length){
          el.innerHTML = `<div class="subitem"><span class="name">표시할 데이터가 없습니다.</span><span class="meta"></span></div>`;
          return;
        }

        for(const it of items){
          const row = document.createElement("div");
          row.className = "subitem";
          row.innerHTML = `<span class="name">${it.name}</span><span class="meta">업체 ${it.cnt}</span>`;
          row.addEventListener("click", ()=>{
            state.sel = { sido: state.sel.sido, sigungu: state.sel.sigungu, dong: it.name };
            saveData();
            renderRightPanel();
            renderCrumbs();
            toast("동 선택됨");
          });
          el.appendChild(row);
        }
      }
    }

    /*****************************************************************
     * 12) 상단/좌측 크럼(전체/한단계위/현재 선택)
     *****************************************************************/
    function renderCrumbs(){
      const el = document.getElementById("crumbs");
      el.innerHTML = "";

      const s = state.sel;

      const addChip = (label, on, fn) => {
        const c = document.createElement("div");
        c.className = "chip" + (on ? " on" : "");
        c.textContent = label;
        c.addEventListener("click", fn);
        el.appendChild(c);
      };

      addChip("전체", !s.sido, () => {
        state.sel = { sido:"", sigungu:"", dong:"" };
        saveData();
        renderAll().catch(e=>console.error(e));
      });

      if(s.sido){
        addChip(s.sido, !!s.sido && !s.sigungu, () => {
          state.sel = { sido:s.sido, sigungu:"", dong:"" };
          saveData();
          renderAll().catch(e=>console.error(e));
        });
      }
      if(s.sigungu){
        addChip(s.sigungu, !!s.sigungu && !s.dong, () => {
          state.sel = { sido:s.sido, sigungu:s.sigungu, dong:"" };
          saveData();
          renderAll().catch(e=>console.error(e));
        });
      }
      if(s.dong){
        addChip(s.dong, !!s.dong, () => {
          // dong 레벨 유지
          renderRightPanel();
        });
      }

      // 한 단계 위
      if(s.sido || s.sigungu || s.dong){
        addChip("← 한 단계 위", false, () => {
          if(s.dong){
            state.sel.dong = "";
          }else if(s.sigungu){
            state.sel.sigungu = "";
          }else if(s.sido){
            state.sel.sido = "";
          }
          saveData();
          renderAll().catch(e=>console.error(e));
        });
      }
    }

    /*****************************************************************
     * 13) 검색
     * - “대구광역시 검색 -> 클릭하면 Daegu로 바뀌며 깨짐” 이슈는 normalizeSido로 해소
     * - 검색은 selection만 바꾸고 데이터/경계 캐시는 건드리지 않음(폴리곤/데이터 사라짐 방지)
     *****************************************************************/
    function applySearch(){
      const q = (document.getElementById("q").value || "").trim();
      if(!q){
        toast("검색어가 비어있습니다.");
        return;
      }

      // 1) 벤더가 포함되면 벤더 필터 우선 적용
      const vendors = Array.from(new Set(state.records.map(r=>r.vendor)));
      const foundVendor = vendors.find(v=> q.includes(v));
      if(foundVendor){
        state.vendorFilter = foundVendor;
        document.getElementById("vendorSelect").value = foundVendor;
      }

      // 2) 시도/시군구/동 매칭 (데이터 기반)
      const recs = getFilteredRecords();

      // sido
      let targetSido = "";
      for(const r of recs){
        if(r.sido && (q.includes(r.sido) || q.includes(r.sido.replace(/특별자치도|특별자치시|광역시|특별시/g,"")))){
          targetSido = r.sido;
          break;
        }
      }
      // 영어/약칭으로 들어온 경우
      if(!targetSido){
        const norm = normalizeSido(q);
        if(norm !== q){
          targetSido = norm;
        }
      }

      // sigungu / dong
      let targetSigungu = "";
      let targetDong = "";

      // 우선 정확한 포함
      for(const r of recs){
        if(!targetSido || r.sido === targetSido){
          if(r.sigungu && q.includes(r.sigungu)){
            targetSido = r.sido || targetSido;
            targetSigungu = r.sigungu;
            break;
          }
        }
      }

      for(const r of recs){
        if((!targetSido || r.sido === targetSido) && (!targetSigungu || matchSigungu(r.sigungu, targetSigungu))){
          if(r.dong && q.includes(r.dong)){
            targetSido = r.sido || targetSido;
            targetSigungu = targetSigungu || r.sigungu;
            targetDong = r.dong;
            break;
          }
        }
      }

      // 최종 반영
      if(targetSido){
        state.sel.sido = targetSido;
      }
      if(targetSigungu){
        state.sel.sigungu = targetSigungu;
      }else{
        // sido만 찾았으면 sigungu/dong은 초기화
        state.sel.sigungu = "";
        state.sel.dong = "";
      }
      if(targetDong){
        state.sel.dong = targetDong;
      }else{
        state.sel.dong = "";
      }

      saveData();
      renderAll().catch(e=>console.error(e));
      toast("검색 적용");
    }

    /*****************************************************************
     * 14) 요약 복사
     *****************************************************************/
    async function copySummary(){
      const s = state.sel;
      const scope = {sido:s.sido, sigungu:s.sigungu, dong:s.dong};
      const dist = computeVendorDistribution(scope);
      const dv = computeDongVendors(scope);

      const lines = [];
      lines.push(`[CoupangLand 요약]`);
      lines.push(`- 범위: ${scopeLabel()}`);
      lines.push(`- 업체 필터: ${state.vendorFilter}`);
      lines.push(`- 유니크(업체+지역): ${uniqueCountInScope(scope)}`);
      lines.push(``);
      lines.push(`[업체 분포]`);
      if(!dist.length) lines.push(`(없음)`);
      else for(const [v,c] of dist) lines.push(`- ${v}: ${c}`);
      lines.push(``);
      lines.push(`[동별 업체]`);
      if(!dv.length) lines.push(`(없음)`);
      else{
        for(const row of dv){
          lines.push(`- ${row.dong}: ${row.vendors.map(([vn,c])=>`${vn}(${c})`).join(", ")}`);
        }
      }

      try{
        await navigator.clipboard.writeText(lines.join("\n"));
        toast("요약 복사 완료");
      }catch(e){
        toast("복사 실패(브라우저 권한 확인)");
      }
    }

    /*****************************************************************
     * 15) 유니크 내보내기
     *****************************************************************/
    async function exportUnique(){
      const s = state.sel;
      const scope = {sido:s.sido, sigungu:s.sigungu, dong:s.dong};
      const recs = getFilteredRecords().filter(r=>{
        if(scope.sido && r.sido !== scope.sido) return false;
        if(scope.sigungu && !matchSigungu(r.sigungu, scope.sigungu)) return false;
        if(scope.dong && r.dong !== scope.dong) return false;
        return true;
      });

      const uniq = new Map(); // key -> record
      for(const r of recs){
        if(!uniq.has(r.uniqueKey)) uniq.set(r.uniqueKey, r);
      }

      const rows = Array.from(uniq.values())
        .map(r => `${r.full} ${r.vendor}`.trim())
        .sort((a,b)=>a.localeCompare(b,"ko"));

      try{
        await navigator.clipboard.writeText(rows.join("\n"));
        toast("유니크 목록 복사 완료");
      }catch(e){
        toast("복사 실패(브라우저 권한 확인)");
      }
    }

    /*****************************************************************
     * 16) 전체 렌더 파이프라인
     *****************************************************************/
    async function renderAll(){
      renderCrumbs();
      renderRightPanel();
      renderSubList();

      try{
        await renderBoundaries();
      }catch(e){
        console.error(e);
        toast("경계 데이터 로드 실패(경로/소스 확인)");
      }
    }

    /*****************************************************************
     * 17) 초기화
     *****************************************************************/
    function resetAll(){
      localStorage.removeItem(LS_DATA);
      localStorage.removeItem(LS_VENDOR);
      localStorage.removeItem(LS_SEL);

      state.vendorFilter = "전체";
      state.sel = {sido:"", sigungu:"", dong:""};
      state.caches.sidoGeojson = null;
      state.caches.sigunguTopo = null;
      state.caches.dongGeojsonBySido.clear();

      document.getElementById("dataInput").value = DEFAULT_SAMPLE_DATA;
      applyDataFromTextarea();
      toast("초기화 완료");
    }

    /*****************************************************************
     * 18) 부트스트랩
     *****************************************************************/
    function initMap(){
      const container = document.getElementById("map");
      const map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(36.35, 127.95),
        level: 13
      });
      state.map = map;
    }

    function restoreState(){
      const dataText = loadDataText();
      document.getElementById("dataInput").value = dataText;

      const v = localStorage.getItem(LS_VENDOR);
      if(v) state.vendorFilter = v;

      const selRaw = localStorage.getItem(LS_SEL);
      if(selRaw){
        try{
          const parsed = JSON.parse(selRaw);
          if(parsed && typeof parsed === "object"){
            state.sel = {
              sido: normalizeSido(parsed.sido || ""),
              sigungu: (parsed.sigungu || "").trim(),
              dong: (parsed.dong || "").trim()
            };
          }
        }catch{}
      }
    }

    function wireEvents(){
      document.getElementById("btnSearch").addEventListener("click", applySearch);
      document.getElementById("q").addEventListener("keydown", (e)=>{
        if(e.key === "Enter") applySearch();
      });

      document.getElementById("vendorSelect").addEventListener("change", (e)=>{
        state.vendorFilter = e.target.value;
        state.sel.dong = ""; // 필터 바뀌면 동 선택은 의미가 달라질 수 있어 초기화
        saveData();
        renderAll().catch(err=>console.error(err));
      });

      document.getElementById("btnApply").addEventListener("click", applyDataFromTextarea);
      document.getElementById("btnLoadSample").addEventListener("click", ()=>{
        document.getElementById("dataInput").value = DEFAULT_SAMPLE_DATA;
        applyDataFromTextarea();
      });
      document.getElementById("btnExportUnique").addEventListener("click", exportUnique);

      document.getElementById("btnAllTop").addEventListener("click", ()=>{
        state.sel = {sido:"", sigungu:"", dong:""};
        saveData();
        renderAll().catch(err=>console.error(err));
      });
      document.getElementById("btnCopyTop").addEventListener("click", copySummary);
      document.getElementById("btnResetTop").addEventListener("click", resetAll);
    }

    function renderParseNote(){
      const el = document.getElementById("parseNote");
      el.textContent =
`입력 포맷:
- [시/도] [시/군/구...] [동/읍/면] [업체명]
- 시/도 생략 가능 (예: 영등포구 대림동 마루웰)
- "시 → 구/군 → 동" 드릴다운은 폴리곤 클릭 또는 아래 리스트 클릭`;
    }

    document.addEventListener("DOMContentLoaded", async ()=>{
      restoreState();
      initMap();
      wireEvents();
      renderParseNote();

      // 초기 데이터 적용
      state.records = parseLinesToRecords(document.getElementById("dataInput").value);
      document.getElementById("dataCount").textContent = String(state.records.length);

      rebuildVendorSelect();
      // vendor restore
      document.getElementById("vendorSelect").value = state.vendorFilter;

      normalizeSelectionAgainstData();
      saveData();

      await renderAll();
    });
  </script>
</body>
</html>
