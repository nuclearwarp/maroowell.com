<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>MarooWell Coupang Route Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      overflow: hidden;
    }

    .page {
      display: flex;
      height: 100%;
      width: 100%;
    }

    .side {
      width: 320px;
      max-width: 100%;
      padding: 16px;
      background: #020617;
      border-right: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .side-header-title {
      font-size: 1rem;
      font-weight: 700;
    }
    .side-header-sub {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .field-label {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
    }

    .input[readonly] {
      opacity: 0.7;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 12px;
      font-size: 0.78rem;
      cursor: pointer;
      white-space: nowrap;
    }
    button.primary {
      background: #111827;
      border-color: #111827;
    }
    button.danger {
      border-color: #b91c1c;
      color: #fecaca;
    }
    button:hover {
      background: #111827;
    }

    .hint {
      margin-top: 4px;
      font-size: 0.72rem;
      color: #6b7280;
      line-height: 1.4;
    }

    .status-box {
      margin-top: 4px;
      font-size: 0.74rem;
      color: #e5e7eb;
      padding: 6px 8px;
      border-radius: 6px;
      background: #020617;
      border: 1px solid #1f2937;
      max-height: 72px;
      overflow: auto;
      white-space: pre-line;
    }

    .map-wrapper {
      flex: 1;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
    }

    .map-overlay-info {
      position: absolute;
      top: 10px;
      left: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.85);
      border: 1px solid #1f2937;
      font-size: 0.75rem;
      pointer-events: none;
    }

    @media (max-width: 768px) {
      .page {
        flex-direction: column;
      }
      .side {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #1f2937;
      }
    }
  </style>

  <!-- Kakao Maps JavaScript API + Drawing 라이브러리 -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=add4ce93b38c0ff9d9b9053728e067b3&libraries=drawing&autoload=false"></script>
</head>
<body>
  <div class="page">
    <aside class="side">
      <div>
        <div class="side-header-title">Route 조회 및 추가</div>
        <div class="side-header-sub">Kakao Map · Supabase /route API</div>
      </div>

      <div>
        <div class="field-label">라우트 코드 (예: 126B01)</div>
        <input id="routeCodeInput" class="input" />
      </div>

      <div class="btn-row">
        <button id="loadBtn">불러오기(GET)</button>
        <button id="newDrawBtn">새로 그리기</button>
        <button class="primary" id="saveBtn">저장(POST)</button>
        <button class="danger" id="clearMapBtn">지도 초기화</button>
      </div>

      <div class="hint">
        · URL에 <code>?code=126B01</code> 이 있으면 자동으로 코드 채워짐<br />
        · 폴리곤은 <b>다각형 도구</b>로 그리고, 더블 클릭하면 닫힙니다.<br />
        · 저장 시 <code>polygon_wgs84</code> / <code>center_wgs84</code> 로 Supabase에 업서트 됩니다.
      </div>

      <div class="status-box" id="statusBox">준비 완료</div>
    </aside>

    <div class="map-wrapper">
      <div id="map"></div>
      <div class="map-overlay-info" id="overlayInfo">
        지도 준비 중...
      </div>
    </div>
  </div>

  <script>
    const ROUTE_API_BASE = "https://route.maroowell.com";

    let map;
    let drawingManager;
    let currentPolygon = null; // 마지막으로 그린 polygon overlay

    const $ = (id) => document.getElementById(id);

    function setStatus(msg) {
      $("statusBox").textContent = msg;
    }
    function setOverlay(msg) {
      $("overlayInfo").textContent = msg;
    }

    // URL ?code=126B01 읽기
    function getCodeFromQuery() {
      const sp = new URLSearchParams(location.search);
      return sp.get("code") || "";
    }

    // Kakao 지도 + DrawingManager 초기화
    function initMap() {
      const container = $("map");
      const center = new kakao.maps.LatLng(37.5665, 126.9780); // 서울시청 근처
      map = new kakao.maps.Map(container, {
        center,
        level: 6,
      });

      // DrawingManager : polygon만 허용
      const options = {
        map,
        drawingMode: [
          kakao.maps.drawing.OverlayType.POLYGON,
        ],
        guideTooltip: ["draw"],

        polygonOptions: {
          draggable: true,
          removable: true,
          strokeWeight: 3,
          strokeColor: "#f97316",
          strokeOpacity: 0.9,
          strokeStyle: "solid",
          fillColor: "#f97316",
          fillOpacity: 0.3,
        },
      };

      drawingManager = new kakao.maps.drawing.DrawingManager(options);

      // 그리기 완료 시 이벤트
      kakao.maps.event.addListener(drawingManager, "drawend", function(data) {
        if (data.overlayType === kakao.maps.drawing.OverlayType.POLYGON) {
          // 이전 폴리곤 지우고 새거로 교체
          if (currentPolygon) currentPolygon.setMap(null);
          currentPolygon = data.target;
          setStatus("폴리곤 작성 완료. 저장하려면 [저장(POST)] 버튼을 누르세요.");
        }
      });

      setOverlay("지도 준비 완료. 라우트 코드를 입력하고 불러오거나, 새로 그리세요.");
    }

    // 현재 currentPolygon 의 경도/위도 배열 추출
    function extractLngLatFromPolygon(poly) {
      const path = poly.getPath();
      const arr = [];
      for (let i = 0; i < path.length; i++) {
        const p = path.getAt(i);
        arr.push([p.getLng(), p.getLat()]);
      }
      return arr;
    }

    // 경도/위도 배열로부터 중심점(단순 평균) 계산
    function calcCenterFromLngLat(points) {
      if (!points.length) return null;
      let sumLng = 0, sumLat = 0;
      points.forEach(([lng, lat]) => {
        sumLng += lng;
        sumLat += lat;
      });
      return [sumLng / points.length, sumLat / points.length];
    }

    // polygon_wgs84 데이터를 지도에 그리기
    function drawPolygonFromWgs84(points) {
      if (!Array.isArray(points) || !points.length) return;

      const path = points.map(([lng, lat]) => new kakao.maps.LatLng(lat, lng));

      if (currentPolygon) currentPolygon.setMap(null);

      currentPolygon = new kakao.maps.Polygon({
        map,
        path,
        strokeWeight: 3,
        strokeColor: "#22c55e",
        strokeOpacity: 0.9,
        strokeStyle: "solid",
        fillColor: "#22c55e",
        fillOpacity: 0.3,
      });

      // 영역 맞게 센터/레벨 조정
      const bounds = new kakao.maps.LatLngBounds();
      path.forEach(p => bounds.extend(p));
      map.setBounds(bounds);

      setStatus("저장된 폴리곤을 불러와서 지도에 표시했습니다.");
    }

    // Supabase에서 라우트 1건 GET
    async function fetchRoute(code) {
      const url = `${ROUTE_API_BASE}/route?code=${encodeURIComponent(code)}`;
      const res = await fetch(url);
      if (res.status === 404) {
        return { found: false };
      }
      if (!res.ok) {
        const t = await res.text();
        throw new Error(`GET /route 실패: ${res.status} / ${t}`);
      }
      return await res.json(); // { found, row }
    }

    // Supabase로 라우트 저장 POST
    async function saveRoute({ code, polygon_wgs84, center_wgs84 }) {
      const url = `${ROUTE_API_BASE}/route`;
      const body = {
        code,
        polygon_wgs84,
        center_wgs84,
      };
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(`POST /route 실패: ${res.status} / ${t}`);
      }
      return await res.json(); // { ok, row }
    }

    // 버튼 이벤트들
    function bindUI() {
      const codeInput = $("routeCodeInput");

      $("loadBtn").onclick = async () => {
        const code = codeInput.value.trim();
        if (!code) {
          alert("라우트 코드를 입력하세요. (예: 126B01)");
          return;
        }
        try {
          setStatus("GET /route 호출 중...");
          const data = await fetchRoute(code);
          if (!data.found) {
            setStatus(`저장된 데이터 없음: ${code}`);
            if (currentPolygon) {
              currentPolygon.setMap(null);
              currentPolygon = null;
            }
            return;
          }
          const row = data.row;
          if (row.polygon_wgs84) {
            drawPolygonFromWgs84(row.polygon_wgs84);
          } else {
            setStatus("polygon_wgs84 데이터가 없어 지도엔 표시하지 못했습니다.");
          }
        } catch (e) {
          console.error(e);
          setStatus(String(e));
          alert("라우트 불러오기 중 오류가 발생했습니다. 콘솔 확인.");
        }
      };

      $("newDrawBtn").onclick = () => {
        setStatus("다각형 도구로 지도를 클릭해서 라우트 영역을 그리세요. (더블 클릭으로 종료)");
        // 기존 폴리곤은 남겨두고 새로 그릴 수도 있지만,
        // 헷갈리지 않게 기존 것 삭제
        if (currentPolygon) {
          currentPolygon.setMap(null);
          currentPolygon = null;
        }
        // polygon 모드로 전환
        drawingManager.cancel();
        drawingManager.select(kakao.maps.drawing.OverlayType.POLYGON);
      };

      $("saveBtn").onclick = async () => {
        const code = codeInput.value.trim();
        if (!code) {
          alert("라우트 코드를 먼저 입력하세요.");
          return;
        }
        if (!currentPolygon) {
          alert("저장할 폴리곤이 없습니다. 먼저 영역을 그려주세요.");
          return;
        }

        try {
          const pts = extractLngLatFromPolygon(currentPolygon);
          if (!pts.length) {
            alert("폴리곤 좌표가 비어 있습니다.");
            return;
          }
          const center = calcCenterFromLngLat(pts);

          setStatus("POST /route (Supabase 저장) 호출 중...");
          const resp = await saveRoute({
            code,
            polygon_wgs84: pts,
            center_wgs84: center,
          });

          setStatus(`저장 완료. id=${resp.row?.id ?? "?"}, updated_at=${resp.row?.updated_at ?? ""}`);
          alert("저장 완료!");
        } catch (e) {
          console.error(e);
          setStatus(String(e));
          alert("저장 중 오류가 발생했습니다. 콘솔 확인.");
        }
      };

      $("clearMapBtn").onclick = () => {
        if (currentPolygon) {
          currentPolygon.setMap(null);
          currentPolygon = null;
        }
        drawingManager.cancel();
        setStatus("지도 초기화 완료.");
      };
    }

    kakao.maps.load(function () {
      initMap();
      bindUI();

      // URL 쿼리에서 code 있으면 자동 세팅
      const qCode = getCodeFromQuery();
      if (qCode) {
        $("routeCodeInput").value = qCode;
        setStatus(`URL에서 code=${qCode} 감지. [불러오기(GET)] 눌러봐도 됨.`);
      } else {
        setStatus("라우트 코드를 입력하고 [불러오기] 또는 [새로 그리기]를 사용하세요.");
      }
    });
  </script>
</body>
</html>
