<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>마루웰 라우트 편집기 · Kakao Map + Supabase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    header {
      height: 48px;
      padding: 0 14px;
      border-bottom: 1px solid #111827;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #020617;
    }

    header .title {
      font-size: 0.95rem;
      font-weight: 700;
    }

    header .subtitle {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .page {
      flex: 1;
      display: flex;
      min-height: 0;
    }

    .side {
      width: 320px;
      max-width: 100%;
      padding: 14px;
      border-right: 1px solid #111827;
      background: #020617;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .side label {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 3px;
      display: block;
    }

    .input {
      width: 100%;
      padding: 7px 10px;
      border-radius: 7px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
    }

    .input::placeholder {
      color: #4b5563;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    button {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 12px;
      font-size: 0.78rem;
      cursor: pointer;
      white-space: nowrap;
    }

    button.primary {
      background: #111827;
      border-color: #111827;
    }

    button.danger {
      border-color: #b91c1c;
      color: #fecaca;
    }

    button:hover {
      background: #111827;
    }

    .hint {
      font-size: 0.72rem;
      color: #6b7280;
      line-height: 1.4;
    }

    .hint code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.72rem;
      background: #020617;
      padding: 1px 4px;
      border-radius: 3px;
    }

    .log {
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #111827;
      background: #020617;
      font-size: 0.7rem;
      color: #9ca3af;
      height: 80px;
      overflow: auto;
      white-space: pre-wrap;
    }

    .map-wrapper {
      flex: 1;
      position: relative;
      min-width: 0;
    }

    #map {
      position: absolute;
      inset: 0;
    }

    .badge {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      font-size: 0.68rem;
      color: #9ca3af;
    }

    .overlay-info {
      position: absolute;
      left: 12px;
      bottom: 12px;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid #111827;
      background: rgba(15, 23, 42, 0.9);
      font-size: 0.72rem;
      color: #9ca3af;
      pointer-events: none;
    }

    @media (max-width: 768px) {
      .page {
        flex-direction: column;
      }
      .side {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #111827;
      }
    }
  </style>

  <!-- Kakao Maps + Drawing Library -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=add4ce93b38c0ff9d9b9053728e067b3&autoload=false&libraries=drawing"></script>
</head>
<body>
  <header>
    <div>
      <div class="title">마루웰 라우트 편집기</div>
      <div class="subtitle">캠프 + 라우트 코드 기반 · Kakao Map · Supabase route API</div>
    </div>
    <span class="badge" id="statusBadge">API: idle</span>
  </header>

  <div class="page">
    <aside class="side">
      <div>
        <label for="campInput">캠프 이름</label>
        <input id="campInput" class="input" placeholder="예: 일산2" />
      </div>

      <div>
        <label for="routeInput">라우트 코드</label>
        <input id="routeInput" class="input" placeholder="예: 126B01 또는 126B" />
      </div>

      <div class="btn-row">
        <button id="loadBtn">불러오기(GET)</button>
        <button id="drawBtn" class="primary">새로 그리기</button>
        <button id="saveBtn">저장(POST)</button>
        <button id="resetBtn" class="danger">지도 초기화</button>
      </div>

      <div class="hint">
        · 조회/저장 시 <b>캠프 + 라우트</b> 둘 다 필수입니다.<br />
        · <code>126B01</code> 처럼 끝까지 쓰면 해당 서서브만 조회<br />
        · <code>126B</code>, <code>126</code> 처럼 중간까지 쓰면 그 밑 서서브까지
        한 번에 가져오도록 <b>mode=prefix</b> 로 요청합니다 (백엔드에서 구현).<br />
        · 저장 시 현재 그려진 폴리곤의 <code>polygon_wgs84</code> / <code>center_wgs84</code> 를
        <code>POST /route</code> 로 전송합니다.
      </div>

      <div class="log" id="log"></div>
    </aside>

    <div class="map-wrapper">
      <div id="map"></div>
      <div class="overlay-info" id="overlayInfo">
        지도 준비 중...
      </div>
    </div>
  </div>

  <script>
    const ROUTE_API_BASE = "https://route.maroowell.com";

    const state = {
      map: null,
      drawingManager: null,
      drawnOverlays: [],   // kakao.maps.Polygon[]
    };

    const $ = (id) => document.getElementById(id);

    function setStatus(text) {
      $("statusBadge").textContent = "API: " + text;
    }

    function log(msg, obj) {
      const box = $("log");
      const time = new Date().toLocaleTimeString("ko-KR", { hour12: false });
      let line = "[" + time + "] " + msg;
      if (obj !== undefined) {
        try {
          line += " " + JSON.stringify(obj);
        } catch (e) {
          line += " " + String(obj);
        }
      }
      box.textContent = line + "\n" + box.textContent;
    }

    function setOverlayMessage(msg) {
      $("overlayInfo").textContent = msg;
    }

    // ----------------- LatLng 수집 유틸 ----------------- //
    // path 구조가 어떤 모양이든 전부 [lng, lat] 배열로 뽑기
    function collectLngLat(pathLike) {
      const out = [];

      const walk = (p) => {
        if (!p) return;

        // kakao.maps.LatLng or 비슷한 객체
        if (
          (typeof kakao !== "undefined" && p instanceof kakao.maps.LatLng) ||
          (typeof p.getLat === "function" && typeof p.getLng === "function")
        ) {
          out.push([p.getLng(), p.getLat()]);
          return;
        }

        // getLength / getAt 지원하는 path
        if (typeof p.getLength === "function" && typeof p.getAt === "function") {
          for (let i = 0; i < p.getLength(); i++) {
            walk(p.getAt(i));
          }
          return;
        }

        // 배열인 경우
        if (Array.isArray(p)) {
          p.forEach(walk);
        }
      };

      walk(pathLike);
      return out;
    }

    // raw 좌표 ( [[lng,lat], ...] 또는 [[[..., ...]], ...] ) → Kakao LatLng path 배열
    function toLatLngPaths(raw) {
      if (!Array.isArray(raw) || !raw.length) return [];

      // 첫 원소가 숫자면 1-ring, 배열이면 multi-ring
      const rings =
        Array.isArray(raw[0]) && typeof raw[0][0] === "number" ? [raw] : raw;

      return rings.map((ring) =>
        ring
          .map((pair) => {
            if (!Array.isArray(pair) || pair.length < 2) return null;
            const lng = Number(pair[0]);
            const lat = Number(pair[1]);
            if (!Number.isFinite(lng) || !Number.isFinite(lat)) return null;
            return new kakao.maps.LatLng(lat, lng);
          })
          .filter(Boolean)
      );
    }

    // bounds 계산
    function fitMapToOverlays(polys) {
      if (!polys.length) return;
      const bounds = new kakao.maps.LatLngBounds();
      let has = false;

      polys.forEach((poly) => {
        const path = poly.getPath ? poly.getPath() : poly;
        const latlngs = collectLngLat(path);
        latlngs.forEach(([lng, lat]) => {
          bounds.extend(new kakao.maps.LatLng(lat, lng));
          has = true;
        });
      });

      if (has) {
        state.map.setBounds(bounds);
      }
    }

    function clearOverlays() {
      state.drawnOverlays.forEach((o) => o.setMap(null));
      state.drawnOverlays = [];
    }

    // ----------------- Kakao 지도 초기화 ----------------- //
    function initMap() {
      const container = $("map");
      const center = new kakao.maps.LatLng(37.5665, 126.9780); // 서울시청 근처
      state.map = new kakao.maps.Map(container, {
        center,
        level: 7,
      });

      // Drawing Manager
      state.drawingManager = new kakao.maps.drawing.DrawingManager({
        map: state.map,
        drawingMode: [],
        guideTooltip: ["draw"],
        polygonOptions: {
          draggable: true,
          removable: true,
          editable: true,
          strokeWeight: 3,
          strokeColor: "#22c55e",
          strokeOpacity: 0.9,
          strokeStyle: "solid",
          fillColor: "#22c55e",
          fillOpacity: 0.25,
        },
      });

      // UI 핸들러 바인딩
      bindUI();

      setOverlayMessage("지도 준비 완료. 캠프 + 라우트 코드를 입력 후 [불러오기] 또는 [새로 그리기]를 이용하세요.");
      log("지도 초기화 완료");
    }

    kakao.maps.load(initMap);

    // ----------------- UI 이벤트 ----------------- //
    function bindUI() {
      const campInput = $("campInput");
      const routeInput = $("routeInput");
      const loadBtn = $("loadBtn");
      const drawBtn = $("drawBtn");
      const saveBtn = $("saveBtn");
      const resetBtn = $("resetBtn");

      // 엔터키로 불러오기
      routeInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          loadBtn.click();
        }
      });

      // 불러오기(GET)
      loadBtn.onclick = async () => {
        const camp = campInput.value.trim();
        const code = routeInput.value.trim();

        if (!camp) {
          alert("캠프 이름을 입력하세요. (예: 일산2)");
          campInput.focus();
          return;
        }
        if (!code) {
          alert("라우트 코드를 입력하세요. (예: 126B01 또는 126B)");
          routeInput.focus();
          return;
        }

        // suffix까지 다 쓰면 exact, 아니면 prefix
        const mode =
          /[0-9]{2}$/.test(code) && code.length >= 5 ? "exact" : "prefix";

        const url =
          ROUTE_API_BASE +
          "/route?camp=" +
          encodeURIComponent(camp) +
          "&code=" +
          encodeURIComponent(code) +
          "&mode=" +
          encodeURIComponent(mode);

        try {
          setStatus("GET /route ...");
          log("GET " + url);
          const res = await fetch(url, { method: "GET" });
          const data = await res.json().catch(() => ({}));
          log("GET /route 응답", data);

          if (!res.ok) {
            alert("조회 실패: " + (data.error || res.status));
            setStatus("error");
            return;
          }

          drawFromRouteApi(data);
          setStatus("ok");
        } catch (e) {
          console.error(e);
          alert("route API 호출 오류: " + e);
          setStatus("error");
        }
      };

      // 새로 그리기
      drawBtn.onclick = () => {
        if (!state.drawingManager) return;
        setOverlayMessage("폴리곤을 그린 뒤 더블클릭하면 완료됩니다.");
        state.drawingManager.cancel();
        state.drawingManager.select(
          kakao.maps.drawing.OverlayType.POLYGON
        );
      };

      // 저장(POST)
      saveBtn.onclick = async () => {
        const camp = campInput.value.trim();
        const code = routeInput.value.trim();

        if (!camp) {
          alert("캠프 이름을 먼저 입력하세요.");
          campInput.focus();
          return;
        }
        if (!code) {
          alert("라우트 코드를 먼저 입력하세요.");
          routeInput.focus();
          return;
        }

        if (!state.drawingManager) {
          alert("지도 준비가 아직 안되었습니다.");
          return;
        }

        const data = state.drawingManager.getData();
        const polys = data[kakao.maps.drawing.OverlayType.POLYGON] || [];

        if (!polys.length) {
          alert("저장할 폴리곤이 없습니다. 먼저 [새로 그리기]로 영역을 그려주세요.");
          return;
        }

        const latest = polys[polys.length - 1]; // 마지막에 그린 폴리곤 사용
        const coords = collectLngLat(latest.points);

        if (coords.length < 3) {
          alert("폴리곤 정점이 너무 적습니다. 최소 3개 이상 찍어주세요.");
          return;
        }

        // 중심 계산 (bounds 이용)
        const bounds = new kakao.maps.LatLngBounds();
        coords.forEach(([lng, lat]) => {
          bounds.extend(new kakao.maps.LatLng(lat, lng));
        });
        const centerLL = bounds.getCenter();
        const center_wgs84 = [centerLL.getLng(), centerLL.getLat()];

        const payload = {
          camp,
          code,
          polygon_wgs84: coords,
          center_wgs84,
        };

        const url = ROUTE_API_BASE + "/route";

        try {
          setStatus("POST /route ...");
          log("POST " + url, payload);

          const res = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          const resJson = await res.json().catch(() => ({}));
          log("POST /route 응답", resJson);

          if (!res.ok) {
            alert("저장 실패: " + (resJson.error || res.status));
            setStatus("error");
            return;
          }

          alert("저장 완료!");
          setStatus("ok");
        } catch (e) {
          console.error(e);
          alert("저장 중 오류: " + e);
          setStatus("error");
        }
      };

      // 지도 초기화
      resetBtn.onclick = () => {
        if (!confirm("지도의 모든 폴리곤을 지우고 초기화할까요?")) return;
        clearOverlays();
        if (state.drawingManager) {
          state.drawingManager.cancel();
        }
        state.map.setLevel(7);
        state.map.setCenter(new kakao.maps.LatLng(37.5665, 126.9780));
        setOverlayMessage("지도 초기화 완료");
      };
    }

    // ----------------- API 응답 → 지도에 그리기 ----------------- //
    function drawFromRouteApi(data) {
      clearOverlays();

      if (!data) {
        alert("응답이 비어 있습니다.");
        return;
      }

      // 단일 row 형태
      if (data.mode === "one" || data.row) {
        if (!data.found || !data.row) {
          alert("해당 라우트를 찾지 못했습니다.");
          return;
        }
        drawOneRoute(data.row);
        return;
      }

      // 리스트 형태
      if (Array.isArray(data.rows) && data.rows.length) {
        data.rows.forEach(drawOneRoute);
        return;
      }

      // 예전 형식: { found:true, row:{...} }
      if (data.found && data.row) {
        drawOneRoute(data.row);
        return;
      }

      alert("표시할 라우트 데이터가 없습니다.");
    }

    function drawOneRoute(row) {
      const raw =
        row.polygon_wgs84 ||
        row.polygon_wgs84_json ||
        row.polygon5179 || // 아직 변환 안된 데이터일 수도 있으니 임시
        [];
      const paths = toLatLngPaths(raw);

      if (!paths.length || !paths[0].length) {
        log("폴리곤 좌표 없음", row);
        return;
      }

      const color = "#f97316";

      paths.forEach((path) => {
        const poly = new kakao.maps.Polygon({
          map: state.map,
          path,
          strokeWeight: 3,
          strokeColor: color,
          strokeOpacity: 0.95,
          strokeStyle: "solid",
          fillColor: color,
          fillOpacity: 0.25,
        });
        state.drawnOverlays.push(poly);
      });

      fitMapToOverlays(state.drawnOverlays);
      setOverlayMessage("로드된 라우트: " + (row.code || ""));
    }
  </script>
</body>
</html>
