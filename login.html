<!doctype html>
<html lang="ko">
<head>
    <script src="/config.js"></script>
  <script>
    // false 로 바꾸면 회원가입 버튼이 숨겨집니다.
    function MAROOWELL_ENABLE_SIGNUP() { return true; }
  </script>
<meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Maroowell.com Login</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --line:#d9deea;
      --text:#0f172a;
      --muted:#475569;
      --btn:#0f172a;
      --btnHover:#1e293b;
    }
    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;
    }
    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .card{
      width:100%;
      max-width:420px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:22px;
      box-shadow:0 10px 30px rgba(15,23,42,.08);
    }
    .logo{
      display:block;
      width:84px;
      height:84px;
      margin:2px auto 10px;
      object-fit:contain;
    }
    .title{
      margin:0 0 18px;
      font-size:28px;
      line-height:1.2;
      font-weight:800;
      letter-spacing:-.2px;
      text-align:center;
    }
    .label{
      display:block;
      margin:12px 0 6px;
      color:var(--muted);
      font-size:13px;
      font-weight:600;
    }
    input{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      outline:none;
      font-size:15px;
    }
    input:focus{
      border-color:#64748b;
      box-shadow:0 0 0 3px rgba(100,116,139,.15);
    }
    .btn{
      width:100%;
      margin-top:16px;
      padding:12px 14px;
      border:none;
      border-radius:12px;
      background:var(--btn);
      color:#fff;
      font-size:15px;
      font-weight:700;
      cursor:pointer;
    }
    .btn:hover{background:var(--btnHover)}
    .btn.secondary{
      margin-top:8px;
      background:#fff;
      color:var(--text);
      border:1px solid var(--line);
    }
    .btn.secondary:hover{background:#f1f5f9}
    .status{
      margin-top:12px;
      min-height:20px;
      font-size:13px;
      color:var(--muted);
      white-space:pre-wrap;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <img class="logo" src="/maroowell-logo2.png" alt="Maroowell Logo" onerror="if(this.dataset.fallback){this.onerror=null;this.src='/favicon.ico';}else{this.dataset.fallback='1';this.src='/public/maroowell-logo2.png';}" />
    <h1 class="title">Maroowell.com Login</h1>
    <label class="label" for="email">이메일</label>
    <input id="email" type="email" placeholder="name@company.com" autocomplete="email" />
    <label class="label" for="password">비밀번호</label>
    <input id="password" type="password" placeholder="********" autocomplete="current-password" />
    <button class="btn" id="btnSignIn" type="button">로그인</button>
    <button class="btn secondary" id="btnSignUp" type="button">회원가입</button>
    <div class="status" id="statusLogin"></div>
  </div>
</div>

<script>
(() => {
  const { SUPABASE_URL, SUPABASE_ANON_KEY, PATHS } = (window.MARUWELL_CONFIG || {});
  const DEFAULT_NEXT = (PATHS?.index || "/index.html");

  const authStorage = (() => {
    try { return window.localStorage; } catch {}
    try { return window.sessionStorage; } catch {}
    return null;
  })();

  const supabase = (SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase?.createClient)
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: !!authStorage,
          storage: authStorage || undefined,
          autoRefreshToken: true,
          detectSessionInUrl: true
        }
      })
    : null;

  const email = document.getElementById("email");
  const password = document.getElementById("password");
  const btnSignIn = document.getElementById("btnSignIn");
  const btnSignUp = document.getElementById("btnSignUp");
  const statusLogin = document.getElementById("statusLogin");
  const ENABLE_SIGNUP = !!(window.MAROOWELL_ENABLE_SIGNUP?.());

  const params = new URLSearchParams(location.search);
  const next = params.get("next") || DEFAULT_NEXT;

  function setStatus(msg) {
    statusLogin.textContent = msg;
  }

  function safeNextUrl(u) {
    if (!u) return DEFAULT_NEXT;
    if (u.startsWith("http://") || u.startsWith("https://")) return DEFAULT_NEXT;
    if (!u.startsWith("/")) return DEFAULT_NEXT;
    return u;
  }

  function requireSupabase() {
    if (supabase) return true;
    setStatus("설정 오류: Supabase 연결 실패");
    return false;
  }

  async function redirectIfLoggedIn() {
    if (!supabase?.auth) return;
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;
    if (redirectIfLoggedIn._scheduled) return;
    redirectIfLoggedIn._scheduled = true;
    location.replace(safeNextUrl(next));
  }

  async function signIn() {
    try {
      if (!requireSupabase()) return;
      setStatus("로그인 중...");

      const em = (email.value || "").trim().toLowerCase();
      const pw = password.value || "";
      if (!em) throw new Error("이메일을 입력하세요.");
      if (!pw) throw new Error("비밀번호를 입력하세요.");

      const { error } = await supabase.auth.signInWithPassword({ email: em, password: pw });
      if (error) throw error;

      setStatus("로그인 성공");
      location.replace(safeNextUrl(next));
    } catch (e) {
      setStatus("로그인 실패: " + (e?.message || String(e)));
    }
  }

  async function signUp() {
    try {
      if (!requireSupabase()) return;
      setStatus("회원가입 중...");

      const em = (email.value || "").trim().toLowerCase();
      const pw = password.value || "";
      if (!em) throw new Error("이메일을 입력하세요.");
      if (!pw) throw new Error("비밀번호를 입력하세요.");
      if (pw.length < 8) throw new Error("비밀번호는 8자 이상 입력하세요.");

      const { data, error } = await supabase.auth.signUp({
        email: em,
        password: pw,
        options: { emailRedirectTo: location.origin + (PATHS?.login || "/login.html") }
      });
      if (error) throw error;

      if (data?.session) {
        setStatus("회원가입 완료");
        location.replace(safeNextUrl(next));
        return;
      }

      setStatus("회원가입 완료. 이메일 인증 후 로그인하세요.");
    } catch (e) {
      setStatus("회원가입 실패: " + (e?.message || String(e)));
    }
  }

  if (!ENABLE_SIGNUP && btnSignUp) {
    btnSignUp.style.display = "none";
  }

  btnSignIn.addEventListener("click", signIn);
  if (btnSignUp && ENABLE_SIGNUP) {
    btnSignUp.addEventListener("click", signUp);
  }
  password.addEventListener("keydown", (e) => {
    if (e.key !== "Enter") return;
    e.preventDefault();
    signIn();
  });

  (async () => {
    if (!requireSupabase()) return;
    supabase.auth.onAuthStateChange((_event, session) => {
      if (!session) return;
      if (redirectIfLoggedIn._scheduled) return;
      redirectIfLoggedIn._scheduled = true;
      location.replace(safeNextUrl(next));
    });
    await redirectIfLoggedIn();
  })();
})();
</script>
</body>
</html>
