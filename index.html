<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="referrer" content="origin" />
  <title>마루웰1</title>
  <style>
    :root { --headerH: 52px; --bg:#0f1115; --card:#161a22; --muted:#8b95a7; --text:#e6e9ef; }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:14px/1.4 system-ui,AppleSDGothicNeo,Segoe UI,Roboto
    }
    header{
      display:flex;
      gap:12px;
      align-items:center;
      padding:12px 16px;
      height:var(--headerH);
      background:#161a22;
      border-bottom:1px solid #232838;
      position:sticky;
      top:0;
      z-index:5
    }
    header h1{font-size:16px;margin:0}
    #app{
      display:grid;
      grid-template-columns:360px 1fr;
      min-height:calc(100dvh - var(--headerH))
    }
    #panel{
      padding:14px;
      border-right:1px solid #232838;
      background:#10141b
    }
    #mapWrap{position:relative}
    #map{position:absolute;inset:0}
    label{display:block;margin:10px 0 6px;color:#9aa6b2}
    input,textarea,button{font:inherit}
    textarea{
      width:100%;
      background:#0c0f14;
      border:1px solid #2a3142;
      color:var(--text);
      padding:10px;
      border-radius:10px;
      min-height:90px
    }
    button{
      background:#1b2230;
      border:1px solid #2a3142;
      color:var(--text);
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer
    }
    button:hover{border-color:#3a4561}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:#8b95a7;font-size:12px}
    .list{margin-top:10px;display:flex;flex-wrap:wrap;gap:6px}
    .chip{
      border:1px solid #2a3142;
      border-radius:999px;
      padding:6px 10px;
      background:#0c0f14;
      display:inline-flex;
      align-items:center;
      gap:6px
    }
    .chip button{
      border:none;
      background:transparent;
      color:#94a3b8;
      cursor:pointer
    }
    #gate{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.8);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:99
    }
    #gateCard{
      background:#0e131a;
      border:1px solid #2a3142;
      border-radius:16px;
      padding:22px;
      width:360px
    }
    #gateCard h2{margin:0 0 12px}
    .ok{color:#9FE870}
    .err{color:#ff7b7b}
    @media (max-width: 900px){
      #app{grid-template-columns:1fr}
      #panel{order:2}
    }
  </style>

  <!-- Daum 우편번호 -->
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

  <!-- proj4 (5179 -> 4326 변환용) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.1/proj4.min.js"></script>

  <!-- Kakao 지도 SDK -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=add4ce93b38c0ff9d9b9053728e067b3"></script>
</head>
<body>
  <header>
    <h1>MarooWell 지도</h1>
    <span class="muted">다중 우편번호 권역 표시 · 향안부 ZIP API · Kakao Map</span>
  </header>

  <!-- 임시 게이트 (코드: maroowell) -->
  <div id="gate">
    <div id="gateCard">
      <h2>접속 코드</h2>
      <p class="muted">임시 보호용. 배포 전 정식 인증으로 교체 권장</p>
      <label>Access Code</label>
      <input id="code" type="password" placeholder="예: maroowell" />
      <div class="row" style="margin-top:12px">
        <button id="enterBtn">입장</button>
        <span id="gateMsg" class="muted"></span>
      </div>
    </div>
  </div>

  <div id="app" style="display:none">
    <aside id="panel">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted">우편번호 여러 개 동시 조회</div>
          <div class="muted">쉼표/공백/줄바꿈 모두 가능</div>
        </div>
        <button id="openAddr">주소검색 추가</button>
      </div>

      <label style="margin-top:12px">우편번호 목록</label>
      <textarea id="zipInput"
        placeholder="예: 07420, 07421 07422&#10;또는 붙여넣기"></textarea>

      <div class="row" style="margin-top:8px">
        <button id="addBtn">추가</button>
        <button id="clearBtn">초기화</button>
        <button id="searchBtn">지도표시</button>
      </div>

      <div class="list" id="zipList"></div>

      <div class="row" style="margin-top:10px">
        <button id="shareBtn">공유링크 복사</button>
        <button id="fitBtn">영역맞춤</button>
      </div>

      <p class="muted" style="margin-top:10px">
        • 각 우편번호는 <code>https://zip.maroowell.com/?zipcode=XXXXX</code> 에서<br>
        &nbsp;&nbsp;폴리곤(5179 좌표)을 받아와서 카카오 지도에 표시합니다.<br>
        • 잘못된 우편번호나 데이터가 없는 경우 미탑재로 안내됩니다.
      </p>
    </aside>

    <div id="mapWrap">
      <div id="map"></div>
    </div>
  </div>

  <script>
    // ------- 전역 상태 ------- //
    const state = {
      map: null,
      polygons: new Map(),    // zipcode -> [Polygon, ...]
      selectedZips: new Set(),
      colors: [
        '#6aa9ff','#9FE870','#fbbf24','#fb7185',
        '#22d3ee','#c084fc','#f472b6','#60a5fa',
        '#34d399','#f59e0b'
      ]
    };

    const ZIP_API = 'https://zip.maroowell.com/?zipcode=';
    const $ = sel => document.querySelector(sel);

    const parseZips = raw =>
      [...new Set((raw || '').match(/\d{5}/g) || [])];

    const pickColor = zip => {
      let h = 0;
      for (let i = 0; i < zip.length; i++) {
        h = (h * 31 + zip.charCodeAt(i)) >>> 0;
      }
      return state.colors[h % state.colors.length];
    };

    // ------- proj4 세팅 (5179 -> 4326) ------- //
    proj4.defs('EPSG:5179',
      '+proj=tmerc +lat_0=38 +lon_0=127.5 +k=0.9996 ' +
      '+x_0=1000000 +y_0=2000000 +ellps=GRS80 ' +
      '+towgs84=0,0,0,0,0,0,0 +units=m +no_defs'
    );
    proj4.defs('EPSG:4326',
      '+proj=longlat +datum=WGS84 +no_defs'
    );

    const toWgs84 = (x, y) => {
      const [lon, lat] = proj4('EPSG:5179', 'EPSG:4326', [x, y]);
      return { lat, lon };
    };

    // ------- 지도 초기화 ------- //
    function createMap() {
      if (!(window.kakao && kakao.maps)) {
        alert('카카오 지도 SDK 로딩 실패');
        return;
      }
      state.map = new kakao.maps.Map($('#map'), {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 8
      });

      // 리사이즈 시 지도 재배치
      window.addEventListener('resize', () => {
        const c = state.map.getCenter();
        state.map.relayout();
        state.map.setCenter(c);
      });
    }

    // ------- 게이트 바인딩 ------- //
    function gateBind() {
      $('#enterBtn').onclick = () => {
        const ok = ($('#code').value.trim() === 'maroowell');
        $('#gateMsg').textContent = ok ? 'OK' : '코드가 올바르지 않습니다.';
        $('#gateMsg').className = ok ? 'ok' : 'err';
        if (ok) {
          $('#gate').style.display = 'none';
          $('#app').style.display = 'grid';
          createMap();
          bindUI();
        }
      };
    }

    // ------- UI 이벤트 ------- //
    function bindUI() {
      $('#addBtn').onclick = () => {
        parseZips($('#zipInput').value)
          .forEach(z => state.selectedZips.add(z));
        $('#zipInput').value = '';
        renderZipChips();
      };

      $('#clearBtn').onclick = () => {
        state.selectedZips.clear();
        clearPolygons();
        renderZipChips();
      };

      $('#searchBtn').onclick = async () => {
        await drawSelected();
        fitBoundsAll();
      };

      $('#fitBtn').onclick = fitBoundsAll;

      $('#shareBtn').onclick = async () => {
        const u = new URL(location.href);
        u.searchParams.set('zips', [...state.selectedZips].join(','));
        await navigator.clipboard.writeText(u.toString());
        alert('공유 링크 복사됨');
      };

      $('#openAddr').onclick = () => {
        new daum.Postcode({
          oncomplete: d => {
            if (d.zonecode) {
              state.selectedZips.add(d.zonecode);
              renderZipChips();
            }
          }
        }).open();
      };

      // URL 쿼리에서 미리 선택
      const preset = parseZips(new URLSearchParams(location.search).get('zips'));
      preset.forEach(z => state.selectedZips.add(z));
      renderZipChips();
      if (preset.length) {
        drawSelected().then(fitBoundsAll);
      }
    }

    function renderZipChips() {
      const list = $('#zipList');
      list.innerHTML = '';
      [...state.selectedZips].sort().forEach(z => {
        const div = document.createElement('div');
        div.className = 'chip';
        const color = pickColor(z);
        div.innerHTML =
          `<b>${z}</b>` +
          `<span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:${color}"></span>` +
          `<button title="삭제">✕</button>`;
        div.querySelector('button').onclick = () => {
          state.selectedZips.delete(z);
          removePolygon(z);
          renderZipChips();
        };
        list.appendChild(div);
      });
    }

    // ------- 폴리곤 관리 ------- //
    function clearPolygons() {
      for (const arr of state.polygons.values()) {
        arr.forEach(p => p.setMap(null));
      }
      state.polygons.clear();
    }

    function removePolygon(zip) {
      if (!state.polygons.has(zip)) return;
      state.polygons.get(zip).forEach(p => p.setMap(null));
      state.polygons.delete(zip);
    }

    // zip API -> Polygon 생성
    function polygonsFrom5179(polygon5179, color) {
      if (!Array.isArray(polygon5179) || !polygon5179.length) return [];

      // polygon5179 가 [[x,y], ...] 형식이라고 가정
      const rings = (
        Array.isArray(polygon5179[0]) &&
        typeof polygon5179[0][0] === 'number'
      ) ? [polygon5179] : polygon5179;

      const polys = [];

      for (const ring of rings) {
        const path = [];
        for (const pt of ring) {
          if (!Array.isArray(pt) || pt.length < 2) continue;
          const x = Number(pt[0]);
          const y = Number(pt[1]);
          if (!isFinite(x) || !isFinite(y)) continue;

          const { lat, lon } = toWgs84(x, y);
          if (!isFinite(lat) || !isFinite(lon)) continue;

          path.push(new kakao.maps.LatLng(lat, lon));
        }

        if (path.length < 3) continue;

        const poly = new kakao.maps.Polygon({
          map: state.map,
          path,
          strokeWeight: 2,
          strokeColor: color,
          strokeOpacity: 0.9,
          strokeStyle: 'solid',
          fillColor: color,
          fillOpacity: 0.25
        });
        polys.push(poly);
      }

      return polys;
    }

    // 선택된 우편번호들 ZIP API 호출해서 그리기
    async function drawSelected() {
      const targets = [...state.selectedZips].filter(z => !state.polygons.has(z));
      if (!targets.length) return;

      const notFound = [];

      for (const zip of targets) {
        try {
          const url = `${ZIP_API}${encodeURIComponent(zip)}`;
          const res = await fetch(url, { cache: 'no-store' });
          const data = await res.json();
          console.log('[ZIP] 로드 완료', zip, data);

          if (!Array.isArray(data.polygon5179) || !data.polygon5179.length) {
            notFound.push(zip);
            continue;
          }

          const color = pickColor(zip);
          const polys = polygonsFrom5179(data.polygon5179, color);
          if (!polys.length) {
            notFound.push(zip);
            continue;
          }

          state.polygons.set(zip, polys);
        } catch (e) {
          console.error('[ZIP] 로드 실패', zip, e);
          notFound.push(zip);
        }
      }

      if (notFound.length) {
        alert(`폴리곤을 그리지 못한 우편번호: ${notFound.join(', ')}`);
      }
    }

    // ------- path 에서 LatLng 전부 뽑아내기 ------- //
    function collectLatLngsFromPath(path) {
      const out = [];

      const walk = (p) => {
        if (!p) return;

        // LatLngPath 형태 (getLength / getAt 있음)
        if (typeof p.getLength === 'function' && typeof p.getAt === 'function') {
          for (let i = 0; i < p.getLength(); i++) {
            out.push(p.getAt(i));
          }
          return;
        }

        // 배열인 경우 (다중 링 또는 그냥 LatLng[])
        if (Array.isArray(p)) {
          for (const item of p) {
            walk(item);
          }
        }
      };

      walk(path);
      return out;
    }

    // ------- 화면 영역 맞추기 ------- //
    function fitBoundsAll() {
      const b = new kakao.maps.LatLngBounds();
      let has = false;

      for (const arr of state.polygons.values()) {
        for (const poly of arr) {
          const latlngs = collectLatLngsFromPath(poly.getPath());
          for (const ll of latlngs) {
            b.extend(ll);
            has = true;
          }
        }
      }

      if (has) state.map.setBounds(b);
    }

    // ------- DOM 로드 ------- //
    document.addEventListener('DOMContentLoaded', () => {
      gateBind();
    });
  </script>
</body>
</html>
